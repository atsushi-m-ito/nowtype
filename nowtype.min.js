"use strict";let CHRM_IME_node_origin=null,CHRM_IME_offset=0,CHRM_IME_length=0,CHRM_IME_original_text=null,CHRM_IME_br_origin=null,CHRM_IME_parent=null,CHRM_IME_offset_in_parent=0,CHRM_IME_update_count=0,CHRM_IME_in_action=!1,CHRM_IME_text_preceding_convert=null,CHRM_IME_node_preceding_convert=null,CHRM_IME_is_connected_undo=!1;function CHRM_OnCompositionstart(e){CHRM_IME_in_action=!0,console.log("compositionstart: ",e.data);const n=document.getSelection();if(0===n.rangeCount)return e.currentTarget.blur(),!1;const t=n.getRangeAt(0);let o=t.startContainer,i=t.startOffset,d=t.endContainer,a=t.endOffset;if(CHRM_IME_is_connected_undo=!1,console.log("focus: ",o,i),o===d&&i===a||console.log("anchor: ",d,a),n.isCollapsed){if(CHRM_IME_node_origin=o,CHRM_IME_offset=i,CHRM_IME_length=0,CHRM_IME_original_text=null,"BR"===o.nodeName)CHRM_IME_br_origin=o,CHRM_IME_parent=o.parentNode,CHRM_IME_offset_in_parent=GetIndex(o.parentNode,o),console.log("keep original BR node");else if(o.hasChildNodes()){const e=o.childNodes.item(i);"BR"===e.nodeName?(CHRM_IME_br_origin=e,CHRM_IME_parent=o,CHRM_IME_offset_in_parent=i,console.log("keep original BR node")):e.nodeType===Node.TEXT_NODE&&(console.log("WARNING: focus is at parent of text"),o=e,i=0)}if(o.nodeType===Node.TEXT_NODE){console.log("IME is input on text:",o.data);let e=o.nextSibling;for(;e&&e.nodeType===Node.TEXT_NODE;)e=e.nextSibling;const n=e;if(o.nextSibling!==n){for(undo_man.Begin(o,i);o.nextSibling!==n;)CombineTextNode(o);undo_man.End(o,i),CHRM_IME_is_connected_undo=!0,console.log("combine_text: ",o.data)}CHRM_IME_node_origin=o,CHRM_IME_offset=i,CHRM_IME_original_text=o.data,CHRM_IME_length=CHRM_IME_original_text.length,CHRM_IME_parent=o.parentNode,CHRM_IME_offset_in_parent=GetIndex(o.parentNode,o)}}else{let t=!1;if(CHRM_IME_node_origin=o,CHRM_IME_offset=i,CHRM_IME_original_text=null,d.nodeType===Node.TEXT_NODE)if(o===d)CHRM_IME_node_origin=o,CHRM_IME_offset=i,CHRM_IME_original_text=o.data,CHRM_IME_length=CHRM_IME_original_text.length,CHRM_IME_parent=o.parentNode,CHRM_IME_offset_in_parent=GetIndex(o.parentNode,o),t=!0;else if(o.nodeType===Node.TEXT_NODE){let e=!0,l=o.nextSibling;for(;l!==d;){if(null===l){e=!1;break}if(l.nodeType!==Node.TEXT_NODE){e=!1;break}l=l.nextSibling}if(e){undo_man.Begin(o,i,d,a);for(;o.nextSibling!==d;)CombineTextNode(o);a=o.length+a,CombineTextNode(o),n.setBaseAndExtent(o,i,o,a),undo_man.End(o,i,o,a),CHRM_IME_node_origin=o,CHRM_IME_offset=i,CHRM_IME_original_text=o.data,CHRM_IME_length=CHRM_IME_original_text.length,CHRM_IME_parent=o.parentNode,CHRM_IME_offset_in_parent=GetIndex(o.parentNode,o),t=!0,CHRM_IME_is_connected_undo=!0,console.log("combine_text: ",CHRM_IME_original_text)}}if(!0&&!t){const[e,d]=CorrectFocusToText(o,i);n.collapse(e,d),CHRM_IME_node_origin=e,CHRM_IME_offset=d,CHRM_IME_original_text=e.data,CHRM_IME_length=CHRM_IME_original_text.length,CHRM_IME_parent=e.parentNode,CHRM_IME_offset_in_parent=GetIndex(e.parentNode,e),t=!0}t||(console.log("Cancel IME"),e.preventDefault(),e.stopImmediatePropagation(),e.currentTarget.blur(),n.removeAllRanges(),alert("IME is cancelled to avoid bug"))}console.log("CHRM_IME_original_text: ",CHRM_IME_original_text),CHRM_IME_node_preceding_convert&&(CHRM_IME_node_origin===CHRM_IME_node_preceding_convert&&CHRM_IME_node_origin.data===CHRM_IME_text_preceding_convert.data||(console.log("WARNING by Chrome bug: CHRM_IME_text_before  : ",CHRM_IME_text_preceding_convert),CHRM_IME_node_origin=CHRM_IME_node_preceding_convert,CHRM_IME_length=(CHRM_IME_original_text=CHRM_IME_text_preceding_convert).length)),CHRM_IME_node_preceding_convert=null,CHRM_IME_text_preceding_convert=null,CHRM_IME_update_count=0}function CHRM_OnCompositionupdate(e){const n=e.data;console.log("composition update: ",n.length);const t=document.activeElement;console.log("active_element:",t,t.selectionStart,t.selectionEnd);const o=document.getSelection(),i=o.focusNode,d=o.focusOffset;console.log("focus: ",i,d),i.nodeType===Node.TEXT_NODE&&console.log("text: ",i.data);const a=o.anchorNode,l=o.anchorOffset;i===a&&d===l||console.log("anchor: ",a,l),CHRM_IME_update_count++}function CHRM_OnCompositionend(e){const n=e.data;console.log("compositionend: ",n.length);const t=()=>{CHRM_IME_br_origin=null,CHRM_IME_node_origin=null,CHRM_IME_offset=0,CHRM_IME_length=0,CHRM_IME_original_text=null,CHRM_IME_in_action=!1},o=document.getSelection();if(0===o.rangeCount)return console.log("IME input is cancel: case 4 (by focus blur)"),void t();const i=document.getSelection().focusNode,d=document.getSelection().focusOffset;{console.log("focus: ",i,d),i.nodeType===Node.TEXT_NODE&&console.log("text: ",i.data);const e=document.getSelection().anchorNode,n=document.getSelection().anchorOffset;i===e&&d===n||console.log("anchor: ",e,n)}if(null===CHRM_IME_node_origin)return console.log("IME input is cancel: case 6 (CHRM_IME_node_origin is null)"),void t();if(CHRM_IME_original_text){if(i.nodeType!==Node.TEXT_NODE||i!==CHRM_IME_parent.childNodes.item(CHRM_IME_offset_in_parent)){if(console.log("all text restarted by Henkan key is deteled."),console.log("node:",CHRM_IME_node_origin),CHRM_IME_node_origin.data=CHRM_IME_original_text,undo_man.Begin(CHRM_IME_node_origin,CHRM_IME_node_origin.length),undo_man.Register(UR_TYPE.REMOVE_NODE,CHRM_IME_node_origin,CHRM_IME_parent,CHRM_IME_offset_in_parent,1),0===CHRM_IME_offset_in_parent&&(CHRM_IME_parent.hasChildNodes()?"BR"===CHRM_IME_parent.firstChild.nodeName?(undo_man.Register(UR_TYPE.ADD_NODE,CHRM_IME_parent.firstChild,CHRM_IME_parent,CHRM_IME_offset_in_parent,1),console.log("br was automatically added by IME, here we only register")):"LI"===CHRM_IME_parent.nodeName&&("OL"!==CHRM_IME_parent.firstChild.nodeName&&"UL"!==CHRM_IME_parent.firstChild.nodeName||(AddNode("BR",CHRM_IME_parent,CHRM_IME_parent.firstChild),console.log("add BR before child OL/UL in LI tag"))):(AddNode("BR",CHRM_IME_parent,CHRM_IME_parent.firstChild),console.log("add BR in P/H1/LI tag"))),"P"===CHRM_IME_parent.nodeName&&IsSpanMathImg(CHRM_IME_parent.firstChild)){const e=EnableMathEdit(ConvertPtoFigure(CHRM_IME_parent).firstChild,2);return document.getSelection().collapse(e.node,e.foffset),undo_man.End(e.node,e.foffset),void t()}return undo_man.End(i,d),void t()}if(i!==CHRM_IME_node_origin)return console.log("IME input node is changed by browser engine"),undo_man.Begin(CHRM_IME_node_origin,CHRM_IME_node_origin.length),CHRM_IME_node_origin.data=CHRM_IME_original_text,undo_man.Register(UR_TYPE.REMOVE_NODE,CHRM_IME_node_origin,CHRM_IME_parent,CHRM_IME_offset_in_parent,1),undo_man.Register(UR_TYPE.ADD_NODE,i,CHRM_IME_parent,CHRM_IME_offset_in_parent,1),undo_man.End(i,d),void t();if(i.data===CHRM_IME_original_text)return console.log("IME input is cancel: case 2 (updated but not changed)"),void t();{const n=i.length-CHRM_IME_length;if(n===e.data.length){const e=CHRM_IME_node_origin.data.slice(CHRM_IME_offset,CHRM_IME_offset+n);if(console.log("IME input text",e),IsTextNodeInMath(CHRM_IME_node_origin))if(0===CHRM_IME_offset||CHRM_IME_offset===CHRM_IME_length)CHRM_IME_node_origin.deleteData(CHRM_IME_offset,n),SwitchInputChar(e,CHRM_IME_node_origin,CHRM_IME_offset);else{const o=GetEditMargin(CHRM_IME_node_origin.parentNode.parentNode);if(CHRM_IME_offset<o||CHRM_IME_node_origin.length-o<CHRM_IME_offset+n)return CHRM_IME_node_origin.deleteData(CHRM_IME_offset,n),console.log("IME input is cancel: case 5 (within the begin/end mark for math like node)"),void t();console.log("regarded, insert into math like text"),undo_man.Begin(CHRM_IME_node_origin,CHRM_IME_offset),undo_man.Register(UR_TYPE.INSERT_TEXT_INTO_TEXT,e,CHRM_IME_node_origin,CHRM_IME_offset,n),undo_man.End(CHRM_IME_node_origin,CHRM_IME_offset+n)}else console.log("regarded, insert into plain text"),undo_man.Begin(CHRM_IME_node_origin,CHRM_IME_offset),undo_man.Register(UR_TYPE.INSERT_TEXT_INTO_TEXT,e,CHRM_IME_node_origin,CHRM_IME_offset,n),undo_man.End(CHRM_IME_node_origin,CHRM_IME_offset+n)}else console.log("regarded, replace all text data in the node"),undo_man.Begin(CHRM_IME_node_origin,CHRM_IME_offset),undo_man.Register(UR_TYPE.DELETE_IN_TEXT,CHRM_IME_original_text,CHRM_IME_node_origin,0,CHRM_IME_original_text.length),undo_man.Register(UR_TYPE.INSERT_TEXT_INTO_TEXT,CHRM_IME_node_origin.data,CHRM_IME_node_origin,0,CHRM_IME_node_origin.length),undo_man.End(i,d)}}else if(i.nodeType!==Node.TEXT_NODE){if(console.log("IME input is cancel (case 1): new node is added and but removed."),CHRM_IME_br_origin){const e=CHRM_IME_parent.childNodes.item(CHRM_IME_offset_in_parent);null!==e&&e!==CHRM_IME_br_origin&&(CHRM_IME_parent.insertBefore(CHRM_IME_br_origin,e),CHRM_IME_parent.removeChild(e),o.collapse(CHRM_IME_parent,CHRM_IME_offset_in_parent),console.log("br is revived."))}}else{const e=i.length,n=i.data;console.log("IME input text",n),console.log("regarded, add text"),undo_man.Begin(CHRM_IME_parent,CHRM_IME_offset_in_parent),CHRM_IME_br_origin&&CHRM_IME_br_origin.parentNode!==CHRM_IME_parent&&undo_man.Register(UR_TYPE.REMOVE_NODE,CHRM_IME_br_origin,CHRM_IME_parent,CHRM_IME_offset_in_parent,1),undo_man.Register(UR_TYPE.ADD_TEXT_NODE,i,i.parentNode,GetIndex(i.parentNode,i),e),CHRM_IME_br_origin&&i.nextSibling===CHRM_IME_br_origin&&RemoveNode(CHRM_IME_br_origin),undo_man.End(i,e)}t()}function CHRM_OnKeydownForIME(e){if(CHRM_IME_in_action)switch(e.key){case"ArrowLeft":case"ArrowRight":case"ArrowUp":case"ArrowDown":case"PageUp":case"PageDown":case"Home":case"End":e.preventDefault(),e.stopImmediatePropagation()}else if("Process"===e.key&&"Convert"===e.code){console.log("catch Convert key before compositionstart: ",e.key,e.code);const n=document.getSelection().focusNode;n.nodeType===Node.TEXT_NODE&&(console.log("Text before composition: ",n.data),CHRM_IME_node_preceding_convert=n,CHRM_IME_text_preceding_convert=n.data)}}function CHRM_OnBeforeinputForIME(e){console.log("beforeinput: ",e.data)}function CHRM_OnContextmenuForIME(e){CHRM_IME_in_action&&(console.log("contextmenu: "),e.preventDefault(),e.stopImmediatePropagation())}let EDGE_IME_node=null,EDGE_IME_node_origin=null,EDGE_IME_offset=0,EDGE_IME_length=0,EDGE_IME_original_text=null,EDGE_IME_br_origin=null,EDGE_IME_parent=null,EDGE_IME_offset_in_parent=0,EDGE_IME_not_by_Henkan=!1,EDGE_IME_update_count=0,EDGE_IME_in_action=!1,EDGE_IME_is_connected_undo=!1;function EDGE_OnCompositionstart(e){EDGE_IME_in_action=!0,console.log("compositionstart: ",e.data);const n=document.getSelection();if(0===n.rangeCount)return e.currentTarget.blur(),!1;const t=n.getRangeAt(0);let o=t.startContainer,i=t.startOffset,d=t.endContainer,a=t.endOffset;if(EDGE_IME_is_connected_undo=!1,console.log("focus: ",o,i),o===d&&i===a||console.log("anchor: ",d,a),n.isCollapsed){if(EDGE_IME_node=null,EDGE_IME_offset=0,EDGE_IME_length=0,EDGE_IME_original_text=null,"BR"===o.nodeName)EDGE_IME_br_origin=o,EDGE_IME_parent=o.parentNode,EDGE_IME_offset_in_parent=GetIndex(o.parentNode,o),console.log("keep original BR node");else if(o.hasChildNodes()){const e=o.childNodes.item(i);"BR"===e.nodeName?(EDGE_IME_br_origin=e,EDGE_IME_parent=o,EDGE_IME_offset_in_parent=i,console.log("keep original BR node")):e.nodeType===Node.TEXT_NODE&&(console.log("WARNING: focus is at parent of text"),o=e,i=0)}if(o.nodeType===Node.TEXT_NODE){console.log("IME is input on text:",o.data);let e=o.nextSibling;for(;e&&e.nodeType===Node.TEXT_NODE;)e=e.nextSibling;const n=e;if(o.nextSibling!==n){for(undo_man.Begin(o,i);o.nextSibling!==n;)CombineTextNode(o);undo_man.End(o,i),EDGE_IME_is_connected_undo=!0,console.log("combine_text: ",o.data)}EDGE_IME_node=o,EDGE_IME_offset=i,EDGE_IME_original_text=o.data,EDGE_IME_length=EDGE_IME_original_text.length,EDGE_IME_parent=o.parentNode,EDGE_IME_offset_in_parent=GetIndex(o.parentNode,o)}}else{let t=!1;if(EDGE_IME_node=null,EDGE_IME_offset=0,EDGE_IME_original_text=null,d.nodeType===Node.TEXT_NODE)if(o===d)EDGE_IME_node=o,EDGE_IME_offset=i,EDGE_IME_original_text=o.data,EDGE_IME_length=EDGE_IME_original_text.length,EDGE_IME_parent=o.parentNode,EDGE_IME_offset_in_parent=GetIndex(o.parentNode,o),t=!0;else if(o.nodeType===Node.TEXT_NODE){let e=!0,l=o.nextSibling;for(;l!==d;){if(null===l){e=!1;break}if(l.nodeType!==Node.TEXT_NODE){e=!1;break}l=l.nextSibling}if(e){undo_man.Begin(o,i,d,a);for(;o.nextSibling!==d;)CombineTextNode(o);a=o.length+a,CombineTextNode(o),n.setBaseAndExtent(o,i,o,a),undo_man.End(o,i,o,a),EDGE_IME_node=o,EDGE_IME_offset=i,EDGE_IME_original_text=o.data,EDGE_IME_length=EDGE_IME_original_text.length,EDGE_IME_parent=o.parentNode,EDGE_IME_offset_in_parent=GetIndex(o.parentNode,o),t=!0,EDGE_IME_is_connected_undo=!0,console.log("combine_text: ",EDGE_IME_original_text)}}t||(e.currentTarget.blur(),n.removeAllRanges(),e.stopImmediatePropagation())}EDGE_IME_node_origin=EDGE_IME_node,EDGE_IME_update_count=0,EDGE_IME_not_by_Henkan=!1}function EDGE_OnCompositionupdate(e){const n=e.data;console.log("composition update: ",n.length);const t=document.getSelection(),o=t.focusNode,i=t.focusOffset;console.log("focus: ",o,i),o.nodeType===Node.TEXT_NODE&&console.log("text: ",o.data);const d=t.anchorNode,a=t.anchorOffset;o===d&&i===a||console.log("anchor: ",d,a),0===EDGE_IME_update_count&&o.nodeType===Node.TEXT_NODE&&(1===e.data.length&&o.length-EDGE_IME_length==1&&(EDGE_IME_not_by_Henkan=!0),EDGE_IME_not_by_Henkan?console.log("IME by simple input"):console.log("IME by Henkan key")),EDGE_IME_update_count++,EDGE_IME_node!==o&&(console.log("node is changed: "),o.nodeType===Node.TEXT_NODE?EDGE_IME_node=o:console.log("node become to be not text"))}function EDGE_OnCompositionend(e){const n=e.data;console.log("compositionend: ",n.length);const t=()=>{EDGE_IME_br_origin=null,EDGE_IME_node=null,EDGE_IME_node_origin=null,EDGE_IME_offset=0,EDGE_IME_length=0,EDGE_IME_original_text=null,EDGE_IME_in_action=!1,EDGE_IME_not_by_Henkan=!1},o=document.getSelection();if(0===o.rangeCount)return console.log("IME input is cancel: case 4 (by focus blur)"),void t();const i=document.getSelection().focusNode,d=document.getSelection().focusOffset;{console.log("focus: ",i,d),i.nodeType===Node.TEXT_NODE&&console.log("text: ",i.data);const e=document.getSelection().anchorNode,n=document.getSelection().anchorOffset;i===e&&d===n||console.log("anchor: ",e,n)}if(null===EDGE_IME_node)return console.log("IME input is cancel: case 6 (EDGE_IME_node is null)"),void t();if(EDGE_IME_original_text){if(EDGE_IME_node.nodeType!==Node.TEXT_NODE)return alert("ERROR: unexpected case in IME input"),void t();if(null===EDGE_IME_node.parentNode){if(EDGE_IME_not_by_Henkan)return alert("ERROR: input node type is not TEXT"),void t();console.log("all text restarted by Henkan key is deteled."),console.log("node:",EDGE_IME_node_origin),EDGE_IME_node_origin.data=EDGE_IME_original_text,undo_man.Begin(EDGE_IME_node_origin,EDGE_IME_node_origin.length),undo_man.Register(UR_TYPE.REMOVE_NODE,EDGE_IME_node_origin,EDGE_IME_parent,EDGE_IME_offset_in_parent,1);if(0===EDGE_IME_offset_in_parent&&(EDGE_IME_parent.hasChildNodes()?"BR"===EDGE_IME_parent.firstChild.nodeName?console.log("br was automatically added by IME, here we only register"):"LI"===EDGE_IME_parent.nodeName&&("OL"!==EDGE_IME_parent.firstChild.nodeName&&"UL"!==EDGE_IME_parent.firstChild.nodeName||(AddNode("BR",EDGE_IME_parent,EDGE_IME_parent.firstChild),console.log("add BR before child OL/UL in LI tag"))):(AddNode("BR",EDGE_IME_parent,EDGE_IME_parent.firstChild),console.log("add BR in P/H1/LI tag"))),"P"===EDGE_IME_parent.nodeName&&IsSpanMathImg(EDGE_IME_parent.firstChild)){const e=EnableMathEdit(ConvertPtoFigure(EDGE_IME_parent).firstChild,2);return document.getSelection().collapse(e.node,e.foffset),undo_man.End(e.node,e.foffset),void t()}return undo_man.End(i,d),void t()}if(EDGE_IME_node_origin!==EDGE_IME_node)return console.log("IME input node is changed by browser engine"),undo_man.Begin(EDGE_IME_node_origin,EDGE_IME_offset),EDGE_IME_node_origin.data=EDGE_IME_original_text,undo_man.Register(UR_TYPE.REMOVE_NODE,EDGE_IME_node_origin,EDGE_IME_parent,EDGE_IME_offset_in_parent,1),undo_man.Register(UR_TYPE.ADD_TEXT_NODE,EDGE_IME_node,EDGE_IME_node.parentNode,GetIndex(EDGE_IME_node.parentNode,EDGE_IME_node),1),undo_man.End(i,d),void t();if(EDGE_IME_node.data===EDGE_IME_original_text)return console.log("IME input is cancel: case 2 (updated but not changed)"),void t();if(EDGE_IME_not_by_Henkan){const e=EDGE_IME_node.length-EDGE_IME_length,n=EDGE_IME_node.data.slice(EDGE_IME_offset,EDGE_IME_offset+e);if(console.log("IME input text",n),IsTextNodeInMath(EDGE_IME_node))if(0===EDGE_IME_offset||EDGE_IME_offset===EDGE_IME_length)EDGE_IME_node.deleteData(EDGE_IME_offset,e),SwitchInputChar(n,EDGE_IME_node,EDGE_IME_offset);else{const o=GetEditMargin(EDGE_IME_node.parentNode.parentNode);if(EDGE_IME_offset<o||EDGE_IME_node.length-o<EDGE_IME_offset+e)return EDGE_IME_node.deleteData(EDGE_IME_offset,e),console.log("IME input is cancel: case 5 (within the begin/end mark for math like node)"),void t();console.log("regarded, insert into math like text"),EDGE_IME_node_origin!==EDGE_IME_node&&alert("ERROR: unexpected node replace"),undo_man.Begin(EDGE_IME_node,EDGE_IME_offset),undo_man.Register(UR_TYPE.INSERT_TEXT_INTO_TEXT,n,EDGE_IME_node,EDGE_IME_offset,e),undo_man.End(EDGE_IME_node,EDGE_IME_offset+e)}else console.log("regarded, insert into plain text"),EDGE_IME_node_origin!==EDGE_IME_node&&alert("ERROR: unexpected node replace"),console.log("Undo history: "+undo_man.numHistory),undo_man.Begin(EDGE_IME_node,EDGE_IME_offset),undo_man.Register(UR_TYPE.INSERT_TEXT_INTO_TEXT,n,EDGE_IME_node,EDGE_IME_offset,e),undo_man.End(EDGE_IME_node,EDGE_IME_offset+e),console.log("Undo history: "+undo_man.numHistory)}else console.log("regarded, replace all text data in the node"),undo_man.Begin(EDGE_IME_node_origin,EDGE_IME_offset),undo_man.Register(UR_TYPE.DELETE_IN_TEXT,EDGE_IME_original_text,EDGE_IME_node,0,EDGE_IME_original_text.length),undo_man.Register(UR_TYPE.INSERT_TEXT_INTO_TEXT,EDGE_IME_node.data,EDGE_IME_node,0,EDGE_IME_node.length),undo_man.End(i,d)}else if(null===EDGE_IME_node.parentNode){if(console.log("IME input is cancel (case 1): new node is added and but removed."),EDGE_IME_br_origin){const e=EDGE_IME_parent.childNodes.item(EDGE_IME_offset_in_parent);null!==e&&e!==EDGE_IME_br_origin&&(EDGE_IME_parent.insertBefore(EDGE_IME_br_origin,e),EDGE_IME_parent.removeChild(e),o.collapse(EDGE_IME_parent,EDGE_IME_offset_in_parent),console.log("br is revived."))}}else{const e=EDGE_IME_node.length,n=EDGE_IME_node.data;console.log("IME input text",n),console.log("regarded, add text"),undo_man.Begin(EDGE_IME_parent,EDGE_IME_offset_in_parent),EDGE_IME_br_origin&&EDGE_IME_br_origin.parentNode!==EDGE_IME_parent&&undo_man.Register(UR_TYPE.REMOVE_NODE,EDGE_IME_br_origin,EDGE_IME_parent,EDGE_IME_offset_in_parent,1),undo_man.Register(UR_TYPE.ADD_TEXT_NODE,EDGE_IME_node,EDGE_IME_node.parentNode,GetIndex(EDGE_IME_node.parentNode,EDGE_IME_node),e),EDGE_IME_br_origin&&EDGE_IME_node.nextSibling===EDGE_IME_br_origin&&RemoveNode(EDGE_IME_br_origin),undo_man.End(EDGE_IME_node,e)}t()}function EDGE_OnKeydownForIME(e){if(EDGE_IME_in_action)switch(e.key){case"ArrowLeft":case"ArrowRight":case"ArrowUp":case"ArrowDown":case"PageUp":case"PageDown":case"Home":case"End":e.preventDefault(),e.stopImmediatePropagation()}}function EDGE_OnContextmenuForIME(e){EDGE_IME_in_action&&(console.log("contextmenu: "),e.preventDefault(),e.stopImmediatePropagation())}let FF_IME_node_origin=null,FF_IME_offset=0,FF_IME_length=0,FF_IME_original_text=null,FF_IME_br_origin=null,FF_IME_parent=null,FF_IME_offset_in_parent=0,FF_IME_update_count=0,FF_IME_in_action=!1,FF_IME_text_preceding_convert=null,FF_IME_node_preceding_convert=null,FF_IME_is_connected_undo=!1;function RefineFocusToText(e,n){const t=e.childNodes.item(n);if(t)t.nodeType===Node.TEXT_NODE&&(e=t,n=0);else{const t=e.childNodes.item(n-1);t&&t.nodeType===Node.TEXT_NODE&&(n=(e=t).length)}return[e,n]}function FF_OnCompositionstart(e){FF_IME_in_action=!0,console.log("compositionstart: ",e.data);const n=document.getSelection();if(0===n.rangeCount)return e.currentTarget.blur(),!1;const t=n.getRangeAt(0);let o=t.startContainer,i=t.startOffset,d=t.endContainer,a=t.endOffset;if(o.nodeType!==Node.TEXT_NODE&&([o,i]=RefineFocusToText(o,i)),d.nodeType!==Node.TEXT_NODE&&([d,a]=RefineFocusToText(d,a)),FF_IME_is_connected_undo=!1,console.log("focus: ",o,i),o===d&&i===a||console.log("anchor: ",d,a),n.isCollapsed){if(FF_IME_node_origin=o,FF_IME_offset=i,FF_IME_length=0,FF_IME_original_text=null,"BR"===o.nodeName)FF_IME_br_origin=o,FF_IME_parent=o.parentNode,FF_IME_offset_in_parent=GetIndex(o.parentNode,o),console.log("keep original BR node");else if(o.hasChildNodes()){const e=o.childNodes.item(i);"BR"===e.nodeName?(FF_IME_br_origin=e,FF_IME_parent=o,FF_IME_offset_in_parent=i,console.log("keep original BR node")):e.nodeType===Node.TEXT_NODE&&(console.log("WARNING: focus is at parent of text"),o=e,i=0)}if(o.nodeType===Node.TEXT_NODE){console.log("IME is input on text:",o.data);let e=o.nextSibling;for(;e&&e.nodeType===Node.TEXT_NODE;)e=e.nextSibling;const n=e;if(o.nextSibling!==n){for(undo_man.Begin(o,i);o.nextSibling!==n;)CombineTextNode(o);undo_man.End(o,i),FF_IME_is_connected_undo=!0,console.log("combine_text: ",o.data)}FF_IME_node_origin=o,FF_IME_offset=i,FF_IME_original_text=o.data,FF_IME_length=FF_IME_original_text.length,FF_IME_parent=o.parentNode,FF_IME_offset_in_parent=GetIndex(o.parentNode,o)}}else{let t=!1;if(FF_IME_node_origin=o,FF_IME_offset=i,FF_IME_original_text=null,d.nodeType===Node.TEXT_NODE)if(o===d)FF_IME_node_origin=o,FF_IME_offset=i,FF_IME_original_text=o.data,FF_IME_length=FF_IME_original_text.length,FF_IME_parent=o.parentNode,FF_IME_offset_in_parent=GetIndex(o.parentNode,o),t=!0;else if(o.nodeType===Node.TEXT_NODE){let e=!0,l=o.nextSibling;for(;l!==d;){if(null===l){e=!1;break}if(l.nodeType!==Node.TEXT_NODE){e=!1;break}l=l.nextSibling}if(e){undo_man.Begin(o,i,d,a);for(;o.nextSibling!==d;)CombineTextNode(o);a=o.length+a,CombineTextNode(o),n.setBaseAndExtent(o,i,o,a),undo_man.End(o,i,o,a),FF_IME_node_origin=o,FF_IME_offset=i,FF_IME_original_text=o.data,FF_IME_length=FF_IME_original_text.length,FF_IME_parent=o.parentNode,FF_IME_offset_in_parent=GetIndex(o.parentNode,o),t=!0,FF_IME_is_connected_undo=!0,console.log("combine_text: ",FF_IME_original_text)}}if(!0&&!t){const[e,d]=CorrectFocusToText(o,i);n.collapse(e,d),FF_IME_node_origin=e,FF_IME_offset=d,FF_IME_original_text=e.data,FF_IME_length=FF_IME_original_text.length,FF_IME_parent=e.parentNode,FF_IME_offset_in_parent=GetIndex(e.parentNode,e),t=!0}t||(console.log("Cancel IME"),e.preventDefault(),e.currentTarget.blur(),n.removeAllRanges())}console.log("FF_IME_original_text: ",FF_IME_original_text),FF_IME_node_preceding_convert&&(FF_IME_node_origin===FF_IME_node_preceding_convert&&FF_IME_node_origin.data===FF_IME_text_preceding_convert.data||(console.log("WARNING by Chrome bug: FF_IME_text_before  : ",FF_IME_text_preceding_convert),FF_IME_node_origin=FF_IME_node_preceding_convert,FF_IME_length=(FF_IME_original_text=FF_IME_text_preceding_convert).length)),FF_IME_node_preceding_convert=null,FF_IME_text_preceding_convert=null,FF_IME_update_count=0}function FF_OnCompositionupdate(e){const n=e.data;console.log("composition update: ",n.length);const t=document.activeElement;console.log("active_element:",t,t.selectionStart,t.selectionEnd);const o=document.getSelection(),i=o.focusNode,d=o.focusOffset;console.log("focus: ",i,d),i.nodeType===Node.TEXT_NODE&&console.log("text: ",i.data);const a=o.anchorNode,l=o.anchorOffset;i===a&&d===l||console.log("anchor: ",a,l),FF_IME_update_count++}function FF_OnCompositionend(e){const n=e.data;console.log("compositionend: ",n.length);const t=()=>{FF_IME_br_origin=null,FF_IME_node_origin=null,FF_IME_offset=0,FF_IME_length=0,FF_IME_original_text=null,FF_IME_in_action=!1},o=document.getSelection();if(0===o.rangeCount)return console.log("IME input is cancel: case 4 (by focus blur)"),void t();let i=document.getSelection().focusNode,d=document.getSelection().focusOffset;i.nodeType!==Node.TEXT_NODE&&([i,d]=RefineFocusToText(i,d));{console.log("focus: ",i,d),i.nodeType===Node.TEXT_NODE&&console.log("text: ",i.data);const e=document.getSelection().anchorNode,n=document.getSelection().anchorOffset;i===e&&d===n||console.log("anchor: ",e,n)}if(null===FF_IME_node_origin)return console.log("IME input is cancel: case 6 (FF_IME_node_origin is null)"),void t();if(FF_IME_original_text){if(i.nodeType!==Node.TEXT_NODE||i!==FF_IME_parent.childNodes.item(FF_IME_offset_in_parent)){if(console.log("all text restarted by Henkan key is deteled."),console.log("node:",FF_IME_node_origin),FF_IME_node_origin.data=FF_IME_original_text,undo_man.Begin(FF_IME_node_origin,FF_IME_node_origin.length),undo_man.Register(UR_TYPE.REMOVE_NODE,FF_IME_node_origin,FF_IME_parent,FF_IME_offset_in_parent,1),0===FF_IME_offset_in_parent&&(FF_IME_parent.hasChildNodes()?"BR"===FF_IME_parent.firstChild.nodeName?(undo_man.Register(UR_TYPE.ADD_NODE,FF_IME_parent.firstChild,FF_IME_parent,FF_IME_offset_in_parent,1),console.log("br was automatically added by IME, here we only register")):"LI"===FF_IME_parent.nodeName&&("OL"!==FF_IME_parent.firstChild.nodeName&&"UL"!==FF_IME_parent.firstChild.nodeName||(AddNode("BR",FF_IME_parent,FF_IME_parent.firstChild),console.log("add BR before child OL/UL in LI tag"))):(AddNode("BR",FF_IME_parent,FF_IME_parent.firstChild),console.log("add BR in P/H1/LI tag"))),"P"===FF_IME_parent.nodeName&&IsSpanMathImg(FF_IME_parent.firstChild)){const e=EnableMathEdit(ConvertPtoFigure(FF_IME_parent).firstChild,2);return document.getSelection().collapse(e.node,e.foffset),undo_man.End(e.node,e.foffset),void t()}return undo_man.End(i,d),void t()}if(i!==FF_IME_node_origin)return console.log("IME input node is changed by browser engine"),undo_man.Begin(FF_IME_node_origin,FF_IME_node_origin.length),FF_IME_node_origin.data=FF_IME_original_text,undo_man.Register(UR_TYPE.REMOVE_NODE,FF_IME_node_origin,FF_IME_parent,FF_IME_offset_in_parent,1),undo_man.Register(UR_TYPE.ADD_NODE,i,FF_IME_parent,FF_IME_offset_in_parent,1),undo_man.End(i,d),void t();if(i.data===FF_IME_original_text)return console.log("IME input is cancel: case 2 (updated but not changed)"),void t();{const n=i.length-FF_IME_length;if(n===e.data.length){const e=FF_IME_node_origin.data.slice(FF_IME_offset,FF_IME_offset+n);if(console.log("IME input text",e),IsTextNodeInMath(FF_IME_node_origin))if(0===FF_IME_offset||FF_IME_offset===FF_IME_length)FF_IME_node_origin.deleteData(FF_IME_offset,n),SwitchInputChar(e,FF_IME_node_origin,FF_IME_offset);else{const o=GetEditMargin(FF_IME_node_origin.parentNode.parentNode);if(FF_IME_offset<o||FF_IME_node_origin.length-o<FF_IME_offset+n)return FF_IME_node_origin.deleteData(FF_IME_offset,n),console.log("IME input is cancel: case 5 (within the begin/end mark for math like node)"),void t();console.log("regarded, insert into math like text"),undo_man.Begin(FF_IME_node_origin,FF_IME_offset),undo_man.Register(UR_TYPE.INSERT_TEXT_INTO_TEXT,e,FF_IME_node_origin,FF_IME_offset,n),undo_man.End(FF_IME_node_origin,FF_IME_offset+n)}else console.log("regarded, insert into plain text"),undo_man.Begin(FF_IME_node_origin,FF_IME_offset),undo_man.Register(UR_TYPE.INSERT_TEXT_INTO_TEXT,e,FF_IME_node_origin,FF_IME_offset,n),undo_man.End(FF_IME_node_origin,FF_IME_offset+n)}else console.log("regarded, replace all text data in the node"),undo_man.Begin(FF_IME_node_origin,FF_IME_offset),undo_man.Register(UR_TYPE.DELETE_IN_TEXT,FF_IME_original_text,FF_IME_node_origin,0,FF_IME_original_text.length),undo_man.Register(UR_TYPE.INSERT_TEXT_INTO_TEXT,FF_IME_node_origin.data,FF_IME_node_origin,0,FF_IME_node_origin.length),undo_man.End(i,d)}}else if(i.nodeType!==Node.TEXT_NODE){if(console.log("IME input is cancel (case 1): new node is added and but removed."),FF_IME_br_origin){const e=FF_IME_parent.childNodes.item(FF_IME_offset_in_parent);null!==e&&e!==FF_IME_br_origin&&(FF_IME_parent.insertBefore(FF_IME_br_origin,e),FF_IME_parent.removeChild(e),o.collapse(FF_IME_parent,FF_IME_offset_in_parent),console.log("br is revived."))}}else{const e=i.length,n=i.data;console.log("IME input text",n),console.log("regarded, add text"),undo_man.Begin(FF_IME_parent,FF_IME_offset_in_parent),FF_IME_br_origin&&FF_IME_br_origin.parentNode!==FF_IME_parent&&undo_man.Register(UR_TYPE.REMOVE_NODE,FF_IME_br_origin,FF_IME_parent,FF_IME_offset_in_parent,1),undo_man.Register(UR_TYPE.ADD_TEXT_NODE,i,i.parentNode,GetIndex(i.parentNode,i),e),FF_IME_br_origin&&i.nextSibling===FF_IME_br_origin&&RemoveNode(FF_IME_br_origin),undo_man.End(i,e)}t()}function FF_OnKeydownForIME(e){if(FF_IME_in_action)switch(e.key){case"ArrowLeft":case"ArrowRight":case"ArrowUp":case"ArrowDown":case"PageUp":case"PageDown":case"Home":case"End":e.preventDefault(),e.stopImmediatePropagation()}else if("Process"===e.key&&"Convert"===e.code){console.log("catch Convert key before compositionstart: ",e.key,e.code);const n=document.getSelection().focusNode;n.nodeType===Node.TEXT_NODE&&(console.log("Text before composition: ",n.data),FF_IME_node_preceding_convert=n,FF_IME_text_preceding_convert=n.data)}}function FF_OnContextmenuForIME(e){FF_IME_in_action&&(console.log("contextmenu: "),e.preventDefault(),e.stopImmediatePropagation())}let br_before_composition=null,node_before_composition=null,offset_before_composition=0,length_before_composition=0,is_collapsed_composition=!1;function OnCompositionstart(e){console.log("compositionstart: ",e.data);const n=document.getSelection(),t=n.getRangeAt(0);let o=t.startContainer,i=t.startOffset,d=t.endContainer,a=t.endOffset;if(is_collapsed_composition=n.isCollapsed,n.isCollapsed||(console.log("selected range:"),o===d&&o.nodeType===Node.TEXT_NODE&&CutSelection(e.currentTarget,n)),console.log("focus: ",o,i),o===d&&i===a||console.log("anchor: ",d,a),node_before_composition=o,offset_before_composition=i,length_before_composition=0,"BR"===o.nodeName)br_before_composition=o,node_before_composition=o.parentNode,offset_before_composition=GetIndex(o.parentNode,o),o.previousSibling&&o.previousSibling.nodeType===Node.TEXT_NODE&&(length_before_composition=o.previousSibling.length),console.log("keep original BR node");else if(o.hasChildNodes()){const e=o.childNodes.item(i);if(e.nodeType===Node.TEXT_NODE)length_before_composition=e.length;else{"BR"===e.nodeName&&(br_before_composition=e,console.log("keep original BR node"));const n=e.previousSibling;n&&n.nodeType===Node.TEXT_NODE&&(length_before_composition=n.length)}}else o.nodeType===Node.TEXT_NODE&&(length_before_composition=o.length-0,console.log("IME is input on test:",o.data))}function OnCompositionupdate(e){console.log("composition update: ",e.data);const n=document.getSelection().focusNode,t=document.getSelection().focusOffset;console.log("focus: ",n,t),n.nodeType===Node.TEXT_NODE&&console.log("text: ",n.data);const o=document.getSelection().anchorNode,i=document.getSelection().anchorOffset;if(n===o&&t===i||console.log("anchor: ",o,i),!is_collapsed_composition){const e=document.getSelection();console.log("text on test:",e.focusNode.data),is_collapsed_composition=!1}}function OnCompositionend(e){const n=e.data;console.log("compositionend: ",n);const t=document.getSelection(),o=document.getSelection().focusNode,i=document.getSelection().focusOffset;console.log("focus: ",o,i),o.nodeType===Node.TEXT_NODE&&console.log("text: ",o.data);const d=document.getSelection().anchorNode,a=document.getSelection().anchorOffset;if(o===d&&i===a||console.log("anchor: ",d,a),0===n.length){if(br_before_composition){let e=node_before_composition.childNodes.item(offset_before_composition);if("BR"===e.nodeName&&e!==br_before_composition){const n=node_before_composition;n.insertBefore(br_before_composition,e),n.removeChild(e),t.collapse(n,offset_before_composition)}}return br_before_composition=null,void(node_before_composition=null)}if(!t.isCollapsed)return console.log("selection: anchor("+t.anchorNode+", "+t.anchorOffset+") - ("+t.focusNode+", "+t.focusOffset+")"),console.log("ERROR: unexpected state, selection is isCollapsed when compositionend fires."),br_before_composition=null,void(node_before_composition=null);const l=offset_before_composition,s=node_before_composition;if(s.nodeType===Node.TEXT_NODE){if(s.data.slice(l,l+n.length)!==n)return alert("ERROR: IME input is not correctly detected (case 1)."),br_before_composition=null,void(node_before_composition=null);if(IsTextNodeInMath(s))if(0===l||l+n.length===s.length)s.deleteData(l,n.length),SwitchInputChar(n,s,l);else{const e=GetEditMargin(s.parentNode.parentNode);l<e||s.length-e<l+n.length?s.deleteData(l,n.length):(undo_man.Begin(s,l),undo_man.Register(UR_TYPE.INSERT_TEXT_INTO_TEXT,n,s,l,n.length),undo_man.End(s,l))}else undo_man.Begin(s,l),undo_man.Register(UR_TYPE.INSERT_TEXT_INTO_TEXT,n,s,l,n.length),undo_man.End(s,l)}else{const e=l,t=s.childNodes.item(e);if(null===t)return alert("ERROR: IME input is not correctly detected (case 5)."),br_before_composition=null,void(node_before_composition=null);if(t.nodeType===Node.TEXT_NODE){const e=t;if(e.data.slice(0,n.length)!==n)return alert("ERROR: IME input is not correctly detected (case 2)."),br_before_composition=null,void(node_before_composition=null);if(e.length!==n.length)return alert("ERROR: IME input is not correctly detected (case 3)."),br_before_composition=null,void(node_before_composition=null);undo_man.Begin(s,l),br_before_composition&&undo_man.Register(UR_TYPE.REMOVE_NODE,br_before_composition,s,l,1),undo_man.Register(UR_TYPE.ADD_TEXT_NODE,e,s,l,n.length),undo_man.End(e,e.length)}else if(t.previousSibling){if(t.previousSibling.nodeType!==Node.TEXT_NODE)return alert("ERROR: IME input is not correctly detected (case 4)."),br_before_composition=null,void(node_before_composition=null);const e=t.previousSibling;if(e.data===n)undo_man.Begin(s,l),br_before_composition&&undo_man.Register(UR_TYPE.REMOVE_NODE,br_node,s,l,1),undo_man.Register(UR_TYPE.ADD_TEXT_NODE,e,s,l,n.length),undo_man.End(e,e.length);else{if(e.data.slice(e.length-n.length,e.length)!==n)return alert("ERROR: IME input is not correctly detected (case 6)."),br_before_composition=null,void(node_before_composition=null);undo_man.Begin(s,l),br_before_composition&&undo_man.Register(UR_TYPE.REMOVE_NODE,br_before_composition,s,l,1),undo_man.Register(UR_TYPE.INSERT_TEXT_INTO_TEXT,n,e,e.length-n.length,n.length),undo_man.End(e,e.length)}}}br_before_composition=null,node_before_composition=null}let MO_IME_node_origin=null,MO_IME_offset_origin=0,MO_update_list=[],MO_observer=null,MO_in_composition=!1;function MO_InitComposition(e){console.log("MutationObserver Create"),(MO_observer=new MutationObserver(MO_OnCompositionChange)).observe(e,{childList:!0,characterData:!0,characterDataOldValue:!0,subtree:!0})}function MO_OnCompositionChange(e){(MO_in_composition||MO_update_list.length>0)&&e.forEach(e=>{if("characterData"===e.type){let n=!0;if(MO_update_list.length>0){const t=MO_update_list[MO_update_list.length-1];t.record.type==e.type&&t.record.target===e.target&&(n=!1,console.log("MutationObserver detect (not new):",t.type,"\n",t.oldValue,"\nto\n",t.target))}n&&(MO_update_list.push({record:e,offset:GetIndex(e.target.parentNode,e.target)}),console.log("MutationObserver detect:",e.type,"\n",e.oldValue,"\nto\n",e.target))}else if("childList"===e.type)if(e.addedNodes.length>0){const n=GetIndex(e.target,e.addedNodes.item(0));MO_update_list.push({record:e,offset:n}),console.log("MutationObserver detect: add\n",e.addedNodes.item(0),"\non offset=",n,"\n",e.target)}else{const n=GetIndex(e.target,e.nextSibling);MO_update_list.push({record:e,offset:n}),console.log("MutationObserver detect: remove\n",e.removedNodes.item(0),"\non offset=",n,"\n",e.target)}}),!MO_in_composition&&MO_update_list.length>0&&MO_RegisterIMEUpdate()}function MO_OnCompositionstart(e){MO_in_composition=!0,console.log('compositionstart: "',e.data,'"'),MO_update_list.length=0;const n=document.getSelection();if(0===n.rangeCount)return e.currentTarget.blur(),!1;const t=n.getRangeAt(0);let o=t.startContainer,i=t.startOffset,d=t.endContainer,a=t.endOffset;if(o.nodeType!==Node.TEXT_NODE&&([o,i]=RefineFocusToText(o,i)),d.nodeType!==Node.TEXT_NODE&&([d,a]=RefineFocusToText(d,a)),MO_IME_node_origin=o,MO_IME_offset_origin=i,console.log("focus: ",o,i),o===d&&i===a||console.log("anchor: ",d,a),!n.isCollapsed){let t=d!==o;if(d!==o){const[e,d]=CorrectFocusToText(o,i);n.collapse(e,d),console.log("colapse before IME:",e,d),t=!1}t&&(console.log("Cancel IME"),e.preventDefault(),e.currentTarget.blur(),n.removeAllRanges())}}function MO_OnCompositionupdate(e){const n=e.data;console.log("composition update: ",n.length)}function MO_OnCompositionend(e){const n=e.data;console.log("compositionend: ",n.length),MO_in_composition=!1,MO_RegisterIMEUpdate()}function MO_OnCompositionendForChrome(e){const n=e.data;0==n.length?(console.log("compositionend (finished by Delete/Backspace): ",n.length),MO_in_composition=!1):(console.log("compositionend (finished by Enter): ",n.length),MO_in_composition=!1,MO_RegisterIMEUpdate())}function MO_RegisterIMEUpdate(){if(0===MO_update_list.length)return;console.log("MO_RegisterIMEUpdate");let e=[];if(undo_man.Begin(MO_IME_node_origin,MO_IME_offset_origin),MO_update_list.forEach(n=>{const t=n.record;if("characterData"===t.type)console.log("IME: regarded, replace all text data in the node"),undo_man.Register(UR_TYPE.DELETE_IN_TEXT,t.oldValue,t.target,0,t.oldValue.length),undo_man.Register(UR_TYPE.INSERT_TEXT_INTO_TEXT,t.target.data,t.target,0,t.target.length),e.push(t.target);else if("childList"===t.type)if(t.addedNodes.length>0){const e=t.target;let o=n.offset;t.addedNodes.forEach(n=>{console.log("IME: added node",n,", offset=",o),undo_man.Register(UR_TYPE.ADD_NODE,n,e,o,1),++o})}else if(t.removedNodes.length>0){const e=t.target,o=n.offset;t.removedNodes.forEach(n=>{console.log("IME: removed node",n,", offset=",o),undo_man.Register(UR_TYPE.REMOVE_NODE,n,e,o,1)})}}),0===document.getSelection().rangeCount)return console.log("IME input is cancel: case 4 (by focus blur)"),void undo_man.End(null,0);e.forEach(e=>{if(IsTextNodeInMath(e)){let n;switch(e.parentNode.className){case"editmath":n={beginMark:"$",endMark:"$",reservedChars:["$"]};break;case"editmathdisp":n={beginMark:"$$",endMark:"$$",reservedChars:["$"]};break;case"editcode":n={beginMark:"`",endMark:"`",reservedChars:["`"]};break;case"editcodedisp":n={beginMark:"```",endMark:"```",reservedChars:["`"]};break;case"editem1":n={beginMark:"*",endMark:"*",reservedChars:["*","_"]};break;case"editem2":n={beginMark:"**",endMark:"**",reservedChars:["*","_"]};break;case"editem3":n={beginMark:"***",endMark:"***",reservedChars:["*","_"]};break;case"edita":n={beginMark:"[",endMark:")",reservedChars:["[",")"]};break;case"editimg":n={beginMark:"![",endMark:") ",reservedChars:["!","[",")"]};break;case"editcite":n={beginMark:"[^",endMark:"] ",reservedChars:["^","[","]"]};break;case"editref":n={beginMark:"[^",endMark:"]:",reservedChars:["^","[","]",":"]};break;default:return void console.error("ERROR: IME input into invalid edit class in math ")}e.data.startsWith(n.beginMark)&&e.data.endsWith(n.endMark)||(n.reservedChars.forEach(n=>{let t=e.data.indexOf(n);for(;t>=0;)DeleteText(e,t,1),t=e.data.indexOf(n)}),InsertTextIntoText(n.beginMark,e,0),InsertTextIntoText(n.endMark,e,e.length))}else{if(e.data==nt_ZWBR)return;let n=e.data.indexOf(nt_ZWBR);n>=0&&DeleteText(e,n,1)}});let n=document.getSelection().focusNode,t=document.getSelection().focusOffset;n.nodeType!==Node.TEXT_NODE&&([n,t]=RefineFocusToText(n,t)),undo_man.End(n,t),MO_update_list.length=0,e.length=0}function MO_OnKeydownForIME(e){if(MO_in_composition)switch(e.key){case"ArrowLeft":case"ArrowRight":case"ArrowUp":case"ArrowDown":case"PageUp":case"PageDown":case"Home":case"End":e.preventDefault(),e.stopImmediatePropagation()}}function MO_OnContextmenuForIME(e){MO_in_composition&&(console.log("contextmenu: "),e.preventDefault(),e.stopImmediatePropagation())}function OnCut(e){console.log("fook cut on "+e.currentTarget),e.preventDefault();let n=CutSelection(e.currentTarget,document.getSelection());if(null!==n&&e.clipboardData){let t=DOM2MD(n);e.clipboardData.setData("text/plain",t);let o=document.createElement("DIV");o.appendChild(n),console.log("copy to clipboard as html: "+o.innerHTML),console.log("copy to clipboard as markdown: "+t)}}function OnCopy(e){if(console.log("fook copy on "+e.currentTarget),e.preventDefault(),e.clipboardData){undo_man.GetChangeEventDispatcher().Disable();const n=CutSelection(e.currentTarget,document.getSelection());if(n&&ExecUndo(),undo_man.Shrink(),undo_man.GetChangeEventDispatcher().Enable(),null===n)return;const t=DOM2MD(n);e.clipboardData.setData("text/plain",t),document.createElement("DIV").appendChild(n)}}function OnPaste(e){console.log("fook paste on "+e.currentTarget),e.preventDefault();const n=e.clipboardData;if(n){let t=n.getData("text/plain");console.log(t);const o=document.getSelection();o.isCollapsed||CutSelection(e.currentTarget,o);const[i,d]=CorrectFocusToText(o.focusNode,o.focusOffset);if(IsTextNodeInMath(i)&&0<d&&d<i.length)return undo_man.Begin(i,d),InsertTextIntoText(t,i,d),void undo_man.End(i,d+t.length);const a=MD2DOM(t);InitializeMathInFragment(a,g_auto_numbering?1:0),PasteTopLevelNodes(i,d,a,e.currentTarget)}}function CutSelection(e,n){if(n.isCollapsed)return null;if(0===n.rangeCount)return null;const t=n.getRangeAt(0),o=t.startContainer,i=t.startOffset;let d,a,l,s,r=t.endContainer,c=t.endOffset;if(undo_man.Begin(n.focusNode,n.focusOffset,n.anchorNode,n.anchorOffset),o&&o===r&&o.nodeType===Node.TEXT_NODE){if(0===i&&c===o.length){const e=o.parentNode,n=o.nextSibling,t=new DocumentFragment;t.appendChild(RemoveNode(o));const i=SafeJunctionPoint(e,n);return undo_man.End(i.node,i.offset),document.getSelection().collapse(i.node,i.offset),t.cloneNode(!0)}{console.log("start_node",o);const e=DeleteText(o,i,c-i);document.getSelection().collapse(o,i),undo_man.End(o,i);const n=new DocumentFragment;return n.appendChild(document.createTextNode(e)),n.cloneNode(!0)}}r.nodeType===Node.TEXT_NODE?(d=r.parentNode,0===c?a=r:c===r.length?a=r.nextSibling:(DivideTextNode(r,c),a=r.nextSibling)):(d=r,a=r.childNodes.item(c)),o.nodeType===Node.TEXT_NODE?(l=o.parentNode,0===i?s=o:i===o.length?s=o.nextSibling:(DivideTextNode(o,i),s=o.nextSibling)):(l=o,s=o.childNodes.item(i));const f=MakeCrossSection(e,l),_=MakeCrossSection(e,d);let u=f.length-1,E=_.length-1,g=e;for(;u>=0&&E>=0;){let e=f[u];if(e!==_[E])break;g=e,u--,E--}"OL"!==g.tagName&&"UL"!==g.tagName||(g=g.parentNode),console.log("common_parent: "+g);const m=DivideAtCrossSection2(a,d,g),N=DivideAtCrossSection2(s,l,g);N.nodeType===Node.TEXT_NODE?console.log("cut_node: "+N.data):console.log("cut_node: "+N+" to "+m);let h,p=RemoveNodeList(g,N,m),C=(h=m?ConnectionNodeRecursive(m):SafeJunctionPoint(g,m)).node,T=h.offset;null===C&&(C=g,T=GetIndex(g,m)),RecoveryEmptyElement(g),RecoveryPandFigure(g),"DIV"!==C.nodeName&&"OL"!==C.nodeName&&"UL"!==C.nodeName||(C=C.firstChild,T=0),[C,T]=CorrectFocusToText(C,T),console.log("new focus: "+C+", "+T),undo_man.End(C,T),n.collapse(C,T);const I=p.cloneNode(!0);return console.log("clone: "+I),I}function MakeCrossSection(e,n){let t=[],o=n;for(;o!==e;)t.push(o),o=o.parentNode;return t.push(o),t}function DivideAtCrossSection2(e,n,t){let o=e,i=n;for(;i&&i!==t;){const e=o;if(e===i.firstChild){AddNode("BR",AddNode(i.tagName,i.parentNode,i),null),o=i}else if(null===e){AddNode("BR",AddNode(i.tagName,i.parentNode,i.nextSibling),null),o=i.nextSibling}else{if(["P","H1","H2","H3","H4","H5","H6","LI","FIGURE","FIGCAPTION","TD","TH"].includes(i.tagName)){const n=SafeRemoveNodeList(i,e,null),t=AddNode(i.tagName,i.parentNode,i.nextSibling);SafePushNodeList(t,n),o=t}else{const n=RemoveNodeList(i,e,null),t=AddNode(i.tagName,i.parentNode,i.nextSibling);AddNodeList(t,null,n),o=t}}i=i.parentNode}return o}function RecoveryEmptyElement(e){switch(e.tagName){case"P":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"TH":case"TD":case"FIGCAPTION":null===e.firstChild&&AddNode("BR",e,null);break;case"LI":if(null===e.firstChild)AddNode("BR",e,null);else{let n=e.firstChild;"OL"!==n.nodeName&&"UL"!==n.nodeName||AddNode("BR",e,n);for(let n=e.firstChild;null!==n;n=n.nextSibling)RecoveryEmptyElement(n)}break;case"OL":case"UL":if(null===e.firstChild)AddNode("LI",e,null),AddNode("BR",e.firstChild,null);else for(let n=e.firstChild;null!==n;n=n.nextSibling)RecoveryEmptyElement(n);break;case"DIV":if(null===e.firstChild)AddNode("P",e,null),AddNode("BR",e.firstChild,null);else for(let n=e.firstChild;null!==n;n=n.nextSibling)RecoveryEmptyElement(n);break;default:for(let n=e.firstChild;null!==n;n=n.nextSibling)RecoveryEmptyElement(n)}}function RecoveryPandFigure(e){switch(e.nodeName){case"P":e.firstChild.nodeType===Node.TEXT_NODE?e.firstChild.data==nt_ZWBR&&IsSpanMathImg(e.firstChild.nextSibling)&&ConvertPtoFigure(e):IsSpanMathImg(e.firstChild)&&ConvertPtoFigure(e);break;case"FIGURE":{let n=!1;e.firstChild.nodeType===Node.TEXT_NODE?e.firstChild.data==nt_ZWBR&&IsSpanMathImg(e.firstChild.nextSibling)&&(n=!0):IsSpanMathImg(e.firstChild)&&(n=!0),n||ConvertFiguretoP(e)}break;case"DIV":{let n;for(let t=e.firstChild;t;t=n)n=t.nextSibling,"P"===t.nodeName?RecoveryPandFigure(t):"FIGURE"===t.nodeName&&RecoveryPandFigure(t)}}}function ConnectionNodeRecursive(e){let n={node:e,offset:0};for(;e;){e.parentNode;if(null===e.previousSibling)break;const t=e.previousSibling;let o=null;if("LI"==e.nodeName){if("LI"!=t.nodeName)break;if(t.lastChild&&("OL"==t.lastChild.nodeName||"UL"==t.lastChild.nodeName)){let o=null;if("BR"==e.firstChild.nodeName?"OL"!=e.firstChild.nextSibling.nodeName&&"UL"!=e.firstChild.nextSibling.nodeName||(o=e.firstChild.nextSibling):"OL"!=e.firstChild.nodeName&&"UL"!=e.firstChild.nodeName||(o=e.firstChild),o&&o.nodeName==t.lastChild){n={node:o.firstChild,offset:0};const i=RemoveNodeList(o,o.firstChild,null);AddNodeList(t.lastChild,null,i),RemoveNode(e);break}break}n=SafePushNodeList(t,RemoveNodeList(e,e.firstChild,null)),RemoveNode(e)}else if("OL"===e.nodeName||"UL"===e.nodeName){if(t.nodeName!=e.nodeName)break;n={node:e.firstChild,offset:0},o=e.firstChild;AddNodeList(t,null,RemoveNodeList(e,e.firstChild,null));RemoveNode(e)}else if("P"===e.nodeName){if(t.nodeName!=e.nodeName)break;n=SafeCombineNode(t)}e=o}return n}function PasteTopLevelNodes(e,n,t,o){if(console.log("try paste: ",e,", ",n),!t.hasChildNodes())return;let i,d;if(undo_man.Begin(e,n),e.nodeType===Node.TEXT_NODE)if(IsTextNodeInMath(e)){const t=e.parentNode.parentNode;if(0===n)i=t.parentNode,d=t;else{if(n!==e.length)return void undo_man.Cancel();i=t.parentNode,d=t.nextSibling}}else 0==n?(i=e.parentNode,d=e):n<e.length?(i=e.parentNode,d=DivideTextNode(e,n)):(i=e.parentNode,d=e.nextSibling);else e.hasChildNodes()?"OL"==e.nodeName||"UL"==e.nodeName?d=(i=e.childNodes.item(n)).firstChild:(i=e,d=e.childNodes.item(n)):(i=e.parentNode,d=e);if(1==t.childNodes.length){if(["P","H1","H2","H3","H4","H5","H6","LI","TH","TD","FIGCAPTION"].includes(t.firstChild.nodeName)){SafeJunctionPoint(i,AddNodeList(i,d,FragmentFromChildren(t.firstChild)));const e=SafeJunctionPoint(i,d);return document.getSelection().collapse(e.node,e.offset),RecoveryPandFigure(i),undo_man.End(e.node,e.offset),void console.log("paste succsess as simple text line")}}if("LI"===i.tagName){let e=null;if(1==t.childNodes.length)"OL"!=t.firstChild.nodeName&&"UL"!=t.firstChild.nodeName||(e=FragmentFromChildren(t.firstChild));else{let n=!0;for(let e=t.firstChild;e;e=e.nextSibling)["P","H1","H2","H3","H4","H5","H6","OL","UL"].includes(e.nodeName)||(n=!1);if(n){e=new DocumentFragment;let n,o=null;for(let i=t.firstChild;i;i=n)if(n=i.nextSibling,"OL"==i.nodeName||"UL"==i.nodeName){if(null===o){const n=document.createElement("LI");n.appendChild(document.createElement("BR")),n.appendChild(t.removeChild(i)),e.appendChild(n)}else o.appendChild(t.removeChild(i));o=null}else{const n=document.createElement("LI");n.appendChild(FragmentFromChildren(i)),e.appendChild(n),o=n}}}if(e){const n=SafeRemoveNodeList(i,d,null),t=AddNode(i.tagName,i.parentNode,i.nextSibling);SafePushNodeList(t,n),ConnectionNodeRecursive(AddNodeList(i.parentNode,t,e));const o=ConnectionNodeRecursive(t);return undo_man.End(o.node,o.offset),document.getSelection().collapse(o.node,o.offset),void console.log("paste succsess as list")}}if(["LI","P","H1","H2","H3","H4","H5","H6","FIGURE","FIGCAPTION"].includes(i.nodeName)){const e=DivideAtCrossSection2(d,i,o);ConnectionNodeRecursive(AddNodeList(o,e,t));const n=e?ConnectionNodeRecursive(e):SafeJunctionPoint(i,e);return RecoveryPandFigure(o),undo_man.End(n.node,n.offset),document.getSelection().collapse(n.node,n.offset),void console.log("paste succsess as paragrafh ")}undo_man.Cancel(),console.log("paste is skiped")}function FragmentFromChildren(e){const n=new DocumentFragment;for(;e.firstChild;)n.appendChild(e.removeChild(e.firstChild));return n}function PrintFocus(){var e=document.getSelection();e.focusNode.nodeType===Node.TEXT_NODE?(console.log("selection: focusNode="+e.focusNode),console.log("selection: focusText="+e.focusNode.data),console.log("selection: focusOffset="+e.focusOffset+" / "+e.focusNode.length)):(console.log("selection: focusNode="+e.focusNode+" "+e.focusNode.className),console.log("selection: focusOffset="+e.focusOffset+" / "+e.focusNode.childNodes.length)),e.isCollapsed||(e.anchorNode.nodeType===Node.TEXT_NODE?(console.log("selection: anchorNode="+e.anchorNode),console.log("selection: anchorText="+e.anchorNode.data),console.log("selection: anchorOffset="+e.anchorOffset+" / "+e.anchorNode.length)):(console.log("selection: anchorNode="+e.anchorNode+" "+e.anchorNode.className),console.log("selection: anchorOffset="+e.anchorOffset+" / "+e.anchorNode.childNodes.length)))}function NT_Dispatch(e){switch(e){case"undo":ExecUndo(),console.log("finish undo");break;case"redo":ExecRedo(),console.log("finish redo");break;case"selectall":SelectAll(nt_render_div),console.log("finish select all")}}function FindNextEffectiveNode(e,n,t){let o;if(e.nodeType===Node.TEXT_NODE){if(n<e.length)return e;o=e}else{if(n<e.childNodes.length)return e.childNodes[n];o=e}for(;null===o.nextSibling;)if((o=o.parentNode)===t)return null;return o=o.nextSibling}function FindNextTextNode(e,n,t){let o=FindNextEffectiveNode(e,n,t);for(;o;){if(o.nodeType===Node.TEXT_NODE)return o;if(o.firstChild)o=o.firstChild;else if(o.nextSibling)o=o.nextSibling;else{for(;null===o.nextSibling;)if((o=o.parentNode)===t)return null;o=o.nextSibling}}return alert("FindNextTextNode is invalid."),null}function FindPreviousEffectiveNode(e,n,t){let o;if(e.nodeType===Node.TEXT_NODE){if(0<n)return e;o=e}else{if(0<n)return e.childNodes[n-1];o=e}for(;null===o.previousSibling;)if((o=o.parentNode)===t)return null;return o=o.previousSibling}function FindPreviousTextNode(e,n,t){let o=FindPreviousEffectiveNode(e,n,t);for(;o;){if(o.nodeType===Node.TEXT_NODE)return o;if(o.lastChild)o=o.lastChild;else if(o.previousSibling)o=o.previousSibling;else{for(;null===o.previousSibling;)if((o=o.parentNode)===t)return null;o=o.previousSibling}}return alert("FindPrvoiusTextNode is invalid."),null}function GetFirstTextNode(e){for(;e;){if(e.nodeType===Node.TEXT_NODE)return e;e=e.firstChild}return null}function FindLastestNode(e){for(;e.hasChildNodes();)e=e.lastChild;return e}const nt_ZWBR="";class SelectionInfo{constructor(e,n,t=e,o=n){this.focusNode=e,this.focusOffset=n,this.anchorNode=t,this.anchorOffset=o}}class OperationInfo{constructor(e,n,t,o,i){this.updateType=e,this.data=n,this.parent=t,this.offset=o,this.length=i,this.is_connect_to_past=!1,this.is_connect_to_future=!1}}class History{constructor(e,n){this.selectionBefore=e,this.selectionAfter=null,this.operationBegin=n,this.operationEnd=n}}var UR_TYPE={NONE:0,INSERT_TEXT_INTO_TEXT:1,DELETE_IN_TEXT:101,BACKSPACE_IN_TEXT:102,DIVIDE_TEXT_NODE:202,ADD_NODE:1001,ADD_TEXT_NODE:1002,ADD_MATH_NODE:1007,REMOVE_NODE:2001,COMBINE_TEXT_NODE:3002,REMOVE_NODE_LIST:3004,ADD_NODE_LIST:3005};class UndoManager{constructor(){this.name="undo_manager",this.operations=[],this.history=[],this.index_history=0,this.index_operation=0,this.acceptable=!1,this.begin_selection=null,this.begin_index_ope=0,this.event_dispatcher=null}get numHistory(){return this.history.length}Begin(e,n,t=e,o=n){this.acceptable&&alert("ERROR: invalid Undo registration"),this.Shrink(),this.begin_selection=new SelectionInfo(e,n,t,o),this.begin_index_ope=this.index_operation,this.operations.length>this.index_operation&&this.operations.splice(this.index_operation),this.acceptable=!0}End(e,n,t=e,o=n){if(this.begin_index_ope<this.index_operation){let i=new History(this.begin_selection,this.begin_index_ope);i.selectionAfter=new SelectionInfo(e,n,t,o),i.operationEnd=this.index_operation,this.history.push(i),this.index_history++}this.acceptable=!1,this.event_dispatcher&&this.event_dispatcher.Dispatch()}Cancel(){this.acceptable&&(this.index_operation=this.begin_index_ope,this.acceptable=!1)}Shrink(){!1===this.acceptable&&this.history.length>this.index_history&&(this.index_operation=this.history[this.index_history].operationBegin,this.operations.splice(this.index_operation),this.history.splice(this.index_history),console.log("shurink: ",this.history.length))}Register(e,n,t,o,i){this.acceptable||alert("ERROR: Undo Manager: call Begin before calling Register!"),this.operations.push(new OperationInfo(e,n,t,o,i)),this.index_operation++}GetUndo(){if(0===this.index_history)return null;this.index_history--;const e=this.history[this.index_history];return this.operation_begin=e.operationBegin,e}GetRedo(){if(this.index_history===this.history.length)return null;const e=this.history[this.index_history];return this.index_history++,this.operation_begin=e.operationEnd,e}GetOperation(e){return this.operations[e]}SetChangeEventDispatcher(e){this.event_dispatcher=e}GetChangeEventDispatcher(){return this.event_dispatcher}}class ChangeEventDispatcher{constructor(e){this.event_target=e,this.has_changed=!1,this.enable=!0}Reset(){this.has_changed=!1}Dispatch(){!1===this.has_changed&&this.event_target&&this.enable&&(this.has_changed=!0,this.event_target.dispatchEvent(new CustomEvent("nt_changed")))}Enable(){this.enable=!0}Disable(){this.enable=!1}}let undo_man=null;function CreateSelectionInfo(e){return new SelectionInfo(e.focusNode,e.focusOffset,e.anchorNode,e.anchorOffset)}function CloneSelectionInfo(e){return new SelectionInfo(e.focusNode,e.focusOffset,e.anchorNode,e.anchorOffset)}function ExecUndo(){let e=undo_man.GetUndo();if(!e)return!1;for(let n=e.operationEnd-1;n>=e.operationBegin;n--){console.log("Undo: "+n+" ------------------ ");const e=undo_man.GetOperation(n);switch(e.updateType){case UR_TYPE.INSERT_TEXT_INTO_TEXT:UndoInsertTextToText(e);break;case UR_TYPE.ADD_TEXT_NODE:UndoAddTextNode(e);break;case UR_TYPE.ADD_NODE:case UR_TYPE.ADD_MATH_NODE:UndoAddNode(e);break;case UR_TYPE.DELETE_IN_TEXT:UndoDeleteText(e);break;case UR_TYPE.BACKSPACE_IN_TEXT:UndoBackspaceText(e);break;case UR_TYPE.DIVIDE_TEXT_NODE:UndoDivideTextNode(e);break;case UR_TYPE.REMOVE_NODE:UndoRemoveNode(e);break;case UR_TYPE.COMBINE_TEXT_NODE:UndoCombineTextNode(e);break;case UR_TYPE.REMOVE_NODE_LIST:UndoRemoveNodeList(e);break;case UR_TYPE.ADD_NODE_LIST:UndoAddNodeList(e)}}return e.selectionBefore.focusNode===e.selectionBefore.anchorNode&&e.selectionBefore.focusOffset===e.selectionBefore.anchorOffset?document.getSelection().collapse(e.selectionBefore.focusNode,e.selectionBefore.focusOffset):document.getSelection().setBaseAndExtent(e.selectionBefore.anchorNode,e.selectionBefore.anchorOffset,e.selectionBefore.focusNode,e.selectionBefore.focusOffset),CheckEditPreview(null,!0),undo_man.GetChangeEventDispatcher().Dispatch(),!0}function ExecRedo(){let e=undo_man.GetRedo();if(!e)return!1;for(let n=e.operationBegin;n<e.operationEnd;n++){console.log("Redo: "+n+" ------------------ ");const e=undo_man.GetOperation(n);switch(e.updateType){case UR_TYPE.INSERT_TEXT_INTO_TEXT:RedoInsertTextToText(e);break;case UR_TYPE.ADD_TEXT_NODE:RedoAddTextNode(e);break;case UR_TYPE.ADD_NODE:case UR_TYPE.ADD_MATH_NODE:RedoAddNode(e);break;case UR_TYPE.DELETE_IN_TEXT:RedoDeleteText(e);break;case UR_TYPE.BACKSPACE_IN_TEXT:RedoBackspaceText(e);break;case UR_TYPE.DIVIDE_TEXT_NODE:RedoDivideTextNode(e);break;case UR_TYPE.REMOVE_NODE:RedoRemoveNode(e);break;case UR_TYPE.COMBINE_TEXT_NODE:RedoCombineTextNode(e);break;case UR_TYPE.REMOVE_NODE_LIST:RedoRemoveNodeList(e);break;case UR_TYPE.ADD_NODE_LIST:RedoAddNodeList(e)}}return e.selectionAfter.focusNode===e.selectionAfter.anchorNode&&e.selectionAfter.focusOffset===e.selectionAfter.anchorOffset?document.getSelection().collapse(e.selectionAfter.focusNode,e.selectionAfter.focusOffset):document.getSelection().setBaseAndExtent(e.selectionAfter.anchorNode,e.selectionAfter.anchorOffset,e.selectionAfter.focusNode,e.selectionAfter.focusOffset),CheckEditPreview(null,!0),undo_man.GetChangeEventDispatcher().Dispatch(),!0}function InsertTextIntoText(e,n,t){console.log("insert text into text"),n.insertData(t,e),undo_man.Register(UR_TYPE.INSERT_TEXT_INTO_TEXT,e,n,t,e.length)}function UndoInsertTextToText(e){let n=e.parent;n.nodeType!==Node.TEXT_NODE&&alert("Undo: node is not text in UndoInsertTextToText"),n.deleteData(e.offset,e.length)}function RedoInsertTextToText(e){let n=e.parent;n.nodeType!==Node.TEXT_NODE&&alert("Undo: node is not text in RedoInsertTextToText"),n.insertData(e.offset,e.data)}function DeleteText(e,n,t=1){if(console.log("delete text",n,t),e.length<=n)return alert("node focus is invalid"),null;const o=e.data.slice(n,n+t);return e.deleteData(n,t),undo_man.Register(UR_TYPE.DELETE_IN_TEXT,o,e,n,t),o}function UndoDeleteText(e){console.log("undo delete text"),e.parent.insertData(e.offset,e.data)}function RedoDeleteText(e){console.log("redo delete text"),e.parent.deleteData(e.offset,e.length)}function AddMathNode(e,n,t){const o=GetIndex(n,t);let i=CreateMathNode(e);return i&&(n.insertBefore(i,t),undo_man.Register(UR_TYPE.ADD_MATH_NODE,i,n,o,1)),i}function CreateMathNode(e){switch(e){case"$":{let e=document.createElement("SPAN");return e.className="math",e.insertAdjacentHTML("afterbegin",katex.renderToString("",{throwOnError:!1})),e.insertAdjacentHTML("beforeend","<span class='editmath'>$$</span>"),e}case"$$":{let e=document.createElement("SPAN");return e.className="math",katexAutoNumber("",e,0),e.insertAdjacentHTML("beforeend","<span class='editmathdisp'>$$\n\n$$</span>"),e.dataset.eqnumberBegin=0,e.dataset.eqnumberEnd=0,e}case"`":{let e=document.createElement("SPAN");return e.className="math",e.insertAdjacentHTML("afterbegin","<span class='previewcode'>dummy</span>"),e.insertAdjacentHTML("beforeend","<span class='editcode'>``</span>"),e}case"```":{const e=document.createElement("SPAN");return e.className="math",e.insertAdjacentHTML("afterbegin","<span class='previewcodedisp'>dummy</span>"),e.insertAdjacentHTML("beforeend","<span class='editcodedisp'>```\n\n```</span>"),e}case"*":case"_":{const n=document.createElement("SPAN");return n.className="math",n.insertAdjacentHTML("afterbegin","<em>dummy</em>"),n.insertAdjacentHTML("beforeend","<span class='editem1'>"+e+e+"</span>"),n}case"**":case"__":{const n=document.createElement("SPAN");return n.className="math",n.insertAdjacentHTML("afterbegin","<strong>dummy</strong>"),n.insertAdjacentHTML("beforeend","<span class='editem2'>"+e+e+"</span>"),n}case"***":case"___":{const n=document.createElement("SPAN");return n.className="math",n.insertAdjacentHTML("afterbegin","<em><strong>dummy</strong></em>"),n.insertAdjacentHTML("beforeend","<span class='editem3'>"+e+e+"</span>"),n}case"[":{const e=document.createElement("SPAN");return e.className="math",e.insertAdjacentHTML("afterbegin",'<a href="'+NT_LINK_DEFAULT_URL+'" target="_blank" ref="noopener noreferrer">'+NT_LINK_DEFAULT_TEXT+"</a>"),e.insertAdjacentHTML("beforeend","<span class='edita'>["+NT_LINK_DEFAULT_TEXT+"]("+NT_LINK_DEFAULT_URL+")</span>"),e}case"![":{const e=document.createElement("SPAN");return e.className="math",e.insertAdjacentHTML("afterbegin",'<img src="sample.jpg" alt="AltWord">'),e.insertAdjacentHTML("beforeend","<span class='editimg'>![AltwWord](image.png) </span>"),e}case"[^":{const e=document.createElement("SPAN");return e.className="math",e.insertAdjacentHTML("afterbegin","<a class='previewcite'>dummy</span>"),e.insertAdjacentHTML("beforeend","<span class='editcite'>[^] </span>"),e}}return null}function AddTextNode(e,n,t){console.log("add text node");const o=GetIndex(n,t);let i=document.createTextNode(e);return n.insertBefore(i,t),undo_man.Register(UR_TYPE.ADD_TEXT_NODE,i,n,o,1),i}function UndoAddTextNode(e){console.log("undo add text node"),e.data.remove()}function RedoAddTextNode(e){console.log("redo add text node");let n=e.parent,t=e.data,o=n.childNodes.item(e.offset);n.insertBefore(t,o)}function GetIndex(e,n){let t=e.firstChild,o=0;for(;t;){if(n===t)return o;t=t.nextSibling,++o}return o}function RemoveNode(e){console.log("remove node");const n=GetIndex(e.parentNode,e),t=e.parentNode;return e.remove(),undo_man.Register(UR_TYPE.REMOVE_NODE,e,t,n,1),e}function UndoRemoveNode(e){console.log("undo remove node");let n=e.parent;n.insertBefore(e.data,n.childNodes.item(e.offset))}function RedoRemoveNode(e){console.log("redo remove node"),e.data.remove()}function AddNode(e,n,t){console.log("add node: "+e);let o=GetIndex(n,t),i=document.createElement(e);return n.insertBefore(i,t),undo_man.Register(UR_TYPE.ADD_NODE,i,n,o,1),i}function UndoAddNode(e){console.log("undo add node");let n=e.data;const t=e.parent,o=e.offset;if(t.childNodes.item(o)!==n){if(t.childNodes.item(o).nodeName!==n.nodeName)return void alert("ERROR: added node does not exist!");console.log("NOTINE: added node does not exist, but same type node is added already."),n=t.childNodes.item(o)}n.remove()}function RedoAddNode(e){console.log("redo add node");let n=e.parent,t=e.data,o=n.childNodes.item(e.offset);n.insertBefore(t,o)}function DivideTextNode(e,n){console.log("divide text node");let t=e.splitText(n);return undo_man.Register(UR_TYPE.DIVIDE_TEXT_NODE,t,e,n,t.length),t}function UndoDivideTextNode(e){console.log("undo divide text node");let n=e.data;e.parent.appendData(n.data),n.remove()}function RedoDivideTextNode(e){console.log("redo divide text node");let n=e.data,t=e.parent;t.deleteData(e.offset,e.length),t.after(n)}function CombineTextNode(e){console.log("combine text node");let n=e.nextSibling;const t=e.length;e.appendData(n.data),n.remove(),undo_man.Register(UR_TYPE.COMBINE_TEXT_NODE,n,e,t,n.length)}function UndoCombineTextNode(e){console.log("undo combine text node");let n=e.parent,t=e.data;n.deleteData(e.offset,e.length),n.after(t)}function RedoCombineTextNode(e){console.log("redo combine text node");let n=e.parent,t=e.data;n.appendData(t.data),t.remove()}function RemoveNodeList(e,n,t=null){console.log("remove node list");let o=GetIndex(e,n),i=new DocumentFragment,d=n;for(;d!==t;){let e=d.nextSibling;d.remove(),i.appendChild(d),d=e}return undo_man.Register(UR_TYPE.REMOVE_NODE_LIST,i,e,o,i.childNodes.length),i}function UndoRemoveNodeList(e){console.log("undo remove node list");let n=e.data,t=e.parent,o=e.offset;t.insertBefore(n,t.childNodes.item(o))}function RedoRemoveNodeList(e){console.log("redo remove node list");let n=e.data,t=e.parent,o=e.offset,i=o+e.length;const d=t.childNodes.item(i);let a=t.childNodes.item(o);for(;a!==d;){let e=a.nextSibling;a.remove(),n.appendChild(a),a=e}}function AddNodeList(e,n,t){console.log("add node list");const o=GetIndex(e,n),i=t.childNodes.length,d=t.firstChild;return e.insertBefore(t,n),undo_man.Register(UR_TYPE.ADD_NODE_LIST,t,e,o,i),d}function UndoAddNodeList(e){console.log("undo add node list");let n=e.data,t=e.parent,o=e.offset,i=o+e.length;const d=t.childNodes.item(i);let a=t.childNodes.item(o);for(;a!==d;){let e=a.nextSibling;a.remove(),n.appendChild(a),a=e}}function RedoAddNodeList(e){console.log("redo add node list");let n=e.data,t=e.parent,o=e.offset;t.insertBefore(n,t.childNodes.item(o))}function RepairLastBr(e){if(null!==e){if("OL"!==e.nodeName&&"UL"!==e.nodeName){let n=e.lastChild;if(null===n)return void AddNode("BR",e,null);if("BR"===n.nodeName)return;return"OL"!==n.nodeName&&"UL"!==n.nodeName?void AddNode("BR",e,null):void("OL"!==e.firstChild.nodeName&&"UL"!==e.firstChild.nodeName||AddNode("BR",e,e.firstChild))}if(null===e.lastChild){AddNode("BR",AddNode("LI",e,null),null)}}}function SafePushNodeList(e,n){const t=n.firstChild;if(null===t)return null;AddNodeList(e,null,"#document-fragment"==n.nodeName?n:RemoveNodeList(n,t,null));const o=SafeJunctionPoint(e,t);return SafeTailPoint(e),o}function SafeCombineNode(e){if(null===e.nextSibling)return null;if(null===e.nextSibling.firstChild)return null;const n=RemoveNodeList(e.nextSibling,e.nextSibling.firstChild,null);return RemoveNode(e.nextSibling),SafePushNodeList(e,n)}function SafeJunctionPoint(e,n){const t=e=>{if(e){if("BR"==e.nodeName)return!0;if(e.nodeType===Node.TEXT_NODE&&e.data==nt_ZWBR)return!0}return!1};let o=n?n.previousSibling:e.lastChild;if(t(o)){const e=o;o=o.previousSibling,RemoveNode(e)}let i=n;if(t(i)){const e=i;i=i.nextSibling,RemoveNode(e)}if(null===o)return SafeHeadPoint(e);if("SPAN"==o.nodeName){if(i&&i.nodeType===Node.TEXT_NODE)return{node:i,offset:0};return{node:AddTextNode(nt_ZWBR,e,i),offset:0}}if("UL"==o.nodeName||"OL"==o.nodeName){if(i&&i.nodeName==o.nodeName){const e={node:i.firstChild,offset:0};return AddNodeList(o,null,RemoveNodeList(i,i.firstChild,null)),RemoveNode(i),e}return{node:o.lastChild,offset:0}}if("FIGCAPTION"==o.nodeName){if(i&&i.nodeName==o.nodeName){const e=SafePushNodeList(o,RemoveNodeList(i,i.firstChild,null));return RemoveNode(i),e}return{node:o.lastChild,offset:0}}o.nodeType!==Node.TEXT_NODE&&console.log("ERROR: unexpect adjacent node(2)",o.nodeName,i.nodeName);const d=o.length;return i&&i.nodeType===Node.TEXT_NODE?(CombineTextNode(o),{node:o,offset:d}):{node:o,offset:d}}function SafeHeadPoint(e){const n=e.firstChild;if(null===n)return AddNode("BR",e,null),{node:e,offset:0};if("BR"==n.nodeName)return n.nextSibling&&"OL"!=n.nextSibling.nodeName&&"UL"!=n.nextSibling.nodeName&&"FIGCAPTION"!=n.nextSibling.nodeName&&RemoveNode(n),{node:e,offset:0};if("SPAN"===n.nodeName){return{node:AddTextNode(nt_ZWBR,e,n),offset:0}}return"OL"===n.nodeName||"UL"===n.nodeName||"FIGCAPTION"===n.nodeName?(AddNode("BR",e,n),{node:e,offset:0}):(n.nodeType!==Node.TEXT_NODE&&console.log("ERROR: unexpect adjacent node",n.nodeName),{node:n,offset:0})}function SafeTailPoint(e){const n=e.lastChild;if(null===n)return AddNode("BR",e,null),{node:e,offset:0};if("BR"==n.nodeName)return n.previousSibling?(RemoveNode(n),SafeTailPoint(e)):{node:e,offset:0};if("SPAN"==n.nodeName){return{node:AddTextNode(nt_ZWBR,e,null),offset:0}}return"OL"==n.nodeName||"UL"==n.nodeName?SafeTailPoint(n.lastChild):"FIGCAPTION"===n.nodeName?SafeTailPoint(n):(n.nodeType!==Node.TEXT_NODE&&console.log("ERROR: unexpect adjacent node",n.nodeName),{node:n,offset:n.length})}function SafeRemoveNodeList(e,n,t=null){const o=RemoveNodeList(e,n,t);return SafeJunctionPoint(e,t),o}function ValidateMathInParent(e){let n=null,t=null;for(let o=e.firstChild;o;o=t){if(t=o.nextSibling,"SPAN"==o.nodeName){if(null===n)return!1;if(n.nodeType!==Node.TEXT_NODE)return!1;if(null===t)return!1;if(t.nodeType!==Node.TEXT_NODE)return!1}n=o}return!0}function AssertValidateMathInParent(e){return!!ValidateMathInParent(e)||(alert("ERROR: invalid for the adjacent nodes of math",e),ValidateMathInParent(e),!1)}function IsTextNode(e){return!(!e||e.nodeType!==Node.TEXT_NODE)}const nt_SPACE_FOR_LIST="  ";function DOM2MD(e){return MdFromChildNodes(e,0)}function MdFromChildNodes(e,n){let t="",o=e.firstChild;for(;o;)t+=MdFromNode(o,n),o=o.nextSibling;return t}function MdFromList(e,n,t){let o="",i=e.firstChild;for(;i;){o+=t+ReplaceAllExcept(MdFromChildNodes(i,n+1),"\n","\n"+nt_SPACE_FOR_LIST,"\n"),i=i.nextSibling,"\n"!=o[o.length-1]&&(o+="\n")}return o}function MdFromNode(e,n){if(e.nodeType===Node.TEXT_NODE)return e.data==nt_ZWBR?"":e.data;switch(e.tagName){case"BR":return"P"==e.parentNode.nodeName?"  \n":"";case"P":{const t=MdFromChildNodes(e,n);return e.previousSibling?0===t.length?"\n  \n":"\n"===t[t.length-1]?"\n"+t:"\n"+t+"\n":0===t.length?"  \n":"\n"===t[t.length-1]?t:t+"\n"}case"UL":{const t=MdFromList(e,n,"- ");return 0===n&&e.previousSibling&&"P"!==e.previousSibling.tagName&&"OL"!==e.previousSibling.tagName&&"UL"!==e.previousSibling.tagName?"\n\n"+t:"\n"+t}case"OL":{const t=MdFromList(e,n,"1. ");return 0===n&&e.previousSibling&&"P"!==e.previousSibling.tagName&&"OL"!==e.previousSibling.tagName&&"UL"!==e.previousSibling.tagName?"\n\n"+t:"\n"+t}case"SPAN":if("math"===e.className)switch(e.lastChild.className){case"editmathdisp":case"editcodedisp":{let t=e.lastChild.firstChild.data;return n>0?"\n\n"+t+"\n":t+"\n"}case"editimg":case"editcite":return e.lastChild.firstChild.data.slice(0,e.lastChild.firstChild.length-1);case"editref":return e.lastChild.firstChild.data.slice(0,e.lastChild.firstChild.length)+" ";default:if("_"==e.lastChild.firstChild.data.charAt(0)){let n=e.lastChild.firstChild.data;return e.previousSibling&&(e.previousSibling.nodeType===Node.TEXT_NODE?" "!=e.previousSibling.data.charAt(e.previousSibling.length-1)&&(n=" "+n):n=" "+n),e.nextSibling&&(e.nextSibling.nodeType===Node.TEXT_NODE?" "!=e.nextSibling.data.charAt(0)&&(n+=" "):n+=" "),n}return e.lastChild.firstChild.data}return console.error("invalid span node cannot be changed:",e.className),"";case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":{const t="#".repeat(parseInt(e.tagName.charAt(1),10))+" ",o=MdFromChildNodes(e,n);return e.previousSibling?0===o.length?"\n"+t+"  \n":"\n"===o[o.length-1]?"\n"+t+o:"\n"+t+o+"\n":0===o.length?t+"  \n":"\n"===o[o.length-1]?t+o:t+o+"\n"}case"FIGURE":{let t=e.previousSibling?"\n":"",o=e.firstChild;for(;o;){if(IsSpanMathImg(o))t+=MdFromNode(o)+"\n";else if("FIGCAPTION"==o.nodeName)break;o=o.nextSibling}return o&&(t+=MdFromChildNodes(o,n)),0===t.length?"  \n":"\n"===t[t.length-1]?t:t+"\n"}case"TABLE":{let n=e.previousSibling?"\n":"";for(let t=e.firstChild;t;t=t.nextSibling){n+="|";for(let e=t.firstChild;e;e=e.nextSibling){let t=MdFromChildNodes(e,0);"\n"===t[t.length-1]?n+=t.slice(0,t.length-1)+"|":n+=t+"|"}n+="\n"}return n}}return alert("invalid node cannot be changed:"+e.tagName),""}function NT_MathNumbering(e){if(null===nt_render_div)return;console.log("mathnumbering = ",e);const n=nt_render_div,t=FragmentFromChildren(n);InitializeMathInFragment(t,e?1:0),n.appendChild(t)}function InitializeMathInFragment(e,n){let t=e.querySelectorAll("span.math");for(let e=0;e<t.length;e++){const o=t[e],i=GetEditMargin(o);let d=o.lastChild.firstChild,a=d.data.substring(i,d.length-i);switch(o.lastChild.className){case"editmath":n+=MathRendering(o,a,n),ShowPreview(o.firstChild);break;case"editmathdisp":n+=MathRendering(o,a,n),ShowPreviewDisplay(o.firstChild);break;case"editcode":o.firstChild.textContent=a,ShowPreview(o.firstChild);break;case"editcodedisp":"\n"===a.charAt(0)?o.firstChild.textContent=a.slice(1,a.length-1):o.firstChild.textContent=a,ShowPreviewDisplay(o.firstChild);break;case"editimg":{let e=a.indexOf("](");e<0&&(o.firstChild.alt=a,o.firstChild.src=null),o.firstChild.src=nt_file_dir+a.slice(e+2,a.length+1),o.firstChild.alt=a.slice(0,e),ShowPreview(o.firstChild)}}SetHide(o.lastChild)}}const IME_TYPE={GENERAL:0,WIN_FIREFOX:0,WIN_EDGE_LEGACY:1,WIN_CHROME:2,WIN_EDG_CHR:4,WIN_ELECTRON:5,MAC_FIREFOX:100,MAC_CHROME:102,MAC_SAFARI:103,MAC_ELECTRON:105,LNX_FIREFOX:200,LNX_CHROME:202,LNX_ELECTRON:205};let nt_render_div=null,nt_is_MacOS=!1;function NT_Initialize(e,n){console.log("IME_type = ",n);const t=document.getElementById(e);switch(nt_render_div=t,t.contentEditable="true",t.addEventListener("keydown",OnKeydownForShortcut,!1),n){case IME_TYPE.WIN_EDGE_LEGACY:MO_InitComposition(t),t.addEventListener("compositionstart",MO_OnCompositionstart,!1),t.addEventListener("compositionupdate",MO_OnCompositionupdate,!1),t.addEventListener("compositionend",MO_OnCompositionend,!1),t.addEventListener("keydown",MO_OnKeydownForIME,!1),t.addEventListener("contextmenu",MO_OnContextmenuForIME,!1),t.addEventListener("keydown",OnKeydownForNavigationEditing,!1),t.addEventListener("keydown",OnKeydownForAsciiChar,!1),t.addEventListener("keyup",OnKeyup,!1);break;case IME_TYPE.WIN_CHROME:case IME_TYPE.LNX_CHROME:case IME_TYPE.WIN_EDG_CHR:case IME_TYPE.WIN_ELECTRON:case IME_TYPE.LNX_ELECTRON:MO_InitComposition(t),t.addEventListener("compositionstart",MO_OnCompositionstart,!1),t.addEventListener("compositionupdate",MO_OnCompositionupdate,!1),t.addEventListener("compositionend",MO_OnCompositionendForChrome,!1),t.addEventListener("keydown",MO_OnKeydownForIME,!1),t.addEventListener("contextmenu",MO_OnContextmenuForIME,!1),t.addEventListener("keydown",OnKeydownForNavigationEditing,!1),t.addEventListener("keydown",OnKeydownForAsciiChar,!1),t.addEventListener("keyup",OnKeyup,!1);break;case IME_TYPE.MAC_CHROME:case IME_TYPE.MAC_ELECTRON:MO_InitComposition(t),t.addEventListener("compositionstart",MO_OnCompositionstart,!1),t.addEventListener("compositionupdate",MO_OnCompositionupdate,!1),t.addEventListener("compositionend",MO_OnCompositionendForChrome,!1),t.addEventListener("keydown",MO_OnKeydownForIME,!1),t.addEventListener("contextmenu",MO_OnContextmenuForIME,!1),t.addEventListener("keydown",OnKeydownForNavigationEditing,!1),t.addEventListener("beforeinput",OnBeforeinputForAsciiChar,!1),t.addEventListener("keyup",OnKeyup,!1),nt_is_MacOS=!0;break;case IME_TYPE.MAC_SAFARI:MO_InitComposition(t),t.addEventListener("compositionstart",MO_OnCompositionstart,!1),t.addEventListener("compositionupdate",MO_OnCompositionupdate,!1),t.addEventListener("compositionend",MO_OnCompositionend,!1),t.addEventListener("keydown",MO_OnKeydownForIME,!1),t.addEventListener("contextmenu",MO_OnContextmenuForIME,!1),t.addEventListener("input",SAFARI_OnInputMarkingEnter,!1),t.addEventListener("keydown",SAFARI_OnKeydownForNavigationEditing,!1),t.addEventListener("beforeinput",OnBeforeinputForAsciiChar,!1),t.addEventListener("keyup",OnKeyup,!1),nt_is_MacOS=!0;break;default:MO_InitComposition(t),t.addEventListener("compositionstart",MO_OnCompositionstart,!1),t.addEventListener("compositionupdate",MO_OnCompositionupdate,!1),t.addEventListener("compositionend",MO_OnCompositionend,!1),t.addEventListener("keydown",MO_OnKeydownForIME,!1),t.addEventListener("contextmenu",MO_OnContextmenuForIME,!1),t.addEventListener("keydown",OnKeydownForNavigationEditing,!1),t.addEventListener("keydown",OnKeydownForAsciiChar,!1),t.addEventListener("keyup",OnKeyup,!1),n===IME_TYPE.MAC_FIREFOX&&(nt_is_MacOS=!0)}t.addEventListener("cut",OnCut,!1),t.addEventListener("copy",OnCopy,!1),t.addEventListener("paste",OnPaste,!1),document.addEventListener("click",OnClickMath,!1),(undo_man=new UndoManager).SetChangeEventDispatcher(new ChangeEventDispatcher(t))}let EDGE_input_event_args={data:null,isComposing:!1,inputType:"insertText",dataTransfer:null};function EDGE_KeepForInputEvent(e){console.log("EDGE_KeepForInputEvent"),e.key&&(EDGE_input_event_args.data=e.key,EDGE_input_event_args.isComposing=EDGE_IME_in_action,EDGE_input_event_args.inputType="insertText",EDGE_input_event_args.dataTransfer=null)}let SAFARI_is_just_after_compositionend=!1;function SAFARI_OnInputMarkingEnter(e){if("insertFromComposition"===e.inputType||"deleteCompositionText"===e.inputType)return SAFARI_is_just_after_compositionend=!0,!1}function SAFARI_OnKeydownForNavigationEditing(e){if(SAFARI_is_just_after_compositionend&&(SAFARI_is_just_after_compositionend=!1,"Enter"===e.key||"Delete"===e.key||"Backspace"===e.key))return e.preventDefault(),void console.log("cancel the",e.key,"just after IME end");OnKeydownForNavigationEditing(e)}function NT_ResetChangeFlag(){undo_man.GetChangeEventDispatcher().Reset()}let g_label_eqnumber=new Map;function katexAutoNumber(e,n,t){const o=e.indexOf("\\begin{align}");return o<0?katexAutoNumber_woAligned(e,n,t):katexAutoNumber_withAligned(e=ReplaceAll(e,"{align}","{aligned}"),o,n,t)}function katexAutoNumber_woAligned(e,n,t){let o=ListupBr(e,0),i=ListUpNonumber(e,o);RegisterLabelEqnumber(i,ListUpLabel(e,o),t),e=ReferLabelEqnumber(e=ReplaceByRangeAll(e=ReplaceAll(e,"\\nonumber"," "),"\\label{","}"," ")),n.insertAdjacentHTML("afterbegin",katex.renderToString(e,{output:"html",displayMode:!0,throwOnError:!1}));let d=FindFirstChild("katex-html",n.firstElementChild);if(null===d)return 0;let a=d.firstElementChild;if(null===a)return 0;if("base"!==a.className)return 0;let l=a.parentElement,s=null,r=0,c=t;for(;a;){for(i[r]?s=null:((s=document.createElement("SPAN")).className="tag",s.appendChild(a.firstElementChild.cloneNode(!0)),"strut"!==s.firstElementChild.className&&alert("ERROR: auto numbering is miss"),s.appendChild(document.createTextNode("("+c+")")),c++),a=a.nextElementSibling;a;){if("mspace newline"===a.className){let e=a.nextElementSibling;s&&(a.before(s),s=null),a=e;break}a=a.nextElementSibling}++r}return s&&(l.appendChild(s),s=null),c-t}function katexAutoNumber_withAligned(e,n,t,o){{let i=ListupBr(e,n+"\\begin{aligned}".length),d=ListUpNonumber(e,i);RegisterLabelEqnumber(d,ListUpLabel(e,i),o),e="\\tag{"+o+"}"+(e=ReferLabelEqnumber(e=ReplaceByRangeAll(e=ReplaceAll(e,"\\nonumber"," "),"\\label{","}"," "))),t.insertAdjacentHTML("afterbegin",katex.renderToString(e,{output:"html",displayMode:!0,throwOnError:!1}));let a=FindFirstChild("katex-html",t.firstElementChild);if(null===a)return 0;let l=a.firstElementChild;if("base"!==l.className)return 0;let s=l.nextElementSibling;if("tag"!==s.className)return 0;let r=FindFirstChild("mtable",l.firstElementChild.nextElementSibling);if(null===r)return 0;let c=r.cloneNode(!0);{let e=c.firstChild;for(;e.nextSibling;)e.nextSibling.remove()}let f=FindFirstChild("vlist-r",c.firstElementChild);if(null===f)return 0;let _=FindFirstChild("vlist",f.firstElementChild);if(null===_)return 0;console.log("vlist.childNodes.length = "+_.childNodes.length);let u=_.firstElementChild,E=o,g=0;for(;u;){let e=FindFirstChild("pstrut",u.firstElementChild);if(e){let n=e.nextElementSibling;if("mord"===n.className){for(;n.firstChild;)n.removeChild(n.firstChild);d[g]?n.appendChild(document.createTextNode(" ")):(n.appendChild(document.createTextNode("("+E+")")),E++)}}u=u.nextElementSibling,++g}let m=s.firstElementChild.nextElementSibling;if(null===m)return 0;for(;m.firstChild;)m.removeChild(m.firstChild);return m.appendChild(c),E-o}}function FindFirstChild(e,n){let t=n;for(;t;){if(t.className===e)return t;t=t.firstElementChild}return t}function FindEndPos(e,n){let t=e.indexOf("\\begin",n),o=e.indexOf("\\end",n);for(;t>=0;){if(o<t)return o;n=FindEndPos(e,t+1),n++,t=e.indexOf("\\begin",n),o=e.indexOf("\\end",n)}return o}function ListupBr(e,n){let t=[];{let o=n,i=e.indexOf("\\begin",o),d=e.indexOf("\\\\",o);for(;d>=0;)i>=0?d<i?(t.push(d),o=d+1,d=e.indexOf("\\\\",o)):(o=FindEndPos(e,i+1),o++,i=e.indexOf("\\begin",o),d=e.indexOf("\\\\",o)):(t.push(d),o=d+1,d=e.indexOf("\\\\",o));t.push(e.length)}return t}function ListUpNonumber(e,n){let t=[];{let o=e.indexOf("\\nonumber",0),i=0;for(;o>=0&&(n[i]<o?t.push(!1):(t.push(!0),o=e.indexOf("\\nonumber",n[i])),!(++i>=n.length)););for(;i<n.length;)t.push(!1),++i;n.length!==t.length&&alert("ERROR: analize nonumber in multi-line equations")}return t}function ListUpLabel(e,n){let t=[];{let o=e.indexOf("\\label",0),i=0;for(;o>=0;){if(n[i]<o)t.push("");else{const d=e.indexOf("{",o+6);if(d<0)t.push(""),alert("ERROR: \\label does not has next { character");else{const n=e.indexOf("}",d+1);if(n<0)t.push(""),alert("ERROR: \\label does not has next } character");else{let o=e.slice(d+1,n);t.push(o.trim())}}o=e.indexOf("\\label",n[i])}if(++i>=n.length)break}for(;i<n.length;)t.push(""),++i;n.length!==t.length&&alert("ERROR: analize label in multi-line equations")}return t}function RegisterLabelEqnumber(e,n,t){const o=n.length;for(let i=0;i<o;++i)e[i]||(n[i].length>0&&g_label_eqnumber.set(n[i],t),t++)}function ReferLabelEqnumber(e){let n=0,t=e.indexOf("\\ref",n);if(t<0)return e;let o="";for(;t>=0;){let i=e.indexOf("{",t+"\\ref".length);if(i<0)break;let d=e.indexOf("}",i+1);if(d<0)break;const a=e.slice(i+1,d).trim();if(g_label_eqnumber.has(a)){const i=g_label_eqnumber.get(a);o+=e.slice(n,t)+i.toString()}else o+=e.slice(n,t)+"??";n=d+1,t=e.indexOf("\\ref",n)}return o+=e.slice(n)}const NT_LINK_DEFAULT_URL="https://sample.url",NT_LINK_DEFAULT_TEXT="PreviewWord";function OnKeyup(e){switch(e.key){case"ArrowUp":case"ArrowDown":case"Home":case"End":case"PageUp":case"PageDown":{const n=document.getSelection();console.log("keyup   fook: "+e.key+"focus: node="+n.focusNode.tagName+", offset="+n.focusOffset);const t=CheckEditPreview(e.currentTarget);console.log("focus_math",t,g_editable_math),t&&(e.shiftKey?document.getSelection().extend(t.node,t.offset):document.getSelection().collapse(t.node,t.offset))}}}function OnKeydownForNavigationEditing(e){if(e.isComposing)return void console.log("nothing to do for composing");console.log("keydown(SP):",e.key);const n=document.getSelection(),[t,o]=n.isCollapsed?CorrectFocusToText(n.focusNode,n.focusOffset):[n.focusNode,n.focusOffset];switch(e.key){case"ArrowUp":case"ArrowDown":if(n.isCollapsed){const n=CheckNodeInTD(document.getSelection().focusNode,e.currentTarget);if(console.log("keydown Up/Down, td: ",n),n){let t;(t="ArrowUp"===e.key?SwitchInputArrowUp(n):SwitchInputArrowDown(n))&&e.preventDefault()}}break;case"ArrowLeft":SwitchInputArrowLeft(t,o,e.getModifierState("Shift"))&&e.preventDefault();break;case"ArrowRight":SwitchInputArrowRight(t,o,e.getModifierState("Shift"))&&e.preventDefault();break;case"Enter":console.log("keydown fook: "+e.key+"focus:"+o),n.isCollapsed?(e.preventDefault(),SwitchInputEnter(t,o,e.getModifierState("Shift"))):e.preventDefault();break;case"Delete":console.log("keydown fook: "+e.key+"focus:"+o),e.preventDefault(),n.isCollapsed?SwitchInputDelete(t,o,e.getModifierState("Shift")):CutSelection(e.currentTarget,n);break;case"Backspace":console.log("keydown fook: "+e.key+"focus:"+o),e.preventDefault(),n.isCollapsed?SwitchInputBackspace(t,o,e.getModifierState("Shift")):CutSelection(e.currentTarget,n);break;case"Tab":e.preventDefault(),e.getModifierState("Shift")?(console.log("keydown fook: Shift + Tab, focus:"+o),SwitchInputShiftTab(t,o)):(console.log("keydown fook: Tab, focus:"+o),SwitchInputTab(t,o))}}function OnKeydownForAsciiChar(e){e.getModifierState("Control")||e.getModifierState("Alt")||e.getModifierState("Meta")||(console.log("keydown(Ascii):",e.key),TryInputAsciiChar(e.key)&&e.preventDefault())}function TryInputAsciiChar(e){const n=document.getSelection();let[t,o]=CorrectFocusToText(n.focusNode,n.focusOffset);switch(e){case"$":case"`":case"*":case"_":if(n.isCollapsed)SwitchInputMath(e,t,o);else{const[i,d]=CorrectFocusToText(n.anchorNode,n.anchorOffset);SwitchInputMathSelection(e,t,o,i,d)}return console.log("keydown: "+e+", make math"),!0;case" ":if(n.isCollapsed){SwitchInputSpace(t,o)||SwitchInputChar(e,t,o)}return!0;case"|":if(n.isCollapsed){SwitchInputBar(t,o)||SwitchInputChar(e,t,o)}return!0;case"^":if(n.isCollapsed){SwitchInputHat(t,o)||SwitchInputChar(e,t,o)}return!0;case"(":if(n.isCollapsed){SwitchInputRoundBra(t,o)||SwitchInputChar(e,t,o)}return!0;default:if(console.log("keydown: "+e),e&&1===e.length)return n.isCollapsed||(CutSelection(event.currentTarget,n),[t,o]=CorrectFocusToText(n.focusNode,n.focusOffset)),SwitchInputChar(e,t,o),!0}return!1}function OnBeforeinputForAsciiChar(e){"insertText"===e.inputType&&TryInputAsciiChar(e.data)&&e.preventDefault()}function SwitchInputChar(e,n,t){if(null===n)return!1;if(n.nodeType===Node.TEXT_NODE){if(IsTextNodeInMath(n)){const e=GetEditMargin(n.parentNode.parentNode);if(t<e)return!0;if(t>n.length-e)return!0}else if(n.data==nt_ZWBR)return undo_man.Begin(n,t),InsertTextIntoText(e,n,1),DeleteText(n,0,1),undo_man.End(n,e.length),document.getSelection().collapse(n,e.length),!0;return undo_man.Begin(n,t),InsertTextIntoText(e,n,t),undo_man.End(n,t+e.length),document.getSelection().collapse(n,t+e.length),!0}switch(n.tagName){case"P":case"LI":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"FIGCAPTION":case"TH":case"TD":{const o=n.childNodes.length;if(0===t&&"BR"===n.firstChild.nodeName){const o=n.firstChild;if((e=>null===e.nextSibling||("OL"===e.nextSibling.nodeName||"UL"===e.nextSibling.nodeName))(o)){undo_man.Begin(n,t);const i=AddTextNode(e,n,o);return RemoveNode(o),undo_man.End(i,i.length),document.getSelection().collapse(i,i.length),!0}}if(t>0){let o=n.childNodes.item(t-1);if(o.nodeType===Node.TEXT_NODE)return undo_man.Begin(o,o.length),InsertTextIntoText(e,o,o.length),undo_man.End(o,o.length),document.getSelection().collapse(o,o.length),!1}if(t<o){let o=n.childNodes.item(t);if(o.nodeType===Node.TEXT_NODE)return undo_man.Begin(o,0),InsertTextIntoText(e,o,0),undo_man.End(o,e.length),document.getSelection().collapse(o,e.length),!1}undo_man.Begin(n,t);let i=n.childNodes.item(t),d=AddTextNode(e,n,i);return IsSpanMathRef(i)&&ConvertMathRefToCite(i),undo_man.End(d,d.length),document.getSelection().collapse(d,d.length),!0}default:alert("ERROR: InputChar at "+n.tagName)}return!1}function FillTdBr(e,n,t){for(;e.childNodes.length<t;){AddNode("BR",AddNode(n,e,null),null)}}function SwitchInputEnter(e,n,t){if(null===e)return!0;let o=!1;if(e.nodeType===Node.TEXT_NODE)switch(e.parentNode.tagName){case"P":case"LI":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"FIGCAPTION":case"TH":case"TD":0===n?(console.log("go to divide node: "+e.parentNode.tagName),undo_man.Begin(e,n),o=!0,n=GetIndex(e.parentNode,e),e=e.parentNode):n===e.length?(console.log("go to divide node: "+e.parentNode.tagName),undo_man.Begin(e,n),o=!0,n=GetIndex(e.parentNode,e)+1,e=e.parentNode):(undo_man.Begin(e,n),o=!0,DivideTextNode(e,n),n=GetIndex(e.parentNode,e)+1,e=e.parentNode);break;case"SPAN":if(IsTextNodeInMath(e)){const t=e.parentNode.parentNode;if("editmathdisp"==e.parentNode.className||"editcodedisp"==e.parentNode.className){const o=GetEditMargin(t);if(o<=n&&n<=e.length-o)return undo_man.Begin(e,n),InsertTextIntoText("\n",e,n),undo_man.End(e,n+1),document.getSelection().collapse(e,n+1),!0}}return!0;default:return!0}switch(e.tagName){case"P":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":{if(o||undo_man.Begin(e,n),0===n){return AddNode("BR",AddNode("P",e.parentNode,e),null),undo_man.End(e,0),document.getSelection().collapse(e,0),!0}if(e.childNodes.length===n){const n=AddNode("P",e.parentNode,e.nextSibling);return AddNode("BR",n,null),undo_man.End(n,0),document.getSelection().collapse(n,0),!0}const t=AddNode("P",e.parentNode,e.nextSibling);let i=SafePushNodeList(t,SafeRemoveNodeList(e,e.childNodes.item(n)));if(t.firstChild.nodeType===Node.TEXT_NODE&&t.firstChild.data==nt_ZWBR)if(IsSpanMathImg(t.firstChild.nextSibling)){ConvertPtoFigure(t)}else IsSpanMathCite(t.firstChild.nextSibling)&&ConvertMathCiteToRef(t.firstChild.nextSibling);document.getSelection().collapse(i.node,i.offset),undo_man.End(i.node,i.offset)}break;case"LI":{if(o||undo_man.Begin(e,n),0===n){if(null===e.previousSibling){if("DIV"===e.parentNode.parentNode.nodeName){return AddNode("BR",AddNode("P",e.parentNode.parentNode,e.parentNode),null),undo_man.End(e,0),document.getSelection().collapse(e,0),!0}}else if(null===e.nextSibling&&"BR"===e.firstChild.nodeName&&null===e.firstChild.nextSibling&&"DIV"===e.parentNode.parentNode.nodeName){const n=AddNode("P",e.parentNode.parentNode,e.parentNode.nextSibling);return AddNode("BR",n,null),undo_man.End(n,0),document.getSelection().collapse(n,0),!0}return AddNode("BR",AddNode("LI",e.parentNode,e),null),undo_man.End(e,0),document.getSelection().collapse(e,0),!0}if(e.childNodes.length===n){const n=AddNode("LI",e.parentNode,e.nextSibling);return AddNode("BR",n,null),undo_man.End(n,0),document.getSelection().collapse(n,0),!0}{const t=e.childNodes.item(n);"OL"!==t.nodeName&&"UL"!==t.nodeName||AddNode("BR",e,t)}const t=SafePushNodeList(AddNode("LI",e.parentNode,e.nextSibling),SafeRemoveNodeList(e,e.childNodes.item(n)));undo_man.End(t.node,t.offset),document.getSelection().collapse(t.node,t.offset)}break;case"FIGCAPTION":{o||undo_man.Begin(e,n);const t=e.parentNode;if(0===n){const n=AddNode("P",t.parentNode,t.nextSibling);return SafePushNodeList(n,RemoveNodeList(e,e.firstChild,null)),AddNode("BR",e,null),undo_man.End(n,0),document.getSelection().collapse(n,0),!0}e.childNodes.length===n&&AddNode("BR",e,null);const i=SafePushNodeList(AddNode("P",t.parentNode,t.nextSibling),SafeRemoveNodeList(e,e.childNodes.item(n),null));document.getSelection().collapse(i.node,i.offset),undo_man.End(i.node,i.offset)}break;case"FIGURE":if(0===n){const n=AddNode("P",e.parentNode,e);AddNode("BR",n,null),undo_man.End(n,0),document.getSelection().collapse(n,0)}else{undo_man.Cancel();const n=FocusOffsetZero(e.lastChild);n&&document.getSelection().collapse(n.node,n.offset)}break;case"TH":if(!t){const t=e.parentNode.parentNode;if(null===t.previousSibling){o||undo_man.Begin(e,n);const i=AddNode("P",t.parentNode,t);return AddNode("BR",i,null),undo_man.End(i,0),document.getSelection().collapse(i,0),!0}}if(o)return undo_man.Cancel(),!0;break;case"TD":{if(o||undo_man.Begin(e,n),!t){const n=e.parentNode.parentNode;if(null===n.nextSibling){const e=AddNode("P",n.parentNode,null);return AddNode("BR",e,null),undo_man.End(e,0),document.getSelection().collapse(e,0),!0}break}const i=e.parentNode,d=i.parentNode;if(i===d.firstChild.nextSibling)return undo_man.Cancel(),!0;const a=AddNode("TR",d,i.nextSibling);if(n<e.childNodes.length){const t=SafeRemoveNodeList(e,e.childNodes.item(n),null);SafePushNodeList(AddNode(e.tagName,a,null),t),e.hasChildNodes()||AddNode("BR",e,null)}if(e!==i.lastChild){AddNodeList(a,null,RemoveNodeList(i,e.nextSibling,null))}const l=d.firstChild.childNodes.length;FillTdBr(i,"TD",l),FillTdBr(a,"TD",l);const s=FocusOffsetZero(a);return undo_man.End(s.node,s.offset),document.getSelection().collapse(s.node,s.offset),!0}default:alert("ERROR: InputEnter at "+e.nodeName),undo_man.Cancel()}return undo_man.Cancel(),!0}function SwitchInputDelete(e,n,t){if(null===e)return;let o=!1;if(e.nodeType===Node.TEXT_NODE)switch(e.parentNode.tagName){case"P":case"LI":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"FIGCAPTION":case"FIGURE":case"TH":case"TD":if(e.data==nt_ZWBR&&(n=1),n!==e.length){undo_man.Begin(e,n);const t=SafeDeleteInTextNode(e,n);return void(t?(undo_man.End(t.node,t.offset),document.getSelection().collapse(t.node,t.offset)):undo_man.Cancel())}if(null===e.nextSibling)console.log("go to parent: "+e.parentNode.tagName),undo_man.Begin(e,n),o=!0,n=(e=e.parentNode).childNodes.length;else{if(e.nextSibling.nodeType===Node.TEXT_NODE)return undo_man.Begin(e,n),CombineTextNode(e),DeleteText(e,n),undo_man.End(e,n),void document.getSelection().collapse(e,n);if("math"===e.nextSibling.className){const n=EnableMathEdit(e.nextSibling,1);return void document.getSelection().collapse(n.node,n.offset)}console.log("go to  parent: "+e.parentNode.tagName),undo_man.Begin(e,n),o=!0,n=GetIndex(e.parentNode,e)+1,e=e.parentNode}break;case"SPAN":if(IsTextNodeInMath(e)){const t=e.parentNode.parentNode,o=GetEditMargin(t);if(n===e.length){n=GetIndex(e=t.parentNode,t)+1;break}if(n===e.length-1)return void SwitchInputArrowRight(e,n,!1);if(n<o||e.length-o<=n){if("editem2"===e.parentNode.className||"editem3"===e.parentNode.className){const t=e.data.slice(0,1);undo_man.Begin(e,n);let i=e.parentNode.parentNode,d=AddMathNode(t.repeat(o-1),i.parentNode,i);console.log("inline em and strong is rank down: ",d),d&&(InsertTextIntoText(e.data.slice(o,e.length-o),d.lastChild.lastChild,o-1),RemoveNode(i));const a=EnableMathEdit(d,n<o?n:n-1);return document.getSelection().collapse(a.node,a.offset),void undo_man.End(a.node,a.offset)}return void document.getSelection().collapse(e,n+1)}{undo_man.Begin(e,n);const t=SafeDeleteInTextNode(e,n);return void(t?(undo_man.End(t.node,t.offset),document.getSelection().collapse(t.node,t.offset)):undo_man.Cancel())}}break;default:return}if(e.hasChildNodes()){const t=e.childNodes.item(n);t&&t.nodeType===Node.TEXT_NODE&&t.data==nt_ZWBR&&n++}switch(e.tagName){case"P":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":if(o||undo_man.Begin(e,n),"BR"===e.firstChild.nodeName&&null===e.firstChild.nextSibling){if(null===e.nextSibling)return void undo_man.Cancel();const n=e.nextSibling;return RemoveNode(e),void(n.firstChild.nodeType===Node.TEXT_NODE?(undo_man.End(n.firstChild,0),document.getSelection().collapse(n.firstChild,0)):"OL"===n.tagName||"UL"===n.tagName?(undo_man.End(n.firstChild,0),document.getSelection().collapse(n.firstChild,0)):(undo_man.End(n,0),document.getSelection().collapse(n,0)))}if(n<e.childNodes.length){let t=e.childNodes.item(n);if(t.nodeType===Node.TEXT_NODE){const e=SafeDeleteInTextNode(t,0);e?(undo_man.End(e.node,e.offset),document.getSelection().collapse(e.node,e.offset)):undo_man.Cancel()}else if("BR"===t.nodeName)RemoveNode(t),undo_man.End(e,n),document.getSelection().collapse(e,n);else if("math"===t.className){const e=EnableMathEdit(t,1);document.getSelection().collapse(e.node,e.offset)}else"OL"===t.tagName||"UL"===t.tagName?alert("ERROR: p node cannot have a child of ol/ul."):alert("ERROR: delete key before undefined element")}else if(null===e.nextSibling)console.log("delete but EOF");else if("P"===e.nextSibling.tagName||"H1"===e.nextSibling.tagName||"H2"===e.nextSibling.tagName||"H3"===e.nextSibling.tagName||"H4"===e.nextSibling.tagName||"H5"===e.nextSibling.tagName||"H6"===e.nextSibling.tagName){const n=e.nextSibling.firstChild;IsSpanMathRef(n)&&ConvertMathRefToCite(n);const t=SafeCombineNode(e);t?(document.getSelection().collapse(t.node,t.offset),undo_man.End(t.node,t.offset)):undo_man.Cancel()}else if("OL"===e.nextSibling.tagName||"UL"===e.nextSibling.tagName){let t=e.nextSibling,o=t.firstChild,i=o.firstChild;if("BR"!==i.nodeName){for(;i&&"OL"!==i.nodeName&&"UL"!==i.nodeName;)i=i.nextSibling;const n=SafePushNodeList(e,RemoveNodeList(o,o.firstChild,i));if(i){AddNodeList(t,o,RemoveNodeList(i,i.firstChild))}return RemoveNode(o),t.hasChildNodes()||RemoveNode(t),undo_man.End(n.node,n.offset),document.getSelection().collapse(n.node,n.offset),!0}if(null===i.nextSibling)RemoveNode(o);else{const e=i.nextSibling;if("OL"!==e.nodeName&&"UL"!==e.nodeName)return alert("ERROR: li has some node after br"),void undo_man.Cancel();AddNodeList(t,o,RemoveNodeList(e,e.firstChild,null)),RemoveNode(o)}t.hasChildNodes()||RemoveNode(t),undo_man.End(e,n),document.getSelection().collapse(e,n)}else if("FIGURE"===e.nextSibling.tagName){const n=e.nextSibling;n.firstChild;let t=n.firstChild;for(;t&&"FIGCAPTION"!==t.nodeName;)t=t.nextSibling;let o=null;if(n.firstChild!==t){o=SafePushNodeList(e,RemoveNodeList(n,n.firstChild,t))}if(t){const n=SafePushNodeList(e,RemoveNodeList(t,t.firstChild,null));null===o&&(o=n)}RemoveNode(n),document.getSelection().collapse(o.node,o.offset),undo_man.End(o.node,o.offset)}else alert("WARNING: delete key before undefined element");break;case"LI":if(o||undo_man.Begin(e,n),"BR"===e.firstChild.nodeName){if(e.firstChild.nextSibling){const n=e.firstChild.nextSibling;if("OL"!==n.nodeName&&"UL"!==n.nodeName)return alert("ERROR: li has some node after br"),void undo_man.Cancel();let t=RemoveNodeList(n,n.firstChild,null);const o=AddNodeList(e.parentNode,e,t);return RemoveNode(e),undo_man.End(o,0),void document.getSelection().collapse(o,0)}n++}if(n<e.childNodes.length){let t=e.childNodes.item(n);if(t.nodeType===Node.TEXT_NODE){const e=SafeDeleteInTextNode(t,0);e?(undo_man.End(e.node,e.offset),document.getSelection().collapse(e.node,e.offset)):undo_man.Cancel()}else if("math"===t.className){const e=EnableMathEdit(t,1);document.getSelection().collapse(e.node,e.offset),undo_man.Cancel()}else"OL"===t.tagName||"UL"===t.tagName?(RaiseFirstLi(t),undo_man.End(e,n),document.getSelection().collapse(e,n)):(alert("ERROR: delete key before undefined element"),undo_man.Cancel())}else if(e.nextSibling){if("LI"!==e.nextSibling.nodeName)return alert("WARNING: delete key before undefined element"),void undo_man.Cancel();const n=SafeCombineNode(e);n?(document.getSelection().collapse(n.node,n.offset),undo_man.End(n.node,n.offset)):undo_man.Cancel()}else{console.log("delete end of ol/ul");let t=e.parentNode;if(t.nextSibling)if("P"===t.nextSibling.nodeName){const n=t.nextSibling,o=RemoveNodeList(t.nextSibling,t.nextSibling.firstChild);RemoveNode(n);const i=SafePushNodeList(e,o);i?(document.getSelection().collapse(i.node,i.offset),undo_man.End(i.node,i.offset)):undo_man.Cancel()}else if("OL"===t.nextSibling.nodeName||"UL"===t.nextSibling.tagName){let o=RemoveNodeList(t.nextSibling,t.nextSibling.firstChild);AddNodeList(t,e.nextSibling,o),RemoveNode(t.nextSibling),undo_man.End(e,n),document.getSelection().collapse(e,n)}else if("FIGURE"===t.nextSibling.nodeName){const n=t.nextSibling;n.firstChild;let o=n.firstChild;for(;o&&"FIGCAPTION"!==o.nodeName;)o=o.nextSibling;let i=null;if(n.firstChild!==o){i=SafePushNodeList(e,RemoveNodeList(n,n.firstChild,o))}if(o&&"FIGCAPTION"===o.nodeName){const n=SafePushNodeList(e,RemoveNodeList(o,o.firstChild,null));null===i&&(i=n)}RemoveNode(n),undo_man.End(i.node,i.offset),document.getSelection().collapse(i.node,i.offset)}else console.log("nothing to do: "+t.nextSibling.tagName);else{let o=e.parentNode.parentNode;if("LI"===o.tagName&&o.nextSibling){let i=RemoveNodeList(o.parentNode,o.nextSibling,o.nextSibling.nextSibling);AddNodeList(t,e.nextSibling,i),undo_man.End(e,n),document.getSelection().collapse(e,n)}}}break;case"FIGCAPTION":if(o||undo_man.Begin(e,n),"BR"===e.firstChild.nodeName&&null===e.firstChild.nextSibling&&(n=1),n<e.childNodes.length){let t=e.childNodes.item(n);if(t.nodeType===Node.TEXT_NODE){const e=SafeDeleteInTextNode(t,0);e?(undo_man.End(e.node,e.offset),document.getSelection().collapse(e.node,e.offset)):undo_man.Cancel()}else if("BR"===t.nodeName)RemoveNode(t),undo_man.End(e,n),document.getSelection().collapse(e,n);else if("math"===t.className){const e=EnableMathEdit(t,1);document.getSelection().collapse(e.node,e.offset)}else"OL"===t.tagName||"UL"===t.tagName?alert("ERROR: figcaption node cannot have a child of ol/ul."):alert("ERROR: delete key before undefined element")}else{const n=e.parentNode.nextSibling;if(null===n)console.log("delete but EOF");else if("P"===n.tagName||"H1"===n.tagName||"H2"===n.tagName||"H3"===n.tagName||"H4"===n.tagName||"H5"===n.tagName||"H6"===n.tagName){const t=SafePushNodeList(e,RemoveNodeList(n,n.firstChild,null));RemoveNode(n),document.getSelection().collapse(t.node,t.offset),undo_man.End(t.node,t.offset)}else if("OL"===n.tagName||"UL"===n.tagName){let t=n,o=t.firstChild,i=o.firstChild;e.firstChild;for(;i&&"OL"!==i.nodeName&&"UL"!==i.nodeName;)i=i.nextSibling;let d=SafePushNodeList(e,RemoveNodeList(o,o.firstChild,i));if(i){AddNodeList(t,o,RemoveNodeList(i,i.firstChild))}RemoveNode(o),t.hasChildNodes()||RemoveNode(t),document.getSelection().collapse(d.node,d.offset),undo_man.End(d.node,d.offset)}else if("FIGURE"===n.tagName){const t=n;t.firstChild;let o=t.firstChild;for(;o&&"FIGCAPTION"!==o.nodeName;)o=o.nextSibling;let i=null;if(t.firstChild!==o){i=SafePushNodeList(e,RemoveNodeList(t,t.firstChild,o))}if(o&&"FIGCAPTION"===o.nodeName){const n=SafePushNodeList(e,RemoveNodeList(o,o.firstChild,null));null===i&&(i=n)}RemoveNode(t),undo_man.End(i.node,i.offset),document.getSelection().collapse(i.node,i.offset)}else alert("WARNING: delete key before undefined element")}break;case"TH":case"TD":if(o||undo_man.Begin(e,n),"BR"===e.firstChild.nodeName&&null===e.firstChild.nextSibling&&(n=1),n<e.childNodes.length){let t=e.childNodes.item(n);if(t.nodeType===Node.TEXT_NODE){const e=SafeDeleteInTextNode(t,0);e?(undo_man.End(e.node,e.offset),document.getSelection().collapse(e.node,e.offset)):undo_man.Cancel()}else if("BR"===t.nodeName)RemoveNode(t),undo_man.End(e,n),document.getSelection().collapse(e,n);else if("math"===t.className){const e=EnableMathEdit(t,1);document.getSelection().collapse(e.node,e.offset)}else"OL"===t.tagName||"UL"===t.tagName?alert("ERROR: td node cannot have a child of ol/ul."):alert("ERROR: delete key before undefined element")}else{if(!t)break;if(e.nextSibling){const n=e.nextSibling,t=SafePushNodeList(e,RemoveNodeList(n,n.firstChild,null));return RemoveNode(n),AddNode("BR",AddNode(e.tagName,e.parentNode,null),null),document.getSelection().collapse(t.node,t.offset),void undo_man.End(t.node,t.offset)}{const t=e.parentNode.nextSibling;if(t)return RemoveNode(t),undo_man.End(e,n),void document.getSelection().collapse(e,n)}}break;default:alert("ERROR: Delete at "+e.tagName)}undo_man.Cancel()}function SafeDeleteInTextNode(e,n){if(e.data==nt_ZWBR)return console.error("tring to delete ZWBR"),null;if(1===e.length){const n=e.parentNode,t=e.nextSibling;return RemoveNode(e),SafeJunctionPoint(n,t)}return DeleteText(e,n),{node:e,offset:n}}function GetIdealFocus(e,n){if(e.nodeType===Node.TEXT_NODE)return[e,n];if(e.previousSibling&&0===n&&e.previousSibling.nodeType===Node.TEXT_NODE)return[e.previousSibling,e.previousSibling.length];if(e.hasChildNodes()){const t=e.childNodes.item(n);if(t){if(t.nodeType===Node.TEXT_NODE)return[t,0];{const e=t.previousSibling;return e&&e.nodeType===Node.TEXT_NODE?[e,e.length]:GetIdealFocus(t.firstChild,0)}}{const t=e.childNodes.item(n-1);return t.nodeType===Node.TEXT_NODE?[t,t.length]:t.hasChildNodes()?GetIdealFocus(t,t.childNodes.length):[e,n-1]}}return[e.parentNode,GetIndex(e.parentNode,e)]}function RaiseFirstLi(e){const n=e.firstChild;if(1!==n.childNodes.length||"BR"!==n.firstChild.nodeName){const t=SafeRemoveNodeList(n,n.firstChild),o=AddNodeList(e.parentNode,e,t);SafeJunctionPoint(e.parentNode,o),SafeJunctionPoint(e.parentNode,e)}RemoveNode(n),e.hasChildNodes()||RemoveNode(e)}function LastFocusInList(e){let n=e.lastChild;for(;"OL"===n.lastChild.nodeName||"UL"===n.lastChild.nodeName;)n=n.lastChild.lastChild;return n.lastChild.nodeType===Node.TEXT_NODE?[n.lastChild,n.lastChild.length]:[n,n.childNodes.length]}function SwitchInputBackspace(e,n,t){if(null===e)return;let o=!1;if(e.nodeType===Node.TEXT_NODE)switch(e.parentNode.tagName){case"P":case"LI":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"FIGCAPTION":case"FIGURE":case"TH":case"TD":if(e.data==nt_ZWBR&&(n=0),n>0){undo_man.Begin(e,n);const t=SafeDeleteInTextNode(e,n-1);return void(t?(undo_man.End(t.node,t.offset),document.getSelection().collapse(t.node,t.offset)):undo_man.Cancel())}if(null===e.previousSibling)console.log("go to parent: "+e.parentNode.tagName),undo_man.Begin(e,n),o=!0,e=e.parentNode,n=0;else{if(e.previousSibling.nodeType===Node.TEXT_NODE){undo_man.Begin(e,n);const t=e.previousSibling,o=e.previousSibling.length-1;return CombineTextNode(t),DeleteText(t,o),undo_man.End(t,o),void document.getSelection().collapse(t,o)}if("math"===e.previousSibling.className){const n=EnableMathEdit(e.previousSibling,-1);return void document.getSelection().collapse(n.node,n.offset)}console.log("go to  parent: "+e.parentNode.tagName),undo_man.Begin(e,n),o=!0,n=GetIndex(e.parentNode,e)-1,e=e.parentNode}break;case"SPAN":if(IsTextNodeInMath(e)){const t=e.parentNode.parentNode,o=GetEditMargin(t);if(0===n){n=GetIndex(e=t.parentNode,t);break}if(1===n)return void SwitchInputArrowLeft(e,n,!1);if(n<=o||e.length-o<n){if("editem2"===e.parentNode.className||"editem3"===e.parentNode.className){const t=e.data.slice(0,1);undo_man.Begin(e,n);let i=e.parentNode.parentNode,d=AddMathNode(t.repeat(o-1),i.parentNode,i);console.log("inline em and strong is rank down: ",d),d&&(InsertTextIntoText(e.data.slice(o,e.length-o),d.lastChild.lastChild,o-1),RemoveNode(i));const a=EnableMathEdit(d,n<=o?n-1:n-2);return document.getSelection().collapse(a.node,a.offset),void undo_man.End(a.node,a.offset)}return void document.getSelection().collapse(e,n-1)}{undo_man.Begin(e,n);const t=SafeDeleteInTextNode(e,n-1);return void(t?(undo_man.End(t.node,t.offset),document.getSelection().collapse(t.node,t.offset)):undo_man.Cancel())}}break;default:return}if(e.hasChildNodes()){const t=e.childNodes.item(n-1);t&&t.nodeType===Node.TEXT_NODE&&t.data==nt_ZWBR&&n--}switch(e.tagName){case"P":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":if(o||undo_man.Begin(e,n),"BR"===e.firstChild.nodeName&&null===e.firstChild.nextSibling){if(null===e.previousSibling)return void undo_man.Cancel();const n=e.previousSibling;RemoveNode(e);let t=null,o=0;return n.lastChild.nodeType===Node.TEXT_NODE?(t=n.lastChild,o=n.lastChild.length):"OL"===n.nodeName||"UL"===n.nodeName?[t,o]=LastFocusInList(n):(t=n,o=n.childNodes.length,"BR"===n.lastChild.nodeName&&o--),undo_man.End(t,o),void document.getSelection().collapse(t,o)}if(n>0){let t=e.childNodes.item(n-1);if(t.nodeType===Node.TEXT_NODE){const e=SafeDeleteInTextNode(t,t.length-1);e?(undo_man.End(e.node,e.offset),document.getSelection().collapse(e.node,e.offset)):undo_man.Cancel()}else if("BR"===t.tagName)RemoveNode(t),undo_man.End(e,n-1),document.getSelection().collapse(e,n-1);else if("math"===t.className){const e=EnableMathEdit(t,-1);document.getSelection().collapse(e.node,e.offset),undo_man.Cancel()}else"OL"===t.tagName||"UL"===t.tagName?(alert("ERROR: p node cannot have a child of ol/ul."),undo_man.Cancel()):(alert("ERROR: delete key before undefined element"),undo_man.Cancel())}else{let n=e.previousSibling;if(null===n)return console.log("backspace but BOF"),void undo_man.Cancel();if("P"===n.tagName||"H1"===n.tagName||"H2"===n.tagName||"H3"===n.tagName||"H4"===n.tagName||"H5"===n.tagName||"H6"===n.tagName){IsSpanMathRef(e.firstChild)&&"P"===n.tagName&&"BR"!=n.lastChild.nodeName&&ConvertMathRefToCite(e.firstChild);const t=SafeCombineNode(n);document.getSelection().collapse(t.node,t.offset),undo_man.End(t.node,t.offset)}else if("OL"===e.previousSibling.tagName||"UL"===e.previousSibling.tagName){let n=e.previousSibling.lastChild;for(;"OL"===n.lastChild.nodeName||"UL"===n.lastChild.nodeName;)n=n.lastChild.lastChild;const t=RemoveNodeList(e,e.firstChild);IsSpanMathRef(t.firstChild)&&ConvertMathRefToCite(t.firstChild);const o=SafePushNodeList(n,t);RemoveNode(e),document.getSelection().collapse(o.node,o.offset),undo_man.End(o.node,o.offset)}else if("FIGURE"===e.previousSibling.nodeName){const n=e.previousSibling.lastChild,t=RemoveNodeList(e,e.firstChild,null);IsSpanMathRef(t.firstChild)&&ConvertMathRefToCite(t.firstChild);const o=SafePushNodeList(n,t);RemoveNode(e),undo_man.End(o.node,o.offset),document.getSelection().collapse(o.node,o.offset)}else alert("WARNING: delete key before undefined element"),undo_man.Cancel()}break;case"LI":if(o||undo_man.Begin(e,n),n>0&&"BR"===e.childNodes.item(n-1).nodeName&&n--,!(n>0))return undo_man.Cancel(),void SwitchInputShiftTab(e,n);{let t=e.childNodes.item(n-1);if(t.nodeType===Node.TEXT_NODE){const e=SafeDeleteInTextNode(t,t.length-1);e?(undo_man.End(e.node,e.offset),document.getSelection().collapse(e.node,e.offset)):undo_man.Cancel()}else if("math"===t.className){const e=EnableMathEdit(t,-1);document.getSelection().collapse(e.node,e.offset)}else{if("OL"!==t.tagName&&"UL"!==t.tagName)return alert("ERROR: backspace key after undefined element"),void undo_man.Cancel();{const o=SafePushNodeList(t.lastChild,SafeRemoveNodeList(e,e.childNodes.item(n)));document.getSelection().collapse(o.node,o.offset),undo_man.End(o.node,o.offset)}}}break;case"FIGCAPTION":if(o||undo_man.Begin(e,n),"BR"===e.firstChild.nodeName&&null===e.firstChild.nextSibling&&(n=0),!(n>0)){let n=e.previousSibling;if(null===n)return undo_man.Cancel(),void alert("figure has no img tag");{const e=n;if("math"!==e.className)return alert("figure has no img tag"),void undo_man.Cancel();if("editimg"!==e.lastChild.className)return alert("figure has no img tag"),void undo_man.Cancel();const t=EnableMathEdit(e,-1);return document.getSelection().collapse(t.node,t.offset),void undo_man.Cancel()}}{let t=e.childNodes.item(n-1);if(t.nodeType===Node.TEXT_NODE){const e=SafeDeleteInTextNode(t,t.length-1);e?(undo_man.End(e.node,e.offset),document.getSelection().collapse(e.node,e.offset)):undo_man.Cancel()}else if("BR"===t.tagName)RemoveNode(t),undo_man.End(e,n-1),document.getSelection().collapse(e,n-1);else if("math"===t.className){const e=EnableMathEdit(t,-1);document.getSelection().collapse(e.node,e.offset),undo_man.Cancel()}else"OL"===t.tagName||"UL"===t.tagName?(alert("ERROR: figcaption node cannot have a child of ol/ul."),undo_man.Cancel()):(alert("ERROR: delete key before undefined element"),undo_man.Cancel())}break;case"TH":case"TD":if(o||undo_man.Begin(e,n),"BR"===e.firstChild.nodeName&&null===e.firstChild.nextSibling&&(n=0),n>0){let t=e.childNodes.item(n-1);if(t.nodeType===Node.TEXT_NODE){const e=SafeDeleteInTextNode(t,t.length-1);e?(undo_man.End(e.node,e.offset),document.getSelection().collapse(e.node,e.offset)):undo_man.Cancel()}else if("BR"===t.tagName)RemoveNode(t),undo_man.End(e,n-1),document.getSelection().collapse(e,n-1);else if("math"===t.className){const e=EnableMathEdit(t,-1);document.getSelection().collapse(e.node,e.offset),undo_man.Cancel()}else"OL"===t.tagName||"UL"===t.tagName?(alert("ERROR: td node cannot have a child of ol/ul."),undo_man.Cancel()):(alert("ERROR: delete key before undefined element"),undo_man.Cancel())}else{if(!t)break;let n=e.previousSibling;if(n){const e=SafeCombineNode(n);return AddNode("BR",AddNode(n.tagName,n.parentNode,null),null),document.getSelection().collapse(e.node,e.offset),void undo_man.End(e.node,e.offset)}{const n=e.parentNode.previousSibling;if(n){RemoveNode(e.parentNode);const t=FocusOffsetLast(n);return undo_man.End(t.node,t.offset),void document.getSelection().collapse(t.node,t.offset)}}}break;default:alert("ERROR: Delete at "+e.tagName),undo_man.Cancel()}undo_man.Cancel()}function SwitchInputArrowRight(e,n,t){if(null===e)return!0;if(t)return SwitchInputArrowRightShift(e,n);if(e.nodeType===Node.TEXT_NODE){if(IsTextNodeInMath(e)){const t=e.parentNode.parentNode;if(n>=e.length-1){const e=DisableEdit(t);if(e.removed)document.getSelection().collapse(e.focus.node,e.focus.offset);else if(null===t.nextSibling)console.error("math.nextSibling is null");else if(t.nextSibling.nodeType===Node.TEXT_NODE)t.nextSibling.data==nt_ZWBR?document.getSelection().collapse(t.nextSibling,1):document.getSelection().collapse(t.nextSibling,0);else{const e=FocusOffsetZero(t.nextSibling);e?(e.node.nodeType===Node.TEXT_NODE&&e.node.data==nt_ZWBR&&(e.offset=1),document.getSelection().collapse(e.node,e.offset)):console.error("math.nextSibling cannot has focus")}return!0}return!1}if(e.data==nt_ZWBR&&(n=1),n!==e.length)return!1;console.log("end of text node"),n=GetIndex(e.parentNode,e)+1,e=e.parentNode}switch(e.nodeName){case"P":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"LI":case"FIGCAPTION":case"FIGURE":case"TH":case"TD":{let t=e.childNodes.item(n);if(t){if(t.nodeType===Node.TEXT_NODE)return document.getSelection().collapse(t,1),!0;if("math"===t.className){const e=EnableMathEdit(t,1);return document.getSelection().collapse(e.node,e.offset),!0}if("BR"!=t.nodeName){const e=FocusOffsetZero(t);return e?document.getSelection().collapse(e.node,e.offset):console.error("cannot find focus position"),!0}e=t}let o=e;for(;null===o.nextSibling;)if("DIV"===(o=o.parentNode).tagName)return!0;const i=FocusOffsetZero(o.nextSibling);return i?document.getSelection().collapse(i.node,i.offset):console.error("cannot find focus position"),!0}}return!1}function SwitchInputArrowRightShift(e,n){if(null===e)return!0;if(e.nodeType===Node.TEXT_NODE)if(IsTextNodeInMath(e)){const t=e.parentNode.parentNode,o=GetEditMargin(t);if(n>=e.length-o){if(console.log("end of math text node"),document.getSelection().anchorNode===t.lastChild.firstChild){const e=DisableEdit(t);if(e.removed)document.getSelection().collapse(e.focus.node,e.focus.offset);else{const e=GetIndex(t.parentNode,t);document.getSelection().setBaseAndExtent(t.parentNode,e,t.parentNode,e+1)}}else{const e=DisableEdit(t);if(e.removed)document.getSelection().extend(e.focus.node,e.focus.offset);else{const e=GetIndex(t.parentNode,t);document.getSelection().extend(t.parentNode,e+1)}}return!0}if(0!==n)return document.getSelection().extend(e,n+1),!0;{const o=DisableEdit(t);if(o.removed)return document.getSelection().extend(o.focus.node,o.focus.offset),!0;n=GetIndex(t.parentNode,t),e=t.parentNode}}else{if(e.data==nt_ZWBR&&(n=1),n!==e.length)return document.getSelection().extend(e,n+1),!0;console.log("end of text node"),n=GetIndex(e.parentNode,e)+1,e=e.parentNode}switch(e.nodeName){case"P":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"LI":case"FIGCAPTION":case"FIGURE":case"TH":case"TD":{const t=e.childNodes.item(n);if(t){if(t.nodeType===Node.TEXT_NODE)return document.getSelection().extend(t,1),!0;if("SPAN"==t.nodeName)return document.getSelection().extend(e,n+1),!0;if("BR"!=t.nodeName){const e=FocusOffsetZero(t,!1);return e?document.getSelection().extend(e.node,e.offset):console.error("cannot find focus position",t),!0}e=t}let o=e;for(;null===o.nextSibling;)if("DIV"===(o=o.parentNode).tagName)return!0;const i=FocusOffsetZero(o.nextSibling,!1);return i?document.getSelection().extend(i.node,i.offset):console.error("cannot find focus position",o.nextSibling),!0}}return!1}function FocusOffsetZero(e,n=!0){for(;e;){if(e.nodeType===Node.TEXT_NODE)return{node:e,offset:0};if(null===e.firstChild)return{node:e.parentNode,offset:GetIndex(e.parentNode,e)};if("BR"===e.firstChild.nodeName)return{node:e,offset:0};if("math"===e.className)return n?EnableMathEdit(e,0):{node:e.parentNode,offset:GetIndex(e.parentNode,e)};e=e.firstChild}return null}function SwitchInputArrowLeft(e,n,t){if(null===e)return!0;if(t)return SwitchInputArrowLeftShift(e,n);if(e.nodeType===Node.TEXT_NODE){if(IsTextNodeInMath(e)){const t=e.parentNode.parentNode;if(n<=1){const e=DisableEdit(t);if(e.removed)document.getSelection().collapse(e.focus.node,e.focus.offset);else{const e=FocusOffsetLast(t.previousSibling);e?(e.node.nodeType===Node.TEXT_NODE&&e.node.data==nt_ZWBR&&(e.offset=0),document.getSelection().collapse(e.node,e.offset)):console.error("math.previousSibling cannot has focus",t.previousSibling)}return!0}return!1}if(e.data==nt_ZWBR&&(n=0),0!==n)return!1;console.log("begin of text node"),n=GetIndex(e.parentNode,e),e=e.parentNode}switch(e.tagName){case"P":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"LI":case"FIGCAPTION":case"FIGURE":case"TH":case"TD":{const t=e.childNodes.item(n-1);if(t){if(t.nodeType===Node.TEXT_NODE)return document.getSelection().extend(t,t.length-1),!0;if("math"===t.className){const e=EnableMathEdit(t,-1);return document.getSelection().collapse(e.node,e.offset),!0}if("BR"!=t.nodeName){const e=FocusOffsetLast(t);return e?document.getSelection().collapse(e.node,e.offset):console.error("cannot find focus position",t),!0}e=t}let o=e;for(;null===o.previousSibling;)if("DIV"===(o=o.parentNode).tagName)return!0;const i=FocusOffsetLast(o.previousSibling);return i?document.getSelection().collapse(i.node,i.offset):console.error("cannot find focus position",o.previousSibling),!0}}}function SwitchInputArrowLeftShift(e,n){if(null===e)return!0;if(e.nodeType===Node.TEXT_NODE)if(IsTextNodeInMath(e)){const t=e.parentNode.parentNode;if(n<=GetEditMargin(t)){if(console.log("begin of math text node"),document.getSelection().anchorNode===t.lastChild.firstChild){const e=DisableEdit(t);if(e.removed)document.getSelection().collapse(e.focus.node,e.focus.offset);else{const e=GetIndex(t.parentNode,t);document.getSelection().setBaseAndExtent(t.parentNode,e+1,t.parentNode,e)}}else{const e=DisableEdit(t);if(e.removed)document.getSelection().extend(e.focus.node,e.focus.offset);else{const e=GetIndex(t.parentNode,t);document.getSelection().extend(t.parentNode,e)}}return!0}if(n!==e.length)return document.getSelection().extend(e,n-1),!0;{const o=DisableEdit(t);if(o.removed)return document.getSelection().extend(o.focus.node,o.focus.offset),!0;n=GetIndex(t.parentNode,t),e=t.parentNode}}else{if(e.data==nt_ZWBR&&(n=0),0!==n)return document.getSelection().extend(e,n-1),!0;console.log("begin of text node"),n=GetIndex(e.parentNode,e),e=e.parentNode}switch(e.tagName){case"P":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"LI":case"FIGCAPTION":case"FIGURE":case"TH":case"TD":{const t=e.childNodes.item(n-1);if(t){if(t.nodeType===Node.TEXT_NODE)return document.getSelection().extend(t,t.length-1),!0;if("SPAN"==t.nodeName)return document.getSelection().extend(e,n-1),!0;if("BR"!=t.nodeName){const e=FocusOffsetLast(t,!1);return e?document.getSelection().extend(e.node,e.offset):console.error("cannot find focus position",t),!0}e=t}let o=e;for(;null===o.previousSibling;)if("DIV"===(o=o.parentNode).tagName)return!0;const i=FocusOffsetLast(o.previousSibling,!1);return i?document.getSelection().extend(i.node,i.offset):console.error("cannot find focus position",o.previousSibling),!0}}return!1}function FocusOffsetLast(e,n=!0){for(;e;){if(e.nodeType===Node.TEXT_NODE)return{node:e,offset:e.length};if(null===e.firstChild)return{node:e.parentNode,offset:GetIndex(e.parentNode,e)};if("BR"===e.firstChild.nodeName)return{node:e,offset:0};if("math"===e.className)return n?EnableMathEdit(e,-1):{node:e.parentNode,offset:GetIndex(e.parentNode,e)};e=e.lastChild}return null}function SwitchInputMath(e,n,t){if(null===n)return;let o;switch(e){case"$":o="editmath";break;case"`":o="editcode";break;case"*":case"_":o="editem";break;default:return}if(n.nodeType===Node.TEXT_NODE){if("SPAN"===n.parentNode.nodeName){if(n.parentNode.className.slice(0,n.parentNode.className.length-1)===o){const o=GetEditMarginByClassName(n.parentNode.className);if(t!==o&&t!==n.length-o)return;undo_man.Begin(n,t);let i=n.parentNode.parentNode,d=AddMathNode(e.repeat(o+1),i.parentNode,i);console.log("inline em and strong is rank up: ",d),d&&(InsertTextIntoText(n.data.slice(o,n.length-o),d.lastChild.lastChild,o+1),RemoveNode(i));const a=EnableMathEdit(d,t+1);return document.getSelection().collapse(a.node,a.offset),void undo_man.End(a.node,a.offset)}if(n.parentNode.className===o){const i=GetEditMarginByClassName(o+"disp");if(!(0<t&&t<i))return;if(n.length>=i&&n.data.slice(0,i-1)===e.repeat(i-1)){undo_man.Begin(n,t);let d=n.parentNode.parentNode,a=AddMathNode(e.repeat(i),d.parentNode,d);console.log("inline math to display math: ",a),a&&(InsertTextIntoText(n.data.slice(i-1,n.length-(i-1)),a.lastChild.lastChild,i+1),RemoveNode(d)),"editmath"===o&&SetEqNumber(a,1);const l=EnableMathEdit(a,i+1);return document.getSelection().collapse(l.node,l.offset),void undo_man.End(l.node,l.offset)}}return undo_man.Begin(n,t),InsertTextIntoText(e,n,t),undo_man.End(n,t+1),void document.getSelection().collapse(n,t+1)}{console.log("add inline ",o),undo_man.Begin(n,t);const i=n.parentNode;let d;const a=AddMathNode(e,i,d=0===t?n:t===n.length?n.nextSibling:DivideTextNode(n,t));IsTextNode(a.previousSibling)||AddTextNode(nt_ZWBR,i,a),IsTextNode(a.nextSibling)||AddTextNode(nt_ZWBR,i,a.nextSibling);const l=EnableMathEdit(a,1);return document.getSelection().collapse(l.node,l.offset),void undo_man.End(l.node,l.offset)}}switch(n.tagName){case"P":case"LI":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"FIGCAPTION":case"FIGURE":case"TH":case"TD":{let o=null;0===t&&"BR"===n.firstChild.nodeName&&(null===n.firstChild.nextSibling?o=n.firstChild:"UL"===n.firstChild.nextSibling.nodeName||"OL"===n.firstChild.nextSibling.nodeName?o=n.firstChild:console.error("invalid position of BR tag")),undo_man.Begin(n,t);let i=AddMathNode(e,n,n.childNodes.item(t));o&&RemoveNode(o),IsTextNode(i.previousSibling)||AddTextNode(nt_ZWBR,n,i),IsTextNode(i.nextSibling)||AddTextNode(nt_ZWBR,n,i.nextSibling);const d=EnableMathEdit(i,1);return document.getSelection().collapse(d.node,d.offset),void undo_man.End(d.node,d.offset)}default:alert("ERROR: InputChar at "+n.tagName)}}function SwitchInputMathSelection(e,n,t,o,i){if(null===n)return;if(n!==o)return;if(n.nodeType!==Node.TEXT_NODE)return;let d;switch(e){case"$":d="editmath";break;case"`":d="editcode";break;case"*":case"_":d="editem";break;case"**":case"_":d="editem";break;default:return}if(!IsTextNodeInMath(n)){console.log("change to math span: ",d),undo_man.Begin(n,t,o,i);const a=n.parentNode,[l,s]=i<t?[i,t]:[t,i];s<n.length&&DivideTextNode(n,s);const r=0==l?n:DivideTextNode(n,l),c=AddMathNode(e,a,r),f=c.lastChild.firstChild,_=GetEditMargin(c);InsertTextIntoText(r.data,f,_),RemoveNode(r),IsTextNode(c.previousSibling)||AddTextNode(nt_ZWBR,a,c),IsTextNode(c.nextSibling)||AddTextNode(nt_ZWBR,a,c.nextSibling);const u=EnableMathEdit(c,1);return document.getSelection().collapse(u.node,u.offset),void undo_man.End(u.node,u.offset)}}function SwitchInputSpace(e,n){if(null===e)return!1;const t=e=>"H1"<=e&&e<="H6";if(e.nodeType!==Node.TEXT_NODE){if("P"!==e.tagName&&!t(e.tagName))return!1;if(null===(e=e.childNodes.item(n-1)))return!1;n=e.length}if(e.nodeType===Node.TEXT_NODE){let o=e.parentNode;if("P"===o.tagName){if(e!==o.firstChild)return!1;const t=e.data.substring(0,n);let i,d,a="none";switch(t){case"-":case"*":case"+":a="UL";break;case"#":a="H1";break;case"##":a="H2";break;case"###":a="H3";break;case"####":a="H4";break;case"#####":a="H5";break;case"######":a="H6"}if("."===t[t.length-1]){a="OL";for(let e=0;e<t.length-1;++e)(t[e]<"0"||"9"<t[e])&&(a="none")}if("none"===a)return!1;if(undo_man.Begin(e,n),"UL"===a){i=AddNode("LI",AddNode(a,o.parentNode,o),null)}else if("OL"===a){i=AddNode("LI",AddNode(a,o.parentNode,o),null)}else i=AddNode(a,o.parentNode,o);if(e.length!==n&&DivideTextNode(e,n),e.nextSibling){d=SafePushNodeList(i,RemoveNodeList(o,e.nextSibling,null))}else AddNode("BR",i,null),d={node:i,offset:0};return RemoveNode(o),undo_man.End(d.node,d.offset),document.getSelection().collapse(d.node,d.offset),!0}if(t(o.tagName)){if(e!==o.firstChild)return!1;let t=0;switch(e.data.substring(0,n)){case"#":t=1;break;case"##":t=2;break;case"###":t=3;break;case"####":t=4;break;case"#####":t=5;break;case"######":t=6}if("none"===t)return!1;const i=parseInt(o.tagName.charAt(1),10);if((t+=i)>6&&(t=6),i===t)return!1;const d="H"+t.toString();undo_man.Begin(e,n);const a=AddNode(d,o.parentNode,o);let l;if(e.length!==n&&DivideTextNode(e,n),e.nextSibling){l=SafePushNodeList(a,RemoveNodeList(o,e.nextSibling,null))}else AddNode("BR",a,null),l={node:a,offset:0};return RemoveNode(o),undo_man.End(l.node,l.offset),document.getSelection().collapse(l.node,l.offset),!0}}return!1}function SwitchInputTab(e,n){if(null===e)return!1;if(n>0)return!1;if(e.nodeType===Node.TEXT_NODE){if(e.previousSibling)return!1;e=e.parentNode}if("SPAN"===e.nodeName){let t=e.parentNode;for(;"SPAN"===t.nodeName;)t=(e=t).parentNode;if((n=GetIndex(t,e))>0)return!1;e=t}if("LI"===e.nodeName){const t=e.previousSibling;if(null===t)return!1;undo_man.Begin(e,n);let o=null;return AddNodeList(o="OL"===t.lastChild.nodeName||"UL"===t.lastChild.nodeName?t.lastChild:AddNode(e.parentNode.tagName,t,null),null,RemoveNodeList(e.parentNode,e,e.nextSibling)),undo_man.End(e,0),document.getSelection().collapse(e,0),!0}if(e.nodeName>="H1"&&e.nodeName<"H6"){undo_man.Begin(e,n);const t=SafePushNodeList(AddNode("H"+(1+parseInt(e.nodeName.charAt(1),10)).toString(),e.parentNode,e),RemoveNodeList(e,e.firstChild));return RemoveNode(e),undo_man.End(t.node,t.offset),document.getSelection().collapse(t.node,t.offset),!0}return!1}function SwitchInputShiftTab(e,n){if(null===e)return!1;if(n>0)return!1;if(e.nodeType===Node.TEXT_NODE){if(e.previousSibling)return!1;e=e.parentNode}if("SPAN"===e.nodeName){let t=e.parentNode;for(;"SPAN"===t.nodeName;)t=(e=t).parentNode;if((n=GetIndex(t,e))>0)return!1;e=t}if("LI"===e.nodeName){undo_man.Begin(e,n);const t=e.parentNode.parentNode;if("LI"===t.nodeName){const n=t.nextSibling,o=t.parentNode,i=e.parentNode;if(e.nextSibling){const n=RemoveNodeList(i,e.nextSibling);"OL"!==e.lastChild.nodeName&&"UL"!==e.lastChild.nodeName&&AddNode(i.tagName,e,null),AddNodeList(e.lastChild,null,n)}AddNodeList(o,n,RemoveNodeList(i,e,e.nextSibling)),i.hasChildNodes()||RemoveNode(i),undo_man.End(e,0),document.getSelection().collapse(e,0)}else{const n=e.parentNode,o=AddNode("P",t,n.nextSibling),i=e.nextSibling?RemoveNodeList(n,e.nextSibling):null;let d=e.firstChild;for(;d&&"OL"!==d.nodeName&&"UL"!==d.nodeName;)d=d.nextSibling;const a=SafePushNodeList(o,RemoveNodeList(e,e.firstChild,d));if(d){const n=e.lastChild,a=RemoveNodeList(e,d);AddNodeList(t,o.nextSibling,a),i&&AddNodeList(n,null,i)}else if(i){AddNodeList(AddNode(n.tagName,t,o.nextSibling),null,i)}RemoveNode(e),n.hasChildNodes()||RemoveNode(n),o.firstChild.nodeType==Node.TEXT_NODE&&o.firstChild.data==nt_ZWBR&&(IsSpanMathImg(o.firstChild.nextSibling)?ConvertPtoFigure(o):IsSpanMathCite(o.firstChild.nextSibling)&&ConvertMathCiteToRef(o.firstChild.nextSibling)),document.getSelection().collapse(a.node,a.offset),undo_man.End(a.node,a.offset)}return!0}if(e.nodeName>"H1"&&e.nodeName<="H6"){undo_man.Begin(e,n);const t=SafePushNodeList(AddNode("H"+(parseInt(e.nodeName.charAt(1),10)-1).toString(),e.parentNode,e),RemoveNodeList(e,e.firstChild));return RemoveNode(e),undo_man.End(t.node,t.offset),document.getSelection().collapse(t.node,t.offset),!0}return!1}function SelectAll(e){document.getSelection().setBaseAndExtent(e.firstChild,0,e.lastChild,e.lastChild.childNodes.length)}function CorrectFocusToText(e,n){if(e.nodeType===Node.TEXT_NODE)return[e,n];if(!e.hasChildNodes())return[e.parentNode,GetIndex(e.parentNode,e)];if(e.childNodes.length<=n){for(;e.lastChild;)if((e=e.lastChild).nodeType===Node.TEXT_NODE)return[e,e.length];return[e.parentNode,e.parentNode.childNodes.length]}if("SPAN"===e.nodeName&&"math"===e.className){return[e.lastChild.firstChild,0]}for(e=e.childNodes.item(n);e.nodeType!==Node.TEXT_NODE;){if(!e.hasChildNodes())return[e.parentNode,n];if("SPAN"===e.nodeName&&"math"===e.className){return[e.lastChild.firstChild,0]}n=0,e=e.firstChild}return[e,0]}function IsSpanMathImg(e){return!!e&&("SPAN"===e.nodeName&&("math"===e.className&&"editimg"===e.lastChild.className))}function ConvertPtoFigure(e){const n=AddNode("FIGURE",e.parentNode,e);let t=e.firstChild;for(;t;){if(!IsSpanMathImg(t)){if(t.nodeType!==Node.TEXT_NODE)break;if(t.data!=nt_ZWBR)break}t=t.nextSibling}SafePushNodeList(n,RemoveNodeList(e,e.firstChild,t));const o=AddNode("FIGCAPTION",n,null);if(e.firstChild){SafePushNodeList(o,RemoveNodeList(e,e.firstChild,null))}else AddNode("BR",o,null);return RemoveNode(e),n}function ConvertFiguretoP(e){const n=AddNode("P",e.parentNode,e);let t=e.firstChild;for(;t&&"FIGCAPTION"!==t.nodeName;)t=t.nextSibling;if(e.firstChild!==t){SafePushNodeList(n,RemoveNodeList(e,e.firstChild,t))}if(t&&t.hasChildNodes()){SafePushNodeList(n,RemoveNodeList(t,t.firstChild,null))}return n.hasChildNodes()||AddNode("BR",n,null),RemoveNode(e),IsSpanMathCite(n.firstChild.nextSibling)&&ConvertMathCiteToRef(n.firstChild.nextSibling),n}function IsSpanMathCite(e){return!!e&&("SPAN"===e.nodeName&&("math"===e.className&&"editcite"===e.lastChild.className))}function ConvertMathCiteToRef(e){const n=new DocumentFragment,t=document.createElement("SPAN");t.className="previewref";const o=e.lastChild.firstChild.data;t.appendChild(document.createTextNode(o.slice(2,o.length-2))),n.appendChild(t);const i=document.createElement("SPAN");i.className="editref",i.appendChild(document.createTextNode(o.slice(0,o.length-1)+":")),n.appendChild(i),SetHide(n.lastChild),RemoveNode(e.firstChild),RemoveNode(e.firstChild),AddNodeList(e,null,n)}function IsSpanMathRef(e){return!!e&&("SPAN"===e.nodeName&&("math"===e.className&&"editref"===e.lastChild.className))}function ConvertMathRefToCite(e){const n=new DocumentFragment,t=document.createElement("A");t.className="previewcite";const o=e.lastChild.firstChild.data;t.appendChild(document.createTextNode(o.slice(2,o.length-2))),t.href="#"+o.slice(2,o.length-2),n.appendChild(t);const i=document.createElement("SPAN");i.className="editcite",i.appendChild(document.createTextNode(o.slice(0,o.length-1)+" ")),n.appendChild(i),SetHide(math.lastChild);e.nextSibling;RemoveNode(e.firstChild),RemoveNode(e.firstChild),AddNodeList(e,null,n)}function SwitchInputBar(e,n){if(null===e)return!1;let t=!1;if(e.nodeType===Node.TEXT_NODE)switch(e.parentNode.tagName){case"P":{if(0===n)return!1;const[t,o]=GetTableSize(e.data.slice(0,n));if(t<=0||o<=0)return!1;undo_man.Begin(e,n);const i=ConvertPtoTable(e.parentNode,t,o).firstChild.firstChild;return undo_man.End(i,0),document.getSelection().collapse(i,0),!0}case"TH":case"TD":0===n?(console.log("go to divide node: "+e.parentNode.tagName),undo_man.Begin(e,n),t=!0,n=GetIndex(e.parentNode,e),e=e.parentNode):n===e.length?(console.log("go to divide node: "+e.parentNode.tagName),undo_man.Begin(e,n),t=!0,n=GetIndex(e.parentNode,e)+1,e=e.parentNode):(undo_man.Begin(e,n),t=!0,DivideTextNode(e,n),n=GetIndex(e.parentNode,e)+1,e=e.parentNode);break;default:return!1}switch(e.tagName){case"TH":{t||undo_man.Begin(e,n);const o=e.parentNode;o.parentNode;let i,d=null;if(n<e.childNodes.length){const t=SafeRemoveNodeList(e,e.childNodes.item(n),null);i=SafePushNodeList(d=AddNode(e.tagName,e.parentNode,e.nextSibling),t),e.hasChildNodes()||AddNode("BR",e,null)}else AddNode("BR",d=AddNode(e.tagName,e.parentNode,e.nextSibling),null),i={node:d,offset:0};const a=GetIndex(o,e)+(0===n?0:1),l=o.nextSibling;{const e=l.childNodes.item(a),n=AddNode("TD",l,e);AddTextNode(e.firstChild.data,n,null)}for(let e=l.nextSibling;e;e=e.nextSibling){AddNode("BR",AddNode("TD",e,e.childNodes.item(a)),null)}return undo_man.End(i.node,i.offset),document.getSelection().collapse(i.node,i.offset),!0}case"TD":{t||undo_man.Begin(e,n);const o=e.parentNode,i=o.parentNode;if(o===i.firstChild.nextSibling)return undo_man.Cancel(),!0;let d,a=null;if(n<e.childNodes.length){const t=SafeRemoveNodeList(e,e.childNodes.item(n),null);d=SafePushNodeList(a=AddNode(e.tagName,e.parentNode,e.nextSibling),t),e.hasChildNodes()||AddNode("BR",e,null)}else AddNode("BR",a=AddNode(e.tagName,e.parentNode,e.nextSibling),null),d={node:a,offset:0};const l=i.firstChild.childNodes.length;for(;o.childNodes.length>l;)RemoveNode(o.lastChild);return undo_man.End(d.node,d.offset),document.getSelection().collapse(d.node,d.offset),!0}default:undo_man.Cancel()}return undo_man.Cancel(),!1}function SwitchInputHat(e,n){if(null===e)return!0;if(e.nodeType!=Node.TEXT_NODE)return!0;if(IsTextNodeInMath(e)&&["edita","editimg","editcite","editref"].includes(e.parentNode.className))return!0;if("["!=e.data.charAt(n-1))return!1;const t=n-1;let o,i=e.data.indexOf("]",n);i<0?(i=n,o=e.data.slice(t,n)+"^] "):(i++,o=e.data.slice(t,n)+"^"+e.data.slice(n,i)+" "),undo_man.Begin(e,n);let d=e;i<e.length&&DivideTextNode(e,i),t>0&&(d=DivideTextNode(e,t));const a=AddMathNode("[^",e.parentNode,d);RemoveNode(d),SafeJunctionPoint(a.parentNode,a),SafeJunctionPoint(a.parentNode,a.nextSibling);const l=a.lastChild.firstChild;InsertTextIntoText(o,l,0),DeleteText(l,o.length,l.length),"P"==a.parentNode.nodeName&&a.previousSibling.data==nt_ZWBR&&null===a.previousSibling.previousSibling&&ConvertMathCiteToRef(a);const s=EnableMathEdit(a,n-t+1);return document.getSelection().collapse(s.node,s.offset),undo_man.End(s.node,s.offset),!0}function SwitchInputRoundBra(e,n){if(null===e)return!0;if(e.nodeType!=Node.TEXT_NODE)return!1;if(IsTextNodeInMath(e))return!1;if("]"!=e.data.charAt(n-1))return!1;let t=e.data.lastIndexOf("[",n-1);if(t<0)return!1;let o=!1;"!"==e.data.charAt(t-1)&&(t--,o=!0);let i,d=e.data.indexOf(")",n);d<0?(d=n,i=e.data.slice(t,n)+"()"):(d++,i=e.data.slice(t,n)+"("+e.data.slice(n,d)),o&&(i+=" "),undo_man.Begin(e,n);let a=e;d<e.length&&DivideTextNode(e,d),t>0&&(a=DivideTextNode(e,t));const l=AddMathNode(o?"![":"[",e.parentNode,a);RemoveNode(a),SafeJunctionPoint(l.parentNode,l),SafeJunctionPoint(l.parentNode,l.nextSibling);const s=l.lastChild.firstChild;InsertTextIntoText(i,s,0),DeleteText(s,i.length,s.length),"P"==l.parentNode.nodeName&&l.previousSibling.data==nt_ZWBR&&null===l.previousSibling.previousSibling&&ConvertPtoFigure(l.parentNode);const r=EnableMathEdit(l,n-t+1);return document.getSelection().collapse(r.node,r.offset),undo_man.End(r.node,r.offset),!0}function ConvertPtoTable(e,n,t){const o=AddNode("TABLE",e.parentNode,e);{const e=AddNode("TR",o,null);for(let t=0;t<n;++t){AddNode("BR",AddNode("TH",e,null),null)}}{const e=AddNode("TR",o,null);for(let t=0;t<n;++t){AddTextNode("---",AddNode("TD",e,null),null)}}for(let e=1;e<t;++e){const e=AddNode("TR",o,null);for(let t=0;t<n;++t){AddNode("BR",AddNode("TD",e,null),null)}}return RemoveNode(e),o}function GetTableSize(e){if("|"!==e[0])return[0,0];const n=e.length;let t=1;for(;" "===e[t];)if(++t===n)return[0,0];const o=t;for(;"0"<=e[t]&&e[t]<="9";)if(++t===n)return[0,0];const i=t;for(;" "===e[t];)if(++t===n)return[0,0];if("x"!==e[t]&&","!==e[t])return[0,0];for(++t;" "===e[t];)if(++t===n)return[0,0];const d=t;for(;"0"<=e[t]&&e[t]<="9"&&++t!==n;);if(t===d)return[0,0];const a=t;for(;t<n;){if(" "!==e[t])return[0,0];++t}return[parseInt(e.slice(o,i),10),parseInt(e.slice(d,a),10)]}function CheckNodeInTD(e,n){let t=e;for(;t;){if(t===n)return null;if("TD"===t.nodeName||"TH"===t.nodeName)return t;t=t.parentNode}return null}function SwitchInputArrowUp(e){const n=e.parentNode;if(null===n.previousSibling){const e=n.parentNode;if(null===e.previousSibling){undo_man.Begin(document.getSelection().focusNode,document.getSelection().focusOffset);const n=AddNode("P",e.parentNode,e);return AddNode("BR",n,null),document.getSelection().collapse(n,0),undo_man.End(n,0),!0}return!1}const t=GetIndex(n,e),o=FocusOffsetLast(n.previousSibling.childNodes.item(t));return document.getSelection().collapse(o.node,o.offset),!0}function SwitchInputArrowDown(e){const n=e.parentNode;if(null===n.nextSibling){const e=n.parentNode;if(null===e.nextSibling){undo_man.Begin(document.getSelection().focusNode,document.getSelection().focusOffset);const n=AddNode("P",e.parentNode,null);return AddNode("BR",n,null),document.getSelection().collapse(n,0),undo_man.End(n,0),!0}return!1}const t=GetIndex(n,e),o=FocusOffsetLast(n.nextSibling.childNodes.item(t));return document.getSelection().collapse(o.node,o.offset),!0}let nt_prevent_shortcut=["Ctrl+B","Ctrl+I","Ctrl+U","Ctrl+Y","Ctrl+Delete","Ctrl+Backspace"];function OnKeydownForShortcut(e){if(e.isComposing)console.log("cancel for composing");else if(e.getModifierState("Control")||e.getModifierState("Meta")){let n="";switch(n+=nt_is_MacOS?e.getModifierState("Meta")?"Ctrl+":"":e.getModifierState("Control")?"Ctrl+":"",n+=e.getModifierState("Shift")?"Shift+":"",n+=1===e.key.length?e.key.toUpperCase():e.key,console.log(n),n){case"Ctrl+Z":e.preventDefault(),NT_Dispatch("undo");break;case"Ctrl+Shift+Z":e.preventDefault(),NT_Dispatch("redo");break;case"Ctrl+A":console.log("ctrl + a"),e.preventDefault(),NT_Dispatch("selectall");break;default:nt_prevent_shortcut.includes(n)?(console.log("prevent: default short cut"),e.preventDefault()):console.log("through: default short cut")}}else if("F2"===e.key)return PrintFocus(),console.log("Undo history: "+undo_man.numHistory),void e.preventDefault()}function NT_SetMarkdown(e){console.log("md_text:\n",e),console.log("clear all elements");const n=nt_render_div;for(;n.firstChild;)n.removeChild(n.firstChild);console.log("create dom");const t=MD2DOM(e);InitializeMathInFragment(t,g_auto_numbering?1:0),console.log("set DOM"),n.appendChild(t),(undo_man=new UndoManager).SetChangeEventDispatcher(new ChangeEventDispatcher(render_div)),console.log("fin: load")}function NT_GetMarkdown(){return DOM2MD(nt_render_div)}let nt_file_dir="";function NT_SetFilePath(e){if("/"===e.charAt(e.length-1))nt_file_dir=e;else if("\\"===e.charAt(e.length-1))nt_file_dir=e;else if(".md"===e.slice(e.length-3)){let n=e.lastIndexOf("/");n<0&&(n=e.lastIndexOf("\\"))<0&&(nt_file_dir=""),nt_file_dir=e.slice(0,n+1)}else{e.lastIndexOf("/")>=0&&(nt_file_dir=e+"/"),nt_file_dir=e+"\\"}console.log("SetFilePath:",nt_file_dir)}let g_editable_math=null,g_auto_numbering=!0;function OnClickMath(e){const n=document.getSelection();let t=document.elementFromPoint(e.clientX,e.clientY),o=CheckNodeInClass(t,"math",nt_render_div);if(null===o&&(o=CheckNodeInClass(t=n.focusNode,"math",nt_render_div)),null===o)return n.isCollapsed||CheckNodeInClass(n.anchorNode,"math",nt_render_div)&&n.collapse(n.focusNode,n.focusOffset),void DisableEdit(g_editable_math,!1);if(g_editable_math!==o){const e=o.lastChild.className;if(["editmath","editmathdisp","editimg"].includes(e)){DisableEdit(g_editable_math,!1);const e=EnableMathEdit(o,1);document.getSelection().collapse(e.node,e.offset)}else{let n=document.getSelection().focusOffset,t=document.getSelection().anchorNode===document.getSelection().focusNode?document.getSelection().anchorOffset:n;DisableEdit(g_editable_math,!1);const i=EnableMathEdit(o,1),d=GetEditMarginByClassName(e);n+=d,t+=d,"editcodedisp"===e&&"\n"===i.node.data.charAt(3)&&(n++,t++),t!=n?document.getSelection().setBaseAndExtent(i.node,t,i.node,n):document.getSelection().collapse(i.node,n)}}}function CheckEditPreview(e,n=!1){let t=CheckFocusInClass("math",e);return g_editable_math!==t&&(DisableEdit(g_editable_math,n),t)?(console.log("focus in : "+t),console.log("num_child: "+t.childNodes.length),EnableMathEdit(t,1)):null}function CheckFocusInClass(e,n){return CheckNodeInClass(document.getSelection().focusNode,e,n)}function CheckNodeInClass(e,n,t){let o=e;for(;o&&o!==t;){if(o.nodeType===Node.ELEMENT_NODE&&o.className===n)return o;o=o.parentNode}return null}function CheckNodeInNode(e,n){let t=e;for(;t;){if(t===n)return t;t=t.parentNode}return null}function SetFocusByCoordinate(e,n,t,o){let i,d=null;if(document.caretPositionFromPoint){let e=document.caretPositionFromPoint(t,o);d=e.offsetNode,i=e.offset}else if(document.caretRangeFromPoint){let e=document.caretRangeFromPoint(t,o);d=e.startContainer,i=e.startOffset}return d===e&&d.nodeType===Node.TEXT_NODE&&(i<n&&(i=n),i>d.length-n&&(i=d.length-n),document.getSelection().collapse(d,i),!0)}function EnableMathEdit(e,n=1){if(null===e)return null;if("math"!==e.className)return null;HidePreview(e.firstChild),UnsetHide(e.lastChild),g_editable_math=e;const t=e.lastChild.firstChild;return{node:t,offset:n<0?t.length+n:n}}function DisableEdit(e,n=!1){if(null===e)return{removed:!1,focus:null};if("math"!==e.className)return{removed:!1,focus:null};let t=e.lastChild;const o=GetEditMargin(e);let i=t.firstChild,d=i.data.slice(o,i.length-o),a=0===d.length,l=0;if("edita"!==t.className&&"editimg"!==t.className||(l=d.indexOf("]("))<0&&(a=!0),a){if(n)return g_editable_math=null,{removed:!1,focus:null};{undo_man.Begin(i,o);const n=e.parentNode,t=e.nextSibling;RemoveNode(e);const d=SafeJunctionPoint(n,t);return undo_man.End(d.node,d.offset),g_editable_math=null,{removed:!0,focus:d}}}switch(t.className){case"editmath":MathRendering(e,d,-1),ShowPreview(e.firstChild);break;case"editmathdisp":MathRendering(e,d,-1),ShowPreviewDisplay(e.firstChild);break;case"editcode":e.firstChild.firstChild.data=d,ShowPreview(e.firstChild);break;case"editcodedisp":"\n"===d.charAt(0)?e.firstChild.firstChild.data=d.slice(1,d.length-1):e.firstChild.firstChild.data=d,ShowPreviewDisplay(e.firstChild);break;case"editem1":case"editem2":case"editem3":{let n=e.firstChild.firstChild;n.nodeType===Node.TEXT_NODE?n.data=d:n.firstChild.data=d,ShowPreview(e.firstChild)}break;case"edita":{let n=e.firstChild;n.href=d.slice(l+2,d.length+1),n.firstChild.data=d.slice(0,l),ShowPreview(n)}break;case"editimg":{const n=e.firstChild;n.src=nt_file_dir+d.slice(l+2,d.length+1),n.alt=d.slice(0,l),ShowPreview(n)}break;case"editcite":{const n=e.firstChild;n.href="#"+d,n.firstChild.data=d,ShowPreview(n)}break;case"editref":{const n=e.firstChild;n.firstChild.data=d,ShowPreview(n)}break;default:alert("ERROR: invalid edit class in math like node")}return SetHide(e.lastChild),g_editable_math=null,{removed:!1,focus:null}}function MathRendering(e,n,t){let o=e.firstChild.getElementsByTagName("annotation");if(o&&o.textContent===n)return 0;let i=e.lastChild;if("editmath"===i.className){let t=ReferLabelEqnumber(n);e.firstChild.remove(),e.insertAdjacentHTML("afterbegin",katex.renderToString(t,{output:"html",displayMode:!1,throwOnError:!1}))}else if("editmathdisp"===i.className){if(0!==t){t<0&&(t=parseInt(e.dataset.eqnumberBegin,10)),e.firstChild.remove();let o=katexAutoNumber(n,e,t);return e.dataset.eqnumberBegin=t,e.dataset.eqnumberEnd=t+o,o}{e.firstChild.remove();const t=ReplaceAll(n,"{align}","{aligned}");e.insertAdjacentHTML("afterbegin",katex.renderToString(t,{output:"html",displayMode:!0,throwOnError:!1}))}}else alert("invalid math editting");return 0}function HidePreview(e){e.style.display="none"}function ShowPreview(e){e.style.display="inline"}function ShowPreviewDisplay(e){e.style.display="block"}function SetHide(e){e.style.cssText="border: 0; clip: rect(0 0 0 0); height: 1px; margin: -1px; overflow: hidden; padding: 0; position: absolute; white-space: nowrap; width: 1px;"}function UnsetHide(e){e.style.cssText="clip: auto; height: auto; margin: 0; overflow: visible; position: static; width: auto;"}function GetEditMargin(e){const n=e.className;return GetEditMarginByClassName("math"===n?e.lastChild.className:n)}function GetEditMarginByClassName(e){switch(e){case"editmath":return 1;case"editmathdisp":return 2;case"editcode":return 1;case"editcodedisp":return 3;case"editem1":return 1;case"editem2":return 2;case"editem3":return 3;case"edita":return 1;case"editimg":case"editcite":case"editref":return 2;default:return 0}}function SetEqNumber(e,n){let t=parseInt(e.dataset.eqnumberEnd,10)-parseInt(e.dataset.eqnumberBegin,10);e.dataset.eqnumberBegin=n,e.dataset.eqnumberEnd=n+t}function IsTextNodeInMath(e){return null!==e.parentNode&&(null!==e.parentNode.parentNode&&"math"===e.parentNode.parentNode.className)}function MD2DOM(e){e=ReplaceAll(ReplaceAll(ReplaceAll(e,"\r\n","\n"),"\r","\n"),"\t","    ");let n=new DocumentFragment;const t=e.length;let o=0;for(;o<t;){const t=e.charAt(o);switch(t){case"\n":++o;break;case"#":{let t=o+1,i=e.charAt(t);for(;"#"===i;)t++,i=e.charAt(t);if(" "===i){let i=document.createElement("H"+(t-o).toString()),d=ParseH1(e,t+1,i);n.appendChild(i),o=d}else{let i=document.createElement("P"),d=ParseP(e,t,i);n.appendChild(i),o=d}}break;case"-":case"+":case"*":if(" "===e.charAt(o+1)){let t=document.createElement("UL"),i=ParseOLUL(e,o,0,!1,t);n.appendChild(t),o=i}else{let t=document.createElement("P"),i=ParseP(e,o,t);n.appendChild(t),o=i}break;case" ":{let t=o+1,i=e.charAt(t);for(;" "===i;)++t,i=e.charAt(t);if(("-"===i||"+"===i||"*"===i)&&t-o>2){alert("ERROR: child list is written but parent list is not found."),o=t;break}let d=document.createElement("P"),a=ParseP(e,o,d);n.appendChild(d),o=a}break;case"[":{let t=!1,i=o+1;if("^"===e.charAt(i)){const d=e.indexOf("]:",i+1);if(d>0){const a=e.indexOf("\n",i+1);if(a>0&&d<a||a<0){t=!0;const a=document.createElement("SPAN");a.className="math";const l=document.createElement("SPAN");l.className="previewref",l.appendChild(document.createTextNode(e.slice(i+1,d))),a.appendChild(l);const s=document.createElement("SPAN");s.className="editref",s.appendChild(document.createTextNode(e.slice(o,d+2))),a.appendChild(s);let r=d+2,c=e.charAt(r);for(;" "===c;)++r,c=e.charAt(r);const f=document.createElement("P");f.appendChild(a);const _=ParseLI(e,r,f);CheckEmptyAndPutBR(f),n.appendChild(f),o=_}}}if(!t){const t=document.createElement("P"),i=ParseP(e,o,t);n.appendChild(t),o=i}}break;default:{if("0"<=t&&t<="9"){let t=o+1,i=e.charAt(t);for(;"0"<=i&&i<="9";)++t,i=e.charAt(t);if("."===i&&(++t," "===(i=e.charAt(t)))){let t=document.createElement("OL"),i=ParseOLUL(e,o,0,!0,t);n.appendChild(t),o=i;break}}let i=document.createElement("P"),d=ParseP(e,o,i);n.appendChild(i),o=d;break}}}if(!n.hasChildNodes()){const e=document.createElement("P");e.appendChild(document.createElement("BR")),n.appendChild(e)}return ConnectAdjacentText(n),PrepareBR(n),PrepareTable(n),LinebreakToSpaceInP(n),PrepareFigure(n),PrepareZWBR2(n),AssertAllforMath(n),n}function ParseP(e,n,t){const o=e.length;let i=n,d=n;for(;d<o;){switch(e.charAt(d)){case"\n":{const n=e.charAt(d+1);if("\n"===n||""===n)return d-i>0&&t.appendChild(document.createTextNode(e.substring(i,d))),CheckEmptyAndPutBR(t),d+1;d++}break;case"$":{d-i>0&&t.appendChild(document.createTextNode(e.substring(i,d)));let n=ParseMath(e,d,t);i=n,d=n}break;case"`":{d-i>0&&t.appendChild(document.createTextNode(e.substring(i,d)));let n=ParseCode(e,d,t);i=n,d=n}break;case"*":{d-i>0&&t.appendChild(document.createTextNode(e.substring(i,d)));const n=ParseEm(e,d,t);i=n,d=n}break;case"_":{if(!UnderscoreWithSpace(e,d)){++d;break}d-i>0&&t.appendChild(document.createTextNode(e.substring(i,d)));const n=ParseEm(e,d,t);i=n,d=n}break;case"!":{d-i>0&&t.appendChild(document.createTextNode(e.substring(i,d)));let n=ParseImg(e,d,t);i=n,d=n}break;case"[":{let n;d-i>0&&t.appendChild(document.createTextNode(e.substring(i,d))),i=n="^"===e.charAt(d+1)?ParseCite(e,d,t):ParseA(e,d,t),d=n}break;case" ":{let n=d+1,o=e.charAt(n);for(;" "===o;)++n,o=e.charAt(n);if("\n"===o&&n-d>=2){i<d&&t.appendChild(document.createTextNode(e.substring(i,d))),i=d=n;break}d=n}break;default:++d}}return d-i>0&&t.appendChild(document.createTextNode(e.substring(i,d))),CheckEmptyAndPutBR(t),o}function ParseH1(e,n,t){const o=e.length;let i=n,d=n;for(;d<o;){switch(e.charAt(d)){case"\n":return d-i>0&&t.appendChild(document.createTextNode(e.substring(i,d))),CheckEmptyAndPutBR(t),d+1;case"$":{d-i>0&&t.appendChild(document.createTextNode(e.substring(i,d)));let n=ParseMath(e,d,t,!1);i=n,d=n}break;case"`":{d-i>0&&t.appendChild(document.createTextNode(e.substring(i,d)));let n=ParseCode(e,d,t,!1);i=n,d=n}break;case"*":{d-i>0&&t.appendChild(document.createTextNode(e.substring(i,d)));const n=ParseEm(e,d,t);i=n,d=n}break;case"_":{if(!UnderscoreWithSpace(e,d)){++d;break}d-i>0&&t.appendChild(document.createTextNode(e.substring(i,d)));const n=ParseEm(e,d,t);i=n,d=n}break;case"!":{d-i>0&&t.appendChild(document.createTextNode(e.substring(i,d)));let n=ParseImg(e,d,t);i=n,d=n}break;case"[":{let n;d-i>0&&t.appendChild(document.createTextNode(e.substring(i,d))),i=n="^"===e.charAt(d+1)?ParseCite(e,d,t):ParseA(e,d,t),d=n}break;default:++d}}return d-i>0&&t.appendChild(document.createTextNode(e.substring(i,d))),CheckEmptyAndPutBR(t),o}function ParseOLUL(e,n,t,o,i){let d=null,a=n;const l=e.length;let s=a;for(;a<l;){const n=e.charAt(a),l=a-s;switch(n){case"\n":if(a>s)return s;s=++a;continue;case" ":++a;continue;case"-":case"+":case"*":if(l<t)return s;if(" "==e.charAt(a+1)){if(l>=t+2){let n=document.createElement("UL"),t=ParseOLUL(e,s,l,!1,n);d.appendChild(n),s=a=t;continue}if(o)return s;{let n=ParseLI(e,a+2,d=document.createElement("LI"));i.appendChild(d),s=a=n;continue}}break;default:if("0"<=n&&n<="9"){if(l<t)return s;let n=a+1,r=e.charAt(n);for(;"0"<=r&&r<="9";)++n,r=e.charAt(n);if("."==r&&(++n," "==(r=e.charAt(n)))){if(l>=t+2){let n=document.createElement("OL"),t=ParseOLUL(e,s,l,!0,n);d.appendChild(n),s=a=t;continue}if(o){let t=ParseLI(e,n+1,d=document.createElement("LI"));i.appendChild(d),s=a=t;continue}return s}}}if(!(l>=2))return s;s=a=ParseLI(e,a,d)}return l}function ParseLI(e,n,t){const o=e.length;let i=n,d=n;for(;d<o;){switch(e.charAt(d)){case"\n":if(d-i>0){let n=e.substring(i,d);t.appendChild(document.createTextNode(n))}return d+1;case"$":{d-i>0&&t.appendChild(document.createTextNode(e.substring(i,d)));const n=ParseMath(e,d,t,!0);i=n,d=n}break;case"`":{d-i>0&&t.appendChild(document.createTextNode(e.substring(i,d)));const n=ParseCode(e,d,t,!0);i=n,d=n}break;case"*":{d-i>0&&t.appendChild(document.createTextNode(e.substring(i,d)));const n=ParseEm(e,d,t);i=n,d=n}break;case"_":{if(!UnderscoreWithSpace(e,d)){++d;break}d-i>0&&t.appendChild(document.createTextNode(e.substring(i,d)));const n=ParseEm(e,d,t);i=n,d=n}break;case"!":{d-i>0&&t.appendChild(document.createTextNode(e.substring(i,d)));let n=ParseImg(e,d,t);i=n,d=n}break;case"[":{let n;d-i>0&&t.appendChild(document.createTextNode(e.substring(i,d))),i=n="^"===e.charAt(d+1)?ParseCite(e,d,t):ParseA(e,d,t),d=n}break;default:++d}}return d-i>0&&t.appendChild(document.createTextNode(e.substring(i,d))),CheckEmptyAndPutBR(t),o}function ParseMath(e,n,t,o=!0){let i=n;if("$"===e.charAt(i+1)){if(!o)return alert("ERROR: display math '$$' is not allowed here."),ErrorTag(e,i,t);let n=e.indexOf("$$",i+2);if(n<0)return alert("ERROR: end of display math '$$' is not found."),ErrorTag(e,i,t);{const o=e.lastIndexOf("\n",i),d="\n"+" ".repeat(o<0?i:i-o-1);let a=e.substring(i,n+2);a=ReplaceAll(a,d,"\n");let l=document.createElement("SPAN");l.className="editmathdisp",l.appendChild(document.createTextNode(a));let s=document.createElement("SPAN");return s.className="math",s.appendChild(document.createElement("SPAN")),s.appendChild(l),t.appendChild(s),n+2}}{let n=e.indexOf("$",i+2);if(n<0)return alert("ERROR: end of inline math '$' is not found."),ErrorTag(e,i,t);{let o=document.createElement("SPAN");o.className="editmath",o.appendChild(document.createTextNode(e.substring(i,n+1)));let d=document.createElement("SPAN");return d.className="math",d.appendChild(document.createElement("SPAN")),d.appendChild(o),t.appendChild(d),n+1}}}function ParseCode(e,n,t,o=!0){let i=n;const d=e.charAt(i+1),a=e.charAt(i+2);if("`"===d&&"`"===a){if(!o)return alert("ERROR: display code '```' is not allowed here."),ErrorTag(e,i,t);let n=e.indexOf("```",i+3);if(n<0)return alert("ERROR: end of display code '```' is not found."),ErrorTag(e,i,t);{const o=e.lastIndexOf("\n",i),d="\n"+" ".repeat(o<0?i:i-o-1);let a=e.substring(i,n+3);a=ReplaceAll(a,d,"\n");const l=document.createElement("SPAN");l.className="previewcodedisp",l.textContent="previewcodedisp";const s=document.createElement("SPAN");s.className="editcodedisp",s.appendChild(document.createTextNode(a));const r=document.createElement("SPAN");return r.className="math",r.appendChild(l),r.appendChild(s),t.appendChild(r),n+3}}{const n=e.indexOf("`",i+2);if(n<0)return alert("ERROR: end of inline code '`' is not found."),ErrorTag(e,i,t);{const o=document.createElement("SPAN");o.className="previewcode",o.textContent="previewcode";const d=document.createElement("SPAN");d.className="editcode",d.appendChild(document.createTextNode(e.substring(i,n+1)));const a=document.createElement("SPAN");return a.className="math",a.appendChild(o),a.appendChild(d),t.appendChild(a),n+1}}}function UnderscoreWithSpace(e,n){const t=n,o=e.charAt(t);if(t>0&&" "!=e.charAt(t-1))return!1;let i=t+1;for(;e.charAt(i)===o;)i++;const d=o.repeat(i-t),a=e.indexOf(d,i);if(a>0&&a+(i-t)<e.length&&" "!=e.charAt(a+(i-t)))return!1;const l=e.indexOf(" ",i);return!(l>0&&l<a)}function ParseEm(e,n,t){const o=n,i=e.charAt(o);let d=o+1;for(;e.charAt(d)==i;)d++;if(d-o<=3){const n=i.repeat(d-o),a=e.indexOf(n,d+1);if(a<0)return alert("ERROR: end of enphasis "+n+" is not found."),ErrorTag(e,o,t);{const n=document.createElement("SPAN");if(n.className="math",d-o==1){const t=document.createElement("EM");t.appendChild(document.createTextNode(e.substring(d,a))),n.appendChild(t)}else if(d-o==2){const t=document.createElement("STRONG");t.appendChild(document.createTextNode(e.substring(d,a))),n.appendChild(t)}else{const t=document.createElement("STRONG");t.appendChild(document.createTextNode(e.substring(d,a)));const o=document.createElement("EM");o.appendChild(t),n.appendChild(o)}const i=document.createElement("SPAN");return i.className="editem"+(d-o).toString(),i.appendChild(document.createTextNode(e.substring(o,a+(d-o)))),n.appendChild(i),t.appendChild(n),a+(d-o)}}{const n=i.repeat(d-o);return alert("ERROR: emphasis mark "+n+" is repeating greater than 3 characters."),ErrorTag(e,o,t)}}function ParseImg(e,n,t){let o=n+1;if("["!==e.charAt(o))return alert("ERROR: img '![]()' has no '[' symbol."),ErrorTag(e,o,t);let i=e.indexOf("]",o+1);if(i<0)return alert("ERROR: img '![]()' has no '' symbol."),ErrorTag(e,o,t);let d=i+1;for(;" "===e.charAt(d);)d++;if("("!==e.charAt(d))return alert("ERROR: link '[]()' has no '(' symbol."),ErrorTag(e,o,t);let a=e.indexOf(")",d+1);if(a<0)return alert("ERROR: link '[]()' has no ')' symbol."),ErrorTag(e,o,t);const l=document.createElement("SPAN");l.className="math";const s=document.createElement("IMG");s.alt=e.substring(o+1,i),s.src=e.substring(d+1,a),l.appendChild(s);const r=document.createElement("SPAN");return r.className="editimg",r.appendChild(document.createTextNode(e.substring(n,a+1)+" ")),l.appendChild(r),t.appendChild(l),a+1}function ParseA(e,n,t){let o=n,i=e.indexOf("]",o+1);if(i<0)return alert("ERROR: link '[]()' has no ']' symbol."),ErrorTag(e,o,t);let d=i+1;for(;" "===e.charAt(d);)d++;if("("!==e.charAt(d))return t.appendChild(document.createTextNode(e.substring(n,d))),d;let a=e.indexOf(")",d+1);if(a<0)return alert("ERROR: link '[]()' has no ')' symbol."),ErrorTag(e,o,t);const l=document.createElement("SPAN");l.className="math";const s=document.createElement("A");s.href=e.substring(d+1,a),s.target="_blank",s.ref="noopener noreferrer",s.appendChild(document.createTextNode(e.substring(o+1,i))),l.appendChild(s);const r=document.createElement("SPAN");return r.className="edita",r.appendChild(document.createTextNode(e.substring(n,a+1))),l.appendChild(r),t.appendChild(l),a+1}function ParseCite(e,n,t){let o=n,i=e.indexOf("]",o+1);if(i<0)return alert("ERROR: cite '[^  ]' has no ']' symbol."),ErrorTag(e,o,t);const d=document.createElement("SPAN");d.className="math";const a=document.createElement("A"),l=e.substring(n+2,i);a.href="#"+l,a.className="previewcite",a.appendChild(document.createTextNode(l)),d.appendChild(a);const s=document.createElement("SPAN");return s.className="editcite",s.appendChild(document.createTextNode("[^"+l+"] ")),d.appendChild(s),t.appendChild(d),i+1}function GetEndSemantics(e,n){const t=e.indexOf("\n",n);return t<0?e.length:t}function ErrorTag(e,n,t){const o=GetEndSemantics(e,n+1);let i=document.createElement("EM");return i.className="readerror",i.appendChild(document.createTextNode(e.substring(n,o))),t.appendChild(i),o}function CheckEmptyAndPutBR(e){0===e.childNodes.length?e.appendChild(document.createElement("BR")):1===e.childNodes.length&&e.firstChild.nodeType===Node.TEXT_NODE&&0===e.firstChild.data.trim().length&&(e.removeChild(e.firstChild),e.appendChild(document.createElement("BR")))}function ConnectAdjacentText(e){let n=null;for(let t=e.firstChild;t;t=n)n=t.nextSibling,t.nodeType===Node.TEXT_NODE?n&&n.nodeType===Node.TEXT_NODE&&(t.appendData(n.data),e.removeChild(n),n=t):t.hasChildNodes()&&ConnectAdjacentText(t)}function PrepareBR(e){let n=null;for(let t=e.firstChild;t;t=n)n=t.nextSibling,t.hasChildNodes()?PrepareBR(t):["P","LI","H1","H2","H3","H4","H5","H6","FIGCAPTION","TD","TH"].includes(t.nodeName)&&t.appendChild(document.createElement("BR")),["LI","FIGURE"].includes(t.nodeName)&&["OL","UL","FIGCAPTION"].includes(t.firstChild.nodeName)&&t.insertBefore(document.createElement("BR"),t.firstChild)}function PrepareFigure(e){let n=null;for(let t=e.firstChild;t;t=n)if(n=t.nextSibling,"P"===t.nodeName&&"SPAN"===t.firstChild.nodeName&&"math"===t.firstChild.className&&"editimg"===t.firstChild.lastChild.className){let n=null;for(n=t.firstChild.nextSibling;n&&"SPAN"===n.nodeName&&"math"===n.className&&"editimg"===n.lastChild.className;n=n.nextSibling);const o=document.createElement("FIGURE");for(;t.firstChild!==n;)o.appendChild(t.removeChild(t.firstChild));const i=document.createElement("FIGCAPTION");for(;t.firstChild;)i.appendChild(t.removeChild(t.firstChild));null===i.firstChild&&i.appendChild(document.createElement("BR")),o.appendChild(i),e.insertBefore(o,t),e.removeChild(t)}}function LinebreakToSpaceInP(e){let n=null;for(let t=e.firstChild;t;t=n)if(n=t.nextSibling,"P"===t.nodeName)for(let e=t.firstChild;e;e=e.nextSibling)if(e.nodeType===Node.TEXT_NODE){const n=e.data;n.indexOf("\n")>=0&&(e.data=ReplaceLinebreakToSpaceForJP(n))}}function PrepareTable(e){let n=null;for(let t=e.firstChild;t;t=n)if(n=t.nextSibling,"P"===t.nodeName){let n=null,o=0;for(let e=t.firstChild;e;e=e.nextSibling)if(e.nodeType===Node.TEXT_NODE){const t=e.data.indexOf("\n");if(t>=0){n=e,o=t;break}}if(null===n)continue;let i=!1;for(let e=t.firstChild;e!==n;e=e.nextSibling)if(e.nodeType===Node.TEXT_NODE&&e.data.indexOf("|")>=0){i=!0;break}if(!i){const e=n.data.indexOf("|");if(e<0)continue;if(e>o)continue}const d=n.data.indexOf("\n",o+1),a=n.data.slice(o+1,d<0?n.length:d);for(let e=0;e<a.length;++e)"-:| ".indexOf(a[e]);const l=document.createElement("TABLE");{const e=SplitLineToTD(t,"\n","TR"),n=e.firstChild;{const e=SplitLineToTD(n,"|","TH");n.appendChild(e)}const o=n.childNodes.length;for(let e=n.nextSibling;e;e=e.nextSibling){const n=SplitLineToTD(e,"|","TD");for(;n.childNodes.length>o;)n.removeChild(n.lastChild);for(;n.childNodes.length<o;){const e=document.createElement("TD");e.appendChild(document.createElement("BR")),n.appendChild(e)}e.appendChild(n)}l.appendChild(e)}e.insertBefore(l,t),e.removeChild(t)}}function SplitLineToNodes(e,n,t){const o=new DocumentFragment;let i=document.createElement(t);o.appendChild(i);let d=null;for(let a=e.firstChild;a;a=d)if(d=a.nextSibling,a.nodeType===Node.TEXT_NODE){let d=e.removeChild(a),l=d.data.indexOf(n);for(;l>=0;){if(l>0){const e=d.splitText(l);i.appendChild(d),d=e}if(i.hasChildNodes()?i=document.createElement(t):o.firstChild!==i&&(i.appendChild(document.createElement("BR")),i=document.createElement(t)),o.appendChild(i),1===d.length){d.data="";break}l=(d=d.splitText(1)).data.indexOf(n)}d.length>0&&i.appendChild(d)}else i.appendChild(e.removeChild(a));return i.hasChildNodes()||i.remove(),o}function SplitLineToTD(e,n,t){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType===Node.TEXT_NODE){const e=t.data.indexOf(n);if(e>=0){if(e>0){t=t.splitText(e)}t.length>1&&t.splitText(1)}}const o=new DocumentFragment;let i=document.createElement(t);for(e.firstChild.nodeType===Node.TEXT_NODE&&e.firstChild.data==n&&e.removeChild(e.firstChild);e.firstChild;)e.firstChild.nodeType!==Node.TEXT_NODE||e.firstChild.data!=n?i.appendChild(e.removeChild(e.firstChild)):(e.removeChild(e.firstChild),null===i.firstChild&&i.appendChild(document.createElement("BR")),o.appendChild(i),i=document.createElement(t));return null!==i.firstChild&&o.appendChild(i),o}function PrepareZWBR2(e){for(let n=e.firstChild;n;n=n.nextSibling){switch(n.nodeName){case"P":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"LI":case"FIGURE":case"FIGCAPTION":case"TD":case"TH":PrepereZWBR_funcP2(n)}n.hasChildNodes()&&PrepareZWBR2(n)}}function PrepereZWBR_funcP2(e){if(null===e.firstChild)return void e.appendChild(document.createElement("BR"));let n=!0;for(let t=e.firstChild;t;t=t.nextSibling)switch(t.nodeName){case"SPAN":n&&e.insertBefore(document.createTextNode(nt_ZWBR),t),n=!0;break;case"OL":case"UL":case"FIGCAPTION":n&&(t.previousSibling?e.insertBefore(document.createTextNode(nt_ZWBR),t):e.insertBefore(document.createElement("BR"),t)),n=!1;break;case"BR":n=!1;break;default:n=!1}n&&e.appendChild(document.createTextNode(nt_ZWBR))}const AssertAllforMath=e=>{for(let n=e.firstChild;n;n=n.nextSibling)["P","H1","H2","H3","H4","H5","H6","LI","FIGURE","FIGCAPTION","TD","TH"].includes(n.nodeName)&&AssertValidateMathInParent(n),n.hasChildNodes()&&AssertAllforMath(n)};class StoredNode{constructor(e){this.real_instance=e,this.nodeName=e.nodeName,this.text_class=e.nodeType===Node.TEXT_NODE?e.data:e.className,this.children=[];for(let n=e.firstChild;n;n=n.nextSibling)this.children.push(new StoredNode(n))}IsSame(e){return!0}}function ReplaceAll(e,n,t){let o=e.indexOf(n,0);if(o<0)return e;const i=n.length;let d=e.slice(0,o)+t,a=o+i;for(o=e.indexOf(n,a);o>=0;)d+=e.slice(a,o)+t,a=o+i,o=e.indexOf(n,a);return d+=e.slice(a)}function ReplaceAllExcept(e,n,t,o){let i=e.indexOf(n,0);if(i<0)return e;const d=n.length;if(i+d>=e.length)return e;for(;e.startsWith(o,i+d);){if((i=e.indexOf(n,i+1))<0)return e;if(i+d>=e.length)return e}let a=e.slice(0,i)+t,l=i+d;for(i=e.indexOf(n,l);i>=0&&i+d<e.length;)e.startsWith(o,i+d)?i=e.indexOf(n,i+1):(a+=e.slice(l,i)+t,l=i+d,i=e.indexOf(n,l));return a+=e.slice(l)}function ReplaceByRangeAll(e,n,t,o){let i=e.indexOf(n,0);if(i<0)return e;const d=n.length;let a=e.indexOf(t,i+d);if(a<0)return e;const l=t.length;let s=e.slice(0,i)+o,r=a+l;for(i=e.indexOf(n,r);i>=0&&!((a=e.indexOf(t,i+d))<0);)s+=e.slice(r,i)+o,r=a+l,i=e.indexOf(n,r);return s+=e.slice(r)}function IsAlphabet(e){return e.charCodeAt(0)<128}function ReplaceLinebreakToSpaceForJP(e){let n=0,t=e.indexOf("\n",n);if(t<0)return e;if(0===t&&(n=1,(t=e.indexOf("\n",n))<0))return e.slice(n);let o="";for(;t>=0;)t===e.length-1?o+=e.slice(n,t):IsAlphabet(e[t-1])||IsAlphabet(e[t+1])?o+=e.slice(n,t)+" ":o+=e.slice(n,t),n=t+1,t=e.indexOf("\n",n);return o+=e.slice(n)}