"use strict";let MO_IME_node_origin=null,MO_IME_offset_origin=0,MO_update_list=[],MO_observer=null,MO_in_composition=!1,MO_highlight=null,MO_update_parents=null;function MO_InitComposition(master_node){MO_observer=new MutationObserver(MO_OnCompositionChange),MO_observer.observe(master_node,{childList:!0,characterData:!0,characterDataOldValue:!0,subtree:!0})}function MO_OnCompositionChange(record_list){(MO_in_composition||MO_update_list.length>0)&&record_list.forEach(record=>{if("characterData"===record.type){let new_target_update=!0;if(MO_update_list.length>0){const last=MO_update_list[MO_update_list.length-1];last.record.type==record.type&&last.record.target===record.target&&(new_target_update=!1)}if(new_target_update){const offset=GetIndex(record.target.parentNode,record.target);MO_update_list.push({record:record,offset:offset});const parent=record.target.parentNode;MO_update_parents.add("MARK"==parent.nodeName?parent.parentNode:parent)}}else if("childList"===record.type){if(record.addedNodes.length>0){const offset=null===record.previousSibling?0:GetIndex(record.target,record.previousSibling)+1;MO_update_list.push({record:record,offset:offset})}else{const offset=null===record.previousSibling?0:GetIndex(record.target,record.previousSibling)+1;MO_update_list.push({record:record,offset:offset})}MO_update_parents.add("MARK"==record.nodeName?record.parentNode:record)}}),!MO_in_composition&&MO_update_list.length>0&&(undo_man.GetChangeEventDispatcher().Disable(),MO_RegisterIMEUpdate(),IsHighlightMode()&&NT_HighlightClear(),ExecUndo(),undo_man.Shrink(),undo_man.GetChangeEventDispatcher().Enable())}function MO_OnCompositionstart(event){MO_in_composition=!0,MO_update_list.length=0,MO_highlight=nt_highlight,MO_update_parents=new Set;const selection=document.getSelection();if(0===selection.rangeCount)return event.currentTarget.blur(),!1;const range=selection.getRangeAt(0);let focus_node=range.startContainer,focus_offset=range.startOffset,anchor_node=range.endContainer,anchor_offset=range.endOffset;if(focus_node.nodeType!==Node.TEXT_NODE&&([focus_node,focus_offset]=RefineFocusToText(focus_node,focus_offset)),anchor_node.nodeType!==Node.TEXT_NODE&&([anchor_node,anchor_offset]=RefineFocusToText(anchor_node,anchor_offset)),MO_IME_node_origin=focus_node,MO_IME_offset_origin=focus_offset,!selection.isCollapsed){let will_canceled=anchor_node!==focus_node;if(anchor_node!==focus_node){const[fnode,foffset]=CorrectFocusToText(focus_node,focus_offset);selection.collapse(fnode,foffset),will_canceled=!1}will_canceled&&(event.preventDefault(),event.currentTarget.blur(),selection.removeAllRanges())}}function MO_OnCompositionupdate(event){event.data}function MO_OnCompositionend(event){event.data;MO_in_composition=!1,MO_RegisterIMEUpdate()}function MO_OnCompositionendForChrome(event){0==event.data.length?MO_in_composition=!1:(MO_in_composition=!1,MO_RegisterIMEUpdate())}function MO_RegisterIMEUpdate(){if(0===MO_update_list.length)return;let modified_text_list=[],warning_math_list=[];const selection=document.getSelection();if(MO_highlight){const org_focus=MO_highlight.OriginalFocus(MO_IME_node_origin,MO_IME_offset_origin);undo_man.Begin(org_focus.node,org_focus.offset),MO_highlight.RegisterUndo(MO_update_parents,undo_man)}else undo_man.Begin(MO_IME_node_origin,MO_IME_offset_origin);if(MO_update_list.forEach(update_info=>{const record=update_info.record;if("characterData"===record.type)undo_man.Register(UR_TYPE.DELETE_IN_TEXT,record.oldValue,record.target,0,record.oldValue.length),undo_man.Register(UR_TYPE.INSERT_TEXT_INTO_TEXT,record.target.data,record.target,0,record.target.length),modified_text_list.push(record.target);else if("childList"===record.type)if(record.addedNodes.length>0){const parent=record.target;let offset=update_info.offset;record.addedNodes.forEach(node=>{undo_man.Register(UR_TYPE.ADD_NODE,node,parent,offset,1),++offset,"math"==parent.className?warning_math_list.push(parent):parent.parentNode&&"math"==parent.parentNode.className&&node.nodeType!=Node.TEXT_NODE&&warning_math_list.push(parent.parentNode)})}else if(record.removedNodes.length>0){const parent=record.target,offset=update_info.offset;record.removedNodes.forEach(node=>{undo_man.Register(UR_TYPE.REMOVE_NODE,node,parent,offset,1),"math"==parent.className&&warning_math_list.push(parent)})}}),0===selection.rangeCount)return void undo_man.End(null,0);modified_text_list.forEach(text_node=>{if(IsTextNodeInMath(text_node)){let info;switch(text_node.parentNode.className){case"editmath":info={beginMark:"$",endMark:"$",reservedChars:["$"]};break;case"editmathdisp":info={beginMark:"$$",endMark:"$$",reservedChars:["$"]};break;case"editcode":info={beginMark:"`",endMark:"`",reservedChars:["`"]};break;case"editcodedisp":info={beginMark:"```",endMark:"```",reservedChars:["`"]};break;case"editem1":info={beginMark:"*",endMark:"*",reservedChars:["*","_"]};break;case"editem2":info={beginMark:"**",endMark:"**",reservedChars:["*","_"]};break;case"editem3":info={beginMark:"***",endMark:"***",reservedChars:["*","_"]};break;case"edita":info={beginMark:"[",endMark:")",reservedChars:["[",")"]};break;case"editimg":info={beginMark:"![",endMark:") ",reservedChars:["!","[",")"]};break;case"editcite":info={beginMark:"[^",endMark:"] ",reservedChars:["^","[","]"]};break;case"editref":info={beginMark:"[^",endMark:"]:",reservedChars:["^","[","]",":"]};break;default:return}text_node.data.startsWith(info.beginMark)&&text_node.data.endsWith(info.endMark)||(info.reservedChars.forEach(c=>{let pos=text_node.data.indexOf(c);for(;pos>=0;)DeleteText(text_node,pos,1),pos=text_node.data.indexOf(c)}),InsertTextIntoText(info.beginMark,text_node,0),InsertTextIntoText(info.endMark,text_node,text_node.length))}else{if(text_node.data==nt_ZWBR)return;let pos=text_node.data.indexOf(nt_ZWBR);pos>=0&&DeleteText(text_node,pos,1)}});let focus={node:document.getSelection().focusNode,offset:document.getSelection().focusOffset};if(focus.node.nodeType!==Node.TEXT_NODE&&([focus.node,focus.offset]=RefineFocusToText(focus.node,focus.offset)),MO_highlight){const org_end_focus=MO_highlight.ForceRepairWithRegister(MO_update_parents,focus.node,focus.offset);org_end_focus&&(focus=org_end_focus),undo_man.End(focus.node,focus.offset),MO_highlight.SearchIn(MO_update_parents);const hi_focus=MO_highlight.HighlightFocus(focus.node,focus.offset);document.getSelection().collapse(hi_focus.node,hi_focus.offset)}else undo_man.End(focus.node,focus.offset);MO_update_list.length=0,modified_text_list.length=0,MO_update_parents=null}function MO_OnKeydownForIME(event){if(MO_in_composition)switch(event.key){case"ArrowLeft":case"ArrowRight":case"ArrowUp":case"ArrowDown":case"PageUp":case"PageDown":case"Home":case"End":event.preventDefault(),event.stopImmediatePropagation()}}function MO_OnContextmenuForIME(event){MO_in_composition&&(event.preventDefault(),event.stopImmediatePropagation())}function RefineFocusToText(focus_node,focus_offset){const ch=focus_node.childNodes.item(focus_offset);if(ch)ch.nodeType===Node.TEXT_NODE&&(focus_node=ch,focus_offset=0);else{const back=focus_node.childNodes.item(focus_offset-1);back&&back.nodeType===Node.TEXT_NODE&&(focus_offset=(focus_node=back).length)}return[focus_node,focus_offset]}function OnCut(event){if(!event.clipboardData)return;if(IsTableSelectionMode())return IsHighlightMode()&&NT_HighlightClear(),void OnCutTable(event);event.preventDefault();const selection=document.getSelection();if(selection.isCollapsed)return;let highlight_word=null;IsHighlightMode()&&(highlight_word=nt_highlight.Word,NT_HighlightClear()),CorrectSelectionEdgeTable();const fragment=CutSelection(event.currentTarget,selection);if(fragment){let md_text=DOM2MD(fragment);event.clipboardData.setData("text/plain",md_text)}highlight_word&&NT_HighlightWord(highlight_word)}function OnCopy(event){if(!event.clipboardData)return;if(IsTableSelectionMode())return IsHighlightMode()&&NT_HighlightClear(),void OnCopyTable(event);event.preventDefault();const selection=document.getSelection();if(selection.isCollapsed)return;let highlight_word=null;IsHighlightMode()&&(highlight_word=nt_highlight.Word,NT_HighlightClear()),undo_man.GetChangeEventDispatcher().Disable(),CorrectSelectionEdgeTable();const fragment=CutSelection(event.currentTarget,selection);if(fragment&&(ExecUndo(),undo_man.Shrink()),undo_man.GetChangeEventDispatcher().Enable(),fragment){const md_text=DOM2MD(fragment);event.clipboardData.setData("text/plain",md_text);document.createElement("DIV").appendChild(fragment)}highlight_word&&NT_HighlightWord(highlight_word)}function OnPaste(event){if(!event.clipboardData)return;let highlight_word=null;if(IsHighlightMode()&&(highlight_word=nt_highlight.Word,NT_HighlightClear()),IsTableSelectionMode())return void OnPasteTable(event);event.preventDefault();const text=event.clipboardData.getData("text/plain"),selection=document.getSelection();selection.isCollapsed||(CorrectSelectionEdgeTable(),CutSelection(event.currentTarget,selection));const[node,offset]=CorrectFocusToText(selection.focusNode,selection.focusOffset);if(IsTextNodeInMath(node)&&0<offset&&offset<node.length)return undo_man.Begin(node,offset),InsertTextIntoText(text,node,offset),undo_man.End(node,offset+text.length),selection.collapse(node,offset+text.length),void(highlight_word&&NT_HighlightWord(highlight_word));const fragment=MD2DOM(ResolveNewlineCode(text));InitializeMathInFragment(fragment,g_auto_numbering?1:0),PasteTopLevelNodes(node,offset,fragment,event.currentTarget),highlight_word&&NT_HighlightWord(highlight_word)}function CutSelection(master_node,selection){if(selection.isCollapsed)return null;if(0===selection.rangeCount)return null;const range=selection.getRangeAt(0);let init_parent2,init_ref2,init_parent1,init_ref1,start_node=range.startContainer,start_offset=range.startOffset,end_node=range.endContainer,end_offset=range.endOffset;start_node.nodeType==Node.TEXT_NODE?"TD"!=start_node.parentNode.nodeName&&"TH"!=start_node.parentNode.nodeName||start_node===start_node.parentNode.lastChild&&start_offset==start_node.length&&start_node.parentNode.nextSibling&&(start_node=start_node.parentNode.nextSibling,start_offset=0,start_node.firstChild.nodeType==Node.TEXT_NODE&&(start_node=start_node.firstChild)):"TD"!=start_node.nodeName&&"TH"!=start_node.nodeName||start_offset==start_node.childNodes.length&&start_node.nextSibling&&(start_node=start_node.nextSibling,start_offset=0,start_node.firstChild.nodeType==Node.TEXT_NODE&&(start_node=start_node.firstChild));end_node.nodeType==Node.TEXT_NODE?"TD"!=end_node.parentNode.nodeName&&"TH"!=end_node.parentNode.nodeName||end_node===end_node.parentNode.firstChild&&0==end_offset&&end_node.parentNode.previousSibling&&(end_node=end_node.parentNode.previousSibling,end_node.lastChild.nodeType==Node.TEXT_NODE?(end_node=end_node.lastChild,end_offset=end_node.length):end_offset=end_node.childNodes.length):"TD"!=end_node.nodeName&&"TH"!=end_node.nodeName||0==end_offset&&end_node.previousSibling&&(end_node=end_node.previousSibling,end_node.lastChild.nodeType==Node.TEXT_NODE?(end_node=end_node.lastChild,end_offset=end_node.length):end_offset=end_node.childNodes.length);if(undo_man.Begin(selection.focusNode,selection.focusOffset,selection.anchorNode,selection.anchorOffset),start_node&&start_node===end_node&&start_node.nodeType===Node.TEXT_NODE){if(IsTextNodeInMath(start_node)){const margin=GetEditMarginByClassName(start_node.parentNode.className);if(start_offset<margin&&(start_offset=margin),end_offset>start_node.length-margin&&(end_offset=start_node.length-margin),start_offset==end_offset)return undo_man.Cancel(),null}if(0===start_offset&&end_offset===start_node.length){const parent=start_node.parentNode,next=start_node.nextSibling,frag=new DocumentFragment;frag.appendChild(RemoveNode(start_node));const focus=SafeJunctionPoint(parent,next);return undo_man.End(focus.node,focus.offset),document.getSelection().collapse(focus.node,focus.offset),frag.cloneNode(!0)}{const text=DeleteText(start_node,start_offset,end_offset-start_offset);document.getSelection().collapse(start_node,start_offset),undo_man.End(start_node,start_offset);const frag=new DocumentFragment;return frag.appendChild(document.createTextNode(text)),frag.cloneNode(!0)}}end_node.nodeType===Node.TEXT_NODE?(init_parent2=end_node.parentNode,0===end_offset?init_ref2=end_node:(end_offset===end_node.length||DivideTextNode(end_node,end_offset),init_ref2=end_node.nextSibling)):(init_parent2=end_node,init_ref2=end_node.childNodes.item(end_offset)),start_node.nodeType===Node.TEXT_NODE?(init_parent1=start_node.parentNode,0===start_offset?init_ref1=start_node:(start_offset===start_node.length||DivideTextNode(start_node,start_offset),init_ref1=start_node.nextSibling)):(init_parent1=start_node,init_ref1=start_node.childNodes.item(start_offset));const cross1=MakeCrossSection(master_node,init_parent1),cross2=MakeCrossSection(master_node,init_parent2);let index1=cross1.length-1,index2=cross2.length-1,common_parent=master_node;for(;index1>=0&&index2>=0;){let ref1=cross1[index1];if(ref1!==cross2[index2])break;common_parent=ref1,index1--,index2--}"OL"!==common_parent.tagName&&"UL"!==common_parent.tagName||(common_parent=common_parent.parentNode);const ref_end=DivideAtCrossSection2(init_ref2,init_parent2,common_parent),ref_begin=DivideAtCrossSection2(init_ref1,init_parent1,common_parent);ref_begin.nodeType,Node.TEXT_NODE;let focus,cut_fragment=RemoveNodeList(common_parent,ref_begin,ref_end);focus=ref_end?ConnectionNodeRecursive(ref_end):SafeTailPoint(common_parent);let next_focus_node=focus.node,next_focus_offset=focus.offset;null===next_focus_node&&(next_focus_node=common_parent,next_focus_offset=GetIndex(common_parent,ref_end)),RecoveryEmptyElement(common_parent),RecoveryPandFigure(common_parent),"DIV"!==next_focus_node.nodeName&&"OL"!==next_focus_node.nodeName&&"UL"!==next_focus_node.nodeName||(next_focus_node=next_focus_node.firstChild,next_focus_offset=0),[next_focus_node,next_focus_offset]=CorrectFocusToText(next_focus_node,next_focus_offset),undo_man.End(next_focus_node,next_focus_offset),selection.collapse(next_focus_node,next_focus_offset);return cut_fragment.cloneNode(!0)}function MakeCrossSection(master_node,init_parent){let cross_section=[],node=init_parent;for(;node!==master_node;)cross_section.push(node),node=node.parentNode;return cross_section.push(node),cross_section}function DivideAtCrossSection2(init_ref,init_parent,common_parent){let next_ref=init_ref,parent=init_parent;for(;parent&&parent!==common_parent;){const ref=next_ref;if(ref===parent.firstChild){const new_node=AddNode(parent.tagName,parent.parentNode,parent);AddNode("BR",new_node,null),next_ref=parent}else if(null===ref){const new_node=AddNode(parent.tagName,parent.parentNode,parent.nextSibling);AddNode("BR",new_node,null),next_ref=parent.nextSibling}else{if(["P","H1","H2","H3","H4","H5","H6","LI","FIGURE","FIGCAPTION","TD","TH"].includes(parent.tagName)){const fragment=SafeRemoveNodeList(parent,ref,null),parent_next=AddNode(parent.tagName,parent.parentNode,parent.nextSibling);SafePushNodeList(parent_next,fragment),next_ref=parent_next}else{const fragment=RemoveNodeList(parent,ref,null),parent_next=AddNode(parent.tagName,parent.parentNode,parent.nextSibling);AddNodeList(parent_next,null,fragment),next_ref=parent_next}}parent=parent.parentNode}return next_ref}function RecoveryEmptyElement(node){switch(node.tagName){case"P":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"TH":case"TD":case"FIGCAPTION":null===node.firstChild&&AddNode("BR",node,null);break;case"LI":if(null===node.firstChild)AddNode("BR",node,null);else{let ch=node.firstChild;"OL"!==ch.nodeName&&"UL"!==ch.nodeName||AddNode("BR",node,ch);for(let a=node.firstChild;null!==a;a=a.nextSibling)RecoveryEmptyElement(a)}break;case"OL":case"UL":if(null===node.firstChild)AddNode("LI",node,null),AddNode("BR",node.firstChild,null);else for(let a=node.firstChild;null!==a;a=a.nextSibling)RecoveryEmptyElement(a);break;case"DIV":if(null===node.firstChild)AddNode("P",node,null),AddNode("BR",node.firstChild,null);else for(let a=node.firstChild;null!==a;a=a.nextSibling)RecoveryEmptyElement(a);break;default:for(let a=node.firstChild;null!==a;a=a.nextSibling)RecoveryEmptyElement(a)}}function RecoveryPandFigure(node){switch(node.nodeName){case"P":node.firstChild.nodeType===Node.TEXT_NODE?node.firstChild.data==nt_ZWBR&&IsSpanMathImg(node.firstChild.nextSibling)&&ConvertPtoFigure(node):IsSpanMathImg(node.firstChild)&&ConvertPtoFigure(node);break;case"FIGURE":{let is_figure=!1;node.firstChild.nodeType===Node.TEXT_NODE?node.firstChild.data==nt_ZWBR&&IsSpanMathImg(node.firstChild.nextSibling)&&(is_figure=!0):IsSpanMathImg(node.firstChild)&&(is_figure=!0),is_figure||ConvertFiguretoP(node)}break;case"DIV":{let next;for(let ch=node.firstChild;ch;ch=next)next=ch.nextSibling,("P"===ch.nodeName||"FIGURE"===ch.nodeName)&&RecoveryPandFigure(ch)}}}function ConnectionNodeRecursive(ref_node){let focus={node:ref_node,offset:0};if(null===ref_node.previousSibling)return focus;if(ref_node.nodeType==Node.TEXT_NODE&&ref_node.previousSibling.nodeType==Node.TEXT_NODE)return ref_node.data==nt_ZWBR?(RemoveNode(ref_node),{node:ref_node.previousSibling,offset:ref_node.previousSibling.length}):ref_node.previousSibling.data==nt_ZWBR?(RemoveNode(ref_node.previousSibling),focus):(focus={node:ref_node.previousSibling,offset:ref_node.previousSibling.length},InsertTextIntoText(ref_node.data,ref_node.previousSibling,ref_node.previousSibling.length),RemoveNode(ref_node),focus);for(;ref_node&&null!==ref_node.previousSibling;){const prev=ref_node.previousSibling;let next_ref=null;if("LI"==ref_node.nodeName){if("LI"!=prev.nodeName)break;if(prev.lastChild&&("OL"==prev.lastChild.nodeName||"UL"==prev.lastChild.nodeName)){let latter_first_OL_UL=null;if("BR"==ref_node.firstChild.nodeName?ref_node.firstChild.nextSibling&&("OL"!=ref_node.firstChild.nextSibling.nodeName&&"UL"!=ref_node.firstChild.nextSibling.nodeName||(latter_first_OL_UL=ref_node.firstChild.nextSibling)):"OL"!=ref_node.firstChild.nodeName&&"UL"!=ref_node.firstChild.nodeName||(latter_first_OL_UL=ref_node.firstChild),latter_first_OL_UL&&latter_first_OL_UL.nodeName==prev.lastChild){focus={node:latter_first_OL_UL.firstChild,offset:0};const fragment=RemoveNodeList(latter_first_OL_UL,latter_first_OL_UL.firstChild,null);AddNodeList(prev.lastChild,null,fragment),RemoveNode(ref_node);break}break}focus=SafePushNodeList(prev,RemoveNodeList(ref_node,ref_node.firstChild,null)),RemoveNode(ref_node)}else if("OL"===ref_node.nodeName||"UL"===ref_node.nodeName){if(prev.nodeName!=ref_node.nodeName)break;focus={node:ref_node.firstChild,offset:0},next_ref=ref_node.firstChild;AddNodeList(prev,null,RemoveNodeList(ref_node,ref_node.firstChild,null));RemoveNode(ref_node)}else if("P"===ref_node.nodeName){if(prev.nodeName!=ref_node.nodeName)break;focus=SafeCombineNode(prev)}ref_node=next_ref}return focus}function PasteTopLevelNodes(node,offset,fragment,master_node){if(!fragment.hasChildNodes())return;let parent,pos_after;if(undo_man.Begin(node,offset),node.nodeType===Node.TEXT_NODE)if(IsTextNodeInMath(node)){const math=node.parentNode.parentNode;if(0===offset)parent=math.parentNode,pos_after=math;else{if(offset!==node.length)return void undo_man.Cancel();parent=math.parentNode,pos_after=math.nextSibling}}else 0==offset?(parent=node.parentNode,pos_after=node):offset<node.length?(parent=node.parentNode,pos_after=DivideTextNode(node,offset)):(parent=node.parentNode,pos_after=node.nextSibling);else node.hasChildNodes()?"OL"==node.nodeName||"UL"==node.nodeName?(parent=node.childNodes.item(offset),pos_after=parent.firstChild):(parent=node,pos_after=node.childNodes.item(offset)):(parent=node.parentNode,pos_after=node);if(1==fragment.childNodes.length){if(["P","H1","H2","H3","H4","H5","H6","LI","TH","TD","FIGCAPTION"].includes(fragment.firstChild.nodeName)){SafeJunctionPoint(parent,AddNodeList(parent,pos_after,FragmentFromChildren(fragment.firstChild)));const focus=SafeJunctionPoint(parent,pos_after);return document.getSelection().collapse(focus.node,focus.offset),RecoveryPandFigure(parent),void undo_man.End(focus.node,focus.offset)}}if("LI"===parent.tagName){let fragment_for_li=null;if(1==fragment.childNodes.length)"OL"!=fragment.firstChild.nodeName&&"UL"!=fragment.firstChild.nodeName||(fragment_for_li=FragmentFromChildren(fragment.firstChild));else{let can_be_regarded_as_LI=!0;for(let node=fragment.firstChild;node;node=node.nextSibling)["P","H1","H2","H3","H4","H5","H6","OL","UL"].includes(node.nodeName)||(can_be_regarded_as_LI=!1);if(can_be_regarded_as_LI){fragment_for_li=new DocumentFragment;let next,prev_li=null;for(let node=fragment.firstChild;node;node=next)if(next=node.nextSibling,"OL"==node.nodeName||"UL"==node.nodeName){if(null===prev_li){const li=document.createElement("LI");li.appendChild(document.createElement("BR")),li.appendChild(fragment.removeChild(node)),fragment_for_li.appendChild(li)}else prev_li.appendChild(fragment.removeChild(node));prev_li=null}else{const li=document.createElement("LI");li.appendChild(FragmentFromChildren(node)),fragment_for_li.appendChild(li),prev_li=li}}}if(fragment_for_li){const fragment=SafeRemoveNodeList(parent,pos_after,null),parent_next=AddNode(parent.tagName,parent.parentNode,parent.nextSibling);SafePushNodeList(parent_next,fragment);ConnectionNodeRecursive(AddNodeList(parent.parentNode,parent_next,fragment_for_li));const focus=ConnectionNodeRecursive(parent_next);return undo_man.End(focus.node,focus.offset),void document.getSelection().collapse(focus.node,focus.offset)}}if(["LI","P","H1","H2","H3","H4","H5","H6","FIGURE","FIGCAPTION"].includes(parent.nodeName)){const ref_node=DivideAtCrossSection2(pos_after,parent,master_node);ConnectionNodeRecursive(AddNodeList(master_node,ref_node,fragment));const focus=ref_node?ConnectionNodeRecursive(ref_node):SafeJunctionPoint(parent,ref_node);return RecoveryPandFigure(master_node),undo_man.End(focus.node,focus.offset),void document.getSelection().collapse(focus.node,focus.offset)}undo_man.Cancel()}function FragmentFromChildren(parent){const frag=new DocumentFragment;for(;parent.firstChild;)frag.appendChild(parent.removeChild(parent.firstChild));return frag}function PrintFocus(){var selection=document.getSelection();selection.focusNode.nodeType,Node.TEXT_NODE,selection.isCollapsed||(selection.anchorNode.nodeType,Node.TEXT_NODE)}function NT_Dispatch(type){switch(type){case"undo":{let highlight_word=null;IsHighlightMode()&&(highlight_word=nt_highlight.Word,NT_HighlightClear()),ExecUndo(),highlight_word&&NT_HighlightWord(highlight_word)}break;case"redo":{let highlight_word=null;IsHighlightMode()&&(highlight_word=nt_highlight.Word,NT_HighlightClear()),ExecRedo(),highlight_word&&NT_HighlightWord(highlight_word)}break;case"selectall":SelectAll(nt_render_div);break;case"findforward":nt_finding_word.length>0&&NT_FindAndSelect(nt_finding_word);break;case"findbackward":nt_finding_word.length>0&&NT_FindBackwardAndSelect(nt_finding_word)}}const nt_SPACE_FOR_LIST="  ";function DOM2MD(target_node){const md_text=MdFromChildNodes(target_node,0);let offset=0;for(;offset<md_text.length&&"\n"==md_text.charAt(offset);)offset++;return md_text.slice(offset)}function MdFromChildNodes(parent,list_rank){let text_buffer="",node=parent.firstChild;for(;node;)text_buffer+=MdFromNode(node,list_rank),node=node.nextSibling;return text_buffer}function MdFromList(parent,list_rank,head){let text_buffer="",li=parent.firstChild;for(;li;){text_buffer+=head+ReplaceAllExcept(MdFromChildNodes(li,list_rank+1),"\n","\n  ","\n"),li=li.nextSibling,"\n"!=text_buffer[text_buffer.length-1]&&(text_buffer+="\n")}return text_buffer}function MdFromNode(node,list_rank){if(node.nodeType===Node.TEXT_NODE)return node.data==nt_ZWBR?"":node.data;switch(node.tagName){case"BR":return"P"==node.parentNode.nodeName?"  \n":"";case"P":{const text=MdFromChildNodes(node,list_rank);return node.previousSibling?0===text.length?"\n  \n":"\n"===text[text.length-1]?"\n"+text:"\n"+text+"\n":0===text.length?"  \n":"\n"===text[text.length-1]?text:text+"\n"}case"UL":{const text=MdFromList(node,list_rank,"- ");return 0===list_rank&&node.previousSibling&&"P"!==node.previousSibling.tagName&&"OL"!==node.previousSibling.tagName&&"UL"!==node.previousSibling.tagName?"\n\n"+text:"\n"+text}case"OL":{const text=MdFromList(node,list_rank,"1. ");return 0===list_rank&&node.previousSibling&&"P"!==node.previousSibling.tagName&&"OL"!==node.previousSibling.tagName&&"UL"!==node.previousSibling.tagName?"\n\n"+text:"\n"+text}case"SPAN":if("math"==node.className)switch(node.lastChild.className){case"editmathdisp":case"editcodedisp":{let math_text=node.lastChild.firstChild.data;if(list_rank>0)return"\n\n"+math_text+"\n";if(node.previousSibling){if("math"==node.previousSibling.className){const math_class=node.previousSibling.lastChild.className;if("editmathdisp"==math_class||"editcodedisp"==math_class)return math_text+"\n"}return"\n"+math_text+"\n"}return math_text+"\n"}case"editimg":case"editcite":return node.lastChild.firstChild.data.slice(0,node.lastChild.firstChild.length-1);case"editref":return node.lastChild.firstChild.data.slice(0,node.lastChild.firstChild.length)+" ";default:if("_"==node.lastChild.firstChild.data.charAt(0)){let text=node.lastChild.firstChild.data;return node.previousSibling&&(node.previousSibling.nodeType===Node.TEXT_NODE?" "!=node.previousSibling.data.charAt(node.previousSibling.length-1)&&(text=" "+text):text=" "+text),node.nextSibling&&(node.nextSibling.nodeType===Node.TEXT_NODE?" "!=node.nextSibling.data.charAt(0)&&(text+=" "):text+=" "),text}return node.lastChild.firstChild.data}return"";case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":{const head="#".repeat(parseInt(node.tagName.charAt(1),10))+" ",text=MdFromChildNodes(node,list_rank);return node.previousSibling?0===text.length?"\n"+head+"  \n":"\n"===text[text.length-1]?"\n"+head+text:"\n"+head+text+"\n":0===text.length?head+"  \n":"\n"===text[text.length-1]?head+text:head+text+"\n"}case"FIGURE":{let text=node.previousSibling?"\n":"",img=node.firstChild;for(;img;){if(IsSpanMathImg(img))text+=MdFromNode(img)+"\n";else if("FIGCAPTION"==img.nodeName)break;img=img.nextSibling}return img&&(text+=MdFromChildNodes(img,list_rank)),0===text.length?"  \n":"\n"===text[text.length-1]?text:text+"\n"}case"TABLE":{let text=node.previousSibling?"\n":"";for(let tr=node.firstChild;tr;tr=tr.nextSibling)text+=MdFromNode(tr,0);return text}case"TR":{let text="|";for(let td=node.firstChild;td;td=td.nextSibling){let text_in_id=MdFromNode(td,0);"\n"===text_in_id[text_in_id.length-1]?text+=text_in_id.slice(0,text_in_id.length-1)+"|":text+=text_in_id+"|"}return text+="\n",text}case"TH":case"TD":case"MARK":return MdFromChildNodes(node,0)}return alert("invalid node cannot be changed:"+node.tagName),""}function DOM2TEX(target_node){return TexHeader()+TexBody(target_node)+TexFooter()}function TexHeader(){let head_text="";return head_text+="\\documentclass{ltjsarticle}\n",head_text+="\\usepackage{bm}\n",head_text+="\\usepackage{graphicx}\n",head_text+="\\usepackage{fancybox}\n",head_text+="\\usepackage{ascmac}\n",head_text+="\\usepackage{amsmath}\n",head_text+="\\usepackage[luatex,pdfencoding=auto]{hyperref}\n",head_text+="\\begin{document}\n",head_text+="\n","\\documentclass{ltjsarticle}\n\\usepackage{bm}\n\\usepackage{graphicx}\n\\usepackage{fancybox}\n\\usepackage{ascmac}\n\\usepackage{amsmath}\n\\usepackage[luatex,pdfencoding=auto]{hyperref}\n\\begin{document}\n\n"}function TexFooter(){return"\n\\end{document}\n"}function TexBody(parent){let text_buffer="",node=parent.firstChild;if("H1"==node.nodeName){const h1_text=TexFromChildNodes(node,0);text_buffer+="\\title{",text_buffer+="\n"==h1_text[h1_text.length-1]?h1_text.slice(0,h1_text.length-1):h1_text,text_buffer+="}\n",text_buffer+="\\maketitle\n\n",node=node.nextSibling}let node_end=null,num_ref=0;{let ref=parent.lastChild;for(;ref!==node;){let to_prev=!1;if("P"==ref.nodeName){let ch=ref.firstChild;ch.nodeType==Node.TEXT_NODE&&ch.data==nt_ZWBR&&(ch=ch.nextSibling),"SPAN"==ch.nodeName&&"editref"==ch.lastChild.className&&(num_ref++,node_end=ref,ref!==node&&(to_prev=!0,ref=ref.previousSibling))}if(!to_prev)break}}for(;node!==node_end;)text_buffer+=TexFromNode(node,0),node=node.nextSibling;if(num_ref>0){for(text_buffer+="\n\\begin{thebibliography}",text_buffer+=num_ref<10?"{9}\n":"{99}\n";node;)text_buffer+=TexFromNode(node,0),node=node.nextSibling;text_buffer+="\\end{thebibliography}\n"}return text_buffer}function TexFromChildNodes(parent,list_rank){let text_buffer="",node=parent.firstChild;for(;node;)text_buffer+=TexFromNode(node,list_rank),node=node.nextSibling;return text_buffer}function TexFromList(parent,list_rank,head){let text_buffer="",li=parent.firstChild;for(;li;){text_buffer+=head+ReplaceAllExcept(TexFromChildNodes(li,list_rank+1),"\n","\n  ","\n"),li=li.nextSibling,"\n"!=text_buffer[text_buffer.length-1]&&(text_buffer+="\n")}return text_buffer}function TexFromNode(node,list_rank){if(node.nodeType===Node.TEXT_NODE)return node.data==nt_ZWBR?"":ReplaceAll(ReplaceAll(node.data,"#","\\#"),"%","\\%");switch(node.tagName){case"BR":return"P"==node.parentNode.nodeName?"  \n":"";case"P":{const text=TexFromChildNodes(node,list_rank);return node.previousSibling?0===text.length?"\n  \n":"\n"===text[text.length-1]?"\n"+text:"\n"+text+"\n":0===text.length?"  \n":"\n"===text[text.length-1]?text:text+"\n"}case"UL":{let text=TexFromList(node,list_rank,"\\item ");return text="\\begin{itemize}\n"+text+"\\end{itemize}\n",0===list_rank&&node.previousSibling&&"P"!==node.previousSibling.tagName&&"OL"!==node.previousSibling.tagName&&"UL"!==node.previousSibling.tagName?"\n\n"+text:"\n"+text}case"OL":{let text=TexFromList(node,list_rank,"\\item ");return text="\\begin{enumerate}\n"+text+"\\end{enumerate}\n",0===list_rank&&node.previousSibling&&"P"!==node.previousSibling.tagName&&"OL"!==node.previousSibling.tagName&&"UL"!==node.previousSibling.tagName?"\n\n"+text:"\n"+text}case"SPAN":if("math"==node.className)switch(node.lastChild.className){case"editmathdisp":{let math_text=node.lastChild.firstChild.data,p_s=math_text.indexOf("\\begin{align}");if(p_s>=0){let p_e=math_text.indexOf("\\end{align}");p_e<0?p_e=math_text.length:p_e+="\\end{align}".length,math_text=math_text.slice(p_s,p_e)}else math_text=math_text.indexOf("\\\\")>=0?"\\begin{align}"+math_text.slice(2,math_text.length-2)+"\\end{align}":"\\begin{equation}"+math_text.slice(2,math_text.length-2)+"\\end{equation}";if(list_rank>0)return"\n\n"+math_text+"\n";if(node.previousSibling){if("math"==node.previousSibling.className){const math_class=node.previousSibling.lastChild.className;if("editmathdisp"==math_class||"editcodedisp"==math_class)return math_text+"\n"}return"\n"+math_text+"\n"}return math_text+"\n"}case"editcodedisp":{let math_text=node.lastChild.firstChild.data,p_s=math_text.indexOf("\n");if(math_text=p_s>3?"\\begin{itembox}[l]{"+math_text.slice(3,p_s)+"}\n\\begin{verbatim}"+math_text.slice(p_s+1,math_text.length-3)+"\\end{verbatim}\n\\end{itembox}":"\\begin{screen}\n\\begin{verbatim}"+math_text.slice(3,math_text.length-3)+"\\end{verbatim}\n\\end{screen}",list_rank>0)return"\n\n"+math_text+"\n";if(node.previousSibling){if("math"==node.previousSibling.className){const math_class=node.previousSibling.lastChild.className;if("editmathdisp"==math_class||"editcodedisp"==math_class)return math_text+"\n"}return"\n"+math_text+"\n"}return math_text+"\n"}case"editimg":{let p_s=node.lastChild.firstChild.data.indexOf("(");return p_s<0&&(p_s=0),p_s++,"\\includegraphics{"+node.lastChild.firstChild.data.slice(p_s,node.lastChild.firstChild.length-2)+"}"}case"edita":{let t_e=node.lastChild.firstChild.data.indexOf("]");t_e<0&&(t_e=1);let p_s=node.lastChild.firstChild.data.indexOf("(",t_e);return p_s<0&&(p_s=0),p_s++,"\\href{"+node.lastChild.firstChild.data.slice(p_s,node.lastChild.firstChild.length-2)+"}{"+node.lastChild.firstChild.data.slice(1,t_e)+"}"}case"editcite":return"\\cite{"+node.lastChild.firstChild.data.slice(2,node.lastChild.firstChild.length-2)+"}";case"editref":return"\\bibitem{"+node.lastChild.firstChild.data.slice(2,node.lastChild.firstChild.length-2)+"} ";case"editcode":return"\\ovalbox{ \\verb*`"+node.lastChild.firstChild.data.slice(1,node.lastChild.firstChild.length-1)+"` }";case"editem1":{const mlen=1;return"\\emph{"+node.lastChild.firstChild.data.slice(mlen,node.lastChild.firstChild.length-mlen)+"}"}case"editem2":{const mlen=2;return"\\textbf{"+node.lastChild.firstChild.data.slice(mlen,node.lastChild.firstChild.length-mlen)+"}"}case"editem3":{const mlen=3;return"\\textbf{\\emph{"+node.lastChild.firstChild.data.slice(mlen,node.lastChild.firstChild.length-mlen)+"}}"}default:if("_"==node.lastChild.firstChild.data.charAt(0)){let text=node.lastChild.firstChild.data;return node.previousSibling&&(node.previousSibling.nodeType===Node.TEXT_NODE?" "!=node.previousSibling.data.charAt(node.previousSibling.length-1)&&(text=" "+text):text=" "+text),node.nextSibling&&(node.nextSibling.nodeType===Node.TEXT_NODE?" "!=node.nextSibling.data.charAt(0)&&(text+=" "):text+=" "),text}return node.lastChild.firstChild.data}return"";case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":{const head=TexSectionName(node.tagName)+"{",text=TexFromChildNodes(node,list_rank);return node.previousSibling?0===text.length?"\n"+head+"}\n":"\n"===text[text.length-1]?"\n"+head+text.slice(0,text.length-1)+"}\n":"\n"+head+text+"}\n":0===text.length?head+"}\n":"\n"===text[text.length-1]?head+text.slice(0,text.length-1)+"}\n":head+text+"}\n"}case"FIGURE":{let text=node.previousSibling?"\n":"";text+="\\begin{figure}[h]\n",text+="\\begin{center}\n";let img=node.firstChild;for(;img;){if(IsSpanMathImg(img))text+=TexFromNode(img)+"\n";else if("FIGCAPTION"==img.nodeName)break;img=img.nextSibling}return img&&(text+="\\caption{"+TexFromChildNodes(img,list_rank)+"}\n"),text+="\\end{center}\n",text+="\\end{figure}\n",0===text.length?"  \n":text}case"TABLE":{let text=node.previousSibling?"\n":"";text+="\\begin{table}[h]\n",text+="\\begin{tabular}";{let align_text="{";for(let td=node.firstChild.nextSibling.firstChild;td;td=td.nextSibling)":"==td[0]?":"==td[td.length-1]?align_text+="c":align_text+="l":":"==td[td.length-1]?align_text+="r":align_text+="l";text+=align_text+"}  \\hline\n"}for(let tr=node.firstChild;tr;tr=tr.nextSibling)if(tr===node.firstChild.nextSibling)text+="\\hline\n";else{for(let td=tr.firstChild;td;td=td.nextSibling){let text_in_id=TexFromChildNodes(td,0);"\n"===text_in_id[text_in_id.length-1]?text+=text_in_id.slice(0,text_in_id.length-1):text+=text_in_id,td.nextSibling&&(text+="&")}text+="\\\\\n"}return text+="\\hline\n",text+="\\end{tabular}\n",text+="\\end{table}\n",text}case"MARK":return TexFromChildNodes(node,0)}return alert("invalid node cannot be changed:"+node.tagName),""}function TexSectionName(tagName){switch(tagName){case"H1":return"\\part";case"H2":return"\\section";case"H3":return"\\subsection";case"H4":return"\\subsubsection";case"H5":return"\\paragraph";case"H6":return"\\subparagraph"}}const nt_ZWBR="​";class SelectionInfo{constructor(focusNode_,focusOffset_,anchorNode_=focusNode_,anchorOffset_=focusOffset_){this.focusNode=focusNode_,this.focusOffset=focusOffset_,this.anchorNode=anchorNode_,this.anchorOffset=anchorOffset_}}class OperationInfo{constructor(update_type,data_,parent_,offset_,length_){this.updateType=update_type,this.data=data_,this.parent=parent_,this.offset=offset_,this.length=length_,this.is_connect_to_past=!1,this.is_connect_to_future=!1}}class History{constructor(selection_before,operation_begin){this.selectionBefore=selection_before,this.selectionAfter=null,this.operationBegin=operation_begin,this.operationEnd=operation_begin}}var UR_TYPE={NONE:0,INSERT_TEXT_INTO_TEXT:1,DELETE_IN_TEXT:101,DIVIDE_TEXT_NODE:202,ADD_NODE:1001,ADD_TEXT_NODE:1002,ADD_MATH_NODE:1007,REMOVE_NODE:2001,COMBINE_TEXT_NODE:3002,REMOVE_NODE_LIST:3004,ADD_NODE_LIST:3005};class UndoManager{constructor(){this.name="undo_manager",this.operations=[],this.history=[],this.index_history=0,this.index_operation=0,this.acceptable=!1,this.begin_selection=null,this.begin_index_ope=0,this.event_dispatcher=null}get numHistory(){return this.history.length}Begin(focusNode_,focusOffset_,anchorNode_=focusNode_,anchorOffset_=focusOffset_){this.acceptable&&alert("ERROR: invalid Undo registration"),this.Shrink(),this.begin_selection=new SelectionInfo(focusNode_,focusOffset_,anchorNode_,anchorOffset_),this.begin_index_ope=this.index_operation,this.operations.length>this.index_operation&&this.operations.splice(this.index_operation),this.acceptable=!0}End(focusNode_,focusOffset_,anchorNode_=focusNode_,anchorOffset_=focusOffset_){if(this.begin_index_ope<this.index_operation){let hist=new History(this.begin_selection,this.begin_index_ope);hist.selectionAfter=new SelectionInfo(focusNode_,focusOffset_,anchorNode_,anchorOffset_),hist.operationEnd=this.index_operation,this.history.push(hist),this.index_history++}this.acceptable=!1,this.event_dispatcher&&this.event_dispatcher.Dispatch()}Cancel(){this.acceptable&&(this.begin_index_ope<this.index_operation&&alert("DOM operation is canceled but, DOM has been already changed."),this.index_operation=this.begin_index_ope,this.acceptable=!1)}Shrink(){!1===this.acceptable&&this.history.length>this.index_history&&(this.index_operation=this.history[this.index_history].operationBegin,this.operations.splice(this.index_operation),this.history.splice(this.index_history))}Register(ur_type,data,parent,offset,length){this.acceptable||alert("ERROR: Undo Manager: call Begin before calling Register!"),this.operations.push(new OperationInfo(ur_type,data,parent,offset,length)),this.index_operation++}GetUndo(){if(0===this.index_history)return null;this.index_history--;const hist=this.history[this.index_history];return this.operation_begin=hist.operationBegin,hist}GetRedo(){if(this.index_history===this.history.length)return null;const hist=this.history[this.index_history];return this.index_history++,this.operation_begin=hist.operationEnd,hist}GetOperation(index_ope){return this.operations[index_ope]}SetChangeEventDispatcher(event_dispatcher){this.event_dispatcher=event_dispatcher}GetChangeEventDispatcher(){return this.event_dispatcher}}class ChangeEventDispatcher{constructor(event_target){this.event_target=event_target,this.has_changed=!1,this.enable=!0}Reset(){this.has_changed=!1}Dispatch(){!1===this.has_changed&&this.event_target&&this.enable&&(this.has_changed=!0,this.event_target.dispatchEvent(new CustomEvent("nt_changed")))}Enable(){this.enable=!0}Disable(){this.enable=!1}}let undo_man=null;function CreateSelectionInfo(selection){return new SelectionInfo(selection.focusNode,selection.focusOffset,selection.anchorNode,selection.anchorOffset)}function CloneSelectionInfo(si){return new SelectionInfo(si.focusNode,si.focusOffset,si.anchorNode,si.anchorOffset)}function ExecUndo(){let history=undo_man.GetUndo();if(!history)return!1;for(let i=history.operationEnd-1;i>=history.operationBegin;i--){const ope=undo_man.GetOperation(i);switch(ope.updateType){case UR_TYPE.INSERT_TEXT_INTO_TEXT:UndoInsertTextToText(ope);break;case UR_TYPE.ADD_TEXT_NODE:UndoAddTextNode(ope);break;case UR_TYPE.ADD_NODE:case UR_TYPE.ADD_MATH_NODE:UndoAddNode(ope);break;case UR_TYPE.DELETE_IN_TEXT:UndoDeleteText(ope);break;case UR_TYPE.DIVIDE_TEXT_NODE:UndoDivideTextNode(ope);break;case UR_TYPE.REMOVE_NODE:UndoRemoveNode(ope);break;case UR_TYPE.COMBINE_TEXT_NODE:UndoCombineTextNode(ope);break;case UR_TYPE.REMOVE_NODE_LIST:UndoRemoveNodeList(ope);break;case UR_TYPE.ADD_NODE_LIST:UndoAddNodeList(ope)}}return history.selectionBefore.focusOffset==NT_SELECT_CELL_MODE?SetSelectTable(history.selectionBefore.anchorNode,history.selectionBefore.focusNode):history.selectionBefore.focusNode===history.selectionBefore.anchorNode&&history.selectionBefore.focusOffset===history.selectionBefore.anchorOffset?document.getSelection().collapse(history.selectionBefore.focusNode,history.selectionBefore.focusOffset):document.getSelection().setBaseAndExtent(history.selectionBefore.anchorNode,history.selectionBefore.anchorOffset,history.selectionBefore.focusNode,history.selectionBefore.focusOffset),CheckEditPreview(null,!0),undo_man.GetChangeEventDispatcher().Dispatch(),!0}function ExecRedo(){let history=undo_man.GetRedo();if(!history)return!1;for(let i=history.operationBegin;i<history.operationEnd;i++){const ope=undo_man.GetOperation(i);switch(ope.updateType){case UR_TYPE.INSERT_TEXT_INTO_TEXT:RedoInsertTextToText(ope);break;case UR_TYPE.ADD_TEXT_NODE:RedoAddTextNode(ope);break;case UR_TYPE.ADD_NODE:case UR_TYPE.ADD_MATH_NODE:RedoAddNode(ope);break;case UR_TYPE.DELETE_IN_TEXT:RedoDeleteText(ope);break;case UR_TYPE.DIVIDE_TEXT_NODE:RedoDivideTextNode(ope);break;case UR_TYPE.REMOVE_NODE:RedoRemoveNode(ope);break;case UR_TYPE.COMBINE_TEXT_NODE:RedoCombineTextNode(ope);break;case UR_TYPE.REMOVE_NODE_LIST:RedoRemoveNodeList(ope);break;case UR_TYPE.ADD_NODE_LIST:RedoAddNodeList(ope)}}return history.selectionAfter.focusOffset==NT_SELECT_CELL_MODE?SetSelectTable(history.selectionAfter.anchorNode,history.selectionAfter.focusNode):history.selectionAfter.focusNode===history.selectionAfter.anchorNode&&history.selectionAfter.focusOffset===history.selectionAfter.anchorOffset?document.getSelection().collapse(history.selectionAfter.focusNode,history.selectionAfter.focusOffset):document.getSelection().setBaseAndExtent(history.selectionAfter.anchorNode,history.selectionAfter.anchorOffset,history.selectionAfter.focusNode,history.selectionAfter.focusOffset),CheckEditPreview(null,!0),undo_man.GetChangeEventDispatcher().Dispatch(),!0}function InsertTextIntoText(text,node,offset){node.insertData(offset,text),undo_man.Register(UR_TYPE.INSERT_TEXT_INTO_TEXT,text,node,offset,text.length)}function UndoInsertTextToText(operation_info){let node=operation_info.parent;node.nodeType!==Node.TEXT_NODE&&alert("Undo: node is not text in UndoInsertTextToText"),node.deleteData(operation_info.offset,operation_info.length)}function RedoInsertTextToText(operation_info){let node=operation_info.parent;node.nodeType!==Node.TEXT_NODE&&alert("Undo: node is not text in RedoInsertTextToText"),node.insertData(operation_info.offset,operation_info.data)}function DeleteText(node,offset,length=1){if(node.length<=offset)return alert("node focus is invalid"),null;const text=node.data.slice(offset,offset+length);return node.deleteData(offset,length),undo_man.Register(UR_TYPE.DELETE_IN_TEXT,text,node,offset,length),text}function UndoDeleteText(operation_info){operation_info.parent.insertData(operation_info.offset,operation_info.data)}function RedoDeleteText(operation_info){operation_info.parent.deleteData(operation_info.offset,operation_info.length)}function AddMathNode(mark,parent,ref_node){const offset=GetIndex(parent,ref_node);let math=CreateMathNode(mark);return math&&(parent.insertBefore(math,ref_node),undo_man.Register(UR_TYPE.ADD_MATH_NODE,math,parent,offset,1)),math}function CreateMathNode(mark){switch(mark){case"$":{let math=document.createElement("SPAN");return math.className="math",math.insertAdjacentHTML("afterbegin",katex.renderToString("",{throwOnError:!1})),math.insertAdjacentHTML("beforeend","<span class='editmath'>$$</span>"),math}case"$$":{let math=document.createElement("SPAN");return math.className="math",katexAutoNumber("",math,0),math.insertAdjacentHTML("beforeend","<span class='editmathdisp'>$$\n\n$$</span>"),math.dataset.eqnumberBegin=0,math.dataset.eqnumberEnd=0,math}case"`":{let math=document.createElement("SPAN");return math.className="math",math.insertAdjacentHTML("afterbegin","<span class='previewcode'>dummy</span>"),math.insertAdjacentHTML("beforeend","<span class='editcode'>``</span>"),math}case"```":{const math=document.createElement("SPAN");return math.className="math",math.insertAdjacentHTML("afterbegin","<span class='previewcodedisp'>dummy</span>"),math.insertAdjacentHTML("beforeend","<span class='editcodedisp'>```\n\n```</span>"),math}case"*":case"_":{const math=document.createElement("SPAN");return math.className="math",math.insertAdjacentHTML("afterbegin","<em>dummy</em>"),math.insertAdjacentHTML("beforeend","<span class='editem1'>"+mark+mark+"</span>"),math}case"**":case"__":{const math=document.createElement("SPAN");return math.className="math",math.insertAdjacentHTML("afterbegin","<strong>dummy</strong>"),math.insertAdjacentHTML("beforeend","<span class='editem2'>"+mark+mark+"</span>"),math}case"***":case"___":{const math=document.createElement("SPAN");return math.className="math",math.insertAdjacentHTML("afterbegin","<em><strong>dummy</strong></em>"),math.insertAdjacentHTML("beforeend","<span class='editem3'>"+mark+mark+"</span>"),math}case"[":{const math=document.createElement("SPAN");return math.className="math",math.insertAdjacentHTML("afterbegin",'<a href="'+NT_LINK_DEFAULT_URL+'" target="_blank" ref="noopener noreferrer">'+NT_LINK_DEFAULT_TEXT+"</a>"),math.insertAdjacentHTML("beforeend","<span class='edita'>["+NT_LINK_DEFAULT_TEXT+"]("+NT_LINK_DEFAULT_URL+")</span>"),math}case"![":{const math=document.createElement("SPAN");return math.className="math",math.insertAdjacentHTML("afterbegin",'<img src="sample.jpg" alt="AltWord">'),math.insertAdjacentHTML("beforeend","<span class='editimg'>![AltwWord](image.png) </span>"),math}case"[^":{const math=document.createElement("SPAN");return math.className="math",math.insertAdjacentHTML("afterbegin","<a class='previewcite'>dummy</span>"),math.insertAdjacentHTML("beforeend","<span class='editcite'>[^] </span>"),math}}return null}function AddTextNode(text,parent,ref_node){const offset=GetIndex(parent,ref_node);let text_node=document.createTextNode(text);return parent.insertBefore(text_node,ref_node),undo_man.Register(UR_TYPE.ADD_TEXT_NODE,text_node,parent,offset,1),text_node}function UndoAddTextNode(operation_info){operation_info.data.remove()}function RedoAddTextNode(operation_info){let parent=operation_info.parent,text_node=operation_info.data,ref_node=parent.childNodes.item(operation_info.offset);parent.insertBefore(text_node,ref_node)}function GetIndex(parent,child){let ch=parent.firstChild,index=0;for(;ch;){if(child===ch)return index;ch=ch.nextSibling,++index}return index}function RemoveNode(node){const offset=GetIndex(node.parentNode,node),parent=node.parentNode;return node.remove(),undo_man.Register(UR_TYPE.REMOVE_NODE,node,parent,offset,1),node}function UndoRemoveNode(operation_info){let parent=operation_info.parent;parent.insertBefore(operation_info.data,parent.childNodes.item(operation_info.offset))}function RedoRemoveNode(operation_info){operation_info.data.remove()}function AddNode(tag_name,parent,ref_node){let offset=GetIndex(parent,ref_node),new_node=document.createElement(tag_name);return parent.insertBefore(new_node,ref_node),undo_man.Register(UR_TYPE.ADD_NODE,new_node,parent,offset,1),new_node}function UndoAddNode(operation_info){let node=operation_info.data;const parent=operation_info.parent,offset=operation_info.offset;if(parent.childNodes.item(offset)!==node){if(parent.childNodes.item(offset).nodeName!==node.nodeName)return void alert("ERROR: added node does not exist!");node=parent.childNodes.item(offset)}node.remove()}function RedoAddNode(operation_info){let parent=operation_info.parent,new_node=operation_info.data,ref_node=parent.childNodes.item(operation_info.offset);parent.insertBefore(new_node,ref_node)}function DivideTextNode(node,offset){let new_node=node.splitText(offset);return undo_man.Register(UR_TYPE.DIVIDE_TEXT_NODE,new_node,node,offset,new_node.length),new_node}function UndoDivideTextNode(operation_info){let node=operation_info.data;operation_info.parent.appendData(node.data),node.remove()}function RedoDivideTextNode(operation_info){let new_node=operation_info.data,node=operation_info.parent;node.deleteData(operation_info.offset,operation_info.length),node.after(new_node)}function CombineTextNode(node){let next=node.nextSibling;const offset=node.length;node.appendData(next.data),next.remove(),undo_man.Register(UR_TYPE.COMBINE_TEXT_NODE,next,node,offset,next.length)}function UndoCombineTextNode(operation_info){let node=operation_info.parent,next=operation_info.data;node.deleteData(operation_info.offset,operation_info.length),node.after(next)}function RedoCombineTextNode(operation_info){let node=operation_info.parent,next=operation_info.data;node.appendData(next.data),next.remove()}function RemoveNodeList(parent,start_node,end_node=null){let offset=GetIndex(parent,start_node),fragment=new DocumentFragment,pos=start_node;for(;pos!==end_node;){let next=pos.nextSibling;pos.remove(),fragment.appendChild(pos),pos=next}return undo_man.Register(UR_TYPE.REMOVE_NODE_LIST,fragment,parent,offset,fragment.childNodes.length),fragment}function UndoRemoveNodeList(operation_info){let fragment=operation_info.data,parent=operation_info.parent,offset=operation_info.offset;parent.insertBefore(fragment,parent.childNodes.item(offset))}function RedoRemoveNodeList(operation_info){let fragment=operation_info.data,parent=operation_info.parent,offset=operation_info.offset,offset_end=offset+operation_info.length;const end_node=parent.childNodes.item(offset_end);let pos=parent.childNodes.item(offset);for(;pos!==end_node;){let next=pos.nextSibling;pos.remove(),fragment.appendChild(pos),pos=next}}function AddNodeList(parent,ref_node,fragment){const offset=GetIndex(parent,ref_node),length=fragment.childNodes.length,first=fragment.firstChild;return parent.insertBefore(fragment,ref_node),undo_man.Register(UR_TYPE.ADD_NODE_LIST,fragment,parent,offset,length),first}function UndoAddNodeList(operation_info){let fragment=operation_info.data,parent=operation_info.parent,offset=operation_info.offset,offset_end=offset+operation_info.length;const end_node=parent.childNodes.item(offset_end);let pos=parent.childNodes.item(offset);for(;pos!==end_node;){let next=pos.nextSibling;pos.remove(),fragment.appendChild(pos),pos=next}}function RedoAddNodeList(operation_info){let fragment=operation_info.data,parent=operation_info.parent,offset=operation_info.offset;parent.insertBefore(fragment,parent.childNodes.item(offset))}function RepairLastBr(node){if(null!==node){if("OL"!==node.nodeName&&"UL"!==node.nodeName){let last=node.lastChild;if(null===last)return void AddNode("BR",node,null);if("BR"===last.nodeName)return;return"OL"!==last.nodeName&&"UL"!==last.nodeName?void AddNode("BR",node,null):void("OL"!==node.firstChild.nodeName&&"UL"!==node.firstChild.nodeName||AddNode("BR",node,node.firstChild))}if(null===node.lastChild){let ref=AddNode("LI",node,null);AddNode("BR",ref,null)}}}function SafePushNodeList(parent1,parent2){const latter_first=parent2.firstChild;if(null===latter_first)return null;AddNodeList(parent1,null,"#document-fragment"==parent2.nodeName?parent2:RemoveNodeList(parent2,latter_first,null));const focus=SafeJunctionPoint(parent1,latter_first);return SafeTailPoint(parent1),focus}function SafeCombineNode(parent1){if(null===parent1.nextSibling)return null;if(null===parent1.nextSibling.firstChild)return null;const fragment=RemoveNodeList(parent1.nextSibling,parent1.nextSibling.firstChild,null);return RemoveNode(parent1.nextSibling),SafePushNodeList(parent1,fragment)}function SafeJunctionPoint(parent,ref){const is_BR_ZWBR=node=>{if(node){if("BR"==node.nodeName)return!0;if(node.nodeType===Node.TEXT_NODE&&node.data==nt_ZWBR)return!0}return!1};let former=ref?ref.previousSibling:parent.lastChild;if(is_BR_ZWBR(former)){const org=former;former=former.previousSibling,RemoveNode(org)}let latter=ref;if(is_BR_ZWBR(latter)){const org=latter;latter=latter.nextSibling,RemoveNode(org)}if(null===former)return SafeHeadPoint(parent);if("SPAN"==former.nodeName){if(latter&&latter.nodeType===Node.TEXT_NODE)return{node:latter,offset:0};return{node:AddTextNode(nt_ZWBR,parent,latter),offset:0}}if("UL"==former.nodeName||"OL"==former.nodeName){if(latter&&latter.nodeName==former.nodeName){const focus={node:latter.firstChild,offset:0};return AddNodeList(former,null,RemoveNodeList(latter,latter.firstChild,null)),RemoveNode(latter),focus}return{node:former.lastChild,offset:0}}if("FIGCAPTION"==former.nodeName){if(latter&&latter.nodeName==former.nodeName){const focus=SafePushNodeList(former,RemoveNodeList(latter,latter.firstChild,null));return RemoveNode(latter),focus}return{node:former.lastChild,offset:0}}former.nodeType,Node.TEXT_NODE;const foffset=former.length;return latter&&latter.nodeType===Node.TEXT_NODE?(CombineTextNode(former),{node:former,offset:foffset}):{node:former,offset:foffset}}function SafeHeadPoint(parent){const head=parent.firstChild;if(null===head){if("DIV"==parent.nodeName){const p=AddNode("P",parent,null);return AddNode("BR",p,null),{node:p,offset:0}}return AddNode("BR",parent,null),{node:parent,offset:0}}if("BR"==head.nodeName)return head.nextSibling&&"OL"!=head.nextSibling.nodeName&&"UL"!=head.nextSibling.nodeName&&"FIGCAPTION"!=head.nextSibling.nodeName&&RemoveNode(head),{node:parent,offset:0};if("SPAN"===head.nodeName){return{node:AddTextNode(nt_ZWBR,parent,head),offset:0}}return"OL"===head.nodeName||"UL"===head.nodeName||"FIGCAPTION"===head.nodeName?(AddNode("BR",parent,head),{node:parent,offset:0}):head.nodeType==Node.TEXT_NODE?{node:head,offset:0}:SafeHeadPoint(head)}function SafeTailPoint(parent){const tail=parent.lastChild;if(null===tail){if("DIV"==parent.nodeName){const p=AddNode("P",parent,null);return AddNode("BR",p,null),{node:p,offset:0}}return AddNode("BR",parent,null),{node:parent,offset:0}}if("BR"==tail.nodeName)return tail.previousSibling?(RemoveNode(tail),SafeTailPoint(parent)):{node:parent,offset:0};if("SPAN"==tail.nodeName){return{node:AddTextNode(nt_ZWBR,parent,null),offset:0}}return"OL"==tail.nodeName||"UL"==tail.nodeName?SafeTailPoint(tail.lastChild):"FIGCAPTION"===tail.nodeName?SafeTailPoint(tail):tail.nodeType==Node.TEXT_NODE?{node:tail,offset:tail.length}:SafeTailPoint(tail)}function SafeRemoveNodeList(parent,start_node,end_node=null){const fragment=RemoveNodeList(parent,start_node,end_node);return SafeJunctionPoint(parent,end_node),fragment}function ValidateMathInParent(parent){let prev=null,next=null;for(let node=parent.firstChild;node;node=next){if(next=node.nextSibling,"SPAN"==node.nodeName){if(null===prev)return!1;if(prev.nodeType!==Node.TEXT_NODE)return!1;if(null===next)return!1;if(next.nodeType!==Node.TEXT_NODE)return!1}prev=node}return!0}function AssertValidateMathInParent(parent){return!!ValidateMathInParent(parent)||(alert("ERROR: invalid for the adjacent nodes of math",parent),ValidateMathInParent(parent),!1)}function IsTextNode(node){return!(!node||node.nodeType!==Node.TEXT_NODE)}function NextOrderNode(node,upper_limit_node){if(node.firstChild)return node.firstChild;if(node.nextSibling)return node.nextSibling;for(;null===node.nextSibling;)if((node=node.parentNode)===upper_limit_node)return null;return node.nextSibling}function FindWord(word,start_node,start_offset,upper_limit_node){if(start_node.nodeType==Node.TEXT_NODE&&start_offset<start_node.length){const p=start_node.data.indexOf(word,start_offset);if(p>=0)return{node:start_node,offset:p}}let node=NextOrderNode(start_node,upper_limit_node);for(;node;)if(node.nodeType==Node.TEXT_NODE){const p=node.data.indexOf(word);if(p>=0)return{node:node,offset:p};node=NextOrderNode(node,upper_limit_node)}else node="math"==node.className?node.lastChild:NextOrderNode(node,upper_limit_node);return null}let nt_finding_word="";function NT_FindAndSelect(word){if(0==word.length)return nt_finding_word="",!1;nt_finding_word=word;const selection=document.getSelection(),focus=nt_render_div.contains(selection.focusNode)?FindWord(word,selection.focusNode,selection.focusOffset,nt_render_div):FindWord(word,nt_render_div.firstChild,0,nt_render_div);return!!focus&&(g_editable_math&&DisableEdit(g_editable_math),IsTextNodeInMath(focus.node)&&EnableMathEdit(focus.node.parentNode.parentNode),selection.setBaseAndExtent(focus.node,focus.offset,focus.node,focus.offset+word.length),!0)}function PreviousOrderNode(node,upper_limit_node){if(node.lastChild)return node.lastChild;if(node.previousSibling)return node.previousSibling;for(;null===node.previousSibling;)if((node=node.parentNode)===upper_limit_node)return null;return node.previousSibling}function FindBackward(word,start_node,start_offset,upper_limit_node){if(start_node.nodeType==Node.TEXT_NODE&&start_offset>0){const p=start_node.data.lastIndexOf(word,start_offset-1);if(p>=0)return{node:start_node,offset:p}}let node=PreviousOrderNode(start_node,upper_limit_node);for(;node;){if(node.nodeType==Node.TEXT_NODE){const p=node.data.lastIndexOf(word);if(p>=0)return{node:node,offset:p}}if("math"==node.parentNode.className&&node===node.parentNode.firstChild){for(node=node.parentNode;null===node.previousSibling;)if(node=node.parentNode,node===upper_limit_node)return null;node=node.previousSibling}else node=PreviousOrderNode(node,upper_limit_node)}return null}function NT_FindBackwardAndSelect(word){if(0==word.length)return nt_finding_word="",!1;nt_finding_word=word;const selection=document.getSelection(),focus=nt_render_div.contains(selection.anchorNode)?FindBackward(word,selection.anchorNode,selection.anchorOffset,nt_render_div):FindBackward(word,nt_render_div.lastChild,0,nt_render_div);return!!focus&&(g_editable_math&&DisableEdit(g_editable_math),IsTextNodeInMath(focus.node)&&EnableMathEdit(focus.node.parentNode.parentNode),selection.setBaseAndExtent(focus.node,focus.offset,focus.node,focus.offset+word.length),!0)}let nt_highlight=null;function IsHighlightMode(){return!(null===nt_highlight)}class Highlighter{constructor(master_node,word){this.master_node=master_node,this.word=word,this.change_list=[],this.SearchAndMark(master_node)}SearchAll(){this.SearchAndMark(this.master_node)}SearchIn(parent_set){parent_set.forEach(parent=>{this.SearchAndMark(parent)})}SearchAndMark(parent){let next;for(let node=parent.firstChild;node;node=next)if(next=node.nextSibling,node.nodeType==Node.TEXT_NODE){const fragment=this.Marking(node);if(fragment){let highlight_node_list=[];fragment.childNodes.forEach(n=>{highlight_node_list.push(n)}),this.change_list.push({original:node,highlight_node_list:highlight_node_list,length:fragment.childNodes.length,parent:parent,offset:GetIndex(parent,node)});const ref=node.nextSibling;parent.removeChild(node),parent.insertBefore(fragment,ref)}}else"SPAN"!=node.nodeName&&this.SearchAndMark(node);return!0}Marking(text_node,word=this.word){const text=text_node.data,length=text.length,width=word.length;let offset=0,p=text.indexOf(word,offset);if(p<0)return null;const fragment=new DocumentFragment;for(;p>=0;){const tnode=document.createTextNode(text.slice(offset,p));fragment.appendChild(tnode);const mark=document.createElement("MARK");mark.appendChild(document.createTextNode(word)),fragment.appendChild(mark),offset=p+width,p=text.indexOf(word,offset)}if(offset<length){const tnode=document.createTextNode(text.slice(offset));fragment.appendChild(tnode)}return fragment}RepairAll(){for(;this.change_list.length>0;){const info=this.change_list.pop(),parent=info.parent;parent.insertBefore(info.original,info.highlight_node_list[0]),info.highlight_node_list.forEach(n=>{parent.removeChild(n)})}}RegisterUndo(parent_set,undo_man){this.change_list.forEach(info=>{if(parent_set.has(info.parent)){undo_man.Register(UR_TYPE.REMOVE_NODE,info.original,info.parent,info.offset,1);let i=0;info.highlight_node_list.forEach(n=>{undo_man.Register(UR_TYPE.ADD_NODE,n,info.parent,info.offset+i,1),++i}),info.parent=null}}),this.change_list=this.change_list.filter(info=>null!==info.parent)}ForceRepairWithRegister(parent_set,fnode,foffset){let new_focus=null;return parent_set.forEach(parent=>{const focus=this.SearchAndRepairWithRegister(parent,fnode,foffset);focus&&(new_focus=focus)}),new_focus}SearchAndRepairWithRegister(parent,fnode,foffset){let next,new_focus=null,begin_text="",is_found=!1;for(let node=parent.firstChild;node;node=next)if(next=node.nextSibling,"MARK"==node.nodeName)0==is_found&&(is_found=!0,node.previousSibling&&node.previousSibling.nodeType==Node.TEXT_NODE&&(begin_text+=node.previousSibling.data,RemoveNode(node.previousSibling))),node.firstChild===fnode&&(new_focus={node:null,offset:begin_text.length+foffset}),begin_text+=node.textContent,RemoveNode(node);else if(node.nodeType==Node.TEXT_NODE)node===fnode&&(new_focus={node:node,offset:begin_text.length+foffset}),is_found&&(begin_text+=node.data,RemoveNode(node));else{if(is_found){is_found=!1;const add_node=AddTextNode(begin_text,parent,node);begin_text="",new_focus&&(new_focus.node=add_node)}const ret_focus=this.SearchAndRepairWithRegister(node,fnode,foffset);ret_focus&&(new_focus=ret_focus)}if(is_found){const add_node=AddTextNode(begin_text,parent,null);new_focus&&(new_focus.node=add_node)}return new_focus}OriginalFocus(node,offset){if(node.nodeType!=Node.TEXT_NODE)return{node:node,offset:offset};const parent="MARK"==node.parentNode.nodeName?node.parentNode.parentNode:node.parentNode;for(let k=0;k<this.change_list.length;++k){const info=this.change_list[k];if(info.parent===parent&&info.highlight_node_list.includes("MARK"==node.parentNode.nodeName?node.parentNode:node)){let org_offset=0;for(let i=0;i<info.highlight_node_list.length;++i){if(info.highlight_node_list[i]===node){org_offset+=offset;break}if(info.highlight_node_list[i]===node.parentNode){org_offset+=offset;break}org_offset+="MARK"==info.highlight_node_list[i].nodeName?info.highlight_node_list[i].firstChild.length:info.highlight_node_list[i].length}return{node:info.original,offset:org_offset}}}return{node:node,offset:offset}}HighlightFocus(node,offset){if(node.nodeType!=Node.TEXT_NODE)return{node:node,offset:offset};for(let k=0;k<this.change_list.length;++k){const info=this.change_list[k];if(info.original===node){let sum_offset=0;for(let i=0;i<info.highlight_node_list.length;++i){const textnode="MARK"==info.highlight_node_list[i].nodeName?info.highlight_node_list[i].firstChild:info.highlight_node_list[i];if(sum_offset+=textnode.length,sum_offset>=offset)return{node:textnode,offset:textnode.length-(sum_offset-offset)}}return{node:info.original,offset:info.highlight_node_list[info.highlight_node_list.length-1].length}}}return{node:node,offset:offset}}get Word(){return this.word}}function NT_HighlightWord(word,keep_selection=!0){if(IsTableSelectionMode()&&ReleaseTableSelectAll(),nt_highlight){if(nt_highlight.Word==word)return!0;if(!NT_HighlightClear(keep_selection))return!1}const selection=document.getSelection();let focus=CorrectFocusToText2(selection.focusNode,selection.focusOffset);const is_collapsed=selection.isCollapsed;let anchor=is_collapsed?focus:CorrectFocusToText2(selection.anchorNode,selection.anchorOffset);nt_highlight=new Highlighter(nt_render_div,word),keep_selection&&(focus=nt_highlight.HighlightFocus(focus.node,focus.offset),is_collapsed?selection.collapse(focus.node,focus.offset):(anchor=nt_highlight.HighlightFocus(anchor.node,anchor.offset),selection.setBaseAndExtent(anchor.node,anchor.offset,focus.node,focus.offset)))}function NT_HighlightClear(keep_selection=!0){if(nt_highlight){const selection=document.getSelection();let focus=CorrectFocusToText2(selection.focusNode,selection.focusOffset);if(focus=nt_highlight.OriginalFocus(focus.node,focus.offset),selection.isCollapsed)nt_highlight.RepairAll(),nt_highlight=null,keep_selection&&selection.collapse(focus.node,focus.offset);else{let anchor=CorrectFocusToText2(selection.anchorNode,selection.anchorOffset);anchor=nt_highlight.OriginalFocus(anchor.node,anchor.offset),nt_highlight.RepairAll(),nt_highlight=null,keep_selection&&selection.setBaseAndExtent(anchor.node,anchor.offset,focus.node,focus.offset)}return!0}return!1}const IME_TYPE={GENERAL:0,WIN_FIREFOX:0,WIN_EDGE_LEGACY:1,WIN_CHROME:2,WIN_EDG_CHR:4,WIN_ELECTRON:5,MAC_FIREFOX:100,MAC_CHROME:102,MAC_SAFARI:103,MAC_ELECTRON:105,LNX_FIREFOX:200,LNX_CHROME:202,LNX_ELECTRON:205};let nt_render_div=null,nt_is_MacOS=!1;function NT_Initialize(target_div_id,ime_type){const render_div=document.getElementById(target_div_id);switch(nt_render_div=render_div,render_div.contentEditable="true",render_div.addEventListener("keydown",OnKeydownForShortcut,!1),ime_type){case IME_TYPE.WIN_EDGE_LEGACY:MO_InitComposition(render_div),render_div.addEventListener("compositionstart",MO_OnCompositionstart,!1),render_div.addEventListener("compositionupdate",MO_OnCompositionupdate,!1),render_div.addEventListener("compositionend",MO_OnCompositionend,!1),render_div.addEventListener("keydown",MO_OnKeydownForIME,!1),render_div.addEventListener("contextmenu",MO_OnContextmenuForIME,!1),render_div.addEventListener("keydown",OnKeydownForNavigation,!1),render_div.addEventListener("keydown",OnKeydownForAsciiChar,!1),render_div.addEventListener("keyup",OnKeyup,!1);break;case IME_TYPE.WIN_CHROME:case IME_TYPE.LNX_CHROME:case IME_TYPE.WIN_EDG_CHR:case IME_TYPE.WIN_ELECTRON:case IME_TYPE.LNX_ELECTRON:MO_InitComposition(render_div),render_div.addEventListener("compositionstart",MO_OnCompositionstart,!1),render_div.addEventListener("compositionupdate",MO_OnCompositionupdate,!1),render_div.addEventListener("compositionend",MO_OnCompositionendForChrome,!1),render_div.addEventListener("keydown",MO_OnKeydownForIME,!1),render_div.addEventListener("contextmenu",MO_OnContextmenuForIME,!1),render_div.addEventListener("keydown",OnKeydownForNavigation,!1),render_div.addEventListener("keydown",OnKeydownForAsciiChar,!1),render_div.addEventListener("keyup",OnKeyup,!1);break;case IME_TYPE.MAC_CHROME:case IME_TYPE.MAC_ELECTRON:MO_InitComposition(render_div),render_div.addEventListener("compositionstart",MO_OnCompositionstart,!1),render_div.addEventListener("compositionupdate",MO_OnCompositionupdate,!1),render_div.addEventListener("compositionend",MO_OnCompositionendForChrome,!1),render_div.addEventListener("keydown",MO_OnKeydownForIME,!1),render_div.addEventListener("contextmenu",MO_OnContextmenuForIME,!1),render_div.addEventListener("keydown",OnKeydownForNavigation,!1),render_div.addEventListener("beforeinput",OnBeforeinputForAsciiChar,!1),render_div.addEventListener("keyup",OnKeyup,!1),nt_is_MacOS=!0;break;case IME_TYPE.MAC_SAFARI:MO_InitComposition(render_div),render_div.addEventListener("compositionstart",MO_OnCompositionstart,!1),render_div.addEventListener("compositionupdate",MO_OnCompositionupdate,!1),render_div.addEventListener("compositionend",MO_OnCompositionend,!1),render_div.addEventListener("keydown",MO_OnKeydownForIME,!1),render_div.addEventListener("contextmenu",MO_OnContextmenuForIME,!1),render_div.addEventListener("input",SAFARI_OnInputMarkingEnter,!1),render_div.addEventListener("keydown",SAFARI_OnKeydownForNavigation,!1),render_div.addEventListener("beforeinput",OnBeforeinputForAsciiChar,!1),render_div.addEventListener("keyup",OnKeyup,!1),nt_is_MacOS=!0;break;default:MO_InitComposition(render_div),render_div.addEventListener("compositionstart",MO_OnCompositionstart,!1),render_div.addEventListener("compositionupdate",MO_OnCompositionupdate,!1),render_div.addEventListener("compositionend",MO_OnCompositionend,!1),render_div.addEventListener("keydown",MO_OnKeydownForIME,!1),render_div.addEventListener("contextmenu",MO_OnContextmenuForIME,!1),render_div.addEventListener("keydown",OnKeydownForNavigation,!1),render_div.addEventListener("keydown",OnKeydownForAsciiChar,!1),render_div.addEventListener("keyup",OnKeyup,!1),ime_type===IME_TYPE.MAC_FIREFOX&&(nt_is_MacOS=!0)}render_div.addEventListener("cut",OnCut,!1),render_div.addEventListener("copy",OnCopy,!1),render_div.addEventListener("paste",OnPaste,!1),document.addEventListener("click",OnClick,!1),render_div.addEventListener("mousedown",OnMouseDownTable,!1),render_div.addEventListener("mousemove",OnMouseMoveTable,!1),render_div.parentNode.parentNode.addEventListener("scroll",OnScroll,{passive:!0}),window.addEventListener("resize",OnScroll,{passive:!0}),undo_man=new UndoManager,undo_man.SetChangeEventDispatcher(new ChangeEventDispatcher(render_div))}let EDGE_input_event_args={data:null,isComposing:!1,inputType:"insertText",dataTransfer:null};function EDGE_KeepForInputEvent(event){event.key&&(EDGE_input_event_args.data=event.key,EDGE_input_event_args.isComposing=EDGE_IME_in_action,EDGE_input_event_args.inputType="insertText",EDGE_input_event_args.dataTransfer=null)}let SAFARI_is_just_after_compositionend=!1;function SAFARI_OnInputMarkingEnter(event){if("insertFromComposition"===event.inputType||"deleteCompositionText"===event.inputType)return SAFARI_is_just_after_compositionend=!0,!1}function SAFARI_OnKeydownForNavigation(event){SAFARI_is_just_after_compositionend&&(SAFARI_is_just_after_compositionend=!1,"Enter"===event.key||"Delete"===event.key||"Backspace"===event.key)?event.preventDefault():OnKeydownForNavigation(event)}function NT_ResetChangeFlag(){undo_man.GetChangeEventDispatcher().Reset()}let nt_scroll_ticking=!1;function OnScroll(event){nt_scroll_ticking||(window.requestAnimationFrame(()=>{QuickRedrawMath(nt_render_div),nt_scroll_ticking=!1}),nt_scroll_ticking=!0)}let nt_focus_print=null;function NT_BeginPrint(){g_editable_math&&DisableEdit(g_editable_math);const selection=document.getSelection();nt_focus_print={anchorNode:selection.anchorNode,anchorOffset:selection.anchorOffset,focusNode:selection.focusNode,focusOffset:selection.focusOffset},FullRedrawMath(nt_render_div),nt_render_div.contentEditable="false"}function NT_EndPrint(){nt_render_div.contentEditable="true",QuickRedrawMath(nt_render_div),document.getSelection().setBaseAndExtent(nt_focus_print.anchorNode,nt_focus_print.anchorOffset,nt_focus_print.focusNode,nt_focus_print.focusOffset)}function NT_MathNumbering(checked){if(null===nt_render_div)return;const render_div=nt_render_div,fragment=FragmentFromChildren(render_div);InitializeMathInFragment(fragment,checked?1:0),render_div.appendChild(fragment)}function InitializeMathInFragment(fragment,number){let matches=fragment.querySelectorAll("span.math");for(let i=0;i<matches.length;i++){const math=matches[i],margin=GetEditMargin(math);let text_node=math.lastChild.firstChild,mathtext=text_node.data.substring(margin,text_node.length-margin);switch(math.lastChild.className){case"editmath":number+=MathRendering(math,mathtext,number),ShowPreview(math.firstChild);break;case"editmathdisp":number+=MathRendering(math,mathtext,number),ShowPreviewDisplay(math.firstChild);break;case"editcode":math.firstChild.textContent=mathtext,ShowPreview(math.firstChild);break;case"editcodedisp":"\n"===mathtext.charAt(0)?math.firstChild.textContent=mathtext.slice(1,mathtext.length-1):math.firstChild.textContent=mathtext,ShowPreviewDisplay(math.firstChild);break;case"editimg":{let pos_split_a_img=mathtext.indexOf("](");pos_split_a_img<0&&(math.firstChild.alt=mathtext,math.firstChild.src=null),math.firstChild.src=nt_file_dir+mathtext.slice(pos_split_a_img+2,mathtext.length+1),math.firstChild.alt=mathtext.slice(0,pos_split_a_img),ShowPreview(math.firstChild)}}SetHide(math.lastChild)}}let g_label_eqnumber=new Map;function katexAutoNumber(mathtext,parent,number){const pos=mathtext.indexOf("\\begin{align}");return pos<0?katexAutoNumber_woAligned(mathtext,parent,number):katexAutoNumber_withAligned(mathtext=ReplaceAll(mathtext,"{align}","{aligned}"),pos,parent,number)}function katexAutoNumber_woAligned(mathtext,parent,number){let line_br_points=ListupBr(mathtext,0),line_has_nonumber=ListUpNonumber(mathtext,line_br_points);RegisterLabelEqnumber(line_has_nonumber,ListUpLabel(mathtext,line_br_points),number),mathtext=ReferLabelEqnumber(mathtext=ReplaceByRangeAll(mathtext=ReplaceAll(mathtext,"\\nonumber"," "),"\\label{","}"," "));const fragment=new DocumentFragment;katex.render(mathtext,fragment,{output:"html",displayMode:!0,throwOnError:!1}),parent.insertBefore(fragment,parent.firstElementChild);let katex_html=FindFirstChild("katex-html",parent.firstElementChild);if(null===katex_html)return 0;let base=katex_html.firstElementChild;if(null===base)return 0;if("base"!==base.className)return 0;let b_parent=base.parentElement,tag=null,i_line=0,my_number=number;for(;base;){for(line_has_nonumber[i_line]?tag=null:(tag=document.createElement("SPAN"),tag.className="tag",tag.appendChild(base.firstElementChild.cloneNode(!0)),"strut"!==tag.firstElementChild.className&&alert("ERROR: auto numbering is miss"),tag.appendChild(document.createTextNode("("+my_number+")")),my_number++),base=base.nextElementSibling;base;){if("mspace newline"===base.className){let next=base.nextElementSibling;tag&&(base.before(tag),tag=null),base=next;break}base=base.nextElementSibling}++i_line}return tag&&(b_parent.appendChild(tag),tag=null),my_number-number}function katexAutoNumber_withAligned(mathtext,pos_begin,parent,number){{let line_br_points=ListupBr(mathtext,pos_begin+"\\begin{aligned}".length),line_has_nonumber=ListUpNonumber(mathtext,line_br_points);RegisterLabelEqnumber(line_has_nonumber,ListUpLabel(mathtext,line_br_points),number),mathtext="\\tag{"+number+"}"+(mathtext=ReferLabelEqnumber(mathtext=ReplaceByRangeAll(mathtext=ReplaceAll(mathtext,"\\nonumber"," "),"\\label{","}"," ")));const fragment=new DocumentFragment;katex.render(mathtext,fragment,{output:"html",displayMode:!0,throwOnError:!1}),parent.insertBefore(fragment,parent.firstElementChild);let katex_html=FindFirstChild("katex-html",parent.firstElementChild);if(null===katex_html)return 0;let base=katex_html.firstElementChild;if("base"!==base.className)return 0;let tag=base.nextElementSibling;if("tag"!==tag.className)return 0;let mtable=FindFirstChild("mtable",base.firstElementChild.nextElementSibling);if(null===mtable)return 0;let mtable_clone=mtable.cloneNode(!0);{let first=mtable_clone.firstChild;for(;first.nextSibling;)first.nextSibling.remove()}let vlist_r=FindFirstChild("vlist-r",mtable_clone.firstElementChild);if(null===vlist_r)return 0;let vlist=FindFirstChild("vlist",vlist_r.firstElementChild);if(null===vlist)return 0;let ve=vlist.firstElementChild,my_number=number,i=0;for(;ve;){let pstrut=FindFirstChild("pstrut",ve.firstElementChild);if(pstrut){let mord=pstrut.nextElementSibling;if("mord"===mord.className){for(;mord.firstChild;)mord.removeChild(mord.firstChild);line_has_nonumber[i]?mord.appendChild(document.createTextNode(" ")):(mord.appendChild(document.createTextNode("("+my_number+")")),my_number++)}}ve=ve.nextElementSibling,++i}let tag_mord_text=tag.firstElementChild.nextElementSibling;if(null===tag_mord_text)return 0;for(;tag_mord_text.firstChild;)tag_mord_text.removeChild(tag_mord_text.firstChild);return tag_mord_text.appendChild(mtable_clone),my_number-number}}function FindFirstChild(class_name,start){let node=start;for(;node;){if(node.className===class_name)return node;node=node.firstElementChild}return node}function FindEndPos(text,offset){let p_begin=text.indexOf("\\begin",offset),p_end=text.indexOf("\\end",offset);for(;p_begin>=0;){if(p_end<p_begin)return p_end;offset=FindEndPos(text,p_begin+1),offset++,p_begin=text.indexOf("\\begin",offset),p_end=text.indexOf("\\end",offset)}return p_end}function ListupBr(mathtext,offset_begin){let line_br_points=[];{let offset=offset_begin,p_begin=mathtext.indexOf("\\begin",offset),p_br=mathtext.indexOf("\\\\",offset);for(;p_br>=0;)p_begin>=0?p_br<p_begin?(line_br_points.push(p_br),offset=p_br+1,p_br=mathtext.indexOf("\\\\",offset)):(offset=FindEndPos(mathtext,p_begin+1),offset++,p_begin=mathtext.indexOf("\\begin",offset),p_br=mathtext.indexOf("\\\\",offset)):(line_br_points.push(p_br),offset=p_br+1,p_br=mathtext.indexOf("\\\\",offset));line_br_points.push(mathtext.length)}return line_br_points}function ListUpNonumber(mathtext,line_br_points){let line_has_nonumber=[];{let p_nonumber=mathtext.indexOf("\\nonumber",0),i=0;for(;p_nonumber>=0&&(line_br_points[i]<p_nonumber?line_has_nonumber.push(!1):(line_has_nonumber.push(!0),p_nonumber=mathtext.indexOf("\\nonumber",line_br_points[i])),++i,!(i>=line_br_points.length)););for(;i<line_br_points.length;)line_has_nonumber.push(!1),++i;line_br_points.length!==line_has_nonumber.length&&alert("ERROR: analize nonumber in multi-line equations")}return line_has_nonumber}function ListUpLabel(mathtext,line_br_points){let line_has_label=[];{let p_label=mathtext.indexOf("\\label",0),i=0;for(;p_label>=0;){if(line_br_points[i]<p_label)line_has_label.push("");else{const ib=mathtext.indexOf("{",p_label+6);if(ib<0)line_has_label.push(""),alert("ERROR: \\label does not has next { character");else{const ie=mathtext.indexOf("}",ib+1);if(ie<0)line_has_label.push(""),alert("ERROR: \\label does not has next } character");else{let word=mathtext.slice(ib+1,ie);line_has_label.push(word.trim())}}p_label=mathtext.indexOf("\\label",line_br_points[i])}if(++i,i>=line_br_points.length)break}for(;i<line_br_points.length;)line_has_label.push(""),++i;line_br_points.length!==line_has_label.length&&alert("ERROR: analize label in multi-line equations")}return line_has_label}function RegisterLabelEqnumber(line_has_nonumber,line_has_label,number){const i_end=line_has_label.length;for(let i=0;i<i_end;++i)line_has_nonumber[i]||(line_has_label[i].length>0&&g_label_eqnumber.set(line_has_label[i],number),number++)}function ReferLabelEqnumber(text_org){let offset=0,i=text_org.indexOf("\\ref",offset);if(i<0)return text_org;let result="";for(;i>=0;){let ib=text_org.indexOf("{",i+"\\ref".length);if(ib<0)break;let ie=text_org.indexOf("}",ib+1);if(ie<0)break;const label=text_org.slice(ib+1,ie).trim();if(g_label_eqnumber.has(label)){const eqnumber=g_label_eqnumber.get(label);result+=text_org.slice(offset,i)+eqnumber.toString()}else result+=text_org.slice(offset,i)+"??";offset=ie+1,i=text_org.indexOf("\\ref",offset)}return result+=text_org.slice(offset),result}let nt_prevent_shortcut=["Ctrl+B","Ctrl+I","Ctrl+U","Ctrl+Y","Ctrl+Delete","Ctrl+Backspace"];function OnKeydownForShortcut(event){if(!event.isComposing)if(event.getModifierState("Control")||event.getModifierState("Meta")){let shortcut_key="";switch(shortcut_key+=nt_is_MacOS?event.getModifierState("Meta")?"Ctrl+":"":event.getModifierState("Control")?"Ctrl+":"",shortcut_key+=event.getModifierState("Shift")?"Shift+":"",shortcut_key+=1===event.key.length?event.key.toUpperCase():event.key,shortcut_key){case"Ctrl+Z":event.preventDefault(),NT_Dispatch("undo");break;case"Ctrl+Shift+Z":event.preventDefault(),NT_Dispatch("redo");break;case"Ctrl+A":event.preventDefault(),NT_Dispatch("selectall");break;default:nt_prevent_shortcut.includes(shortcut_key)&&event.preventDefault()}}else switch(event.key){case"F3":event.preventDefault(),event.getModifierState("Shift")?NT_Dispatch("findbackward"):NT_Dispatch("findforward");break;case"F2":return PrintFocus(),void event.preventDefault()}}const NT_LINK_DEFAULT_URL="https://sample.url",NT_LINK_DEFAULT_TEXT="PreviewWord";function OnKeyup(event){switch(event.key){case"ArrowUp":case"ArrowDown":case"Home":case"End":case"PageUp":case"PageDown":{if(!CorrectSelectionEdgeTable())return event.preventDefault(),!1;document.getSelection();const focus_math=CheckEditPreview(event.currentTarget);focus_math&&(event.shiftKey?document.getSelection().extend(focus_math.node,focus_math.offset):document.getSelection().collapse(focus_math.node,focus_math.offset))}}}function OnKeydownForNavigation(event){if(event.isComposing)return;if(IsTableSelectionMode())return void OnKeydownForNavigationTable(event);const selection=document.getSelection();let[node,offset]=selection.isCollapsed?CorrectFocusToText(selection.focusNode,selection.focusOffset):[selection.focusNode,selection.focusOffset];switch(event.key){case"ArrowUp":{const td=CheckNodeInTD(selection.focusNode,event.currentTarget);if(td)if(event.getModifierState("Shift"))IsHighlightMode()&&NT_HighlightClear(),SetSelectTable(td,td),event.preventDefault();else{SwitchInputArrowUp(td)&&event.preventDefault()}}break;case"ArrowDown":{const td=CheckNodeInTD(selection.focusNode,event.currentTarget);if(td)if(event.getModifierState("Shift"))IsHighlightMode()&&NT_HighlightClear(),SetSelectTable(td,td),event.preventDefault();else{SwitchInputArrowDown(td)&&event.preventDefault()}}break;case"ArrowLeft":SwitchInputArrowLeft(node,offset,event.getModifierState("Shift"))&&event.preventDefault();break;case"ArrowRight":SwitchInputArrowRight(node,offset,event.getModifierState("Shift"))&&event.preventDefault();break;case"Enter":if(event.preventDefault(),selection.focusNode&&selection.focusNode.scrollIntoView&&selection.focusNode.scrollIntoView({behavior:"auto",block:"nearest"}),selection.isCollapsed){let highlight_word=null;IsHighlightMode()&&(highlight_word=nt_highlight.Word,NT_HighlightClear()),[node,offset]=CorrectFocusToText(selection.focusNode,selection.focusOffset),SwitchInputEnter(node,offset,event.getModifierState("Shift")),highlight_word&&NT_HighlightWord(highlight_word)}break;case"Delete":{event.preventDefault(),selection.focusNode&&selection.focusNode.scrollIntoView&&selection.focusNode.scrollIntoView({behavior:"auto",block:"nearest"});let highlight_word=null;IsHighlightMode()&&(highlight_word=nt_highlight.Word,NT_HighlightClear()),selection.isCollapsed?([node,offset]=CorrectFocusToText(selection.focusNode,selection.focusOffset),SwitchInputDelete(node,offset,event.getModifierState("Shift"))):(CorrectSelectionEdgeTable(),CutSelection(event.currentTarget,selection)),highlight_word&&NT_HighlightWord(highlight_word)}break;case"Backspace":{event.preventDefault(),selection.focusNode&&selection.focusNode.scrollIntoView&&selection.focusNode.scrollIntoView({behavior:"auto",block:"nearest"});let highlight_word=null;IsHighlightMode()&&(highlight_word=nt_highlight.Word,NT_HighlightClear()),selection.isCollapsed?([node,offset]=CorrectFocusToText(selection.focusNode,selection.focusOffset),SwitchInputBackspace(node,offset,event.getModifierState("Shift"))):(CorrectSelectionEdgeTable(),CutSelection(event.currentTarget,selection)),highlight_word&&NT_HighlightWord(highlight_word)}break;case"Tab":{event.preventDefault();let highlight_word=null;IsHighlightMode()&&(highlight_word=nt_highlight.Word,NT_HighlightClear()),event.getModifierState("Shift")?SwitchInputShiftTab(node,offset):SwitchInputTab(node,offset),highlight_word&&NT_HighlightWord(highlight_word)}}}function OnKeydownForAsciiChar(event){event.getModifierState("Control")||event.getModifierState("Alt")||event.getModifierState("Meta")||TryInputAsciiChar(event.key)&&event.preventDefault()}function TryInputAsciiChar(char){if(IsTableSelectionMode())return!1;const selection=document.getSelection();switch(char){case"$":case"`":case"*":case"_":{let highlight_word=null;IsHighlightMode()&&(highlight_word=nt_highlight.Word,NT_HighlightClear());let[node,offset]=CorrectFocusToText(selection.focusNode,selection.focusOffset);if(selection.isCollapsed)SwitchInputMath(char,node,offset);else{const[anchor_node,anchor_offset]=CorrectFocusToText(selection.anchorNode,selection.anchorOffset);SwitchInputMathSelection(char,node,offset,anchor_node,anchor_offset)}return highlight_word&&NT_HighlightWord(highlight_word),!0}case" ":if(selection.isCollapsed){let highlight_word=null;IsHighlightMode()&&(highlight_word=nt_highlight.Word,NT_HighlightClear());let[node,offset]=CorrectFocusToText(selection.focusNode,selection.focusOffset);SwitchInputSpace(node,offset)||SwitchInputChar(char,node,offset),highlight_word&&NT_HighlightWord(highlight_word)}return!0;case"|":if(selection.isCollapsed){let highlight_word=null;IsHighlightMode()&&(highlight_word=nt_highlight.Word,NT_HighlightClear());let[node,offset]=CorrectFocusToText(selection.focusNode,selection.focusOffset);SwitchInputBar(node,offset)||SwitchInputChar(char,node,offset),highlight_word&&NT_HighlightWord(highlight_word)}return!0;case"^":if(selection.isCollapsed){let highlight_word=null;IsHighlightMode()&&(highlight_word=nt_highlight.Word,NT_HighlightClear());let[node,offset]=CorrectFocusToText(selection.focusNode,selection.focusOffset);SwitchInputHat(node,offset)||SwitchInputChar(char,node,offset),highlight_word&&NT_HighlightWord(highlight_word)}return!0;case"(":if(selection.isCollapsed){let highlight_word=null;IsHighlightMode()&&(highlight_word=nt_highlight.Word,NT_HighlightClear());let[node,offset]=CorrectFocusToText(selection.focusNode,selection.focusOffset);SwitchInputRoundBra(node,offset)||SwitchInputChar(char,node,offset),highlight_word&&NT_HighlightWord(highlight_word)}return!0;default:if(char&&1===char.length){let highlight_word=null;IsHighlightMode()&&(highlight_word=nt_highlight.Word,NT_HighlightClear()),selection.isCollapsed||(CorrectSelectionEdgeTable(),CutSelection(event.currentTarget,selection));let[node,offset]=CorrectFocusToText(selection.focusNode,selection.focusOffset);return SwitchInputChar(char,node,offset),highlight_word&&NT_HighlightWord(highlight_word),!0}}return!1}function OnBeforeinputForAsciiChar(event){"insertText"===event.inputType&&TryInputAsciiChar(event.data)&&event.preventDefault()}function SwitchInputChar(text,node,offset){if(null===node)return!1;if(node.nodeType===Node.TEXT_NODE){if(IsTextNodeInMath(node)){const margin=GetEditMargin(node.parentNode.parentNode);if(offset<margin)return!0;if(offset>node.length-margin)return!0}else if(node.data==nt_ZWBR)return undo_man.Begin(node,offset),InsertTextIntoText(text,node,1),DeleteText(node,0,1),undo_man.End(node,text.length),document.getSelection().collapse(node,text.length),!0;return undo_man.Begin(node,offset),InsertTextIntoText(text,node,offset),undo_man.End(node,offset+text.length),document.getSelection().collapse(node,offset+text.length),!0}switch(node.tagName){case"P":case"LI":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"FIGCAPTION":case"TH":case"TD":{const num_children=node.childNodes.length;if(0===offset&&"BR"===node.firstChild.nodeName){const br_node=node.firstChild;if((br_node=>(null===br_node.nextSibling||"OL"===br_node.nextSibling.nodeName||br_node.nextSibling.nodeName,!0))(br_node)){undo_man.Begin(node,offset);const new_node=AddTextNode(text,node,br_node);return RemoveNode(br_node),undo_man.End(new_node,new_node.length),document.getSelection().collapse(new_node,new_node.length),!0}}if(offset>0){let target=node.childNodes.item(offset-1);if(target.nodeType===Node.TEXT_NODE)return undo_man.Begin(target,target.length),InsertTextIntoText(text,target,target.length),undo_man.End(target,target.length),document.getSelection().collapse(target,target.length),!0}if(offset<num_children){let target=node.childNodes.item(offset);if(target.nodeType===Node.TEXT_NODE)return undo_man.Begin(target,0),InsertTextIntoText(text,target,0),undo_man.End(target,text.length),document.getSelection().collapse(target,text.length),!0}undo_man.Begin(node,offset);let ref_node=node.childNodes.item(offset),text_node=AddTextNode(text,node,ref_node);return IsSpanMathRef(ref_node)&&ConvertMathRefToCite(ref_node),undo_man.End(text_node,text_node.length),document.getSelection().collapse(text_node,text_node.length),!0}default:alert("ERROR: InputChar at "+node.tagName)}return!1}function FillTdBr(tr,tag_name,num_column){for(;tr.childNodes.length<num_column;){const td=AddNode(tag_name,tr,null);AddNode("BR",td,null)}}function SwitchInputEnter(node,offset,is_shift){if(null===node)return!0;const origin={node:node,offset:offset};let should_devide=!1;if(node.nodeType===Node.TEXT_NODE)switch(node.parentNode.tagName){case"P":case"LI":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"FIGCAPTION":case"TH":case"TD":offset===node.length?(offset=GetIndex(node.parentNode,node)+1,node=node.parentNode):(should_devide=offset>0,offset=GetIndex(node.parentNode,node),node=node.parentNode);break;case"SPAN":if(IsTextNodeInMath(node)){const math=node.parentNode.parentNode;if("editmathdisp"==node.parentNode.className||"editcodedisp"==node.parentNode.className){const margin=GetEditMargin(math);if(margin<=offset&&offset<=node.length-margin)return undo_man.Begin(node,offset),InsertTextIntoText("\n",node,offset),undo_man.End(node,offset+1),document.getSelection().collapse(node,offset+1),!0}}return!0;default:return!0}switch(node.tagName){case"P":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":{if(undo_man.Begin(origin.node,origin.offset),should_devide&&(DivideTextNode(origin.node,origin.offset),++offset),0===offset){const p_node=AddNode("P",node.parentNode,node);return AddNode("BR",p_node,null),undo_man.End(node,0),document.getSelection().collapse(node,0),!0}if(node.childNodes.length===offset){const p_node=AddNode("P",node.parentNode,node.nextSibling);return AddNode("BR",p_node,null),undo_man.End(p_node,0),document.getSelection().collapse(p_node,0),!0}const new_node=AddNode("P",node.parentNode,node.nextSibling);let focus=SafePushNodeList(new_node,SafeRemoveNodeList(node,node.childNodes.item(offset)));if(new_node.firstChild.nodeType===Node.TEXT_NODE&&new_node.firstChild.data==nt_ZWBR)if(IsSpanMathImg(new_node.firstChild.nextSibling)){ConvertPtoFigure(new_node)}else IsSpanMathCite(new_node.firstChild.nextSibling)&&ConvertMathCiteToRef(new_node.firstChild.nextSibling);document.getSelection().collapse(focus.node,focus.offset),undo_man.End(focus.node,focus.offset)}break;case"LI":{if(undo_man.Begin(origin.node,origin.offset),should_devide&&(DivideTextNode(origin.node,origin.offset),++offset),0===offset){if(null===node.previousSibling){if("DIV"===node.parentNode.parentNode.nodeName){const p_node=AddNode("P",node.parentNode.parentNode,node.parentNode);return AddNode("BR",p_node,null),undo_man.End(node,0),document.getSelection().collapse(node,0),!0}}else if(null===node.nextSibling&&"BR"===node.firstChild.nodeName&&null===node.firstChild.nextSibling&&"DIV"===node.parentNode.parentNode.nodeName){const p_node=AddNode("P",node.parentNode.parentNode,node.parentNode.nextSibling);return AddNode("BR",p_node,null),undo_man.End(p_node,0),document.getSelection().collapse(p_node,0),!0}const li_node=AddNode("LI",node.parentNode,node);return AddNode("BR",li_node,null),undo_man.End(node,0),document.getSelection().collapse(node,0),!0}if(node.childNodes.length===offset){const p_node=AddNode("LI",node.parentNode,node.nextSibling);return AddNode("BR",p_node,null),undo_man.End(p_node,0),document.getSelection().collapse(p_node,0),!0}{const ref=node.childNodes.item(offset);"OL"!==ref.nodeName&&"UL"!==ref.nodeName||AddNode("BR",node,ref)}const focus=SafePushNodeList(AddNode("LI",node.parentNode,node.nextSibling),SafeRemoveNodeList(node,node.childNodes.item(offset)));undo_man.End(focus.node,focus.offset),document.getSelection().collapse(focus.node,focus.offset)}break;case"FIGCAPTION":{undo_man.Begin(origin.node,origin.offset);const figure=node.parentNode;if(0===offset){const p_node=AddNode("P",figure.parentNode,figure.nextSibling);return SafePushNodeList(p_node,RemoveNodeList(node,node.firstChild,null)),AddNode("BR",node,null),undo_man.End(p_node,0),document.getSelection().collapse(p_node,0),!0}node.childNodes.length===offset&&AddNode("BR",node,null);const focus=SafePushNodeList(AddNode("P",figure.parentNode,figure.nextSibling),SafeRemoveNodeList(node,node.childNodes.item(offset),null));return document.getSelection().collapse(focus.node,focus.offset),undo_man.End(focus.node,focus.offset),!0}case"FIGURE":if(0===offset&&0==origin.offset){undo_man.Begin(origin.node,origin.offset);const new_node=AddNode("P",node.parentNode,node);return AddNode("BR",new_node,null),undo_man.End(new_node,0),document.getSelection().collapse(new_node,0),!0}return document.getSelection().collapse(origin.node,origin.offset),!0;case"TH":if(!is_shift){const table=node.parentNode.parentNode;if(null===table.previousSibling){undo_man.Begin(origin.node,origin.offset);const p=AddNode("P",table.parentNode,table);AddNode("BR",p,null),undo_man.End(p,0),document.getSelection().collapse(p,0)}}return!0;case"TD":{if(!is_shift){const table=node.parentNode.parentNode;if(null===table.nextSibling){undo_man.Begin(origin.node,origin.offset);const p=AddNode("P",table.parentNode,null);AddNode("BR",p,null),undo_man.End(p,0),document.getSelection().collapse(p,0)}return!0}const org_tr=node.parentNode,table=org_tr.parentNode;if(org_tr===table.firstChild.nextSibling)return!0;undo_man.Begin(origin.node,origin.offset),should_devide&&(DivideTextNode(origin.node,origin.offset),++offset);const new_tr=AddNode("TR",table,org_tr.nextSibling);if(offset<node.childNodes.length){const fragment=SafeRemoveNodeList(node,node.childNodes.item(offset),null);SafePushNodeList(AddNode(node.tagName,new_tr,null),fragment),node.hasChildNodes()||AddNode("BR",node,null)}if(node!==org_tr.lastChild){AddNodeList(new_tr,null,RemoveNodeList(org_tr,node.nextSibling,null))}const num_column=table.firstChild.childNodes.length;FillTdBr(org_tr,"TD",num_column),FillTdBr(new_tr,"TD",num_column);const focus=FocusOffsetZero(new_tr);return undo_man.End(focus.node,focus.offset),document.getSelection().collapse(focus.node,focus.offset),!0}default:alert("ERROR: InputEnter at "+node.nodeName)}return!0}function SwitchInputDelete(node,offset,is_shift){if(null===node)return;const origin={node:node,offset:offset};if(node.nodeType===Node.TEXT_NODE)switch(node.parentNode.tagName){case"P":case"LI":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"FIGCAPTION":case"FIGURE":case"TH":case"TD":if(node.data==nt_ZWBR&&(offset=1),offset!==node.length){undo_man.Begin(node,offset);const focus=SafeDeleteInTextNode(node,offset);return void(focus?(undo_man.End(focus.node,focus.offset),document.getSelection().collapse(focus.node,focus.offset)):undo_man.Cancel())}if(null===node.nextSibling)offset=(node=node.parentNode).childNodes.length;else{if(node.nextSibling.nodeType===Node.TEXT_NODE)return undo_man.Begin(node,offset),CombineTextNode(node),DeleteText(node,offset),undo_man.End(node,offset),void document.getSelection().collapse(node,offset);if("math"===node.nextSibling.className){const focus=EnableMathEdit(node.nextSibling,1);return void document.getSelection().collapse(focus.node,focus.offset)}offset=GetIndex(node.parentNode,node)+1,node=node.parentNode}break;case"SPAN":if(IsTextNodeInMath(node)){const math=node.parentNode.parentNode,margin=GetEditMargin(math);if(offset===node.length){offset=GetIndex(node=math.parentNode,math)+1;break}if(offset===node.length-1)return void SwitchInputArrowRight(node,offset,!1);if(offset<margin||node.length-margin<=offset){if("editem2"===node.parentNode.className||"editem3"===node.parentNode.className){const mark=node.data.slice(0,1);undo_man.Begin(node,offset);let math_old=node.parentNode.parentNode,math_new=AddMathNode(mark.repeat(margin-1),math_old.parentNode,math_old);math_new&&(InsertTextIntoText(node.data.slice(margin,node.length-margin),math_new.lastChild.lastChild,margin-1),RemoveNode(math_old));const focus=EnableMathEdit(math_new,offset<margin?offset:offset-1);return document.getSelection().collapse(focus.node,focus.offset),void undo_man.End(focus.node,focus.offset)}return void document.getSelection().collapse(node,offset+1)}{undo_man.Begin(node,offset);const focus=SafeDeleteInTextNode(node,offset);return void(focus?(undo_man.End(focus.node,focus.offset),document.getSelection().collapse(focus.node,focus.offset)):undo_man.Cancel())}}break;default:return}if(node.hasChildNodes()){const z=node.childNodes.item(offset);z&&z.nodeType===Node.TEXT_NODE&&z.data==nt_ZWBR&&offset++}switch(node.tagName){case"P":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":if(undo_man.Begin(origin.node,origin.offset),"BR"===node.firstChild.nodeName&&null===node.firstChild.nextSibling){if(null===node.nextSibling)return void undo_man.Cancel();if("FIGURE"==node.nextSibling.nodeName)return void undo_man.Cancel();const next=node.nextSibling;return RemoveNode(node),void(next.firstChild.nodeType===Node.TEXT_NODE||"OL"===next.tagName||"UL"===next.tagName?(undo_man.End(next.firstChild,0),document.getSelection().collapse(next.firstChild,0)):(undo_man.End(next,0),document.getSelection().collapse(next,0)))}if(offset<node.childNodes.length){let ch=node.childNodes.item(offset);if(ch.nodeType===Node.TEXT_NODE){const focus=SafeDeleteInTextNode(ch,0);focus?(undo_man.End(focus.node,focus.offset),document.getSelection().collapse(focus.node,focus.offset)):undo_man.Cancel()}else if("BR"===ch.nodeName)RemoveNode(ch),undo_man.End(node,offset),document.getSelection().collapse(node,offset);else if("math"===ch.className){const focus=EnableMathEdit(ch,1);document.getSelection().collapse(focus.node,focus.offset)}else"OL"===ch.tagName||"UL"===ch.tagName?alert("ERROR: p node cannot have a child of ol/ul."):alert("ERROR: delete key before undefined element")}else if(null===node.nextSibling);else if("P"===node.nextSibling.tagName||"H1"===node.nextSibling.tagName||"H2"===node.nextSibling.tagName||"H3"===node.nextSibling.tagName||"H4"===node.nextSibling.tagName||"H5"===node.nextSibling.tagName||"H6"===node.nextSibling.tagName){const latter_head=node.nextSibling.firstChild;IsSpanMathRef(latter_head)&&ConvertMathRefToCite(latter_head);const focus=SafeCombineNode(node);focus?(document.getSelection().collapse(focus.node,focus.offset),undo_man.End(focus.node,focus.offset)):undo_man.Cancel()}else if("OL"===node.nextSibling.tagName||"UL"===node.nextSibling.tagName){let ol=node.nextSibling,ol_li=ol.firstChild,end_point=ol_li.firstChild;if("BR"!==end_point.nodeName){for(;end_point&&"OL"!==end_point.nodeName&&"UL"!==end_point.nodeName;)end_point=end_point.nextSibling;const focus=SafePushNodeList(node,RemoveNodeList(ol_li,ol_li.firstChild,end_point));if(end_point){AddNodeList(ol,ol_li,RemoveNodeList(end_point,end_point.firstChild))}return RemoveNode(ol_li),ol.hasChildNodes()||RemoveNode(ol),undo_man.End(focus.node,focus.offset),document.getSelection().collapse(focus.node,focus.offset),!0}if(null===end_point.nextSibling)RemoveNode(ol_li);else{const ol2=end_point.nextSibling;if("OL"!==ol2.nodeName&&"UL"!==ol2.nodeName)return alert("ERROR: li has some node after br"),void undo_man.Cancel();AddNodeList(ol,ol_li,RemoveNodeList(ol2,ol2.firstChild,null)),RemoveNode(ol_li)}ol.hasChildNodes()||RemoveNode(ol),undo_man.End(node,offset),document.getSelection().collapse(node,offset)}else if("FIGURE"===node.nextSibling.tagName){const figure=node.nextSibling;figure.firstChild;let end_point=figure.firstChild;for(;end_point&&"FIGCAPTION"!==end_point.nodeName;)end_point=end_point.nextSibling;let focus=null;if(figure.firstChild!==end_point){focus=SafePushNodeList(node,RemoveNodeList(figure,figure.firstChild,end_point))}if(end_point){const f2=SafePushNodeList(node,RemoveNodeList(end_point,end_point.firstChild,null));null===focus&&(focus=f2)}RemoveNode(figure),document.getSelection().collapse(focus.node,focus.offset),undo_man.End(focus.node,focus.offset)}else alert("WARNING: delete key before undefined element");break;case"LI":if(undo_man.Begin(origin.node,origin.offset),"BR"===node.firstChild.nodeName){if(node.firstChild.nextSibling){const ol2=node.firstChild.nextSibling;if("OL"!==ol2.nodeName&&"UL"!==ol2.nodeName)return alert("ERROR: li has some node after br"),void undo_man.Cancel();let frag=RemoveNodeList(ol2,ol2.firstChild,null);const new_node=AddNodeList(node.parentNode,node,frag);return RemoveNode(node),undo_man.End(new_node,0),void document.getSelection().collapse(new_node,0)}offset++}if(offset<node.childNodes.length){let ch=node.childNodes.item(offset);if(ch.nodeType===Node.TEXT_NODE){const focus=SafeDeleteInTextNode(ch,0);focus?(undo_man.End(focus.node,focus.offset),document.getSelection().collapse(focus.node,focus.offset)):undo_man.Cancel()}else if("math"===ch.className){const focus=EnableMathEdit(ch,1);document.getSelection().collapse(focus.node,focus.offset),undo_man.Cancel()}else"OL"===ch.tagName||"UL"===ch.tagName?(RaiseFirstLi(ch),undo_man.End(node,offset),document.getSelection().collapse(node,offset)):(alert("ERROR: delete key before undefined element"),undo_man.Cancel())}else if(node.nextSibling){if("LI"!==node.nextSibling.nodeName)return alert("WARNING: delete key before undefined element"),void undo_man.Cancel();const focus=SafeCombineNode(node);focus?(document.getSelection().collapse(focus.node,focus.offset),undo_man.End(focus.node,focus.offset)):undo_man.Cancel()}else{let parent_ol=node.parentNode;if(parent_ol.nextSibling){if("P"===parent_ol.nextSibling.nodeName){const p=parent_ol.nextSibling,fragment=RemoveNodeList(parent_ol.nextSibling,parent_ol.nextSibling.firstChild);RemoveNode(p);const focus=SafePushNodeList(node,fragment);focus?(document.getSelection().collapse(focus.node,focus.offset),undo_man.End(focus.node,focus.offset)):undo_man.Cancel()}else if("OL"===parent_ol.nextSibling.nodeName||"UL"===parent_ol.nextSibling.tagName){let fragment=RemoveNodeList(parent_ol.nextSibling,parent_ol.nextSibling.firstChild);AddNodeList(parent_ol,node.nextSibling,fragment),RemoveNode(parent_ol.nextSibling),undo_man.End(node,offset),document.getSelection().collapse(node,offset)}else if("FIGURE"===parent_ol.nextSibling.nodeName){const figure=parent_ol.nextSibling;figure.firstChild;let end_point=figure.firstChild;for(;end_point&&"FIGCAPTION"!==end_point.nodeName;)end_point=end_point.nextSibling;let focus=null;if(figure.firstChild!==end_point){focus=SafePushNodeList(node,RemoveNodeList(figure,figure.firstChild,end_point))}if(end_point&&"FIGCAPTION"===end_point.nodeName){const f2=SafePushNodeList(node,RemoveNodeList(end_point,end_point.firstChild,null));null===focus&&(focus=f2)}RemoveNode(figure),undo_man.End(focus.node,focus.offset),document.getSelection().collapse(focus.node,focus.offset)}}else{let parent_parent=node.parentNode.parentNode;if("LI"===parent_parent.tagName&&parent_parent.nextSibling){let fragment=RemoveNodeList(parent_parent.parentNode,parent_parent.nextSibling,parent_parent.nextSibling.nextSibling);AddNodeList(parent_ol,node.nextSibling,fragment),undo_man.End(node,offset),document.getSelection().collapse(node,offset)}}}break;case"FIGCAPTION":if(undo_man.Begin(origin.node,origin.offset),"BR"===node.firstChild.nodeName&&null===node.firstChild.nextSibling&&(offset=1),offset<node.childNodes.length){let ch=node.childNodes.item(offset);if(ch.nodeType===Node.TEXT_NODE){const focus=SafeDeleteInTextNode(ch,0);focus?(undo_man.End(focus.node,focus.offset),document.getSelection().collapse(focus.node,focus.offset)):undo_man.Cancel()}else if("BR"===ch.nodeName)RemoveNode(ch),undo_man.End(node,offset),document.getSelection().collapse(node,offset);else if("math"===ch.className){const focus=EnableMathEdit(ch,1);document.getSelection().collapse(focus.node,focus.offset)}else"OL"===ch.tagName||"UL"===ch.tagName?alert("ERROR: figcaption node cannot have a child of ol/ul."):alert("ERROR: delete key before undefined element")}else{const next=node.parentNode.nextSibling;if(null===next);else if("P"===next.tagName||"H1"===next.tagName||"H2"===next.tagName||"H3"===next.tagName||"H4"===next.tagName||"H5"===next.tagName||"H6"===next.tagName){const focus=SafePushNodeList(node,RemoveNodeList(next,next.firstChild,null));RemoveNode(next),document.getSelection().collapse(focus.node,focus.offset),undo_man.End(focus.node,focus.offset)}else if("OL"===next.tagName||"UL"===next.tagName){let ol=next,ol_li=ol.firstChild,end_point=ol_li.firstChild;node.firstChild;for(;end_point&&"OL"!==end_point.nodeName&&"UL"!==end_point.nodeName;)end_point=end_point.nextSibling;let focus=SafePushNodeList(node,RemoveNodeList(ol_li,ol_li.firstChild,end_point));if(end_point){AddNodeList(ol,ol_li,RemoveNodeList(end_point,end_point.firstChild))}RemoveNode(ol_li),ol.hasChildNodes()||RemoveNode(ol),document.getSelection().collapse(focus.node,focus.offset),undo_man.End(focus.node,focus.offset)}else if("FIGURE"===next.tagName){const figure=next;figure.firstChild;let end_point=figure.firstChild;for(;end_point&&"FIGCAPTION"!==end_point.nodeName;)end_point=end_point.nextSibling;let focus=null;if(figure.firstChild!==end_point){focus=SafePushNodeList(node,RemoveNodeList(figure,figure.firstChild,end_point))}if(end_point&&"FIGCAPTION"===end_point.nodeName){const f2=SafePushNodeList(node,RemoveNodeList(end_point,end_point.firstChild,null));null===focus&&(focus=f2)}RemoveNode(figure),undo_man.End(focus.node,focus.offset),document.getSelection().collapse(focus.node,focus.offset)}else alert("WARNING: delete key before undefined element")}break;case"TH":case"TD":if(undo_man.Begin(origin.node,origin.offset),"BR"===node.firstChild.nodeName&&null===node.firstChild.nextSibling&&(offset=1),offset<node.childNodes.length){let ch=node.childNodes.item(offset);if(ch.nodeType===Node.TEXT_NODE){const focus=SafeDeleteInTextNode(ch,0);focus?(undo_man.End(focus.node,focus.offset),document.getSelection().collapse(focus.node,focus.offset)):undo_man.Cancel()}else if("BR"===ch.nodeName)RemoveNode(ch),undo_man.End(node,offset),document.getSelection().collapse(node,offset);else if("math"===ch.className){const focus=EnableMathEdit(ch,1);document.getSelection().collapse(focus.node,focus.offset)}else"OL"===ch.tagName||"UL"===ch.tagName?alert("ERROR: td node cannot have a child of ol/ul."):alert("ERROR: delete key before undefined element")}else{if(!is_shift)break;if(node.nextSibling){const next=node.nextSibling,focus=SafePushNodeList(node,RemoveNodeList(next,next.firstChild,null));RemoveNode(next);const new_td=AddNode(node.tagName,node.parentNode,null);return AddNode("BR",new_td,null),document.getSelection().collapse(focus.node,focus.offset),void undo_man.End(focus.node,focus.offset)}{const next_tr=node.parentNode.nextSibling;if(next_tr)return RemoveNode(next_tr),undo_man.End(node,offset),void document.getSelection().collapse(node,offset)}}break;default:alert("ERROR: Delete at "+node.tagName)}undo_man.Cancel()}function SafeDeleteInTextNode(node,offset){if(node.data==nt_ZWBR)return null;if(1===node.length){const parent=node.parentNode,next=node.nextSibling;RemoveNode(node);return SafeJunctionPoint(parent,next)}return DeleteText(node,offset),{node:node,offset:offset}}function GetIdealFocus(node,offset){if(node.nodeType===Node.TEXT_NODE)return[node,offset];if(node.previousSibling&&0===offset&&node.previousSibling.nodeType===Node.TEXT_NODE)return[node.previousSibling,node.previousSibling.length];if(node.hasChildNodes()){const ch=node.childNodes.item(offset);if(ch){if(ch.nodeType===Node.TEXT_NODE)return[ch,0];{const prev=ch.previousSibling;return prev&&prev.nodeType===Node.TEXT_NODE?[prev,prev.length]:GetIdealFocus(ch.firstChild,0)}}{const prev=node.childNodes.item(offset-1);return prev.nodeType===Node.TEXT_NODE?[prev,prev.length]:prev.hasChildNodes()?GetIdealFocus(prev,prev.childNodes.length):[node,offset-1]}}return[node.parentNode,GetIndex(node.parentNode,node)]}function RaiseFirstLi(ol_node){const ol_li=ol_node.firstChild;if("BR"==ol_li.firstChild.nodeName&&1==ol_li.childNodes.length)RemoveNode(ol_node);else{const fragment=RemoveNodeList(ol_li,ol_li.firstChild);RemoveNode(ol_li);const head=AddNodeList(ol_node.parentNode,ol_node,fragment);SafeJunctionPoint(ol_node.parentNode,head),ol_node.hasChildNodes()?SafeJunctionPoint(ol_node.parentNode,ol_node):RemoveNode(ol_node)}}function LastFocusInList(prev){let last_li=prev.lastChild;for(;"OL"===last_li.lastChild.nodeName||"UL"===last_li.lastChild.nodeName;)last_li=last_li.lastChild.lastChild;return last_li.lastChild.nodeType===Node.TEXT_NODE?[last_li.lastChild,last_li.lastChild.length]:[last_li,last_li.childNodes.length]}function SwitchInputBackspace(node,offset,is_shift){if(null===node)return;const origin={node:node,offset:offset};if(node.nodeType===Node.TEXT_NODE)switch(node.parentNode.tagName){case"P":case"LI":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"FIGCAPTION":case"FIGURE":case"TH":case"TD":if(node.data==nt_ZWBR&&(offset=0),offset>0){undo_man.Begin(node,offset);const focus=SafeDeleteInTextNode(node,offset-1);return void(focus?(undo_man.End(focus.node,focus.offset),document.getSelection().collapse(focus.node,focus.offset)):undo_man.Cancel())}if(null===node.previousSibling)node=node.parentNode,offset=0;else{if(node.previousSibling.nodeType===Node.TEXT_NODE){undo_man.Begin(node,offset);const focus_node=node.previousSibling,focus_offset=node.previousSibling.length-1;return CombineTextNode(focus_node),DeleteText(focus_node,focus_offset),undo_man.End(focus_node,focus_offset),void document.getSelection().collapse(focus_node,focus_offset)}if("math"===node.previousSibling.className){const focus=EnableMathEdit(node.previousSibling,-1);return void document.getSelection().collapse(focus.node,focus.offset)}offset=GetIndex(node.parentNode,node)-1,node=node.parentNode}break;case"SPAN":if(IsTextNodeInMath(node)){const math=node.parentNode.parentNode,margin=GetEditMargin(math);if(0===offset){offset=GetIndex(node=math.parentNode,math);break}if(1===offset)return void SwitchInputArrowLeft(node,offset,!1);if(offset<=margin||node.length-margin<offset){if("editem2"===node.parentNode.className||"editem3"===node.parentNode.className){const mark=node.data.slice(0,1);undo_man.Begin(node,offset);let math_old=node.parentNode.parentNode,math_new=AddMathNode(mark.repeat(margin-1),math_old.parentNode,math_old);math_new&&(InsertTextIntoText(node.data.slice(margin,node.length-margin),math_new.lastChild.lastChild,margin-1),RemoveNode(math_old));const focus=EnableMathEdit(math_new,offset<=margin?offset-1:offset-2);return document.getSelection().collapse(focus.node,focus.offset),void undo_man.End(focus.node,focus.offset)}return void document.getSelection().collapse(node,offset-1)}{undo_man.Begin(node,offset);const focus=SafeDeleteInTextNode(node,offset-1);return void(focus?(undo_man.End(focus.node,focus.offset),document.getSelection().collapse(focus.node,focus.offset)):undo_man.Cancel())}}break;default:return}if(node.hasChildNodes()){const z=node.childNodes.item(offset-1);z&&z.nodeType===Node.TEXT_NODE&&z.data==nt_ZWBR&&offset--}switch(node.tagName){case"P":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":if(undo_man.Begin(origin.node,origin.offset),"BR"===node.firstChild.nodeName&&null===node.firstChild.nextSibling){if(null===node.previousSibling)return void undo_man.Cancel();const prev=node.previousSibling;RemoveNode(node);let fnode=null,foffset=0;return prev.lastChild.nodeType===Node.TEXT_NODE?(fnode=prev.lastChild,foffset=prev.lastChild.length):"OL"===prev.nodeName||"UL"===prev.nodeName?[fnode,foffset]=LastFocusInList(prev):(fnode=prev,foffset=prev.childNodes.length,"BR"===prev.lastChild.nodeName&&foffset--),undo_man.End(fnode,foffset),void document.getSelection().collapse(fnode,foffset)}if(offset>0){let ch=node.childNodes.item(offset-1);if(ch.nodeType===Node.TEXT_NODE){const focus=SafeDeleteInTextNode(ch,ch.length-1);focus?(undo_man.End(focus.node,focus.offset),document.getSelection().collapse(focus.node,focus.offset)):undo_man.Cancel()}else if("BR"===ch.tagName)RemoveNode(ch),undo_man.End(node,offset-1),document.getSelection().collapse(node,offset-1);else if("math"===ch.className){const focus=EnableMathEdit(ch,-1);document.getSelection().collapse(focus.node,focus.offset),undo_man.Cancel()}else"OL"===ch.tagName||"UL"===ch.tagName?(alert("ERROR: p node cannot have a child of ol/ul."),undo_man.Cancel()):(alert("ERROR: delete key before undefined element"),undo_man.Cancel())}else{let prev=node.previousSibling;if(null===prev)return void undo_man.Cancel();if("P"===prev.tagName||"H1"===prev.tagName||"H2"===prev.tagName||"H3"===prev.tagName||"H4"===prev.tagName||"H5"===prev.tagName||"H6"===prev.tagName){IsSpanMathRef(node.firstChild)&&"P"===prev.tagName&&"BR"!=prev.lastChild.nodeName&&ConvertMathRefToCite(node.firstChild);const focus=SafeCombineNode(prev);document.getSelection().collapse(focus.node,focus.offset),undo_man.End(focus.node,focus.offset)}else if("OL"===node.previousSibling.tagName||"UL"===node.previousSibling.tagName){let target_li=node.previousSibling.lastChild;for(;"OL"===target_li.lastChild.nodeName||"UL"===target_li.lastChild.nodeName;)target_li=target_li.lastChild.lastChild;const fragment=RemoveNodeList(node,node.firstChild);IsSpanMathRef(fragment.firstChild)&&ConvertMathRefToCite(fragment.firstChild);const focus=SafePushNodeList(target_li,fragment);RemoveNode(node),document.getSelection().collapse(focus.node,focus.offset),undo_man.End(focus.node,focus.offset)}else if("FIGURE"===node.previousSibling.nodeName){const figcaption=node.previousSibling.lastChild,fragment=RemoveNodeList(node,node.firstChild,null);IsSpanMathRef(fragment.firstChild)&&ConvertMathRefToCite(fragment.firstChild);const focus=SafePushNodeList(figcaption,fragment);RemoveNode(node),undo_man.End(focus.node,focus.offset),document.getSelection().collapse(focus.node,focus.offset)}else alert("WARNING: delete key before undefined element"),undo_man.Cancel()}break;case"LI":if(undo_man.Begin(origin.node,origin.offset),offset>0&&"BR"===node.childNodes.item(offset-1).nodeName&&offset--,!(offset>0))return undo_man.Cancel(),void SwitchInputShiftTab(node,offset);{let ch=node.childNodes.item(offset-1);if(ch.nodeType===Node.TEXT_NODE){const focus=SafeDeleteInTextNode(ch,ch.length-1);focus?(undo_man.End(focus.node,focus.offset),document.getSelection().collapse(focus.node,focus.offset)):undo_man.Cancel()}else if("math"===ch.className){const focus=EnableMathEdit(ch,-1);document.getSelection().collapse(focus.node,focus.offset)}else{if("OL"!==ch.tagName&&"UL"!==ch.tagName)return alert("ERROR: backspace key after undefined element"),void undo_man.Cancel();{const focus=SafePushNodeList(ch.lastChild,SafeRemoveNodeList(node,node.childNodes.item(offset)));document.getSelection().collapse(focus.node,focus.offset),undo_man.End(focus.node,focus.offset)}}}break;case"FIGCAPTION":if(undo_man.Begin(origin.node,origin.offset),"BR"===node.firstChild.nodeName&&null===node.firstChild.nextSibling&&(offset=0),!(offset>0)){let prev=node.previousSibling;if(null===prev)return undo_man.Cancel(),void alert("figure has no img tag");{const math=prev;if("math"!==math.className)return alert("figure has no img tag"),void undo_man.Cancel();if("editimg"!==math.lastChild.className)return alert("figure has no img tag"),void undo_man.Cancel();const focus=EnableMathEdit(math,-1);return document.getSelection().collapse(focus.node,focus.offset),void undo_man.Cancel()}}{let ch=node.childNodes.item(offset-1);if(ch.nodeType===Node.TEXT_NODE){const focus=SafeDeleteInTextNode(ch,ch.length-1);focus?(undo_man.End(focus.node,focus.offset),document.getSelection().collapse(focus.node,focus.offset)):undo_man.Cancel()}else if("BR"===ch.tagName)RemoveNode(ch),undo_man.End(node,offset-1),document.getSelection().collapse(node,offset-1);else if("math"===ch.className){const focus=EnableMathEdit(ch,-1);document.getSelection().collapse(focus.node,focus.offset),undo_man.Cancel()}else"OL"===ch.tagName||"UL"===ch.tagName?(alert("ERROR: figcaption node cannot have a child of ol/ul."),undo_man.Cancel()):(alert("ERROR: delete key before undefined element"),undo_man.Cancel())}break;case"TH":case"TD":if(undo_man.Begin(origin.node,origin.offset),"BR"===node.firstChild.nodeName&&null===node.firstChild.nextSibling&&(offset=0),offset>0){let ch=node.childNodes.item(offset-1);if(ch.nodeType===Node.TEXT_NODE){const focus=SafeDeleteInTextNode(ch,ch.length-1);focus?(undo_man.End(focus.node,focus.offset),document.getSelection().collapse(focus.node,focus.offset)):undo_man.Cancel()}else if("BR"===ch.tagName)RemoveNode(ch),undo_man.End(node,offset-1),document.getSelection().collapse(node,offset-1);else if("math"===ch.className){const focus=EnableMathEdit(ch,-1);document.getSelection().collapse(focus.node,focus.offset),undo_man.Cancel()}else"OL"===ch.tagName||"UL"===ch.tagName?(alert("ERROR: td node cannot have a child of ol/ul."),undo_man.Cancel()):(alert("ERROR: delete key before undefined element"),undo_man.Cancel())}else{if(!is_shift)break;let prev=node.previousSibling;if(prev){const focus=SafeCombineNode(prev),new_td=AddNode(prev.tagName,prev.parentNode,null);return AddNode("BR",new_td,null),document.getSelection().collapse(focus.node,focus.offset),void undo_man.End(focus.node,focus.offset)}{const prev_tr=node.parentNode.previousSibling;if(prev_tr){RemoveNode(node.parentNode);const focus=FocusOffsetLast(prev_tr);return undo_man.End(focus.node,focus.offset),void document.getSelection().collapse(focus.node,focus.offset)}}}break;default:alert("ERROR: Delete at "+node.tagName),undo_man.Cancel()}undo_man.Cancel()}function SwitchInputArrowRight(node,offset,is_shift){if(null===node)return!0;if(is_shift)return SwitchInputArrowRightShift(node,offset);if(node.nodeType===Node.TEXT_NODE){if(IsTextNodeInMath(node)){const math=node.parentNode.parentNode;if(offset>=node.length-1){const res=DisableEdit(math);if(res.removed)document.getSelection().collapse(res.focus.node,res.focus.offset);else if(null===math.nextSibling);else if(math.nextSibling.nodeType===Node.TEXT_NODE)math.nextSibling.data==nt_ZWBR?document.getSelection().collapse(math.nextSibling,1):document.getSelection().collapse(math.nextSibling,0);else{const focus=FocusOffsetZero(math.nextSibling);focus&&(focus.node.nodeType===Node.TEXT_NODE&&focus.node.data==nt_ZWBR&&(focus.offset=1),document.getSelection().collapse(focus.node,focus.offset))}return!0}return!1}if(node.data==nt_ZWBR&&(offset=1),offset!==node.length)return!1;offset=GetIndex(node.parentNode,node)+1,"MARK"==(node=node.parentNode).nodeName&&(offset=GetIndex(node.parentNode,node)+1,node=node.parentNode)}switch(node.nodeName){case"P":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"LI":case"FIGCAPTION":case"FIGURE":case"TH":case"TD":case"DIV":{let ch=node.childNodes.item(offset);if(ch){if(ch.nodeType===Node.TEXT_NODE)return document.getSelection().collapse(ch,1),!0;if("math"===ch.className){const focus=EnableMathEdit(ch,1);return document.getSelection().collapse(focus.node,focus.offset),!0}if("BR"!=ch.nodeName){if("MARK"==ch.nodeName)return document.getSelection().collapse(ch.firstChild,1),!0;{const focus=FocusOffsetZero(ch);return focus&&document.getSelection().collapse(focus.node,focus.offset),!0}}node=ch}let p=node;for(;null===p.nextSibling;)if(p=p.parentNode,"DIV"===p.tagName)return!0;const focus=FocusOffsetZero(p.nextSibling);return focus&&document.getSelection().collapse(focus.node,focus.offset),!0}}return!1}function SwitchInputArrowRightShift(node,offset){if(null===node)return!0;if(node.nodeType===Node.TEXT_NODE)if(IsTextNodeInMath(node)){const math=node.parentNode.parentNode,margin=GetEditMargin(math);if(offset>=node.length-margin){if(document.getSelection().anchorNode===math.lastChild.firstChild){const res=DisableEdit(math);if(res.removed)document.getSelection().collapse(res.focus.node,res.focus.offset);else{const foffset=GetIndex(math.parentNode,math);document.getSelection().setBaseAndExtent(math.parentNode,foffset,math.parentNode,foffset+1)}}else{const res=DisableEdit(math);if(res.removed)document.getSelection().extend(res.focus.node,res.focus.offset);else{const foffset=GetIndex(math.parentNode,math);document.getSelection().extend(math.parentNode,foffset+1)}}return!0}if(0!==offset)return document.getSelection().extend(node,offset+1),!0;{const res=DisableEdit(math);if(res.removed)return document.getSelection().extend(res.focus.node,res.focus.offset),!0;offset=GetIndex(math.parentNode,math),node=math.parentNode}}else{if(node.data==nt_ZWBR&&(offset=1),offset!==node.length)return document.getSelection().extend(node,offset+1),!0;offset=GetIndex(node.parentNode,node)+1,"MARK"==(node=node.parentNode).nodeName&&(offset=GetIndex(node.parentNode,node)+1,node=node.parentNode)}if(("TH"==node.tagName||"TD"==node.tagName)&&offset==node.childNodes.length)return IsHighlightMode()&&NT_HighlightClear(),SetSelectTable(node,node),!0;switch(node.nodeName){case"P":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"LI":case"FIGCAPTION":case"FIGURE":case"TH":case"TD":{const ch=node.childNodes.item(offset);if(ch){if(ch.nodeType===Node.TEXT_NODE)return document.getSelection().extend(ch,1),!0;if("SPAN"==ch.nodeName)return document.getSelection().extend(node,offset+1),!0;if("BR"!=ch.nodeName){if("MARK"==ch.nodeName)return document.getSelection().extend(ch.firstChild,1),!0;{const focus=FocusOffsetZero(ch,!1);return focus&&document.getSelection().extend(focus.node,focus.offset),!0}}node=ch}let p=node;for(;null===p.nextSibling;)if(p=p.parentNode,"DIV"===p.tagName)return!0;if("TABLE"==p.nextSibling.nodeName){const table=p.nextSibling,master=table.parentNode;return document.getSelection().extend(master,GetIndex(master,table)+1),!0}const focus=FocusOffsetZero(p.nextSibling,!1);return focus&&document.getSelection().extend(focus.node,focus.offset),!0}case"DIV":{const expect_table=node.childNodes.item(offset);if(null===expect_table)return!1;if("TABLE"==expect_table.nodeName)return document.getSelection().extend(node,offset+1),!0;{const focus=FocusOffsetZero(expect_table,!1);return focus&&document.getSelection().extend(focus.node,focus.offset),!0}}}return!1}function FocusOffsetZero(node,is_enable_math=!0){for(;node;){if(node.nodeType===Node.TEXT_NODE)return{node:node,offset:0};if(null===node.firstChild)return{node:node.parentNode,offset:GetIndex(node.parentNode,node)};if("BR"===node.firstChild.nodeName)return{node:node,offset:0};if("math"===node.className)return is_enable_math?EnableMathEdit(node,0):{node:node.parentNode,offset:GetIndex(node.parentNode,node)};node=node.firstChild}return null}function SwitchInputArrowLeft(node,offset,is_shift){if(null===node)return!0;if(is_shift)return SwitchInputArrowLeftShift(node,offset);if(node.nodeType===Node.TEXT_NODE){if(IsTextNodeInMath(node)){const math=node.parentNode.parentNode;if(offset<=1){if("FIGURE"==math.parentNode.nodeName&&null===math.previousSibling){const figure=math.parentNode;if(DisableEdit(math).removed){const focus=FocusOffsetZero(ConvertFiguretoP(figure));document.getSelection().collapse(focus.node,focus.offset)}else if(figure.previousSibling){const focus=FocusOffsetLast(figure.previousSibling);focus&&(focus.node.nodeType===Node.TEXT_NODE&&focus.node.data==nt_ZWBR&&(focus.offset=0),document.getSelection().collapse(focus.node,focus.offset))}else{undo_man.Begin(node,offset);const p_node=AddNode("P",figure.parentNode,figure);AddNode("BR",p_node,null),undo_man.End(p_node,0),document.getSelection().collapse(p_node,0)}}else{const res=DisableEdit(math);if(res.removed)document.getSelection().collapse(res.focus.node,res.focus.offset);else{const focus=FocusOffsetLast(math.previousSibling);focus&&(focus.node.nodeType===Node.TEXT_NODE&&focus.node.data==nt_ZWBR&&(focus.offset=0),document.getSelection().collapse(focus.node,focus.offset))}}return!0}return!1}if(node.data==nt_ZWBR&&(offset=0),0!==offset)return!1;offset=GetIndex(node.parentNode,node),"MARK"==(node=node.parentNode).nodeName&&(offset=GetIndex(node.parentNode,node),node=node.parentNode)}switch(node.tagName){case"P":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"LI":case"FIGCAPTION":case"FIGURE":case"TH":case"TD":case"DIV":{const ch=node.childNodes.item(offset-1);if(ch){if(ch.nodeType===Node.TEXT_NODE)return document.getSelection().collapse(ch,ch.length-1),!0;if("math"===ch.className){const focus=EnableMathEdit(ch,-1);return document.getSelection().collapse(focus.node,focus.offset),!0}if("BR"!=ch.nodeName){if("MARK"==ch.nodeName)return document.getSelection().collapse(ch.firstChild,ch.firstChild.length-1),!0;{const focus=FocusOffsetLast(ch);return focus&&document.getSelection().collapse(focus.node,focus.offset),!0}}node=ch}let p=node;for(;null===p.previousSibling;)if(p=p.parentNode,"DIV"===p.tagName)return!0;const focus=FocusOffsetLast(p.previousSibling);return focus&&document.getSelection().collapse(focus.node,focus.offset),!0}}}function SwitchInputArrowLeftShift(node,offset){if(null===node)return!0;if(node.nodeType===Node.TEXT_NODE)if(IsTextNodeInMath(node)){const math=node.parentNode.parentNode;if(offset<=GetEditMargin(math)){if(document.getSelection().anchorNode===math.lastChild.firstChild){const res=DisableEdit(math);if(res.removed)document.getSelection().collapse(res.focus.node,res.focus.offset);else{const foffset=GetIndex(math.parentNode,math);document.getSelection().setBaseAndExtent(math.parentNode,foffset+1,math.parentNode,foffset)}}else{const res=DisableEdit(math);if(res.removed)document.getSelection().extend(res.focus.node,res.focus.offset);else{const foffset=GetIndex(math.parentNode,math);document.getSelection().extend(math.parentNode,foffset)}}return!0}if(offset!==node.length)return document.getSelection().extend(node,offset-1),!0;{const res=DisableEdit(math);if(res.removed)return document.getSelection().extend(res.focus.node,res.focus.offset),!0;offset=GetIndex(math.parentNode,math),node=math.parentNode}}else{if(node.data==nt_ZWBR&&(offset=0),0!==offset)return document.getSelection().extend(node,offset-1),!0;offset=GetIndex(node.parentNode,node),"MARK"==(node=node.parentNode).nodeName&&(offset=GetIndex(node.parentNode,node),node=node.parentNode)}if(("TH"==node.tagName||"TD"==node.tagName)&&0==offset)return IsHighlightMode()&&NT_HighlightClear(),SetSelectTable(node,node),!0;switch(node.tagName){case"P":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"LI":case"FIGCAPTION":case"FIGURE":case"TH":case"TD":{const ch=node.childNodes.item(offset-1);if(ch){if(ch.nodeType===Node.TEXT_NODE)return document.getSelection().extend(ch,ch.length-1),!0;if("SPAN"==ch.nodeName)return document.getSelection().extend(node,offset-1),!0;if("BR"!=ch.nodeName){if("MARK"==ch.nodeName)return document.getSelection().extend(ch.firstChild,ch.firstChild.length-1),!0;{const focus=FocusOffsetLast(ch,!1);return focus&&document.getSelection().extend(focus.node,focus.offset),!0}}node=ch}let p=node;for(;null===p.previousSibling;)if(p=p.parentNode,"DIV"===p.tagName)return!0;if("TABLE"==p.previousSibling.nodeName){const table=p.previousSibling,master=table.parentNode;return document.getSelection().extend(master,GetIndex(master,table)),!0}const focus=FocusOffsetLast(p.previousSibling,!1);return focus&&document.getSelection().extend(focus.node,focus.offset),!0}case"DIV":{const expect_table=node.childNodes.item(offset-1);if(null===expect_table)return!1;if("TABLE"==expect_table.nodeName)return document.getSelection().extend(node,offset-1),!0;{const focus=FocusOffsetLast(expect_table,!1);return focus&&document.getSelection().extend(focus.node,focus.offset),!0}}}return!1}function FocusOffsetLast(node,is_enable_math=!0){for(;node;){if(node.nodeType===Node.TEXT_NODE)return{node:node,offset:node.length};if(null===node.firstChild)return{node:node.parentNode,offset:GetIndex(node.parentNode,node)};if("BR"===node.firstChild.nodeName)return{node:node,offset:0};if("math"===node.className)return is_enable_math?EnableMathEdit(node,-1):{node:node.parentNode,offset:GetIndex(node.parentNode,node)};node=node.lastChild}return null}function SwitchInputMath(mark,node,offset){if(null===node)return;let class_name;switch(mark){case"$":class_name="editmath";break;case"`":class_name="editcode";break;case"*":case"_":class_name="editem";break;default:return}if(node.nodeType===Node.TEXT_NODE){if("SPAN"===node.parentNode.nodeName){if(node.parentNode.className.slice(0,node.parentNode.className.length-1)===class_name){const margin=GetEditMarginByClassName(node.parentNode.className);if(offset!==margin&&offset!==node.length-margin)return;undo_man.Begin(node,offset);let math_old=node.parentNode.parentNode,math_new=AddMathNode(mark.repeat(margin+1),math_old.parentNode,math_old);math_new&&(InsertTextIntoText(node.data.slice(margin,node.length-margin),math_new.lastChild.lastChild,margin+1),RemoveNode(math_old));const focus=EnableMathEdit(math_new,offset+1);return document.getSelection().collapse(focus.node,focus.offset),void undo_man.End(focus.node,focus.offset)}if(node.parentNode.className===class_name){const margin=GetEditMarginByClassName(class_name+"disp");if(!(0<offset&&offset<margin))return;if(node.length>=margin&&node.data.slice(0,margin-1)===mark.repeat(margin-1)){undo_man.Begin(node,offset);let math_inline=node.parentNode.parentNode,math_display=AddMathNode(mark.repeat(margin),math_inline.parentNode,math_inline);math_display&&(InsertTextIntoText(node.data.slice(margin-1,node.length-(margin-1)),math_display.lastChild.lastChild,margin+1),RemoveNode(math_inline)),"editmath"===class_name&&SetEqNumber(math_display,1);const focus=EnableMathEdit(math_display,margin+1);return document.getSelection().collapse(focus.node,focus.offset),void undo_man.End(focus.node,focus.offset)}}return undo_man.Begin(node,offset),InsertTextIntoText(mark,node,offset),undo_man.End(node,offset+1),void document.getSelection().collapse(node,offset+1)}{undo_man.Begin(node,offset);const parent=node.parentNode;let ref_node;ref_node=0===offset?node:offset===node.length?node.nextSibling:DivideTextNode(node,offset);const math=AddMathNode(mark,parent,ref_node);IsTextNode(math.previousSibling)||AddTextNode(nt_ZWBR,parent,math),IsTextNode(math.nextSibling)||AddTextNode(nt_ZWBR,parent,math.nextSibling);const focus=EnableMathEdit(math,1);return document.getSelection().collapse(focus.node,focus.offset),void undo_man.End(focus.node,focus.offset)}}switch(node.tagName){case"P":case"LI":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"FIGCAPTION":case"FIGURE":case"TH":case"TD":{let br_node=null;0===offset&&"BR"===node.firstChild.nodeName&&(null===node.firstChild.nextSibling?br_node=node.firstChild:"UL"!==node.firstChild.nextSibling.nodeName&&"OL"!==node.firstChild.nextSibling.nodeName||(br_node=node.firstChild)),undo_man.Begin(node,offset);let ref_node=node.childNodes.item(offset),math=AddMathNode(mark,node,ref_node);br_node&&RemoveNode(br_node),IsTextNode(math.previousSibling)||AddTextNode(nt_ZWBR,node,math),IsTextNode(math.nextSibling)||AddTextNode(nt_ZWBR,node,math.nextSibling);const focus=EnableMathEdit(math,1);return document.getSelection().collapse(focus.node,focus.offset),void undo_man.End(focus.node,focus.offset)}default:alert("ERROR: InputChar in Math at"+node.tagName)}}function SwitchInputMathSelection(mark,node,offset,anchor_node,anchor_offset){if(null===node)return;if(node!==anchor_node)return;if(node.nodeType!==Node.TEXT_NODE)return;let class_name;switch(mark){case"$":class_name="editmath";break;case"`":class_name="editcode";break;case"*":case"_":class_name="editem";break;case"**":case"_":class_name="editem";break;default:return}if(!IsTextNodeInMath(node)){undo_man.Begin(node,offset,anchor_node,anchor_offset);const parent=node.parentNode,[begin_off,end_off]=anchor_offset<offset?[anchor_offset,offset]:[offset,anchor_offset];end_off<node.length&&DivideTextNode(node,end_off);const ref_node=0==begin_off?node:DivideTextNode(node,begin_off),math=AddMathNode(mark,parent,ref_node),math_text=math.lastChild.firstChild,margin=GetEditMargin(math);InsertTextIntoText(ref_node.data,math_text,margin),RemoveNode(ref_node),IsTextNode(math.previousSibling)||AddTextNode(nt_ZWBR,parent,math),IsTextNode(math.nextSibling)||AddTextNode(nt_ZWBR,parent,math.nextSibling);const focus=EnableMathEdit(math,1);return document.getSelection().collapse(focus.node,focus.offset),void undo_man.End(focus.node,focus.offset)}}function SwitchInputSpace(node,offset){if(null===node)return!1;const is_H1to6=tagName=>"H1"<=tagName&&tagName<="H6";if(node.nodeType!==Node.TEXT_NODE){if("P"!==node.tagName&&!is_H1to6(node.tagName))return!1;if(null===(node=node.childNodes.item(offset-1)))return!1;offset=node.length}if(node.nodeType===Node.TEXT_NODE){let parent=node.parentNode;if("P"===parent.tagName){if(node!==parent.firstChild)return!1;const head_word=node.data.substring(0,offset);let new_node,focus,tagname="none";switch(head_word){case"-":case"*":case"+":tagname="UL";break;case"#":tagname="H1";break;case"##":tagname="H2";break;case"###":tagname="H3";break;case"####":tagname="H4";break;case"#####":tagname="H5";break;case"######":tagname="H6"}if("."===head_word[head_word.length-1]){tagname="OL";for(let i=0;i<head_word.length-1;++i)(head_word[i]<"0"||"9"<head_word[i])&&(tagname="none")}if("none"===tagname)return!1;if(undo_man.Begin(node,offset),"UL"===tagname){const ul=AddNode(tagname,parent.parentNode,parent);new_node=AddNode("LI",ul,null)}else if("OL"===tagname){const ul=AddNode(tagname,parent.parentNode,parent);new_node=AddNode("LI",ul,null)}else new_node=AddNode(tagname,parent.parentNode,parent);if(node.length!==offset&&DivideTextNode(node,offset),node.nextSibling){focus=SafePushNodeList(new_node,RemoveNodeList(parent,node.nextSibling,null))}else AddNode("BR",new_node,null),focus={node:new_node,offset:0};return RemoveNode(parent),undo_man.End(focus.node,focus.offset),document.getSelection().collapse(focus.node,focus.offset),!0}if(is_H1to6(parent.tagName)){if(node!==parent.firstChild)return!1;let tagrank=0;switch(node.data.substring(0,offset)){case"#":tagrank=1;break;case"##":tagrank=2;break;case"###":tagrank=3;break;case"####":tagrank=4;break;case"#####":tagrank=5;break;case"######":tagrank=6}if("none"===tagrank)return!1;const myrank=parseInt(parent.tagName.charAt(1),10);if(tagrank+=myrank,tagrank>6&&(tagrank=6),myrank===tagrank)return!1;const tagname="H"+tagrank.toString();undo_man.Begin(node,offset);const new_node=AddNode(tagname,parent.parentNode,parent);let focus;if(node.length!==offset&&DivideTextNode(node,offset),node.nextSibling){focus=SafePushNodeList(new_node,RemoveNodeList(parent,node.nextSibling,null))}else AddNode("BR",new_node,null),focus={node:new_node,offset:0};return RemoveNode(parent),undo_man.End(focus.node,focus.offset),document.getSelection().collapse(focus.node,focus.offset),!0}}return!1}function SwitchInputTab(node,offset){if(null===node)return!1;if(offset>0)return!1;if(node.nodeType===Node.TEXT_NODE){if(node.previousSibling)return!1;node=node.parentNode}if("SPAN"===node.nodeName){let parent=node.parentNode;for(;"SPAN"===parent.nodeName;)parent=(node=parent).parentNode;if((offset=GetIndex(parent,node))>0)return!1;node=parent}if("LI"===node.nodeName){const prev=node.previousSibling;if(null===prev)return!1;undo_man.Begin(node,offset);let joint_target_list=null;joint_target_list="OL"===prev.lastChild.nodeName||"UL"===prev.lastChild.nodeName?prev.lastChild:AddNode(node.parentNode.tagName,prev,null);return AddNodeList(joint_target_list,null,RemoveNodeList(node.parentNode,node,node.nextSibling)),undo_man.End(node,0),document.getSelection().collapse(node,0),!0}if(node.nodeName>="H1"&&node.nodeName<"H6"){undo_man.Begin(node,offset);const focus=SafePushNodeList(AddNode("H"+(1+parseInt(node.nodeName.charAt(1),10)).toString(),node.parentNode,node),RemoveNodeList(node,node.firstChild));return RemoveNode(node),undo_man.End(focus.node,focus.offset),document.getSelection().collapse(focus.node,focus.offset),!0}return!1}function SwitchInputShiftTab(node,offset){if(null===node)return!1;if(offset>0)return!1;if(node.nodeType===Node.TEXT_NODE){if(node.previousSibling)return!1;node=node.parentNode}if("SPAN"===node.nodeName){let parent=node.parentNode;for(;"SPAN"===parent.nodeName;)parent=(node=parent).parentNode;if((offset=GetIndex(parent,node))>0)return!1;node=parent}if("LI"===node.nodeName){undo_man.Begin(node,offset);const pp=node.parentNode.parentNode;if("LI"===pp.nodeName){const ref=pp.nextSibling,joint_ol=pp.parentNode,org_ol=node.parentNode;if(node.nextSibling){const frag2=RemoveNodeList(org_ol,node.nextSibling);"OL"!==node.lastChild.nodeName&&"UL"!==node.lastChild.nodeName&&AddNode(org_ol.tagName,node,null),AddNodeList(node.lastChild,null,frag2)}AddNodeList(joint_ol,ref,RemoveNodeList(org_ol,node,node.nextSibling)),org_ol.hasChildNodes()||RemoveNode(org_ol),undo_man.End(node,0),document.getSelection().collapse(node,0)}else{const org_ol=node.parentNode,p_node=AddNode("P",pp,org_ol.nextSibling),frag2=node.nextSibling?RemoveNodeList(org_ol,node.nextSibling):null;let end_line=node.firstChild;for(;end_line&&"OL"!==end_line.nodeName&&"UL"!==end_line.nodeName;)end_line=end_line.nextSibling;const focus=SafePushNodeList(p_node,RemoveNodeList(node,node.firstChild,end_line));if(end_line){const later_target_ol=node.lastChild,frag3=RemoveNodeList(node,end_line);AddNodeList(pp,p_node.nextSibling,frag3),frag2&&AddNodeList(later_target_ol,null,frag2)}else if(frag2){AddNodeList(AddNode(org_ol.tagName,pp,p_node.nextSibling),null,frag2)}RemoveNode(node),org_ol.hasChildNodes()||RemoveNode(org_ol),p_node.firstChild.nodeType==Node.TEXT_NODE&&p_node.firstChild.data==nt_ZWBR&&(IsSpanMathImg(p_node.firstChild.nextSibling)?ConvertPtoFigure(p_node):IsSpanMathCite(p_node.firstChild.nextSibling)&&ConvertMathCiteToRef(p_node.firstChild.nextSibling)),document.getSelection().collapse(focus.node,focus.offset),undo_man.End(focus.node,focus.offset)}return!0}if(node.nodeName>"H1"&&node.nodeName<="H6"){undo_man.Begin(node,offset);const focus=SafePushNodeList(AddNode("H"+(parseInt(node.nodeName.charAt(1),10)-1).toString(),node.parentNode,node),RemoveNodeList(node,node.firstChild));return RemoveNode(node),undo_man.End(focus.node,focus.offset),document.getSelection().collapse(focus.node,focus.offset),!0}return!1}function SelectAll(maindiv){document.getSelection().setBaseAndExtent(maindiv.firstChild,0,maindiv.lastChild,maindiv.lastChild.childNodes.length)}function CorrectFocusToText2(node,offset){let[fnode,foffset]=CorrectFocusToText(node,offset);return{node:fnode,offset:foffset}}function CorrectFocusToText(node,offset){if(node.nodeType===Node.TEXT_NODE)return[node,offset];if(!node.hasChildNodes())return[node.parentNode,GetIndex(node.parentNode,node)];if(node.childNodes.length<=offset){for(;node.lastChild;)if((node=node.lastChild).nodeType===Node.TEXT_NODE)return[node,node.length];return[node.parentNode,node.parentNode.childNodes.length]}if("SPAN"===node.nodeName&&"math"===node.className){return[node.lastChild.firstChild,0]}for(node=node.childNodes.item(offset);node.nodeType!=Node.TEXT_NODE;){if(node.previousSibling&&node.previousSibling.nodeType==Node.TEXT_NODE)return[node.previousSibling,node.previousSibling.length];if(!node.hasChildNodes())return[node.parentNode,offset];if("SPAN"===node.nodeName&&"math"===node.className){return[node.lastChild.firstChild,0]}offset=0,node=node.firstChild}return[node,0]}function IsSpanMathImg(node){return!!node&&("SPAN"===node.nodeName&&("math"===node.className&&"editimg"===node.lastChild.className))}function ConvertPtoFigure(p_node){const figure=AddNode("FIGURE",p_node.parentNode,p_node);let i_end=p_node.firstChild;for(;i_end;){if(!IsSpanMathImg(i_end)){if(i_end.nodeType!==Node.TEXT_NODE)break;if(i_end.data!=nt_ZWBR)break}i_end=i_end.nextSibling}AddNodeList(figure,null,RemoveNodeList(p_node,p_node.firstChild,i_end)),figure.firstChild.nodeType==Node.TEXT_NODE&&RemoveNode(figure.firstChild),figure.lastChild.nodeType==Node.TEXT_NODE&&RemoveNode(figure.lastChild);const figcaption=AddNode("FIGCAPTION",figure,null);if(p_node.firstChild){SafePushNodeList(figcaption,RemoveNodeList(p_node,p_node.firstChild,null))}else AddNode("BR",figcaption,null);return RemoveNode(p_node),figure}function ConvertFiguretoP(figure){const p_node=AddNode("P",figure.parentNode,figure);let i_end=figure.firstChild;for(;i_end&&"FIGCAPTION"!==i_end.nodeName;)i_end=i_end.nextSibling;if(figure.firstChild!==i_end){SafePushNodeList(p_node,RemoveNodeList(figure,figure.firstChild,i_end))}if(i_end&&i_end.hasChildNodes()){SafePushNodeList(p_node,RemoveNodeList(i_end,i_end.firstChild,null))}return p_node.hasChildNodes()||AddNode("BR",p_node,null),RemoveNode(figure),IsSpanMathCite(p_node.firstChild.nextSibling)&&ConvertMathCiteToRef(p_node.firstChild.nextSibling),p_node}function IsSpanMathCite(node){return!!node&&("SPAN"===node.nodeName&&("math"===node.className&&"editcite"===node.lastChild.className))}function ConvertMathCiteToRef(math_cite){const frag=new DocumentFragment,preview=document.createElement("SPAN");preview.className="previewref";const text=math_cite.lastChild.firstChild.data;preview.appendChild(document.createTextNode(text.slice(2,text.length-2))),frag.appendChild(preview);const edit=document.createElement("SPAN");edit.className="editref",edit.appendChild(document.createTextNode(text.slice(0,text.length-1)+":")),frag.appendChild(edit),SetHide(frag.lastChild),RemoveNode(math_cite.firstChild),RemoveNode(math_cite.firstChild),AddNodeList(math_cite,null,frag)}function IsSpanMathRef(node){return!!node&&("SPAN"===node.nodeName&&("math"===node.className&&"editref"===node.lastChild.className))}function ConvertMathRefToCite(math_ref){const frag=new DocumentFragment,preview=document.createElement("A");preview.className="previewcite";const text=math_ref.lastChild.firstChild.data;preview.appendChild(document.createTextNode(text.slice(2,text.length-2))),preview.href="#"+text.slice(2,text.length-2),frag.appendChild(preview);const edit=document.createElement("SPAN");edit.className="editcite",edit.appendChild(document.createTextNode(text.slice(0,text.length-1)+" ")),frag.appendChild(edit),SetHide(math.lastChild);math_ref.nextSibling;RemoveNode(math_ref.firstChild),RemoveNode(math_ref.firstChild),AddNodeList(math_ref,null,frag)}function SwitchInputBar(node,offset){if(null===node)return!1;const origin={node:node,offset:offset};let should_devide=!1;if(node.nodeType===Node.TEXT_NODE)switch(node.parentNode.tagName){case"P":{if(0===offset)return!1;const[col_size,row_size]=GetTableSize(node.data.slice(0,offset));if(col_size<=0||row_size<=0)return!1;undo_man.Begin(node,offset);const fnode=ConvertPtoTable(node.parentNode,col_size,row_size).firstChild.firstChild;return undo_man.End(fnode,0),document.getSelection().collapse(fnode,0),!0}case"TH":case"TD":offset===node.length?(offset=GetIndex(node.parentNode,node)+1,node=node.parentNode):(should_devide=offset>0,offset=GetIndex(node.parentNode,node),node=node.parentNode);break;default:return!1}switch(node.tagName){case"TH":{undo_man.Begin(origin.node,origin.offset),should_devide&&(DivideTextNode(origin.node,origin.offset),++offset);const org_tr=node.parentNode;org_tr.parentNode;let focus,new_td=null;if(offset<node.childNodes.length){const fragment=SafeRemoveNodeList(node,node.childNodes.item(offset),null);new_td=AddNode(node.tagName,node.parentNode,node.nextSibling),focus=SafePushNodeList(new_td,fragment),node.hasChildNodes()||AddNode("BR",node,null)}else new_td=AddNode(node.tagName,node.parentNode,node.nextSibling),AddNode("BR",new_td,null),focus={node:new_td,offset:0};const begin_shilf=GetIndex(org_tr,node)+(0===offset?0:1),second_tr=org_tr.nextSibling;{const begin_td=second_tr.childNodes.item(begin_shilf),td=AddNode("TD",second_tr,begin_td);AddTextNode(begin_td.firstChild.data,td,null)}for(let tr=second_tr.nextSibling;tr;tr=tr.nextSibling){const begin_td=tr.childNodes.item(begin_shilf),td=AddNode("TD",tr,begin_td);AddNode("BR",td,null)}return undo_man.End(focus.node,focus.offset),document.getSelection().collapse(focus.node,focus.offset),!0}case"TD":{const org_tr=node.parentNode,table=org_tr.parentNode;if(org_tr===table.firstChild.nextSibling)return!0;undo_man.Begin(origin.node,origin.offset),should_devide&&(DivideTextNode(origin.node,origin.offset),++offset);let focus,new_td=null;if(offset<node.childNodes.length){const fragment=SafeRemoveNodeList(node,node.childNodes.item(offset),null);new_td=AddNode(node.tagName,node.parentNode,node.nextSibling),focus=SafePushNodeList(new_td,fragment),node.hasChildNodes()||AddNode("BR",node,null)}else new_td=AddNode(node.tagName,node.parentNode,node.nextSibling),AddNode("BR",new_td,null),focus={node:new_td,offset:0};const num_column=table.firstChild.childNodes.length;for(;org_tr.childNodes.length>num_column;)RemoveNode(org_tr.lastChild);return undo_man.End(focus.node,focus.offset),document.getSelection().collapse(focus.node,focus.offset),!0}}return!1}function SwitchInputHat(node,offset){if(null===node)return!0;if(node.nodeType!=Node.TEXT_NODE)return!0;if(IsTextNodeInMath(node)&&["edita","editimg","editcite","editref"].includes(node.parentNode.className))return!0;if("["!=node.data.charAt(offset-1))return!1;const pos_sq_bra=offset-1;let sq_text,cut_end=node.data.indexOf("]",offset);cut_end<0?(cut_end=offset,sq_text=node.data.slice(pos_sq_bra,offset)+"^] "):(cut_end++,sq_text=node.data.slice(pos_sq_bra,offset)+"^"+node.data.slice(offset,cut_end)+" "),undo_man.Begin(node,offset);let rm_node=node;cut_end<node.length&&DivideTextNode(node,cut_end),pos_sq_bra>0&&(rm_node=DivideTextNode(node,pos_sq_bra));const math=AddMathNode("[^",node.parentNode,rm_node);RemoveNode(rm_node),SafeJunctionPoint(math.parentNode,math),SafeJunctionPoint(math.parentNode,math.nextSibling);const math_text=math.lastChild.firstChild;InsertTextIntoText(sq_text,math_text,0),DeleteText(math_text,sq_text.length,math_text.length),"P"==math.parentNode.nodeName&&math.previousSibling.data==nt_ZWBR&&null===math.previousSibling.previousSibling&&ConvertMathCiteToRef(math);const focus=EnableMathEdit(math,offset-pos_sq_bra+1);return document.getSelection().collapse(focus.node,focus.offset),undo_man.End(focus.node,focus.offset),!0}function SwitchInputRoundBra(node,offset){if(null===node)return!0;if(node.nodeType!=Node.TEXT_NODE)return!1;if(IsTextNodeInMath(node))return!1;if("]"!=node.data.charAt(offset-1))return!1;let pos_sq_bra=node.data.lastIndexOf("[",offset-1);if(pos_sq_bra<0)return!1;let is_img=!1;"!"==node.data.charAt(pos_sq_bra-1)&&(pos_sq_bra--,is_img=!0);let sq_text,cut_end=node.data.indexOf(")",offset);cut_end<0?(cut_end=offset,sq_text=node.data.slice(pos_sq_bra,offset)+"()"):(cut_end++,sq_text=node.data.slice(pos_sq_bra,offset)+"("+node.data.slice(offset,cut_end)),is_img&&(sq_text+=" "),undo_man.Begin(node,offset);let rm_node=node;cut_end<node.length&&DivideTextNode(node,cut_end),pos_sq_bra>0&&(rm_node=DivideTextNode(node,pos_sq_bra));const math=AddMathNode(is_img?"![":"[",node.parentNode,rm_node);RemoveNode(rm_node),SafeJunctionPoint(math.parentNode,math),SafeJunctionPoint(math.parentNode,math.nextSibling);const math_text=math.lastChild.firstChild;InsertTextIntoText(sq_text,math_text,0),DeleteText(math_text,sq_text.length,math_text.length),"P"==math.parentNode.nodeName&&math.previousSibling.data==nt_ZWBR&&null===math.previousSibling.previousSibling&&ConvertPtoFigure(math.parentNode);const focus=EnableMathEdit(math,offset-pos_sq_bra+1);return document.getSelection().collapse(focus.node,focus.offset),undo_man.End(focus.node,focus.offset),!0}function ConvertPtoTable(p_node,col_size,row_size){const table=AddNode("TABLE",p_node.parentNode,p_node);{const tr=AddNode("TR",table,null);for(let i=0;i<col_size;++i){const th=AddNode("TH",tr,null);AddNode("BR",th,null)}}{const tr=AddNode("TR",table,null);for(let i=0;i<col_size;++i){AddTextNode("---",AddNode("TD",tr,null),null)}}for(let k=1;k<row_size;++k){const tr=AddNode("TR",table,null);for(let i=0;i<col_size;++i){const td=AddNode("TD",tr,null);AddNode("BR",td,null)}}return RemoveNode(p_node),table}function GetTableSize(text){if("|"!==text[0])return[0,0];const length=text.length;let i=1;for(;" "===text[i];)if(++i,i===length)return[0,0];const num1_begin=i;for(;"0"<=text[i]&&text[i]<="9";)if(++i,i===length)return[0,0];const num1_end=i;for(;" "===text[i];)if(++i,i===length)return[0,0];if("x"!==text[i]&&","!==text[i])return[0,0];for(++i;" "===text[i];)if(++i,i===length)return[0,0];const num2_begin=i;for(;"0"<=text[i]&&text[i]<="9"&&(++i,i!==length););if(i===num2_begin)return[0,0];const num2_end=i;for(;i<length;){if(" "!==text[i])return[0,0];++i}return[parseInt(text.slice(num1_begin,num1_end),10),parseInt(text.slice(num2_begin,num2_end),10)]}function SwitchInputArrowUp(td){const tr=td.parentNode;if(null===tr.previousSibling){const table=tr.parentNode;if(null===table.previousSibling){undo_man.Begin(document.getSelection().focusNode,document.getSelection().focusOffset);const p=AddNode("P",table.parentNode,table);return AddNode("BR",p,null),document.getSelection().collapse(p,0),undo_man.End(p,0),!0}return!1}const index=GetIndex(tr,td),focus=FocusOffsetLast(tr.previousSibling.childNodes.item(index));return document.getSelection().collapse(focus.node,focus.offset),!0}function SwitchInputArrowDown(td){const tr=td.parentNode;if(null===tr.nextSibling){const table=tr.parentNode;if(null===table.nextSibling){undo_man.Begin(document.getSelection().focusNode,document.getSelection().focusOffset);const p=AddNode("P",table.parentNode,null);return AddNode("BR",p,null),document.getSelection().collapse(p,0),undo_man.End(p,0),!0}return!1}const index=GetIndex(tr,td),focus=FocusOffsetLast(tr.nextSibling.childNodes.item(index));return document.getSelection().collapse(focus.node,focus.offset),!0}function NT_SetMarkdown(md_text){const maindiv=nt_render_div;for(;maindiv.firstChild;)maindiv.removeChild(maindiv.firstChild);const fragment=MD2DOM(ResolveNewlineCode(md_text));InitializeMathInFragment(fragment,g_auto_numbering?1:0),maindiv.appendChild(fragment),undo_man=new UndoManager,undo_man.SetChangeEventDispatcher(new ChangeEventDispatcher(render_div))}function NT_GetMarkdown(){return DOM2MD(nt_render_div)}function NT_GetTeX(){return DOM2TEX(nt_render_div)}let nt_file_dir="";function NT_SetFilePath(path){if("/"===path.charAt(path.length-1))nt_file_dir=path;else if("\\"===path.charAt(path.length-1))nt_file_dir=path;else if(".md"===path.slice(path.length-3)){let pos=path.lastIndexOf("/");pos<0&&(pos=path.lastIndexOf("\\"),pos<0&&(nt_file_dir="")),nt_file_dir=path.slice(0,pos+1)}else{path.lastIndexOf("/")>=0&&(nt_file_dir=path+"/"),nt_file_dir=path+"\\"}}let g_editable_math=null,g_auto_numbering=!0;function OnClick(event){if(IsTableSelectionMode())return!1;if(!CorrectSelectionEdgeTable())return event.preventDefault(),!1;if(event.shiftKey&&event.ctrlKey){const td=CheckNodeInTD(document.elementFromPoint(event.clientX,event.clientY),nt_render_div);if(td){const table=td.parentNode.parentNode,parent=table.parentNode;event.preventDefault();const index=GetIndex(parent,table);return document.getSelection().setBaseAndExtent(parent,index,parent,index+1),!1}}OnClickMath(event)}function OnClickMath(event){const selection=document.getSelection();let clicked_node=document.elementFromPoint(event.clientX,event.clientY),focus_math=CheckNodeInClass(clicked_node,"math",nt_render_div);if(null===focus_math&&(clicked_node=selection.focusNode,focus_math=CheckNodeInClass(clicked_node,"math",nt_render_div)),null===focus_math)return selection.isCollapsed||CheckNodeInClass(selection.anchorNode,"math",nt_render_div)&&selection.collapse(selection.focusNode,selection.focusOffset),void DisableEdit(g_editable_math,!1);if(g_editable_math!==focus_math){const math_class=focus_math.lastChild.className;if(["editmath","editmathdisp","editimg"].includes(math_class))if(DisableEdit(g_editable_math,!1),event.shiftKey){const parent=focus_math.parentNode,offset=GetIndex(parent,focus_math);document.getSelection().setBaseAndExtent(parent,offset,parent,offset+1)}else{const math_text=EnableMathEdit(focus_math,1);document.getSelection().collapse(math_text.node,math_text.offset)}else{let focus_offset=document.getSelection().focusOffset,anchor_offset=document.getSelection().anchorNode===document.getSelection().focusNode?document.getSelection().anchorOffset:focus_offset;DisableEdit(g_editable_math,!1);const math_text=EnableMathEdit(focus_math,1),margin=GetEditMarginByClassName(math_class);focus_offset+=margin,anchor_offset+=margin,"editcodedisp"===math_class&&"\n"===math_text.node.data.charAt(3)&&(focus_offset++,anchor_offset++),anchor_offset!=focus_offset?document.getSelection().setBaseAndExtent(math_text.node,anchor_offset,math_text.node,focus_offset):document.getSelection().collapse(math_text.node,focus_offset)}}}function CheckEditPreview(master_node,in_undo_redo=!1){let focus_math=CheckFocusInClass("math",master_node);return g_editable_math!==focus_math&&(DisableEdit(g_editable_math,in_undo_redo),focus_math)?EnableMathEdit(focus_math,1):null}function CheckFocusInClass(target_class_name,master_node){return CheckNodeInClass(document.getSelection().focusNode,target_class_name,master_node)}function CheckNodeInClass(ref_node,target_class_name,master_node){let node=ref_node;for(;node&&node!==master_node;){if(node.nodeType===Node.ELEMENT_NODE&&node.className===target_class_name)return node;node=node.parentNode}return null}function CheckNodeInNode(ref_node,target_node){let node=ref_node;for(;node;){if(node===target_node)return node;node=node.parentNode}return null}function SetFocusByCoordinate(target_text_node,margin,x,y){let offset,textNode=null;if(document.caretPositionFromPoint){let range=document.caretPositionFromPoint(x,y);textNode=range.offsetNode,offset=range.offset}else if(document.caretRangeFromPoint){let range=document.caretRangeFromPoint(x,y);textNode=range.startContainer,offset=range.startOffset}return textNode===target_text_node&&textNode.nodeType===Node.TEXT_NODE&&(offset<margin&&(offset=margin),offset>textNode.length-margin&&(offset=textNode.length-margin),document.getSelection().collapse(textNode,offset),!0)}function EnableMathEdit(math,offset=1){if(null===math)return null;if("math"!==math.className)return null;HidePreview(math.firstChild),UnsetHide(math.lastChild),g_editable_math=math;const text=math.lastChild.firstChild;return{node:text,offset:offset<0?text.length+offset:offset}}function DisableEdit(math,in_undo_redo=!1){if(null===math)return{removed:!1,focus:null};if("math"!==math.className)return{removed:!1,focus:null};let edit_node=math.lastChild;const margin=GetEditMargin(math);let text_node=edit_node.firstChild,mathtext=text_node.data.slice(margin,text_node.length-margin),is_removed=0===mathtext.length,pos_split_a_img=0;if("edita"!==edit_node.className&&"editimg"!==edit_node.className||(pos_split_a_img=mathtext.indexOf("]("),pos_split_a_img<0&&(is_removed=!0)),is_removed){if(in_undo_redo)return g_editable_math=null,{removed:!1,focus:null};{let highlight_word=null;IsHighlightMode()&&(highlight_word=nt_highlight.Word,NT_HighlightClear()),undo_man.Begin(text_node,margin);const parent=math.parentNode,math_next=math.nextSibling;RemoveNode(math);let focus=SafeJunctionPoint(parent,math_next);return undo_man.End(focus.node,focus.offset),document.getSelection().collapse(focus.node,focus.offset),highlight_word&&(NT_HighlightWord(highlight_word),focus=nt_highlight.HighlightFocus(focus.node,focus.offset)),g_editable_math=null,{removed:!0,focus:focus}}}switch(edit_node.className){case"editmath":MathRendering(math,mathtext,-1),ShowPreview(math.firstChild);break;case"editmathdisp":MathRendering(math,mathtext,-1),ShowPreviewDisplay(math.firstChild),math.firstChild.style.width=String(math.firstChild.clientWidth)+"px",math.firstChild.style.height=String(math.firstChild.clientHeight)+"px";break;case"editcode":math.firstChild.firstChild.data=mathtext,ShowPreview(math.firstChild);break;case"editcodedisp":"\n"===mathtext.charAt(0)?math.firstChild.firstChild.data=mathtext.slice(1,mathtext.length-1):math.firstChild.firstChild.data=mathtext,ShowPreviewDisplay(math.firstChild);break;case"editem1":case"editem2":case"editem3":{let target=math.firstChild.firstChild;target.nodeType===Node.TEXT_NODE?target.data=mathtext:target.firstChild.data=mathtext,ShowPreview(math.firstChild)}break;case"edita":{let target=math.firstChild;target.href=mathtext.slice(pos_split_a_img+2,mathtext.length+1),target.firstChild.data=mathtext.slice(0,pos_split_a_img),ShowPreview(target)}break;case"editimg":{const target=math.firstChild;target.src=nt_file_dir+mathtext.slice(pos_split_a_img+2,mathtext.length+1),target.alt=mathtext.slice(0,pos_split_a_img),ShowPreview(target)}break;case"editcite":{const target=math.firstChild;target.href="#"+mathtext,target.firstChild.data=mathtext,ShowPreview(target)}break;case"editref":{const target=math.firstChild;target.firstChild.data=mathtext,ShowPreview(target)}break;default:alert("ERROR: invalid edit class in math like node")}return SetHide(math.lastChild),g_editable_math=null,{removed:!1,focus:null}}function MathRendering(math,mathtext,number){let annotation=math.firstChild.getElementsByTagName("annotation");if(annotation&&annotation.textContent===mathtext)return 0;let edit_node=math.lastChild,delta=0;if("editmath"===edit_node.className){let ref_mathtext=ReferLabelEqnumber(mathtext);math.firstChild.remove();const fragment=new DocumentFragment;katex.render(ref_mathtext,fragment,{output:"html",displayMode:!1,throwOnError:!1}),math.insertBefore(fragment,math.firstChild),math.firstChild.contentEditable=!1}else if("editmathdisp"===edit_node.className){if(0===number){math.firstChild.remove();const re_mathtext=ReplaceAll(mathtext,"{align}","{aligned}"),fragment=new DocumentFragment;katex.render(re_mathtext,fragment,{output:"html",displayMode:!0,throwOnError:!1}),math.insertBefore(fragment,math.firstChild)}else number<0&&(number=parseInt(math.dataset.eqnumberBegin,10)),math.firstChild.remove(),delta=katexAutoNumber(mathtext,math,number),math.dataset.eqnumberBegin=number,math.dataset.eqnumberEnd=number+delta;math.firstChild.contentEditable=!1}else alert("invalid math editting");return delta}function HidePreview(node){node.style.display="none"}function ShowPreview(node){node.style.display="inline"}function ShowPreviewDisplay(node){node.style.display="block"}function SetHide(node){node.style.cssText="border: 0; clip: rect(0 0 0 0); height: 1px; margin: -1px; overflow: hidden; padding: 0; position: absolute; white-space: nowrap; width: 1px;"}function UnsetHide(node){node.style.cssText="clip: auto; height: auto; margin: 0; overflow: visible; position: static; width: auto;"}function GetEditMargin(math){const class_name=math.className;return GetEditMarginByClassName("math"===class_name?math.lastChild.className:class_name)}function GetEditMarginByClassName(class_name){switch(class_name){case"editmath":return 1;case"editmathdisp":return 2;case"editcode":return 1;case"editcodedisp":return 3;case"editem1":return 1;case"editem2":return 2;case"editem3":return 3;case"edita":return 1;case"editimg":case"editcite":case"editref":return 2;default:return 0}}function SetEqNumber(math,number){let delta=parseInt(math.dataset.eqnumberEnd,10)-parseInt(math.dataset.eqnumberBegin,10);math.dataset.eqnumberBegin=number,math.dataset.eqnumberEnd=number+delta}function IsTextNodeInMath(node){return null!==node.parentNode&&(null!==node.parentNode.parentNode&&"math"===node.parentNode.parentNode.className)}function QuickRedrawMath(render_div){let matches=render_div.querySelectorAll("span.editmathdisp");const whole_height=document.documentElement.clientHeight;for(let i=0;i<matches.length;i++){const math=matches[i].parentNode,katexdisp=math.firstChild,katex=katexdisp.firstChild,rect=katexdisp.getBoundingClientRect();"none"==katex.style.display?rect.bottom>0&&rect.top<whole_height&&math!==g_editable_math&&(katex.style.display=null):(rect.bottom<0||rect.top>whole_height)&&(katexdisp.style.length<=1&&rect.height>0&&(katexdisp.style.width=String(katexdisp.clientWidth)+"px",katexdisp.style.height=String(katexdisp.clientHeight)+"px"),katex.style.display="none")}}function FullRedrawMath(render_div){let matches=render_div.querySelectorAll("span.editmathdisp");document.documentElement.clientHeight;for(let i=0;i<matches.length;i++){matches[i].parentNode.firstChild.firstChild.style.display=null}}function MD2DOM(text_buffer){text_buffer=ReplaceAll(text_buffer,"\t","    ");let parent=new DocumentFragment;const buffer_length=text_buffer.length;let i=0;for(;i<buffer_length;){const ch=text_buffer.charAt(i);switch(ch){case"\n":++i;break;case"#":{let k=i+1,s=text_buffer.charAt(k);for(;"#"===s;)k++,s=text_buffer.charAt(k);if(" "===s){let h1_node=document.createElement("H"+(k-i).toString()),p_end=ParseH1(text_buffer,k+1,h1_node);parent.appendChild(h1_node),i=p_end}else{let p_node=document.createElement("P"),p_end=ParseP(text_buffer,k,p_node);parent.appendChild(p_node),i=p_end}}break;case"-":case"+":case"*":if(" "===text_buffer.charAt(i+1)){let ul_node=document.createElement("UL"),p_end=ParseOLUL(text_buffer,i,0,!1,ul_node);parent.appendChild(ul_node),i=p_end}else{let p_node=document.createElement("P"),p_end=ParseP(text_buffer,i,p_node);parent.appendChild(p_node),i=p_end}break;case" ":{let k=i+1,s=text_buffer.charAt(k);for(;" "===s;)++k,s=text_buffer.charAt(k);if(("-"===s||"+"===s||"*"===s)&&k-i>2){alert("ERROR: child list is written but parent list is not found."),i=k;break}let p_node=document.createElement("P"),p_end=ParseP(text_buffer,i,p_node);parent.appendChild(p_node),i=p_end}break;case"[":{let is_reference=!1,k=i+1;if("^"===text_buffer.charAt(k)){const k_end=text_buffer.indexOf("]:",k+1);if(k_end>0){const npos=text_buffer.indexOf("\n",k+1);if(npos>0&&k_end<npos||npos<0){is_reference=!0;const math=document.createElement("SPAN");math.className="math";const preview=document.createElement("SPAN");preview.className="previewref",preview.appendChild(document.createTextNode(text_buffer.slice(k+1,k_end))),math.appendChild(preview);const edit=document.createElement("SPAN");edit.className="editref",edit.appendChild(document.createTextNode(text_buffer.slice(i,k_end+2))),math.appendChild(edit);let begin_pos=k_end+2,s=text_buffer.charAt(begin_pos);for(;" "===s;)++begin_pos,s=text_buffer.charAt(begin_pos);const p_node=document.createElement("P");p_node.appendChild(math);const p_end=ParseLI(text_buffer,begin_pos,p_node);CheckEmptyAndPutBR(p_node),parent.appendChild(p_node),i=p_end}}}if(!is_reference){const p_node=document.createElement("P"),p_end=ParseP(text_buffer,i,p_node);parent.appendChild(p_node),i=p_end}}break;default:{if("0"<=ch&&ch<="9"){let k=i+1,s=text_buffer.charAt(k);for(;"0"<=s&&s<="9";)++k,s=text_buffer.charAt(k);if("."===s&&(++k,s=text_buffer.charAt(k)," "===s)){let ol_node=document.createElement("OL"),p_end=ParseOLUL(text_buffer,i,0,!0,ol_node);parent.appendChild(ol_node),i=p_end;break}}let p_node=document.createElement("P"),p_end=ParseP(text_buffer,i,p_node);parent.appendChild(p_node),i=p_end;break}}}if(!parent.hasChildNodes()){const p=document.createElement("P");p.appendChild(document.createElement("BR")),parent.appendChild(p)}return ConnectAdjacentText(parent),PrepareBR(parent),PrepareTable(parent),LinebreakToSpaceInP(parent),PrepareFigure(parent),PrepareZWBR2(parent),AssertAllforMath(parent),parent}function ParseP(text_buffer,i_begin,parent){const buffer_length=text_buffer.length;let offset=i_begin,i=i_begin;for(;i<buffer_length;){switch(text_buffer.charAt(i)){case"\n":{const s=text_buffer.charAt(i+1);if("\n"===s||""===s)return i-offset>0&&parent.appendChild(document.createTextNode(text_buffer.substring(offset,i))),CheckEmptyAndPutBR(parent),i+1;i++}break;case"$":{i-offset>0&&parent.appendChild(document.createTextNode(text_buffer.substring(offset,i)));let p_end=ParseMath(text_buffer,i,parent);offset=p_end,i=p_end}break;case"`":{i-offset>0&&parent.appendChild(document.createTextNode(text_buffer.substring(offset,i)));let p_end=ParseCode(text_buffer,i,parent);offset=p_end,i=p_end}break;case"*":{i-offset>0&&parent.appendChild(document.createTextNode(text_buffer.substring(offset,i)));const p_end=ParseEm(text_buffer,i,parent);offset=p_end,i=p_end}break;case"_":{if(!UnderscoreWithSpace(text_buffer,i)){++i;break}i-offset>0&&parent.appendChild(document.createTextNode(text_buffer.substring(offset,i)));const p_end=ParseEm(text_buffer,i,parent);offset=p_end,i=p_end}break;case"!":{i-offset>0&&parent.appendChild(document.createTextNode(text_buffer.substring(offset,i)));let p_end=ParseImg(text_buffer,i,parent);offset=p_end,i=p_end}break;case"[":{let p_end;i-offset>0&&parent.appendChild(document.createTextNode(text_buffer.substring(offset,i))),p_end="^"===text_buffer.charAt(i+1)?ParseCite(text_buffer,i,parent):ParseA(text_buffer,i,parent),offset=p_end,i=p_end}break;case" ":{let k=i+1,s=text_buffer.charAt(k);for(;" "===s;)++k,s=text_buffer.charAt(k);if("\n"===s&&k-i>=2){offset<i&&parent.appendChild(document.createTextNode(text_buffer.substring(offset,i))),i=k,offset=i;break}i=k}break;default:++i}}return i-offset>0&&parent.appendChild(document.createTextNode(text_buffer.substring(offset,i))),CheckEmptyAndPutBR(parent),buffer_length}function ParseH1(text_buffer,i_begin,parent){const buffer_length=text_buffer.length;let offset=i_begin,i=i_begin;for(;i<buffer_length;){switch(text_buffer.charAt(i)){case"\n":return i-offset>0&&parent.appendChild(document.createTextNode(text_buffer.substring(offset,i))),CheckEmptyAndPutBR(parent),i+1;case"$":{i-offset>0&&parent.appendChild(document.createTextNode(text_buffer.substring(offset,i)));let p_end=ParseMath(text_buffer,i,parent,!1);offset=p_end,i=p_end}break;case"`":{i-offset>0&&parent.appendChild(document.createTextNode(text_buffer.substring(offset,i)));let p_end=ParseCode(text_buffer,i,parent,!1);offset=p_end,i=p_end}break;case"*":{i-offset>0&&parent.appendChild(document.createTextNode(text_buffer.substring(offset,i)));const p_end=ParseEm(text_buffer,i,parent);offset=p_end,i=p_end}break;case"_":{if(!UnderscoreWithSpace(text_buffer,i)){++i;break}i-offset>0&&parent.appendChild(document.createTextNode(text_buffer.substring(offset,i)));const p_end=ParseEm(text_buffer,i,parent);offset=p_end,i=p_end}break;case"!":{i-offset>0&&parent.appendChild(document.createTextNode(text_buffer.substring(offset,i)));let p_end=ParseImg(text_buffer,i,parent);offset=p_end,i=p_end}break;case"[":{let p_end;i-offset>0&&parent.appendChild(document.createTextNode(text_buffer.substring(offset,i))),p_end="^"===text_buffer.charAt(i+1)?ParseCite(text_buffer,i,parent):ParseA(text_buffer,i,parent),offset=p_end,i=p_end}break;default:++i}}return i-offset>0&&parent.appendChild(document.createTextNode(text_buffer.substring(offset,i))),CheckEmptyAndPutBR(parent),buffer_length}function ParseOLUL(text_buffer,i_begin,num_head_spaces,is_numbered,parent){let li_node=null,i=i_begin;const buffer_length=text_buffer.length;let offset=i;for(;i<buffer_length;){const ch=text_buffer.charAt(i),space=i-offset;switch(ch){case"\n":if(i>offset)return offset;++i,offset=i;continue;case" ":++i;continue;case"-":case"+":case"*":if(space<num_head_spaces)return offset;if(" "==text_buffer.charAt(i+1)){if(space>=num_head_spaces+2){let ul_node=document.createElement("UL"),p_end=ParseOLUL(text_buffer,offset,space,!1,ul_node);li_node.appendChild(ul_node),i=p_end,offset=i;continue}if(is_numbered)return offset;{li_node=document.createElement("LI");let p_end=ParseLI(text_buffer,i+2,li_node);parent.appendChild(li_node),i=p_end,offset=i;continue}}break;default:if("0"<=ch&&ch<="9"){if(space<num_head_spaces)return offset;let k=i+1,s=text_buffer.charAt(k);for(;"0"<=s&&s<="9";)++k,s=text_buffer.charAt(k);if("."==s&&(++k,s=text_buffer.charAt(k)," "==s)){if(space>=num_head_spaces+2){let ol_node=document.createElement("OL"),p_end=ParseOLUL(text_buffer,offset,space,!0,ol_node);li_node.appendChild(ol_node),i=p_end,offset=i;continue}if(is_numbered){li_node=document.createElement("LI");let p_end=ParseLI(text_buffer,k+1,li_node);parent.appendChild(li_node),i=p_end,offset=i;continue}return offset}}}if(!(space>=2))return offset;i=ParseLI(text_buffer,i,li_node),offset=i}return buffer_length}function ParseLI(text_buffer,i_begin,parent){const buffer_length=text_buffer.length;let offset=i_begin,i=i_begin;for(;i<buffer_length;){switch(text_buffer.charAt(i)){case"\n":if(i-offset>0){let text=text_buffer.substring(offset,i);parent.appendChild(document.createTextNode(text))}return i+1;case"$":{i-offset>0&&parent.appendChild(document.createTextNode(text_buffer.substring(offset,i)));const p_end=ParseMath(text_buffer,i,parent,!0);offset=p_end,i=p_end}break;case"`":{i-offset>0&&parent.appendChild(document.createTextNode(text_buffer.substring(offset,i)));const p_end=ParseCode(text_buffer,i,parent,!0);offset=p_end,i=p_end}break;case"*":{i-offset>0&&parent.appendChild(document.createTextNode(text_buffer.substring(offset,i)));const p_end=ParseEm(text_buffer,i,parent);offset=p_end,i=p_end}break;case"_":{if(!UnderscoreWithSpace(text_buffer,i)){++i;break}i-offset>0&&parent.appendChild(document.createTextNode(text_buffer.substring(offset,i)));const p_end=ParseEm(text_buffer,i,parent);offset=p_end,i=p_end}break;case"!":{i-offset>0&&parent.appendChild(document.createTextNode(text_buffer.substring(offset,i)));let p_end=ParseImg(text_buffer,i,parent);offset=p_end,i=p_end}break;case"[":{let p_end;i-offset>0&&parent.appendChild(document.createTextNode(text_buffer.substring(offset,i))),p_end="^"===text_buffer.charAt(i+1)?ParseCite(text_buffer,i,parent):ParseA(text_buffer,i,parent),offset=p_end,i=p_end}break;default:++i}}return i-offset>0&&parent.appendChild(document.createTextNode(text_buffer.substring(offset,i))),CheckEmptyAndPutBR(parent),buffer_length}function ParseMath(text_buffer,i_begin,parent,allow_display=!0){let i=i_begin;if("$"===text_buffer.charAt(i+1)){if(!allow_display)return alert("ERROR: display math '$$' is not allowed here."),ErrorTag(text_buffer,i,parent);let p=text_buffer.indexOf("$$",i+2);if(p<0)return alert("ERROR: end of display math '$$' is not found."),ErrorTag(text_buffer,i,parent);{const prev_n=text_buffer.lastIndexOf("\n",i),rep_str="\n"+" ".repeat(prev_n<0?i:i-prev_n-1);let math_text=text_buffer.substring(i,p+2);math_text=ReplaceAll(math_text,rep_str,"\n");let span=document.createElement("SPAN");span.className="editmathdisp",span.appendChild(document.createTextNode(math_text));let math=document.createElement("SPAN");return math.className="math",math.appendChild(document.createElement("SPAN")),math.appendChild(span),parent.appendChild(math),p+2}}{let p=text_buffer.indexOf("$",i+2);if(p<0)return alert("ERROR: end of inline math '$' is not found."),ErrorTag(text_buffer,i,parent);{let span=document.createElement("SPAN");span.className="editmath",span.appendChild(document.createTextNode(text_buffer.substring(i,p+1)));let math=document.createElement("SPAN");return math.className="math",math.appendChild(document.createElement("SPAN")),math.appendChild(span),parent.appendChild(math),p+1}}}function ParseCode(text_buffer,i_begin,parent,allow_display=!0){let i=i_begin;const s=text_buffer.charAt(i+1),s2=text_buffer.charAt(i+2);if("`"===s&&"`"===s2){if(!allow_display)return alert("ERROR: display code '```' is not allowed here."),ErrorTag(text_buffer,i,parent);let p=text_buffer.indexOf("```",i+3);if(p<0)return alert("ERROR: end of display code '```' is not found."),ErrorTag(text_buffer,i,parent);{const prev_n=text_buffer.lastIndexOf("\n",i),rep_str="\n"+" ".repeat(prev_n<0?i:i-prev_n-1);let math_text=text_buffer.substring(i,p+3);math_text=ReplaceAll(math_text,rep_str,"\n");const pre=document.createElement("SPAN");pre.className="previewcodedisp",pre.textContent="previewcodedisp";const span=document.createElement("SPAN");span.className="editcodedisp",span.appendChild(document.createTextNode(math_text));const math=document.createElement("SPAN");return math.className="math",math.appendChild(pre),math.appendChild(span),parent.appendChild(math),p+3}}{const p=text_buffer.indexOf("`",i+2);if(p<0)return alert("ERROR: end of inline code '`' is not found."),ErrorTag(text_buffer,i,parent);{const pre=document.createElement("SPAN");pre.className="previewcode",pre.textContent="previewcode";const span=document.createElement("SPAN");span.className="editcode",span.appendChild(document.createTextNode(text_buffer.substring(i,p+1)));const math=document.createElement("SPAN");return math.className="math",math.appendChild(pre),math.appendChild(span),parent.appendChild(math),p+1}}}function UnderscoreWithSpace(text_buffer,i_begin){const i=i_begin,ch=text_buffer.charAt(i);if(i>0&&" "!=text_buffer.charAt(i-1))return!1;let k=i+1;for(;text_buffer.charAt(k)===ch;)k++;const mark=ch.repeat(k-i),p=text_buffer.indexOf(mark,k);if(p>0&&p+(k-i)<text_buffer.length&&" "!=text_buffer.charAt(p+(k-i)))return!1;const s=text_buffer.indexOf(" ",k);return!(s>0&&s<p)}function ParseEm(text_buffer,i_begin,parent){const i=i_begin,ch=text_buffer.charAt(i);let k=i+1;for(;text_buffer.charAt(k)==ch;)k++;if(k-i<=3){const mark=ch.repeat(k-i),p=text_buffer.indexOf(mark,k+1);if(p<0)return alert("ERROR: end of enphasis "+mark+" is not found."),ErrorTag(text_buffer,i,parent);{const math=document.createElement("SPAN");if(math.className="math",k-i==1){const span=document.createElement("EM");span.appendChild(document.createTextNode(text_buffer.substring(k,p))),math.appendChild(span)}else if(k-i==2){const span=document.createElement("STRONG");span.appendChild(document.createTextNode(text_buffer.substring(k,p))),math.appendChild(span)}else{const span=document.createElement("STRONG");span.appendChild(document.createTextNode(text_buffer.substring(k,p)));const span1=document.createElement("EM");span1.appendChild(span),math.appendChild(span1)}const edit=document.createElement("SPAN");return edit.className="editem"+(k-i).toString(),edit.appendChild(document.createTextNode(text_buffer.substring(i,p+(k-i)))),math.appendChild(edit),parent.appendChild(math),p+(k-i)}}{const mark=ch.repeat(k-i);return alert("ERROR: emphasis mark "+mark+" is repeating greater than 3 characters."),ErrorTag(text_buffer,i,parent)}}function ParseImg(text_buffer,i_begin,parent){let k=i_begin+1;if("["!==text_buffer.charAt(k))return alert("ERROR: img '![]()' has no '[' symbol."),ErrorTag(text_buffer,k,parent);let k_end=text_buffer.indexOf("]",k+1);if(k_end<0)return alert("ERROR: img '![]()' has no '' symbol."),ErrorTag(text_buffer,k,parent);let s=k_end+1;for(;" "===text_buffer.charAt(s);)s++;if("("!==text_buffer.charAt(s))return alert("ERROR: link '[]()' has no '(' symbol."),ErrorTag(text_buffer,k,parent);let s_end=text_buffer.indexOf(")",s+1);if(s_end<0)return alert("ERROR: link '[]()' has no ')' symbol."),ErrorTag(text_buffer,k,parent);const math=document.createElement("SPAN");math.className="math";const img=document.createElement("IMG");img.alt=text_buffer.substring(k+1,k_end),img.src=text_buffer.substring(s+1,s_end),math.appendChild(img);const edit=document.createElement("SPAN");return edit.className="editimg",edit.appendChild(document.createTextNode(text_buffer.substring(i_begin,s_end+1)+" ")),math.appendChild(edit),parent.appendChild(math),s_end+1}function ParseA(text_buffer,i_begin,parent){let k=i_begin,k_end=text_buffer.indexOf("]",k+1);if(k_end<0)return alert("ERROR: link '[]()' has no ']' symbol."),ErrorTag(text_buffer,k,parent);let s=k_end+1;for(;" "===text_buffer.charAt(s);)s++;if("("!==text_buffer.charAt(s))return parent.appendChild(document.createTextNode(text_buffer.substring(i_begin,s))),s;let s_end=text_buffer.indexOf(")",s+1);if(s_end<0)return alert("ERROR: link '[]()' has no ')' symbol."),ErrorTag(text_buffer,k,parent);const math=document.createElement("SPAN");math.className="math";const a=document.createElement("A");a.href=text_buffer.substring(s+1,s_end),a.target="_blank",a.ref="noopener noreferrer",a.appendChild(document.createTextNode(text_buffer.substring(k+1,k_end))),math.appendChild(a);const edit=document.createElement("SPAN");return edit.className="edita",edit.appendChild(document.createTextNode(text_buffer.substring(i_begin,s_end+1))),math.appendChild(edit),parent.appendChild(math),s_end+1}function ParseCite(text_buffer,i_begin,parent){let k=i_begin,k_end=text_buffer.indexOf("]",k+1);if(k_end<0)return alert("ERROR: cite '[^  ]' has no ']' symbol."),ErrorTag(text_buffer,k,parent);const math=document.createElement("SPAN");math.className="math";const a=document.createElement("A"),text=text_buffer.substring(i_begin+2,k_end);a.href="#"+text,a.className="previewcite",a.appendChild(document.createTextNode(text)),math.appendChild(a);const edit=document.createElement("SPAN");return edit.className="editcite",edit.appendChild(document.createTextNode("[^"+text+"] ")),math.appendChild(edit),parent.appendChild(math),k_end+1}function GetEndSemantics(text_buffer,i_begin){const p_end=text_buffer.indexOf("\n",i_begin);return p_end<0?text_buffer.length:p_end}function ErrorTag(text_buffer,i_begin,parent){const i_end=GetEndSemantics(text_buffer,i_begin+1);let span=document.createElement("EM");return span.className="readerror",span.appendChild(document.createTextNode(text_buffer.substring(i_begin,i_end))),parent.appendChild(span),i_end}function CheckEmptyAndPutBR(parent){0===parent.childNodes.length?parent.appendChild(document.createElement("BR")):1===parent.childNodes.length&&parent.firstChild.nodeType===Node.TEXT_NODE&&0===parent.firstChild.data.trim().length&&(parent.removeChild(parent.firstChild),parent.appendChild(document.createElement("BR")))}function ConnectAdjacentText(parent){let next=null;for(let node=parent.firstChild;node;node=next)next=node.nextSibling,node.nodeType===Node.TEXT_NODE?next&&next.nodeType===Node.TEXT_NODE&&(node.appendData(next.data),parent.removeChild(next),next=node):node.hasChildNodes()&&ConnectAdjacentText(node)}function PrepareBR(parent){let next=null;for(let node=parent.firstChild;node;node=next)next=node.nextSibling,node.hasChildNodes()?PrepareBR(node):["P","LI","H1","H2","H3","H4","H5","H6","FIGCAPTION","TD","TH"].includes(node.nodeName)&&node.appendChild(document.createElement("BR")),["LI","FIGURE"].includes(node.nodeName)&&["OL","UL","FIGCAPTION"].includes(node.firstChild.nodeName)&&node.insertBefore(document.createElement("BR"),node.firstChild)}function PrepareFigure(parent){let next=null;for(let node=parent.firstChild;node;node=next)if(next=node.nextSibling,"P"===node.nodeName&&"SPAN"===node.firstChild.nodeName&&"math"===node.firstChild.className&&"editimg"===node.firstChild.lastChild.className){let first_text=null;for(first_text=node.firstChild.nextSibling;first_text&&"SPAN"===first_text.nodeName&&"math"===first_text.className&&"editimg"===first_text.lastChild.className;first_text=first_text.nextSibling);const figure=document.createElement("FIGURE");for(;node.firstChild!==first_text;)figure.appendChild(node.removeChild(node.firstChild));const caption=document.createElement("FIGCAPTION");for(;node.firstChild;)caption.appendChild(node.removeChild(node.firstChild));null===caption.firstChild&&caption.appendChild(document.createElement("BR")),figure.appendChild(caption),parent.insertBefore(figure,node),parent.removeChild(node)}}function LinebreakToSpaceInP(parent){let next=null;for(let node=parent.firstChild;node;node=next)if(next=node.nextSibling,"P"===node.nodeName)for(let t_node=node.firstChild;t_node;t_node=t_node.nextSibling)if(t_node.nodeType===Node.TEXT_NODE){const text=t_node.data;text.indexOf("\n")>=0&&(t_node.data=ReplaceLinebreakToSpaceForJP(text))}}function PrepareTable(parent){let next=null;for(let node=parent.firstChild;node;node=next)if(next=node.nextSibling,"P"===node.nodeName){let flb_node=null,flb_offset=0;for(let t_node=node.firstChild;t_node;t_node=t_node.nextSibling)if(t_node.nodeType===Node.TEXT_NODE){const t_offset=t_node.data.indexOf("\n");if(t_offset>=0){flb_node=t_node,flb_offset=t_offset;break}}if(null===flb_node)continue;let has_split=!1;for(let t_node=node.firstChild;t_node!==flb_node;t_node=t_node.nextSibling)if(t_node.nodeType===Node.TEXT_NODE&&t_node.data.indexOf("|")>=0){has_split=!0;break}if(!has_split){const pos_split=flb_node.data.indexOf("|");if(pos_split<0)continue;if(pos_split>flb_offset)continue}const slb_offset=flb_node.data.indexOf("\n",flb_offset+1),second_line=flb_node.data.slice(flb_offset+1,slb_offset<0?flb_node.length:slb_offset);if(!IsSecondLineOfTableMD(second_line))continue;for(let i=0;i<second_line.length;++i)"-:| ".indexOf(second_line[i]);const table=document.createElement("TABLE");{const frag_tr=SplitLineToTD(node,"\n","TR"),tr1st=frag_tr.firstChild;{const frag_td=SplitLineToTD(tr1st,"|","TH");tr1st.appendChild(frag_td)}const num_column=tr1st.childNodes.length;for(let tr=tr1st.nextSibling;tr;tr=tr.nextSibling){const frag_td=SplitLineToTD(tr,"|","TD");for(;frag_td.childNodes.length>num_column;)frag_td.removeChild(frag_td.lastChild);for(;frag_td.childNodes.length<num_column;){const td=document.createElement("TD");td.appendChild(document.createElement("BR")),frag_td.appendChild(td)}tr.appendChild(frag_td)}table.appendChild(frag_tr)}parent.insertBefore(table,node),parent.removeChild(node)}}function IsSecondLineOfTableMD(second_line){for(let i=0;i<second_line.length;++i)if("-:| ".indexOf(second_line[i])<0)return!1;return!(second_line.indexOf("|")<0)&&!(second_line.indexOf("-")<0)}function SplitLineToNodes(parent,symbol,tag_name){const fragment=new DocumentFragment;let td=document.createElement(tag_name);fragment.appendChild(td);let next=null;for(let node=parent.firstChild;node;node=next)if(next=node.nextSibling,node.nodeType===Node.TEXT_NODE){let target=parent.removeChild(node),pos_split=target.data.indexOf(symbol);for(;pos_split>=0;){if(pos_split>0){const after_text=target.splitText(pos_split);td.appendChild(target),target=after_text}if(td.hasChildNodes()?td=document.createElement(tag_name):fragment.firstChild!==td&&(td.appendChild(document.createElement("BR")),td=document.createElement(tag_name)),fragment.appendChild(td),1===target.length){target.data="";break}target=target.splitText(1),pos_split=target.data.indexOf(symbol)}target.length>0&&td.appendChild(target)}else td.appendChild(parent.removeChild(node));return td.hasChildNodes()||td.remove(),fragment}function SplitLineToTD(parent,symbol,tag_name){for(let node=parent.firstChild;node;node=node.nextSibling)if(node.nodeType===Node.TEXT_NODE){const pos_split=node.data.indexOf(symbol);if(pos_split>=0){if(pos_split>0){const after=node.splitText(pos_split);node=after}node.length>1&&node.splitText(1)}}const fragment=new DocumentFragment;let td=document.createElement(tag_name);for(parent.firstChild.nodeType===Node.TEXT_NODE&&parent.firstChild.data==symbol&&parent.removeChild(parent.firstChild);parent.firstChild;)parent.firstChild.nodeType!==Node.TEXT_NODE||parent.firstChild.data!=symbol?td.appendChild(parent.removeChild(parent.firstChild)):(parent.removeChild(parent.firstChild),null===td.firstChild&&td.appendChild(document.createElement("BR")),fragment.appendChild(td),td=document.createElement(tag_name));return null!==td.firstChild&&fragment.appendChild(td),fragment}function PrepareZWBR2(parent){for(let node=parent.firstChild;node;node=node.nextSibling){switch(node.nodeName){case"P":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"LI":case"FIGCAPTION":case"TD":case"TH":PrepereZWBR_funcP2(node)}node.hasChildNodes()&&PrepareZWBR2(node)}}function PrepereZWBR_funcP2(p_node){if(null===p_node.firstChild)return void p_node.appendChild(document.createElement("BR"));let is_prev_math=!0;for(let node=p_node.firstChild;node;node=node.nextSibling)switch(node.nodeName){case"SPAN":is_prev_math&&p_node.insertBefore(document.createTextNode(nt_ZWBR),node),is_prev_math=!0;break;case"OL":case"UL":is_prev_math&&(node.previousSibling?p_node.insertBefore(document.createTextNode(nt_ZWBR),node):p_node.insertBefore(document.createElement("BR"),node)),is_prev_math=!1;break;case"BR":is_prev_math=!1;break;default:is_prev_math=!1}is_prev_math&&p_node.appendChild(document.createTextNode(nt_ZWBR))}const AssertAllforMath=parent=>{for(let node=parent.firstChild;node;node=node.nextSibling)["P","H1","H2","H3","H4","H5","H6","LI","FIGCAPTION","TD","TH"].includes(node.nodeName)&&AssertValidateMathInParent(node),node.hasChildNodes()&&AssertAllforMath(node)};let nt_selected_cell=null,nt_anchor_cell=null;const NT_SELECT_CELL_MODE=-256;function IsTableSelectionMode(){return!(null===nt_selected_cell)}function SwitchInputArrowLeftTable(node,offset){if(!nt_selected_cell.previousSibling)return!0;if(nt_selected_cell.previousSibling.classList.contains("selectcell"))ReleaseTableSelectVertical(nt_selected_cell);else{const index=GetIndex(nt_selected_cell.parentNode,nt_selected_cell);nt_selected_cell.parentNode.parentNode.childNodes.forEach(tr=>{const td=tr.childNodes.item(index);td.classList.contains("selectcell")&&td.previousSibling.classList.add("selectcell")})}nt_selected_cell.classList.remove("maincell"),nt_selected_cell=nt_selected_cell.previousSibling,nt_selected_cell.classList.add("maincell")}function SwitchInputArrowRightTable(node,offset){if(!nt_selected_cell.nextSibling)return!0;if(nt_selected_cell.nextSibling.classList.contains("selectcell"))ReleaseTableSelectVertical(nt_selected_cell);else{const index=GetIndex(nt_selected_cell.parentNode,nt_selected_cell);nt_selected_cell.parentNode.parentNode.childNodes.forEach(tr=>{const td=tr.childNodes.item(index);td.classList.contains("selectcell")&&td.nextSibling.classList.add("selectcell")})}nt_selected_cell.classList.remove("maincell"),nt_selected_cell=nt_selected_cell.nextSibling,nt_selected_cell.classList.add("maincell")}function SwitchInputArrowUpTable(node,offset){const tr=nt_selected_cell.parentNode;if(!tr)return!0;if(!tr.previousSibling)return!0;const index=GetIndex(tr,nt_selected_cell),next_cell=tr.previousSibling.childNodes.item(index);if(next_cell.classList.contains("selectcell"))ReleaseTableSelectHorizontal(nt_selected_cell);else{let tdp=tr.previousSibling.firstChild;for(let td=tr.firstChild;td;td=td.nextSibling)td.classList.contains("selectcell")&&tdp.classList.add("selectcell"),tdp=tdp.nextSibling}nt_selected_cell.classList.remove("maincell"),nt_selected_cell=next_cell,nt_selected_cell.classList.add("maincell")}function SwitchInputArrowDownTable(node,offset){const tr=nt_selected_cell.parentNode;if(!tr)return!0;if(!tr.nextSibling)return!0;const index=GetIndex(tr,nt_selected_cell),next_cell=tr.nextSibling.childNodes.item(index);if(next_cell.classList.contains("selectcell"))ReleaseTableSelectHorizontal(nt_selected_cell);else{let tdp=tr.nextSibling.firstChild;for(let td=tr.firstChild;td;td=td.nextSibling)td.classList.contains("selectcell")&&tdp.classList.add("selectcell"),tdp=tdp.nextSibling}nt_selected_cell.classList.remove("maincell"),nt_selected_cell=next_cell,nt_selected_cell.classList.add("maincell")}function ReleaseTableSelectAll(){if(!nt_selected_cell)return;const parent=nt_selected_cell.parentNode;if(nt_selected_cell.classList.remove("maincell"),nt_selected_cell=null,!parent)return;const table=parent.parentNode;table&&table.childNodes.forEach(tr=>{tr.childNodes.forEach(td=>{td.classList.remove("selectcell")})})}function ReleaseTableSelectVertical(cell){if(!cell)return;if(!cell.parentNode)return;const table=cell.parentNode.parentNode;if(!table)return;const index=GetIndex(cell.parentNode,cell);table.childNodes.forEach(tr=>{tr.childNodes.item(index).classList.remove("selectcell")})}function ReleaseTableSelectHorizontal(cell){if(!cell)return;if(!cell.parentNode)return;if(!cell.parentNode.parentNode)return;cell.parentNode.childNodes.forEach(td=>{td.classList.remove("selectcell")})}function CheckNodeInTD(ref_node,master_node){let node=ref_node;for(;node;){if(node===master_node)return null;if("TD"===node.nodeName||"TH"===node.nodeName)return node;node=node.parentNode}return null}function OnMouseDownTable(event){return event.shiftKey?CommonMouseDownAndMoveTable(event):(nt_selected_cell&&ReleaseTableSelectAll(),!0)}function OnMouseMoveTable(event){return 0==(1&event.buttons)||CommonMouseDownAndMoveTable(event)}function CommonMouseDownAndMoveTable(event){const node=document.elementFromPoint(event.clientX,event.clientY);if(!node)return!0;const selection=document.getSelection();if(nt_selected_cell){const td=CheckNodeInTD(node,nt_render_div);if(td&&IsSameTable(td,nt_selected_cell)){const anchor_td=nt_anchor_cell;if(ReleaseTableSelectAll(),SetSelectTable(anchor_td,td))return event.preventDefault(),!1}if(selection.rangeCount>0){const focus=FocusOffsetZero(nt_selected_cell);selection.collapse(focus.node,focus.offset)}return event.preventDefault(),!1}{const td=CheckNodeInTD(node,nt_render_div),anchor=CheckNodeInTD(selection.anchorNode,nt_render_div);if(anchor){if(td){if(anchor===td)return!0;if(IsSameTable(anchor,td)&&SetSelectTable(anchor,td))return event.preventDefault(),!1;const table_focus=td.parentNode.parentNode,table_anchor=anchor.parentNode.parentNode,master=table_focus.parentNode,index_focus=GetIndex(master,table_focus),index_anchor=GetIndex(master,table_anchor);return index_anchor<index_focus?selection.setBaseAndExtent(master,index_anchor,master,index_focus+1):selection.setBaseAndExtent(master,index_focus,master,index_anchor+1),event.preventDefault(),!1}{const table=anchor.parentNode.parentNode,master=table.parentNode,top_focus=FindTopNode(node,master);if(!top_focus)return event.preventDefault(),!1;const index_table=GetIndex(master,table);return index_table<GetIndex(master,top_focus)?selection.setBaseAndExtent(master,index_table,node,0):selection.setBaseAndExtent(master,index_table+1,node,0),!0}}}return!0}function SetSelectTable(anchor_td,focus_td){if(nt_selected_cell&&nt_selected_cell.classList.remove("maincell"),anchor_td&&focus_td){nt_selected_cell=focus_td,nt_anchor_cell=anchor_td;return SelectCells(RangeSelectedIndexes()),nt_selected_cell.classList.add("maincell"),document.getSelection().rangeCount>0&&document.getSelection().collapseToStart(),!0}return!1}function IsSameTable(anchor_td,focus_td){const anchor_tr=anchor_td.parentNode;return focus_td.parentNode.parentNode===anchor_tr.parentNode}function SelectCells(range){document.getSelection();let tr=nt_selected_cell.parentNode.parentNode.childNodes.item(range.tr.begin);for(let k=range.tr.begin;k<range.tr.end;++k){let td=tr.childNodes.item(range.td.begin);for(let i=range.td.begin;i<range.td.end;++i)td.classList.add("selectcell"),td=td.nextSibling;tr=tr.nextSibling}return!0}function FindTopNode(node,master){for(;node;){if(node.parentNode===master)return node;node=node.parentNode}return node}function CorrectSelectionEdgeTable(){const selection=document.getSelection();if(selection.isCollapsed)return!0;const range=selection.getRangeAt(0),start_node=range.startContainer;range.endContainer;let anchor_node=selection.anchorNode,anchor_offset=selection.anchorOffset,focus_node=selection.focusNode,focus_offset=selection.focusOffset;const anchor_td=CheckNodeInTD(anchor_node,nt_render_div),focus_td=CheckNodeInTD(focus_node,nt_render_div);if(focus_td&&focus_td===anchor_td)return!0;const anchor_table=anchor_td?anchor_td.parentNode.parentNode:"TABLE"==anchor_node.nodeName?anchor_node:"TR"==anchor_node.nodeName?anchor_node.parentNode:null;if(anchor_table){const index=GetIndex(anchor_table.parentNode,anchor_table);anchor_offset=anchor_node===start_node?index:index+1,anchor_node=anchor_table.parentNode}const focus_table=focus_td?focus_td.parentNode.parentNode:"TABLE"==focus_node.nodeName?focus_node:"TR"==focus_node.nodeName?focus_node.parentNode:null;if(focus_table){const index=GetIndex(focus_table.parentNode,focus_table);focus_offset=focus_node===start_node?index:index+1,focus_node=focus_table.parentNode}return!anchor_table&&!focus_table||(selection.setBaseAndExtent(anchor_node,anchor_offset,focus_node,focus_offset),!1)}function OnKeydownForNavigationTable(event){const selection=document.getSelection(),[node,offset]=[nt_selected_cell,0];switch(event.key){case"ArrowUp":if(event.preventDefault(),event.getModifierState("Shift"))SwitchInputArrowUpTable(node,offset);else{const focus_node=nt_selected_cell.firstChild;ReleaseTableSelectAll(),focus_node.nodeType==Node.TEXT_NODE?selection.collapse(focus_node,0):selection.collapse(focus_node.parentNode,0)}break;case"ArrowDown":if(event.preventDefault(),event.getModifierState("Shift"))SwitchInputArrowDownTable(node,offset);else{const focus_node=nt_selected_cell.lastChild;ReleaseTableSelectAll(),focus_node.nodeType==Node.TEXT_NODE?selection.collapse(focus_node,focus_node.length):selection.collapse(focus_node.parentNode,focus_node.parentNode.childNodes.length)}break;case"ArrowLeft":if(event.preventDefault(),event.getModifierState("Shift"))SwitchInputArrowLeftTable(node,offset);else{const focus_node=nt_selected_cell.firstChild;ReleaseTableSelectAll(),focus_node.nodeType==Node.TEXT_NODE?selection.collapse(focus_node,0):selection.collapse(focus_node.parentNode,0)}break;case"ArrowRight":if(event.preventDefault(),event.getModifierState("Shift"))SwitchInputArrowRightTable(node,offset);else{const focus_node=nt_selected_cell.lastChild;ReleaseTableSelectAll(),focus_node.nodeType==Node.TEXT_NODE?selection.collapse(focus_node,focus_node.length):selection.collapse(focus_node.parentNode,focus_node.parentNode.childNodes.length)}break;case"Enter":break;case"Delete":case"Backspace":{event.preventDefault(),IsHighlightMode()&&NT_HighlightClear();const range=RangeSelectedIndexes();undo_man.Begin(nt_selected_cell,NT_SELECT_CELL_MODE,nt_anchor_cell,NT_SELECT_CELL_MODE),DeleteSelectedCells(range),undo_man.End(nt_selected_cell,0),selection.collapse(nt_selected_cell,0),ReleaseTableSelectAll()}break;case"Tab":event.preventDefault()}}function RangeSelectedIndexes(){if(!nt_selected_cell)return null;const focus_tr=nt_selected_cell.parentNode,anchor_tr=nt_anchor_cell.parentNode,table=focus_tr.parentNode;if(!table)return null;let end_td_index=GetIndex(focus_tr,nt_selected_cell),begin_td_index=GetIndex(anchor_tr,nt_anchor_cell),end_tr_index=GetIndex(table,focus_tr),begin_tr_index=GetIndex(table,anchor_tr);if(begin_td_index>end_td_index){const temp=end_td_index;end_td_index=begin_td_index,begin_td_index=temp}if(begin_tr_index>end_tr_index){const temp=end_tr_index;end_tr_index=begin_tr_index,begin_tr_index=temp}return end_tr_index++,end_td_index++,{tr:{begin:begin_tr_index,end:end_tr_index},td:{begin:begin_td_index,end:end_td_index}}}function CopySelectedCells(range){let text="",tr=nt_selected_cell.parentNode.parentNode.childNodes.item(range.tr.begin);for(let k=range.tr.begin;k<range.tr.end;++k){if(1!=k){let td=tr.childNodes.item(range.td.begin);for(let i=range.td.begin;i<range.td.end;++i)i!=range.td.begin&&(text+="\t"),text+=MdFromChildNodes(td,0),td=td.nextSibling;text+="\n"}tr=tr.nextSibling}return text}function DeleteSelectedCells(range){let tr=nt_selected_cell.parentNode.parentNode.childNodes.item(range.tr.begin);for(let k=range.tr.begin;k<range.tr.end;++k){if(1!=k){let td=tr.childNodes.item(range.td.begin);for(let i=range.td.begin;i<range.td.end;++i)RemoveNodeList(td,td.firstChild,null),AddNode("BR",td),td=td.nextSibling}tr=tr.nextSibling}}function OnCutTable(event){if(event.preventDefault(),!nt_selected_cell)return;if(!event.clipboardData)return;const range=RangeSelectedIndexes(),cell_text=CopySelectedCells(range);event.clipboardData.setData("text/plain",cell_text),undo_man.Begin(nt_selected_cell,NT_SELECT_CELL_MODE,nt_anchor_cell,NT_SELECT_CELL_MODE),DeleteSelectedCells(range),document.getSelection().collapse(nt_selected_cell,0),undo_man.End(nt_selected_cell,0),ReleaseTableSelectAll()}function OnCopyTable(event){if(event.preventDefault(),!nt_selected_cell)return;if(!event.clipboardData)return;const cell_text=CopySelectedCells(RangeSelectedIndexes());event.clipboardData.setData("text/plain",cell_text)}function OnPasteTable(event){if(event.preventDefault(),!nt_selected_cell)return;if(!event.clipboardData)return;const text=ResolveNewlineCode(event.clipboardData.getData("text/plain"));if(!text)return;const fragment=MD2DOM(TableMDFromCSV(text));if(fragment&&"TABLE"==fragment.firstChild.nodeName){InitializeMathInFragment(fragment,0);const range=RangeSelectedIndexes();undo_man.Begin(nt_selected_cell,NT_SELECT_CELL_MODE,nt_anchor_cell,NT_SELECT_CELL_MODE),PasteTableToTable(fragment.firstChild,range),undo_man.End(nt_selected_cell,NT_SELECT_CELL_MODE,nt_anchor_cell,NT_SELECT_CELL_MODE)}}function CorrectForTableCell(td){let node=td.firstChild;for(;node;){let next=node.nextSibling;if("math"==node.className&&["editmathdisp","editcodedisp"].includes(node.lastChild.className)){RemoveNode(node);const focus=SafeJunctionPoint(next);focus&&(next=focus.node)}node=next}}function TableMDFromCSV(text){let offset=0,pos_n=text.indexOf("\n",offset),md_text="",num_row=0;for(;pos_n>=0;){const row_text=TableRowFromCSV(text,offset,pos_n);++num_row,2==num_row&&(IsSecondLineOfTableMD(row_text)||(md_text+="|---|\n",++num_row)),md_text+=row_text+"\n",offset=pos_n+1,pos_n=text.indexOf("\n",offset)}return offset<text.length&&(md_text+=TableRowFromCSV(text,offset,text.length)+"\n",++num_row),1==num_row&&(md_text+="|---|\n",++num_row),md_text}function TableRowFromCSV(text,begin_index,end_index){let offset=begin_index,pos_t=text.indexOf("\t",offset),md_text="|"!=text.charAt(offset)?"|":"";for(;pos_t>=0&&pos_t<end_index;)md_text+=text.slice(offset,pos_t)+"|",offset=pos_t+1,pos_t=text.indexOf("\t",offset);return offset<end_index&&(md_text+=text.slice(offset,end_index)),"|"!=text.charAt(end_index-1)&&(md_text+="|"),md_text}function PasteTableToTable(src_table,range){let tr=nt_selected_cell.parentNode.parentNode.childNodes.item(range.tr.begin),src_tr=src_table.firstChild;const range_width=range.td.end-range.td.begin,num_col=range_width<src_tr.childNodes.length?range_width:src_tr.childNodes.length;for(let k=range.tr.begin;k<range.tr.end;++k){if(1!=k)if(src_tr){let src_td=src_tr.firstChild,dest_td=tr.childNodes.item(range.td.begin);for(let i=0;i<num_col;++i){const frag_new_tds=new DocumentFragment;for(;src_td.firstChild;)frag_new_tds.appendChild(src_td.removeChild(src_td.firstChild));RemoveNodeList(dest_td,dest_td.firstChild,null),AddNodeList(dest_td,dest_td.firstChild,frag_new_tds),dest_td=dest_td.nextSibling,src_td=src_td.nextSibling}for(let i=num_col;i<range_width;++i)RemoveNodeList(dest_td,dest_td.firstChild,null),AddNode("BR",dest_td),dest_td=dest_td.nextSibling;src_tr===src_table.firstChild&&(src_tr=src_tr.nextSibling),src_tr=src_tr.nextSibling}else{let dest_td=tr.childNodes.item(range.td.begin);for(let i=0;i<range_width;++i)RemoveNodeList(dest_td,dest_td.firstChild,null),AddNode("BR",dest_td),dest_td=dest_td.nextSibling}tr=tr.nextSibling}}class StoredNode{constructor(node){this.real_instance=node,this.nodeName=node.nodeName,this.text_class=node.nodeType===Node.TEXT_NODE?node.data:node.className,this.children=[];for(let ch=node.firstChild;ch;ch=ch.nextSibling)this.children.push(new StoredNode(ch))}IsSame(node){return!0}}function ReplaceAll(text_org,before_word,after_word){let i=text_org.indexOf(before_word,0);if(i<0)return text_org;const before_len=before_word.length;let result=text_org.slice(0,i)+after_word,offset=i+before_len;for(i=text_org.indexOf(before_word,offset);i>=0;)result+=text_org.slice(offset,i)+after_word,offset=i+before_len,i=text_org.indexOf(before_word,offset);return result+=text_org.slice(offset),result}function ReplaceAllExcept(text_org,before_word,after_word,ignore_next){let i=text_org.indexOf(before_word,0);if(i<0)return text_org;const before_len=before_word.length;if(i+before_len>=text_org.length)return text_org;for(;text_org.startsWith(ignore_next,i+before_len);){if(i=text_org.indexOf(before_word,i+1),i<0)return text_org;if(i+before_len>=text_org.length)return text_org}let result=text_org.slice(0,i)+after_word,offset=i+before_len;for(i=text_org.indexOf(before_word,offset);i>=0&&i+before_len<text_org.length;)text_org.startsWith(ignore_next,i+before_len)?i=text_org.indexOf(before_word,i+1):(result+=text_org.slice(offset,i)+after_word,offset=i+before_len,i=text_org.indexOf(before_word,offset));return result+=text_org.slice(offset),result}function ReplaceByRangeAll(text_org,begin_word,end_word,after_word){let i=text_org.indexOf(begin_word,0);if(i<0)return text_org;const begin_len=begin_word.length;let k=text_org.indexOf(end_word,i+begin_len);if(k<0)return text_org;const end_len=end_word.length;let result=text_org.slice(0,i)+after_word,offset=k+end_len;for(i=text_org.indexOf(begin_word,offset);i>=0&&(k=text_org.indexOf(end_word,i+begin_len),!(k<0));)result+=text_org.slice(offset,i)+after_word,offset=k+end_len,i=text_org.indexOf(begin_word,offset);return result+=text_org.slice(offset),result}function IsAlphabet(str){return str.charCodeAt(0)<128}function ReplaceLinebreakToSpaceForJP(text_org){let offset=0,i=text_org.indexOf("\n",offset);if(i<0)return text_org;if(0===i&&(offset=1,i=text_org.indexOf("\n",offset),i<0))return text_org.slice(offset);let result="";for(;i>=0;)i===text_org.length-1?result+=text_org.slice(offset,i):IsAlphabet(text_org[i-1])||IsAlphabet(text_org[i+1])?result+=text_org.slice(offset,i)+" ":result+=text_org.slice(offset,i),offset=i+1,i=text_org.indexOf("\n",offset);return result+=text_org.slice(offset),result}function ResolveNewlineCode(text_org){let offset=0,i=text_org.indexOf("\r",offset);if(i<0)return text_org;let result="";for(;i>=0;)result+=text_org.slice(offset,i)+"\n",offset="\n"==text_org.charAt(i+1)?i+2:i+1,i=text_org.indexOf("\r",offset);return result+=text_org.slice(offset),result}