"use strict";let MO_IME_node_origin=null;let MO_IME_offset_origin=0;let MO_update_list=[];let MO_observer=null;let MO_in_composition=false;let MO_highlight=null;let MO_update_parents=null;function MO_InitComposition(master_node){console.log("MutationObserver Create");MO_observer=new MutationObserver(MO_OnCompositionChange);MO_observer.observe(master_node,{childList:true,characterData:true,characterDataOldValue:true,subtree:true})}function MO_OnCompositionChange(record_list){if(MO_in_composition||MO_update_list.length>0){record_list.forEach((record=>{if(record.type==="characterData"){let new_target_update=true;if(MO_update_list.length>0){const last=MO_update_list[MO_update_list.length-1];if(last.record.type==record.type&&last.record.target===record.target){new_target_update=false;const old_for_log=last.record.oldValue;const new_for_log=last.record.target;console.log("MutationObserver detect (not new):",last.record.type,"\n",old_for_log,"(",old_for_log.length,")","\nto\n",new_for_log)}}if(new_target_update){const offset=GetIndex(record.target.parentNode,record.target);MO_update_list.push({record:record,offset:offset});const old_for_log=record.oldValue;const new_for_log=record.target;console.log("MutationObserver detect:",record.type,"\n",old_for_log,"(",old_for_log.length,")","\nto\n",new_for_log);const parent=record.target.parentNode;MO_update_parents.add(parent.nodeName=="MARK"?parent.parentNode:parent)}}else if(record.type==="childList"){if(record.addedNodes.length>0){const offset=record.previousSibling===null?0:GetIndex(record.target,record.previousSibling)+1;MO_update_list.push({record:record,offset:offset});console.log("MutationObserver detect: add\n",record.addedNodes.item(0),"\non offset=",offset,"\n",record.target)}else{const offset=record.previousSibling===null?0:GetIndex(record.target,record.previousSibling)+1;MO_update_list.push({record:record,offset:offset});console.log("MutationObserver detect: remove\n",record.removedNodes.item(0),"\non offset=",offset,"\n",record.target)}MO_update_parents.add(record.nodeName=="MARK"?record.parentNode:record)}}))}if(!MO_in_composition&&MO_update_list.length>0){undo_man.GetChangeEventDispatcher().Disable();const num_undo_history=undo_man.numHistory;MO_RegisterIMEUpdate();if(IsHighlightMode()){NT_HighlightClear()}if(undo_man.numHistory!=num_undo_history){ExecUndo();undo_man.Shrink()}undo_man.GetChangeEventDispatcher().Enable()}}function MO_OnCompositionstart(event){MO_in_composition=true;console.log('compositionstart: "',event.data,'"');MO_update_list.length=0;MO_highlight=nt_highlight;MO_update_parents=new Set;const selection=document.getSelection();if(selection.rangeCount===0){event.currentTarget.blur();return false}const range=selection.getRangeAt(0);let focus_node=range.startContainer;let focus_offset=range.startOffset;let anchor_node=range.endContainer;let anchor_offset=range.endOffset;if(focus_node.nodeType!==Node.TEXT_NODE){console.log("focus(before refine): ",focus_node,focus_offset);[focus_node,focus_offset]=RefineFocusToText(focus_node,focus_offset)}if(anchor_node.nodeType!==Node.TEXT_NODE){[anchor_node,anchor_offset]=RefineFocusToText(anchor_node,anchor_offset)}MO_IME_node_origin=focus_node;MO_IME_offset_origin=focus_offset;console.log("focus: ",focus_node,focus_offset);if(focus_node!==anchor_node||focus_offset!==anchor_offset){console.log("anchor: ",anchor_node,anchor_offset)}if(!selection.isCollapsed){let will_canceled=anchor_node!==focus_node;if(anchor_node!==focus_node){const[fnode,foffset]=CorrectFocusToText(focus_node,focus_offset);selection.collapse(fnode,foffset);console.log("colapse before IME:",fnode,foffset);will_canceled=false}if(will_canceled){console.log("Cancel IME");event.preventDefault();event.currentTarget.blur();selection.removeAllRanges();
//!!!!This alert is very important to vanish IME subwindow on Chrome!!!!//
}}}function MO_OnCompositionupdate(event){const subtext=event.data;console.log("composition update: ",subtext.length)}function MO_OnCompositionend(event){const subtext=event.data;console.log("compositionend: ",subtext.length);MO_in_composition=false;MO_RegisterIMEUpdate()}function MO_OnCompositionendForChrome(event){const subtext=event.data;if(subtext.length==0){console.log("compositionend (finished by Delete/Backspace): ",subtext.length);MO_in_composition=false}else{console.log("compositionend (finished by Enter): ",subtext.length);MO_in_composition=false;MO_RegisterIMEUpdate()}}function MO_RegisterIMEUpdate(){if(MO_update_list.length===0)return;console.log("MO_RegisterIMEUpdate");let modified_text_list=[];let warning_math_list=[];const selection=document.getSelection();if(MO_highlight){const org_focus=MO_highlight.OriginalFocus(MO_IME_node_origin,MO_IME_offset_origin);undo_man.Begin(org_focus.node,org_focus.offset);MO_highlight.RegisterUndo(MO_update_parents,undo_man)}else{undo_man.Begin(MO_IME_node_origin,MO_IME_offset_origin)}MO_update_list.forEach((update_info=>{const record=update_info.record;if(record.type==="characterData"){console.log("IME: regarded, replace all text data in the node");const change=StrEnclosureComp(record.oldValue,record.target.data);if(change.width1>0){undo_man.Register(UR_TYPE.DELETE_IN_TEXT,record.oldValue.substring(change.begin,change.begin+change.width1),record.target,change.begin,change.width1)}if(change.width2>0){undo_man.Register(UR_TYPE.INSERT_TEXT_INTO_TEXT,record.target.data.substring(change.begin,change.begin+change.width2),record.target,change.begin,change.width2)}modified_text_list.push({text_node:record.target,offset:change.begin,length:change.width2})}else if(record.type==="childList"){if(record.addedNodes.length>0){const parent=record.target;let offset=update_info.offset;record.addedNodes.forEach((node=>{console.log("IME: added node",node,", offset=",offset);undo_man.Register(UR_TYPE.ADD_NODE,node,parent,offset,1);++offset;if(parent.className=="math"){warning_math_list.push(parent)}else if(parent.parentNode&&parent.parentNode.className=="math"){if(node.nodeType!=Node.TEXT_NODE){warning_math_list.push(parent.parentNode)}}}))}else if(record.removedNodes.length>0){const parent=record.target;const offset=update_info.offset;record.removedNodes.forEach((node=>{console.log("IME: removed node",node,", offset=",offset);undo_man.Register(UR_TYPE.REMOVE_NODE,node,parent,offset,1);if(parent.className=="math"){warning_math_list.push(parent)}}))}}}));if(selection.rangeCount===0){console.log("IME input is cancel: case 4 (by focus blur)");undo_man.End(null,0);return}modified_text_list.forEach((value=>{const text_node=value.text_node;if(IsTextNodeInMath(text_node)){let info;switch(text_node.parentNode.className){case"editmath":info={beginMark:"$",endMark:"$",reservedChars:["$"]};break;case"editmathdisp":info={beginMark:"$$",endMark:"$$",reservedChars:["$"]};break;case"editcode":info={beginMark:"`",endMark:"`",reservedChars:["`"]};break;case"editcodedisp":info={beginMark:"```",endMark:"```",reservedChars:["`"]};break;case"editem1":info={beginMark:"*",endMark:"*",reservedChars:["*","_"]};break;case"editem2":info={beginMark:"**",endMark:"**",reservedChars:["*","_"]};break;case"editem3":info={beginMark:"***",endMark:"***",reservedChars:["*","_"]};break;case"edita":info={beginMark:"[",endMark:")",reservedChars:["[",")"]};break;case"editimg":info={beginMark:"![",endMark:") ",reservedChars:["!","[",")"]};break;case"editcite":info={beginMark:"[^",endMark:"] ",reservedChars:["^","[","]"]};break;case"editref":info={beginMark:"[^",endMark:"]:",reservedChars:["^","[","]",":"]};break;default:console.error("ERROR: IME input into invalid edit class in math ");return}if(!text_node.data.startsWith(info.beginMark)||!text_node.data.endsWith(info.endMark)){info.reservedChars.forEach((c=>{let pos=text_node.data.indexOf(c);while(pos>=0){DeleteText(text_node,pos,1);pos=text_node.data.indexOf(c)}}));InsertTextIntoText(info.beginMark,text_node,0);InsertTextIntoText(info.endMark,text_node,text_node.length)}}else{{const target_text=text_node.data.substring(value.offset,value.offset+value.length);let fragment=MD2DOM_OneLine(target_text);let is_including_math=false;let last_math=null;fragment.childNodes.forEach((child=>{if(child.className=="math"){is_including_math=true;last_math=child}}));if(is_including_math){let node_next=null;if(value.offset+value.length<text_node.data.length){DivideTextNode(text_node,value.offset+value.length);node_next=text_node.nextSibling}let removable_node=text_node;if(value.offset>0){DivideTextNode(text_node,value.offset);removable_node=text_node.nextSibling}let parent=text_node.parentNode;RemoveNode(removable_node);let first=AddNodeList(parent,node_next,fragment);for(let node=first;node!==node_next;node=node.nextSibling){DisableEdit(node,true)}const focus_by_math=SafeJunctionPoint(parent,node_next);if(first.parentNode===parent){SafeJunctionPoint(parent,first)}document.getSelection().collapse(focus_by_math.node,focus_by_math.offset)}else{if(text_node.data==nt_ZWBR)return;const pos=text_node.data.indexOf(nt_ZWBR);if(pos>=0){DeleteText(text_node,pos,1)}}}}}));let focus={node:document.getSelection().focusNode,offset:document.getSelection().focusOffset};if(focus.node.nodeType!==Node.TEXT_NODE){[focus.node,focus.offset]=RefineFocusToText(focus.node,focus.offset)}if(MO_highlight){const org_end_focus=MO_highlight.ForceRepairWithRegister(MO_update_parents,focus.node,focus.offset);if(org_end_focus)focus=org_end_focus;undo_man.End(focus.node,focus.offset);MO_highlight.SearchIn(MO_update_parents);const hi_focus=MO_highlight.HighlightFocus(focus.node,focus.offset);document.getSelection().collapse(hi_focus.node,hi_focus.offset)}else{undo_man.End(focus.node,focus.offset)}MO_update_list.length=0;modified_text_list.length=0;MO_update_parents=null}function MO_OnKeydownForIME(event){if(MO_in_composition){switch(event.key){case"ArrowLeft":case"ArrowRight":case"ArrowUp":case"ArrowDown":case"PageUp":case"PageDown":case"Home":case"End":event.preventDefault();event.stopImmediatePropagation();break}}}function MO_OnContextmenuForIME(event){if(MO_in_composition){console.log("contextmenu: ");event.preventDefault();event.stopImmediatePropagation()}}function RefineFocusToText(focus_node,focus_offset){const ch=focus_node.childNodes.item(focus_offset);if(ch){if(ch.nodeType===Node.TEXT_NODE){focus_node=ch;focus_offset=0}}else{const back=focus_node.childNodes.item(focus_offset-1);if(back){if(back.nodeType===Node.TEXT_NODE){focus_node=back;focus_offset=focus_node.length}}}return[focus_node,focus_offset]}"use strict";function OnCut(event){if(!event.clipboardData){console.error("event.clipboardData is not defined");return}if(IsTableSelectionMode()){if(IsHighlightMode()){NT_HighlightClear()}OnCutTable(event);return}console.log("fook cut on "+event.currentTarget);event.preventDefault();const selection=document.getSelection();if(selection.isCollapsed)return;let highlight_word=null;if(IsHighlightMode()){highlight_word=nt_highlight.Word;NT_HighlightClear()}CorrectSelectionEdgeTable();const fragment=CutSelection(event.currentTarget,selection);if(fragment){let md_text=DOM2MD(fragment);event.clipboardData.setData("text/plain",md_text);console.log("copy to clipboard as markdown: "+md_text)}if(highlight_word){NT_HighlightWord(highlight_word)}}function OnCopy(event){if(!event.clipboardData){console.error("event.clipboardData is not defined");return}if(IsTableSelectionMode()){if(IsHighlightMode()){NT_HighlightClear()}OnCopyTable(event);return}console.log("fook copy on "+event.currentTarget);event.preventDefault();const selection=document.getSelection();if(selection.isCollapsed)return;let highlight_word=null;if(IsHighlightMode()){highlight_word=nt_highlight.Word;NT_HighlightClear()}undo_man.GetChangeEventDispatcher().Disable();CorrectSelectionEdgeTable();const fragment=CutSelection(event.currentTarget,selection);if(fragment){ExecUndo();undo_man.Shrink()}undo_man.GetChangeEventDispatcher().Enable();if(fragment){const md_text=DOM2MD(fragment);event.clipboardData.setData("text/plain",md_text);const temp=document.createElement("DIV");temp.appendChild(fragment)}if(highlight_word){NT_HighlightWord(highlight_word)}}function OnPaste(event){if(!event.clipboardData){console.error("event.clipboardData is not defined");return}let highlight_word=null;if(IsHighlightMode()){highlight_word=nt_highlight.Word;NT_HighlightClear()}if(IsTableSelectionMode()){OnPasteTable(event);return}console.log("fook paste on "+event.currentTarget);event.preventDefault();const text=event.clipboardData.getData("text/plain");console.log(text);const selection=document.getSelection();if(!selection.isCollapsed){CorrectSelectionEdgeTable();CutSelection(event.currentTarget,selection)}const[node,offset]=CorrectFocusToText(selection.focusNode,selection.focusOffset);if(IsTextNodeInMath(node)){if(0<offset&&offset<node.length){undo_man.Begin(node,offset);InsertTextIntoText(text,node,offset);undo_man.End(node,offset+text.length);selection.collapse(node,offset+text.length);if(highlight_word){NT_HighlightWord(highlight_word)}return}}const fragment=MD2DOM(ResolveNewlineCode(text));InitializeMathInFragment(fragment,g_auto_numbering?1:0);PasteTopLevelNodes(node,offset,fragment,event.currentTarget);if(highlight_word){NT_HighlightWord(highlight_word)}}function CutSelection(master_node,selection){if(selection.isCollapsed){return null}if(selection.rangeCount===0){return null}const range=selection.getRangeAt(0);let start_node=range.startContainer;let start_offset=range.startOffset;let end_node=range.endContainer;let end_offset=range.endOffset;{if(start_node.nodeType==Node.TEXT_NODE){if(start_node.parentNode.nodeName=="TD"||start_node.parentNode.nodeName=="TH"){if(start_node===start_node.parentNode.lastChild){if(start_offset==start_node.length){if(start_node.parentNode.nextSibling){start_node=start_node.parentNode.nextSibling;start_offset=0;if(start_node.firstChild.nodeType==Node.TEXT_NODE){start_node=start_node.firstChild}}}}}}else if(start_node.nodeName=="TD"||start_node.nodeName=="TH"){if(start_offset==start_node.childNodes.length){if(start_node.nextSibling){start_node=start_node.nextSibling;start_offset=0;if(start_node.firstChild.nodeType==Node.TEXT_NODE){start_node=start_node.firstChild}}}}let shift_end=false;if(end_node.nodeType==Node.TEXT_NODE){if(end_node.parentNode.nodeName=="TD"||end_node.parentNode.nodeName=="TH"){if(end_node===end_node.parentNode.firstChild){if(end_offset==0){if(end_node.parentNode.previousSibling){end_node=end_node.parentNode.previousSibling;if(end_node.lastChild.nodeType==Node.TEXT_NODE){end_node=end_node.lastChild;end_offset=end_node.length}else{end_offset=end_node.childNodes.length}}}}}}else if(end_node.nodeName=="TD"||end_node.nodeName=="TH"){if(end_offset==0){if(end_node.previousSibling){end_node=end_node.previousSibling;if(end_node.lastChild.nodeType==Node.TEXT_NODE){end_node=end_node.lastChild;end_offset=end_node.length}else{end_offset=end_node.childNodes.length}}}}}undo_man.Begin(selection.focusNode,selection.focusOffset,selection.anchorNode,selection.anchorOffset);{if(start_node&&start_node===end_node){if(start_node.nodeType===Node.TEXT_NODE){if(IsTextNodeInMath(start_node)){const margin=GetEditMarginByClassName(start_node.parentNode.className);if(start_offset<margin)start_offset=margin;if(end_offset>start_node.length-margin)end_offset=start_node.length-margin;if(start_offset==end_offset){undo_man.Cancel();return null}}if(start_offset===0&&end_offset===start_node.length){const parent=start_node.parentNode;const next=start_node.nextSibling;const frag=new DocumentFragment;frag.appendChild(RemoveNode(start_node));const focus=SafeJunctionPoint(parent,next);undo_man.End(focus.node,focus.offset);document.getSelection().collapse(focus.node,focus.offset);return frag.cloneNode(true)}else{console.log("start_node",start_node);const text=DeleteText(start_node,start_offset,end_offset-start_offset);document.getSelection().collapse(start_node,start_offset);undo_man.End(start_node,start_offset);const frag=new DocumentFragment;frag.appendChild(document.createTextNode(text));return frag.cloneNode(true)}}}}let init_parent2;let init_ref2;if(end_node.nodeType===Node.TEXT_NODE){init_parent2=end_node.parentNode;if(end_offset===0){init_ref2=end_node}else if(end_offset===end_node.length){init_ref2=end_node.nextSibling}else{DivideTextNode(end_node,end_offset);init_ref2=end_node.nextSibling}}else{init_parent2=end_node;init_ref2=end_node.childNodes.item(end_offset)}let init_parent1;let init_ref1;if(start_node.nodeType===Node.TEXT_NODE){init_parent1=start_node.parentNode;if(start_offset===0){init_ref1=start_node}else if(start_offset===start_node.length){init_ref1=start_node.nextSibling}else{DivideTextNode(start_node,start_offset);init_ref1=start_node.nextSibling}}else{init_parent1=start_node;init_ref1=start_node.childNodes.item(start_offset)}const cross1=MakeCrossSection(master_node,init_parent1);const cross2=MakeCrossSection(master_node,init_parent2);let index1=cross1.length-1;let index2=cross2.length-1;let common_parent=master_node;while(index1>=0&&index2>=0){let ref1=cross1[index1];let ref2=cross2[index2];if(ref1!==ref2){break}common_parent=ref1;index1--;index2--}if(common_parent.tagName==="OL"||common_parent.tagName==="UL"){common_parent=common_parent.parentNode}console.log("common_parent: "+common_parent);const ref_end=DivideAtCrossSection2(init_ref2,init_parent2,common_parent);const ref_begin=DivideAtCrossSection2(init_ref1,init_parent1,common_parent);if(ref_begin.nodeType===Node.TEXT_NODE){console.log("cut_node: "+ref_begin.data)}else{console.log("cut_node: "+ref_begin+" to "+ref_end)}let cut_fragment=RemoveNodeList(common_parent,ref_begin,ref_end);let focus;if(ref_end){focus=ConnectionNodeRecursive(ref_end)}else{focus=SafeTailPoint(common_parent)}let next_focus_node=focus.node;let next_focus_offset=focus.offset;if(next_focus_node===null){next_focus_node=common_parent;next_focus_offset=GetIndex(common_parent,ref_end)}RecoveryEmptyElement(common_parent);RecoveryPandFigure(common_parent);if(next_focus_node.nodeName==="DIV"||next_focus_node.nodeName==="OL"||next_focus_node.nodeName==="UL"){next_focus_node=next_focus_node.firstChild;next_focus_offset=0}[next_focus_node,next_focus_offset]=CorrectFocusToText(next_focus_node,next_focus_offset);console.log("new focus: "+next_focus_node+", "+next_focus_offset);undo_man.End(next_focus_node,next_focus_offset);selection.collapse(next_focus_node,next_focus_offset);const fragment_clone=cut_fragment.cloneNode(true);console.log("clone: "+fragment_clone);return fragment_clone}function MakeCrossSection(master_node,init_parent){let cross_section=[];let node=init_parent;while(node!==master_node){cross_section.push(node);node=node.parentNode}cross_section.push(node);return cross_section}function DivideAtCrossSection2(init_ref,init_parent,common_parent){let next_ref=init_ref;let parent=init_parent;while(parent){if(parent===common_parent)break;const ref=next_ref;if(ref===parent.firstChild){const new_node=AddNode(parent.tagName,parent.parentNode,parent);AddNode("BR",new_node,null);next_ref=parent}else if(ref===null){next_ref=parent.nextSibling}else{const simple_parents=["P","H1","H2","H3","H4","H5","H6","LI","FIGURE","FIGCAPTION","TD","TH"];if(simple_parents.includes(parent.tagName)){const fragment=SafeRemoveNodeList(parent,ref,null);const parent_next=AddNode(parent.tagName,parent.parentNode,parent.nextSibling);SafePushNodeList(parent_next,fragment);next_ref=parent_next}else{const fragment=RemoveNodeList(parent,ref,null);const parent_next=AddNode(parent.tagName,parent.parentNode,parent.nextSibling);AddNodeList(parent_next,null,fragment);next_ref=parent_next}}parent=parent.parentNode}return next_ref}function RecoveryEmptyElement(node){switch(node.tagName){case"P":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"TH":case"TD":case"FIGCAPTION":{if(node.firstChild===null){AddNode("BR",node,null)}}break;case"LI":{if(node.firstChild===null){AddNode("BR",node,null)}else{let ch=node.firstChild;if(ch.nodeName==="OL"||ch.nodeName==="UL"){AddNode("BR",node,ch)}for(let a=node.firstChild;a!==null;a=a.nextSibling){RecoveryEmptyElement(a)}}}break;case"OL":case"UL":{if(node.firstChild===null){AddNode("LI",node,null);AddNode("BR",node.firstChild,null)}else{for(let a=node.firstChild;a!==null;a=a.nextSibling){RecoveryEmptyElement(a)}}}break;case"DIV":{if(node.firstChild===null){AddNode("P",node,null);AddNode("BR",node.firstChild,null)}else{for(let a=node.firstChild;a!==null;a=a.nextSibling){RecoveryEmptyElement(a)}}}break;default:{for(let a=node.firstChild;a!==null;a=a.nextSibling){RecoveryEmptyElement(a)}}break}}function RecoveryPandFigure(node){switch(node.nodeName){case"P":{if(node.firstChild.nodeType===Node.TEXT_NODE){if(node.firstChild.data==nt_ZWBR){if(IsSpanMathImg(node.firstChild.nextSibling)){ConvertPtoFigure(node)}}}else if(IsSpanMathImg(node.firstChild)){ConvertPtoFigure(node)}}break;case"FIGURE":{let is_figure=false;if(node.firstChild.nodeType===Node.TEXT_NODE){if(node.firstChild.data==nt_ZWBR){if(IsSpanMathImg(node.firstChild.nextSibling)){is_figure=true}}}else if(IsSpanMathImg(node.firstChild)){is_figure=true}if(!is_figure){ConvertFiguretoP(node)}}break;case"DIV":{let next;for(let ch=node.firstChild;ch;ch=next){next=ch.nextSibling;if(ch.nodeName==="P"){RecoveryPandFigure(ch)}else if(ch.nodeName==="FIGURE"){RecoveryPandFigure(ch)}}}break}}function ConnectionNodeRecursive(ref_node){let focus={node:ref_node,offset:0};if(ref_node.previousSibling===null)return focus;if(ref_node.nodeType==Node.TEXT_NODE&&ref_node.previousSibling.nodeType==Node.TEXT_NODE){if(ref_node.data==nt_ZWBR){RemoveNode(ref_node);return{node:ref_node.previousSibling,offset:ref_node.previousSibling.length}}else if(ref_node.previousSibling.data==nt_ZWBR){RemoveNode(ref_node.previousSibling);return focus}focus={node:ref_node.previousSibling,offset:ref_node.previousSibling.length};InsertTextIntoText(ref_node.data,ref_node.previousSibling,ref_node.previousSibling.length);RemoveNode(ref_node);return focus}while(ref_node){if(ref_node.previousSibling===null)break;const prev=ref_node.previousSibling;let next_ref=null;if(ref_node.nodeName=="LI"){if(prev.nodeName!="LI"){break}if(prev.lastChild){if(prev.lastChild.nodeName=="OL"||prev.lastChild.nodeName=="UL"){let latter_first_OL_UL=null;if(ref_node.firstChild.nodeName=="BR"){if(ref_node.firstChild.nextSibling){if(ref_node.firstChild.nextSibling.nodeName=="OL"||ref_node.firstChild.nextSibling.nodeName=="UL"){latter_first_OL_UL=ref_node.firstChild.nextSibling}}}else if(ref_node.firstChild.nodeName=="OL"||ref_node.firstChild.nodeName=="UL"){latter_first_OL_UL=ref_node.firstChild}if(latter_first_OL_UL){if(latter_first_OL_UL.nodeName==prev.lastChild){focus={node:latter_first_OL_UL.firstChild,offset:0};const fragment=RemoveNodeList(latter_first_OL_UL,latter_first_OL_UL.firstChild,null);AddNodeList(prev.lastChild,null,fragment);RemoveNode(ref_node);break}}break}}const fragment=RemoveNodeList(ref_node,ref_node.firstChild,null);focus=SafePushNodeList(prev,fragment);RemoveNode(ref_node)}else if(ref_node.nodeName==="OL"||ref_node.nodeName==="UL"){if(prev.nodeName!=ref_node.nodeName){break}focus={node:ref_node.firstChild,offset:0};next_ref=ref_node.firstChild;const fragment=RemoveNodeList(ref_node,ref_node.firstChild,null);const fnode=AddNodeList(prev,null,fragment);RemoveNode(ref_node)}else if(ref_node.nodeName==="P"){if(prev.nodeName!=ref_node.nodeName){break}focus=SafeCombineNode(prev)}ref_node=next_ref}return focus}function PasteTopLevelNodes(node,offset,fragment,master_node){console.log("try paste: ",node,", ",offset);if(!fragment.hasChildNodes())return;undo_man.Begin(node,offset);let parent;let pos_after;if(node.nodeType===Node.TEXT_NODE){if(IsTextNodeInMath(node)){const math=node.parentNode.parentNode;if(offset===0){parent=math.parentNode;pos_after=math}else if(offset===node.length){parent=math.parentNode;pos_after=math.nextSibling}else{undo_man.Cancel();return}}else{if(offset==0){parent=node.parentNode;pos_after=node}else if(offset<node.length){parent=node.parentNode;pos_after=DivideTextNode(node,offset)}else{parent=node.parentNode;pos_after=node.nextSibling}}}else if(node.hasChildNodes()){if(node.nodeName=="OL"||node.nodeName=="UL"){parent=node.childNodes.item(offset);pos_after=parent.firstChild}else{parent=node;pos_after=node.childNodes.item(offset)}}else{parent=node.parentNode;pos_after=node}if(fragment.childNodes.length==1){const indepenent_tag=["P","H1","H2","H3","H4","H5","H6","LI","TH","TD","FIGCAPTION"];if(indepenent_tag.includes(fragment.firstChild.nodeName)){const frag=FragmentFromChildren(fragment.firstChild);const begin_pos=AddNodeList(parent,pos_after,frag);SafeJunctionPoint(parent,begin_pos);const focus=SafeJunctionPoint(parent,pos_after);document.getSelection().collapse(focus.node,focus.offset);RecoveryPandFigure(parent);undo_man.End(focus.node,focus.offset);console.log("paste succsess as simple text line");return}}if(parent.tagName==="LI"){let fragment_for_li=null;if(fragment.childNodes.length==1){if(fragment.firstChild.nodeName=="OL"||fragment.firstChild.nodeName=="UL"){fragment_for_li=FragmentFromChildren(fragment.firstChild)}}else{let can_be_regarded_as_LI=true;for(let node=fragment.firstChild;node;node=node.nextSibling){if(!["P","H1","H2","H3","H4","H5","H6","OL","UL"].includes(node.nodeName)){can_be_regarded_as_LI=false}}if(can_be_regarded_as_LI){fragment_for_li=new DocumentFragment;let prev_li=null;let next;for(let node=fragment.firstChild;node;node=next){next=node.nextSibling;if(node.nodeName=="OL"||node.nodeName=="UL"){if(prev_li===null){const li=document.createElement("LI");li.appendChild(document.createElement("BR"));li.appendChild(fragment.removeChild(node));fragment_for_li.appendChild(li)}else{prev_li.appendChild(fragment.removeChild(node))}prev_li=null}else{const li=document.createElement("LI");li.appendChild(FragmentFromChildren(node));fragment_for_li.appendChild(li);prev_li=li}}}}if(fragment_for_li){const fragment=SafeRemoveNodeList(parent,pos_after,null);const parent_next=AddNode(parent.tagName,parent.parentNode,parent.nextSibling);SafePushNodeList(parent_next,fragment);const paste_begin=AddNodeList(parent.parentNode,parent_next,fragment_for_li);ConnectionNodeRecursive(paste_begin);const focus=ConnectionNodeRecursive(parent_next);undo_man.End(focus.node,focus.offset);document.getSelection().collapse(focus.node,focus.offset);console.log("paste succsess as list");return}}if(["LI","P","H1","H2","H3","H4","H5","H6","FIGURE","FIGCAPTION"].includes(parent.nodeName)){const ref_node=DivideAtCrossSection2(pos_after,parent,master_node);const ref_first=AddNodeList(master_node,ref_node,fragment);ConnectionNodeRecursive(ref_first);const focus=ref_node?ConnectionNodeRecursive(ref_node):SafeJunctionPoint(parent,ref_node);RecoveryPandFigure(master_node);undo_man.End(focus.node,focus.offset);document.getSelection().collapse(focus.node,focus.offset);console.log("paste succsess as paragrafh ");return}undo_man.Cancel();console.log("paste is skiped")}function FragmentFromChildren(parent){const frag=new DocumentFragment;while(parent.firstChild){frag.appendChild(parent.removeChild(parent.firstChild))}return frag}"use strict";function PrintFocus(){var selection=document.getSelection();if(selection.focusNode.nodeType===Node.TEXT_NODE){console.log("selection: focusNode="+selection.focusNode);console.log("selection: focusText="+selection.focusNode.data);console.log("selection: focusOffset="+selection.focusOffset+" / "+selection.focusNode.length)}else{console.log("selection: focusNode="+selection.focusNode+" "+selection.focusNode.className);console.log("selection: focusOffset="+selection.focusOffset+" / "+selection.focusNode.childNodes.length)}if(!selection.isCollapsed){if(selection.anchorNode.nodeType===Node.TEXT_NODE){console.log("selection: anchorNode="+selection.anchorNode);console.log("selection: anchorText="+selection.anchorNode.data);console.log("selection: anchorOffset="+selection.anchorOffset+" / "+selection.anchorNode.length)}else{console.log("selection: anchorNode="+selection.anchorNode+" "+selection.anchorNode.className);console.log("selection: anchorOffset="+selection.anchorOffset+" / "+selection.anchorNode.childNodes.length)}}}"use strict";function NT_Dispatch(type){switch(type){case"undo":{let highlight_word=null;if(IsHighlightMode()){highlight_word=nt_highlight.Word;NT_HighlightClear()}ExecUndo();console.log("finish undo");if(highlight_word){NT_HighlightWord(highlight_word)}}break;case"redo":{let highlight_word=null;if(IsHighlightMode()){highlight_word=nt_highlight.Word;NT_HighlightClear()}ExecRedo();console.log("finish redo");if(highlight_word){NT_HighlightWord(highlight_word)}}break;case"selectall":{SelectAll(nt_render_div);console.log("finish select all")}break;case"findforward":{if(nt_finding_word.length>0){NT_FindAndSelect(nt_finding_word)}}break;case"findbackward":{if(nt_finding_word.length>0){NT_FindBackwardAndSelect(nt_finding_word)}}break}}"use strict";const nt_SPACE_FOR_LIST="  ";function DOM2MD(target_node){const list_rank=0;const md_text=MdFromChildNodes(target_node,list_rank);let offset=0;while(offset<md_text.length){if(md_text.charAt(offset)!="\n")break;offset++}return md_text.slice(offset)}function MdFromChildNodes(parent,list_rank){let text_buffer="";let node=parent.firstChild;while(node){text_buffer+=MdFromNode(node,list_rank);node=node.nextSibling}return text_buffer}function MdFromList(parent,list_rank,head){let text_buffer="";let li=parent.firstChild;while(li){const text=MdFromChildNodes(li,list_rank+1);text_buffer+=head+ReplaceAllExcept(text,"\n","\n"+nt_SPACE_FOR_LIST,"\n");li=li.nextSibling;if(text_buffer[text_buffer.length-1]!="\n"){text_buffer+="\n"}}return text_buffer}function MdFromNode(node,list_rank){if(node.nodeType===Node.TEXT_NODE){if(node.data==nt_ZWBR){return""}return node.data}switch(node.tagName){case"BR":{if(node.parentNode.nodeName=="P"){return"  \n"}return""}case"P":{const text=MdFromChildNodes(node,list_rank);if(node.previousSibling){if(text.length===0){return"\n  \n"}else if(text[text.length-1]==="\n"){return"\n"+text}else{return"\n"+text+"\n"}}else{if(text.length===0){return"  \n"}else if(text[text.length-1]==="\n"){return text}else{return text+"\n"}}}case"UL":{const head="- ";const text=MdFromList(node,list_rank,head);if(list_rank===0){if(node.previousSibling){if(node.previousSibling.tagName!=="P"&&node.previousSibling.tagName!=="OL"&&node.previousSibling.tagName!=="UL"){return"\n\n"+text}}}return"\n"+text}case"OL":{const head="1. ";const text=MdFromList(node,list_rank,head);if(list_rank===0){if(node.previousSibling){if(node.previousSibling.tagName!=="P"&&node.previousSibling.tagName!=="OL"&&node.previousSibling.tagName!=="UL"){return"\n\n"+text}}}return"\n"+text}case"SPAN":{if(node.className=="math"){switch(node.lastChild.className){case"editmathdisp":case"editcodedisp":{let math_text=node.lastChild.firstChild.data;if(list_rank>0){return"\n\n"+math_text+"\n"}else{if(node.previousSibling){if(node.previousSibling.className=="math"){const math_class=node.previousSibling.lastChild.className;if(math_class=="editmathdisp"||math_class=="editcodedisp"){return math_text+"\n"}}return"\n"+math_text+"\n"}else{return math_text+"\n"}}}case"editimg":case"editcite":return node.lastChild.firstChild.data.slice(0,node.lastChild.firstChild.length-1);case"editref":return node.lastChild.firstChild.data.slice(0,node.lastChild.firstChild.length)+" ";default:if(node.lastChild.firstChild.data.charAt(0)=="_"){let text=node.lastChild.firstChild.data;if(node.previousSibling){if(node.previousSibling.nodeType===Node.TEXT_NODE){if(node.previousSibling.data.charAt(node.previousSibling.length-1)!=" "){text=" "+text}}else{text=" "+text}}if(node.nextSibling){if(node.nextSibling.nodeType===Node.TEXT_NODE){if(node.nextSibling.data.charAt(0)!=" "){text=text+" "}}else{text=text+" "}}return text}else{return node.lastChild.firstChild.data}}}console.error("invalid span node cannot be changed:",node.className);return""}case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":{const head="#".repeat(parseInt(node.tagName.charAt(1),10))+" ";const text=MdFromChildNodes(node,list_rank);if(node.previousSibling){if(text.length===0){return"\n"+head+"  \n"}else if(text[text.length-1]==="\n"){return"\n"+head+text}else{return"\n"+head+text+"\n"}}else{if(text.length===0){return head+"  \n"}else if(text[text.length-1]==="\n"){return head+text}else{return head+text+"\n"}}}case"FIGURE":{let text=node.previousSibling?"\n":"";let img=node.firstChild;while(img){if(IsSpanMathImg(img)){text+=MdFromNode(img)+"\n"}else if(img.nodeName=="FIGCAPTION"){break}img=img.nextSibling}if(img){text+=MdFromChildNodes(img,list_rank)}if(text.length===0){return"  \n"}else if(text[text.length-1]==="\n"){return text}else{return text+"\n"}}case"TABLE":{let text=node.previousSibling?"\n":"";for(let tr=node.firstChild;tr;tr=tr.nextSibling){text+=MdFromNode(tr,0)}return text}case"TR":{let text="|";for(let td=node.firstChild;td;td=td.nextSibling){let text_in_id=MdFromNode(td,0);if(text_in_id[text_in_id.length-1]==="\n"){text+=text_in_id.slice(0,text_in_id.length-1)+"|"}else{text+=text_in_id+"|"}}text+="\n";return text}case"TH":case"TD":{return MdFromChildNodes(node,0)}case"MARK":{return MdFromChildNodes(node,0)}}alert("invalid node cannot be changed:"+node.tagName);return""}"use strict";function DOM2TEX(target_node){const head_text=TexHeader();const body_text=TexBody(target_node);const foot_text=TexFooter();return head_text+body_text+foot_text}function TexHeader(){let head_text="";head_text+="\\documentclass{ltjsarticle}\n";head_text+="\\usepackage{bm}\n";head_text+="\\usepackage{graphicx}\n";head_text+="\\usepackage{fancybox}\n";head_text+="\\usepackage{ascmac}\n";head_text+="\\usepackage{amsmath}\n";head_text+="\\usepackage[luatex,pdfencoding=auto]{hyperref}\n";head_text+="\\usepackage[normalem]{ulem}\n";head_text+="\\begin{document}\n";head_text+="\n";return head_text}function TexFooter(){let foot_text="\n\\end{document}\n";return foot_text}function TexBody(parent){let list_rank=0;let text_buffer="";let node=parent.firstChild;if(node.nodeName=="H1"){const h1_text=TexFromChildNodes(node,list_rank);text_buffer+="\\title{";text_buffer+=h1_text[h1_text.length-1]=="\n"?h1_text.slice(0,h1_text.length-1):h1_text;text_buffer+="}\n";text_buffer+="\\maketitle\n\n";node=node.nextSibling}let node_end=null;let num_ref=0;{let ref=parent.lastChild;while(ref!==node){let to_prev=false;if(ref.nodeName=="P"){let ch=ref.firstChild;if(ch.nodeType==Node.TEXT_NODE){if(ch.data==nt_ZWBR){ch=ch.nextSibling}}if(ch.nodeName=="SPAN"){if(ch.lastChild.className=="editref"){num_ref++;node_end=ref;if(ref!==node){to_prev=true;ref=ref.previousSibling}}}}if(!to_prev)break}}while(node!==node_end){text_buffer+=TexFromNode(node,list_rank);node=node.nextSibling}if(num_ref>0){text_buffer+="\n\\begin{thebibliography}";text_buffer+=num_ref<10?"{9}\n":"{99}\n";while(node){text_buffer+=TexFromNode(node,list_rank);node=node.nextSibling}text_buffer+="\\end{thebibliography}\n"}return text_buffer}function TexFromChildNodes(parent,list_rank){let text_buffer="";let node=parent.firstChild;while(node){text_buffer+=TexFromNode(node,list_rank);node=node.nextSibling}return text_buffer}function TexFromList(parent,list_rank,head){let text_buffer="";let li=parent.firstChild;while(li){const text=TexFromChildNodes(li,list_rank+1);text_buffer+=head+ReplaceAllExcept(text,"\n","\n"+nt_SPACE_FOR_LIST,"\n");li=li.nextSibling;if(text_buffer[text_buffer.length-1]!="\n"){text_buffer+="\n"}}return text_buffer}function TexFromNode(node,list_rank){if(node.nodeType===Node.TEXT_NODE){if(node.data==nt_ZWBR){return""}return ReplaceAll(ReplaceAll(node.data,"#","\\#"),"%","\\%")}switch(node.tagName){case"BR":{if(node.parentNode.nodeName=="P"){return"  \n"}return""}case"P":{const text=TexFromChildNodes(node,list_rank);if(node.previousSibling){if(text.length===0){return"\n  \n"}else if(text[text.length-1]==="\n"){return"\n"+text}else{return"\n"+text+"\n"}}else{if(text.length===0){return"  \n"}else if(text[text.length-1]==="\n"){return text}else{return text+"\n"}}}case"UL":{const head="\\item ";let text=TexFromList(node,list_rank,head);text="\\begin{itemize}\n"+text+"\\end{itemize}\n";if(list_rank===0){if(node.previousSibling){if(node.previousSibling.tagName!=="P"&&node.previousSibling.tagName!=="OL"&&node.previousSibling.tagName!=="UL"){return"\n\n"+text}}}return"\n"+text}case"OL":{const head="\\item ";let text=TexFromList(node,list_rank,head);text="\\begin{enumerate}\n"+text+"\\end{enumerate}\n";if(list_rank===0){if(node.previousSibling){if(node.previousSibling.tagName!=="P"&&node.previousSibling.tagName!=="OL"&&node.previousSibling.tagName!=="UL"){return"\n\n"+text}}}return"\n"+text}case"SPAN":{if(node.className=="math"){switch(node.lastChild.className){case"editmathdisp":{let math_text=node.lastChild.firstChild.data;let p_s=math_text.indexOf("\\begin{align}");if(p_s>=0){let p_e=math_text.indexOf("\\end{align}");if(p_e<0){p_e=math_text.length}else{p_e+="\\end{align}".length}math_text=math_text.slice(p_s,p_e)}else{if(math_text.indexOf("\\\\")>=0){math_text="\\begin{align}"+math_text.slice(2,math_text.length-2)+"\\end{align}"}else{math_text="\\begin{equation}"+math_text.slice(2,math_text.length-2)+"\\end{equation}"}}if(list_rank>0){return"\n\n"+math_text+"\n"}else{if(node.previousSibling){if(node.previousSibling.className=="math"){const math_class=node.previousSibling.lastChild.className;if(math_class=="editmathdisp"||math_class=="editcodedisp"){return math_text+"\n"}}return"\n"+math_text+"\n"}else{return math_text+"\n"}}}case"editcodedisp":{let math_text=node.lastChild.firstChild.data;let p_s=math_text.indexOf("\n");if(p_s>3){math_text="\\begin{itembox}[l]{"+math_text.slice(3,p_s)+"}\n\\begin{verbatim}"+math_text.slice(p_s+1,math_text.length-3)+"\\end{verbatim}\n\\end{itembox}"}else{math_text="\\begin{screen}\n\\begin{verbatim}"+math_text.slice(3,math_text.length-3)+"\\end{verbatim}\n\\end{screen}"}if(list_rank>0){return"\n\n"+math_text+"\n"}else{if(node.previousSibling){if(node.previousSibling.className=="math"){const math_class=node.previousSibling.lastChild.className;if(math_class=="editmathdisp"||math_class=="editcodedisp"){return math_text+"\n"}}return"\n"+math_text+"\n"}else{return math_text+"\n"}}}case"editimg":{let p_s=node.lastChild.firstChild.data.indexOf("(");if(p_s<0)p_s=0;p_s++;return"\\includegraphics{"+node.lastChild.firstChild.data.slice(p_s,node.lastChild.firstChild.length-2)+"}"}case"edita":{let t_e=node.lastChild.firstChild.data.indexOf("]");if(t_e<0)t_e=1;let p_s=node.lastChild.firstChild.data.indexOf("(",t_e);if(p_s<0)p_s=0;p_s++;return"\\href{"+node.lastChild.firstChild.data.slice(p_s,node.lastChild.firstChild.length-2)+"}{"+node.lastChild.firstChild.data.slice(1,t_e)+"}"}case"editcite":return"\\cite{"+node.lastChild.firstChild.data.slice(2,node.lastChild.firstChild.length-2)+"}";case"editref":return"\\bibitem{"+node.lastChild.firstChild.data.slice(2,node.lastChild.firstChild.length-2)+"} ";case"editcode":return"\\ovalbox{ \\verb*`"+node.lastChild.firstChild.data.slice(1,node.lastChild.firstChild.length-1)+"` }";case"editem1":{const mlen=1;let text=node.lastChild.firstChild.data.slice(mlen,node.lastChild.firstChild.length-mlen);return"\\emph{"+text+"}"}case"editem2":{const mlen=2;let text=node.lastChild.firstChild.data.slice(mlen,node.lastChild.firstChild.length-mlen);return"\\textbf{"+text+"}"}case"editem3":{const mlen=3;let text=node.lastChild.firstChild.data.slice(mlen,node.lastChild.firstChild.length-mlen);return"\\textbf{\\emph{"+text+"}}"}case"editdeleted":return"\\sout{"+node.lastChild.firstChild.data.slice(2,node.lastChild.firstChild.length-2)+"}";default:if(node.lastChild.firstChild.data.charAt(0)=="_"){let text=node.lastChild.firstChild.data;if(node.previousSibling){if(node.previousSibling.nodeType===Node.TEXT_NODE){if(node.previousSibling.data.charAt(node.previousSibling.length-1)!=" "){text=" "+text}}else{text=" "+text}}if(node.nextSibling){if(node.nextSibling.nodeType===Node.TEXT_NODE){if(node.nextSibling.data.charAt(0)!=" "){text=text+" "}}else{text=text+" "}}return text}else{return node.lastChild.firstChild.data}}}console.error("invalid span node cannot be changed:",node.className);return""}case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":{const head=TexSectionName(node.tagName)+"{";const text=TexFromChildNodes(node,list_rank);if(node.previousSibling){if(text.length===0){return"\n"+head+"}\n"}else if(text[text.length-1]==="\n"){return"\n"+head+text.slice(0,text.length-1)+"}\n"}else{return"\n"+head+text+"}\n"}}else{if(text.length===0){return head+"}\n"}else if(text[text.length-1]==="\n"){return head+text.slice(0,text.length-1)+"}\n"}else{return head+text+"}\n"}}}case"FIGURE":{let text=node.previousSibling?"\n":"";text+="\\begin{figure}[h]\n";text+="\\begin{center}\n";let img=node.firstChild;while(img){if(IsSpanMathImg(img)){text+=TexFromNode(img)+"\n"}else if(img.nodeName=="FIGCAPTION"){break}img=img.nextSibling}if(img){text+="\\caption{"+TexFromChildNodes(img,list_rank)+"}\n"}text+="\\end{center}\n";text+="\\end{figure}\n";if(text.length===0){return"  \n"}return text}case"TABLE":{let text=node.previousSibling?"\n":"";text+="\\begin{table}[h]\n";text+="\\begin{tabular}";{let align_text="{";const tr2=node.firstChild.nextSibling;for(let td=tr2.firstChild;td;td=td.nextSibling){if(td[0]==":"){if(td[td.length-1]==":"){align_text+="c"}else{align_text+="l"}}else{if(td[td.length-1]==":"){align_text+="r"}else{align_text+="l"}}}text+=align_text+"}  \\hline\n"}for(let tr=node.firstChild;tr;tr=tr.nextSibling){if(tr===node.firstChild.nextSibling){text+="\\hline\n"}else{for(let td=tr.firstChild;td;td=td.nextSibling){let text_in_id=TexFromChildNodes(td,0);if(text_in_id[text_in_id.length-1]==="\n"){text+=text_in_id.slice(0,text_in_id.length-1)}else{text+=text_in_id}if(td.nextSibling){text+="&"}}text+="\\\\\n"}}text+="\\hline\n";text+="\\end{tabular}\n";text+="\\end{table}\n";return text}case"MARK":{return TexFromChildNodes(node,0)}}alert("invalid node cannot be changed:"+node.tagName);return""}function TexSectionName(tagName){switch(tagName){case"H1":return"\\part";case"H2":return"\\section";case"H3":return"\\subsection";case"H4":return"\\subsubsection";case"H5":return"\\paragraph";case"H6":return"\\subparagraph"}}"use strict";const nt_ZWBR="​";class SelectionInfo{constructor(focusNode_,focusOffset_,anchorNode_=focusNode_,anchorOffset_=focusOffset_){this.focusNode=focusNode_;this.focusOffset=focusOffset_;this.anchorNode=anchorNode_;this.anchorOffset=anchorOffset_}}class OperationInfo{constructor(update_type,data_,parent_,offset_,length_){this.updateType=update_type;this.data=data_;this.parent=parent_;this.offset=offset_;this.length=length_;this.is_connect_to_past=false;this.is_connect_to_future=false}}class History{constructor(selection_before,operation_begin){this.selectionBefore=selection_before;this.selectionAfter=null;this.operationBegin=operation_begin;this.operationEnd=operation_begin}}var UR_TYPE={NONE:0,INSERT_TEXT_INTO_TEXT:1,DELETE_IN_TEXT:101,DIVIDE_TEXT_NODE:202,ADD_NODE:1001,ADD_TEXT_NODE:1002,ADD_MATH_NODE:1007,REMOVE_NODE:2001,COMBINE_TEXT_NODE:3002,REMOVE_NODE_LIST:3004,ADD_NODE_LIST:3005};class UndoManager{constructor(){this.name="undo_manager";this.operations=[];this.history=[];this.index_history=0;this.index_operation=0;this.acceptable=false;this.begin_selection=null;this.begin_index_ope=0;this.event_dispatcher=null}get numHistory(){return this.history.length}Begin(focusNode_,focusOffset_,anchorNode_=focusNode_,anchorOffset_=focusOffset_){if(this.acceptable){alert("ERROR: invalid Undo registration")}this.Shrink();this.begin_selection=new SelectionInfo(focusNode_,focusOffset_,anchorNode_,anchorOffset_);this.begin_index_ope=this.index_operation;if(this.operations.length>this.index_operation){this.operations.splice(this.index_operation)}this.acceptable=true}End(focusNode_,focusOffset_,anchorNode_=focusNode_,anchorOffset_=focusOffset_){if(this.begin_index_ope<this.index_operation){let hist=new History(this.begin_selection,this.begin_index_ope);hist.selectionAfter=new SelectionInfo(focusNode_,focusOffset_,anchorNode_,anchorOffset_);hist.operationEnd=this.index_operation;this.history.push(hist);this.index_history++}this.acceptable=false;if(this.event_dispatcher){this.event_dispatcher.Dispatch()}}Cancel(){if(this.acceptable){if(this.begin_index_ope<this.index_operation){alert("DOM operation is canceled but, DOM has been already changed.")}this.index_operation=this.begin_index_ope;this.acceptable=false}}Shrink(){if(this.acceptable===false){if(this.history.length>this.index_history){this.index_operation=this.history[this.index_history].operationBegin;this.operations.splice(this.index_operation);this.history.splice(this.index_history);console.log("shurink: ",this.history.length)}}}Register(ur_type,data,parent,offset,length){if(!this.acceptable){alert("ERROR: Undo Manager: call Begin before calling Register!")}this.operations.push(new OperationInfo(ur_type,data,parent,offset,length));this.index_operation++}GetUndo(){if(this.index_history===0){return null}this.index_history--;const hist=this.history[this.index_history];this.operation_begin=hist.operationBegin;return hist}GetRedo(){if(this.index_history===this.history.length){return null}const hist=this.history[this.index_history];this.index_history++;this.operation_begin=hist.operationEnd;return hist}GetOperation(index_ope){return this.operations[index_ope]}SetChangeEventDispatcher(event_dispatcher){this.event_dispatcher=event_dispatcher}GetChangeEventDispatcher(){return this.event_dispatcher}}class ChangeEventDispatcher{constructor(event_target){this.event_target=event_target;this.has_changed=false;this.enable=true}Reset(){this.has_changed=false}Dispatch(){if(this.has_changed===false){if(this.event_target&&this.enable){this.has_changed=true;this.event_target.dispatchEvent(new CustomEvent("nt_changed"))}}}Enable(){this.enable=true}Disable(){this.enable=false}}let undo_man=null;function CreateSelectionInfo(selection){return new SelectionInfo(selection.focusNode,selection.focusOffset,selection.anchorNode,selection.anchorOffset)}function CloneSelectionInfo(si){return new SelectionInfo(si.focusNode,si.focusOffset,si.anchorNode,si.anchorOffset)}function ExecUndo(){let history=undo_man.GetUndo();if(!history){return false}for(let i=history.operationEnd-1;i>=history.operationBegin;i--){console.log("Undo: "+i+" ------------------ ");const ope=undo_man.GetOperation(i);switch(ope.updateType){case UR_TYPE.INSERT_TEXT_INTO_TEXT:UndoInsertTextToText(ope);break;case UR_TYPE.ADD_TEXT_NODE:UndoAddTextNode(ope);break;case UR_TYPE.ADD_NODE:case UR_TYPE.ADD_MATH_NODE:UndoAddNode(ope);break;case UR_TYPE.DELETE_IN_TEXT:UndoDeleteText(ope);break;case UR_TYPE.DIVIDE_TEXT_NODE:UndoDivideTextNode(ope);break;case UR_TYPE.REMOVE_NODE:UndoRemoveNode(ope);break;case UR_TYPE.COMBINE_TEXT_NODE:UndoCombineTextNode(ope);break;case UR_TYPE.REMOVE_NODE_LIST:UndoRemoveNodeList(ope);break;case UR_TYPE.ADD_NODE_LIST:UndoAddNodeList(ope);break}}if(history.selectionBefore.focusOffset==NT_SELECT_CELL_MODE){SetSelectTable(history.selectionBefore.anchorNode,history.selectionBefore.focusNode)}else if(history.selectionBefore.focusNode===history.selectionBefore.anchorNode&&history.selectionBefore.focusOffset===history.selectionBefore.anchorOffset){document.getSelection().collapse(history.selectionBefore.focusNode,history.selectionBefore.focusOffset)}else{document.getSelection().setBaseAndExtent(history.selectionBefore.anchorNode,history.selectionBefore.anchorOffset,history.selectionBefore.focusNode,history.selectionBefore.focusOffset)}CheckEditPreview(null,true);undo_man.GetChangeEventDispatcher().Dispatch();return true}function ExecRedo(){let history=undo_man.GetRedo();if(!history){return false}for(let i=history.operationBegin;i<history.operationEnd;i++){console.log("Redo: "+i+" ------------------ ");const ope=undo_man.GetOperation(i);switch(ope.updateType){case UR_TYPE.INSERT_TEXT_INTO_TEXT:RedoInsertTextToText(ope);break;case UR_TYPE.ADD_TEXT_NODE:RedoAddTextNode(ope);break;case UR_TYPE.ADD_NODE:case UR_TYPE.ADD_MATH_NODE:RedoAddNode(ope);break;case UR_TYPE.DELETE_IN_TEXT:RedoDeleteText(ope);break;case UR_TYPE.DIVIDE_TEXT_NODE:RedoDivideTextNode(ope);break;case UR_TYPE.REMOVE_NODE:RedoRemoveNode(ope);break;case UR_TYPE.COMBINE_TEXT_NODE:RedoCombineTextNode(ope);break;case UR_TYPE.REMOVE_NODE_LIST:RedoRemoveNodeList(ope);break;case UR_TYPE.ADD_NODE_LIST:RedoAddNodeList(ope);break}}if(history.selectionAfter.focusOffset==NT_SELECT_CELL_MODE){SetSelectTable(history.selectionAfter.anchorNode,history.selectionAfter.focusNode)}else if(history.selectionAfter.focusNode===history.selectionAfter.anchorNode&&history.selectionAfter.focusOffset===history.selectionAfter.anchorOffset){document.getSelection().collapse(history.selectionAfter.focusNode,history.selectionAfter.focusOffset)}else{document.getSelection().setBaseAndExtent(history.selectionAfter.anchorNode,history.selectionAfter.anchorOffset,history.selectionAfter.focusNode,history.selectionAfter.focusOffset)}CheckEditPreview(null,true);undo_man.GetChangeEventDispatcher().Dispatch();return true}function InsertTextIntoText(text,node,offset){console.log("insert text into text");node.insertData(offset,text);undo_man.Register(UR_TYPE.INSERT_TEXT_INTO_TEXT,text,node,offset,text.length)}function UndoInsertTextToText(operation_info){let node=operation_info.parent;if(node.nodeType!==Node.TEXT_NODE){alert("Undo: node is not text in UndoInsertTextToText")}node.deleteData(operation_info.offset,operation_info.length)}function RedoInsertTextToText(operation_info){let node=operation_info.parent;if(node.nodeType!==Node.TEXT_NODE){alert("Undo: node is not text in RedoInsertTextToText")}node.insertData(operation_info.offset,operation_info.data)}function DeleteText(node,offset,length=1){console.log("delete text",offset,length);if(node.length<=offset){alert("node focus is invalid");return null}const text=node.data.slice(offset,offset+length);node.deleteData(offset,length);undo_man.Register(UR_TYPE.DELETE_IN_TEXT,text,node,offset,length);return text}function UndoDeleteText(operation_info){console.log("undo delete text");let node=operation_info.parent;node.insertData(operation_info.offset,operation_info.data)}function RedoDeleteText(operation_info){console.log("redo delete text");let node=operation_info.parent;node.deleteData(operation_info.offset,operation_info.length)}function AddMathNode(mark,parent,ref_node){const offset=GetIndex(parent,ref_node);let math=CreateMathNode(mark);if(math){parent.insertBefore(math,ref_node);undo_man.Register(UR_TYPE.ADD_MATH_NODE,math,parent,offset,1)}return math}function CreateMathNode(mark){switch(mark){case"$":{let math=document.createElement("SPAN");math.className="math";math.insertAdjacentHTML("afterbegin",katex.renderToString("",{throwOnError:false}));math.insertAdjacentHTML("beforeend","<span class='editmath'>$$</span>");return math}case"$$":{let math=document.createElement("SPAN");math.className="math";katexAutoNumber("",math,0);math.insertAdjacentHTML("beforeend","<span class='editmathdisp'>$$\n\n$$</span>");math.dataset.eqnumberBegin=0;math.dataset.eqnumberEnd=0;return math}case"`":{let math=document.createElement("SPAN");math.className="math";math.insertAdjacentHTML("afterbegin","<span class='previewcode'>dummy</span>");math.insertAdjacentHTML("beforeend","<span class='editcode'>``</span>");return math}case"```":{const math=document.createElement("SPAN");math.className="math";math.insertAdjacentHTML("afterbegin","<span class='previewcodedisp'>dummy</span>");math.insertAdjacentHTML("beforeend","<span class='editcodedisp'>```\n\n```</span>");return math}case"*":case"_":{const math=document.createElement("SPAN");math.className="math";math.insertAdjacentHTML("afterbegin","<em>dummy</em>");math.insertAdjacentHTML("beforeend","<span class='editem1'>"+mark+mark+"</span>");return math}case"**":case"__":{const math=document.createElement("SPAN");math.className="math";math.insertAdjacentHTML("afterbegin","<strong>dummy</strong>");math.insertAdjacentHTML("beforeend","<span class='editem2'>"+mark+mark+"</span>");return math}case"***":case"___":{const math=document.createElement("SPAN");math.className="math";math.insertAdjacentHTML("afterbegin","<em><strong>dummy</strong></em>");math.insertAdjacentHTML("beforeend","<span class='editem3'>"+mark+mark+"</span>");return math}case"~~":{let math=document.createElement("SPAN");math.className="math";math.insertAdjacentHTML("afterbegin","<span class='previewdeleted'>dummy</span>");math.insertAdjacentHTML("beforeend","<span class='editdeleted'>"+mark+mark+"</span>");return math}case"[":{const math=document.createElement("SPAN");math.className="math";math.insertAdjacentHTML("afterbegin",'<a href="'+NT_LINK_DEFAULT_URL+'" target="_blank" ref="noopener noreferrer">'+NT_LINK_DEFAULT_TEXT+"</a>");math.insertAdjacentHTML("beforeend","<span class='edita'>["+NT_LINK_DEFAULT_TEXT+"]("+NT_LINK_DEFAULT_URL+")</span>");return math}case"![":{const math=document.createElement("SPAN");math.className="math";math.insertAdjacentHTML("afterbegin",'<img src="sample.jpg" alt="AltWord">');math.insertAdjacentHTML("beforeend","<span class='editimg'>![AltwWord](image.png) </span>");return math}case"[^":{const math=document.createElement("SPAN");math.className="math";math.insertAdjacentHTML("afterbegin","<a class='previewcite'>dummy</span>");math.insertAdjacentHTML("beforeend","<span class='editcite'>[^] </span>");return math}}return null}function AddTextNode(text,parent,ref_node){console.log("add text node");const offset=GetIndex(parent,ref_node);let text_node=document.createTextNode(text);parent.insertBefore(text_node,ref_node);undo_man.Register(UR_TYPE.ADD_TEXT_NODE,text_node,parent,offset,1);return text_node}function UndoAddTextNode(operation_info){console.log("undo add text node");let node=operation_info.data;node.remove()}function RedoAddTextNode(operation_info){console.log("redo add text node");let parent=operation_info.parent;let text_node=operation_info.data;let ref_node=parent.childNodes.item(operation_info.offset);parent.insertBefore(text_node,ref_node)}function GetIndex(parent,child){let ch=parent.firstChild;let index=0;while(ch){if(child===ch){return index}ch=ch.nextSibling;++index}return index}function RemoveNode(node){console.log("remove node");const offset=GetIndex(node.parentNode,node);const parent=node.parentNode;node.remove();undo_man.Register(UR_TYPE.REMOVE_NODE,node,parent,offset,1);return node}function UndoRemoveNode(operation_info){console.log("undo remove node");let parent=operation_info.parent;parent.insertBefore(operation_info.data,parent.childNodes.item(operation_info.offset))}function RedoRemoveNode(operation_info){console.log("redo remove node");let node=operation_info.data;node.remove()}function AddNode(tag_name,parent,ref_node){console.log("add node: "+tag_name);let offset=GetIndex(parent,ref_node);let new_node=document.createElement(tag_name);parent.insertBefore(new_node,ref_node);undo_man.Register(UR_TYPE.ADD_NODE,new_node,parent,offset,1);return new_node}function UndoAddNode(operation_info){console.log("undo add node");let node=operation_info.data;const parent=operation_info.parent;const offset=operation_info.offset;if(parent.childNodes.item(offset)!==node){if(parent.childNodes.item(offset).nodeName!==node.nodeName){alert("ERROR: added node does not exist!");return}else{console.log("NOTINE: added node does not exist, but same type node is added already.");node=parent.childNodes.item(offset)}}node.remove()}function RedoAddNode(operation_info){console.log("redo add node");let parent=operation_info.parent;let new_node=operation_info.data;let ref_node=parent.childNodes.item(operation_info.offset);parent.insertBefore(new_node,ref_node)}function DivideTextNode(node,offset){console.log("divide text node");let new_node=node.splitText(offset);undo_man.Register(UR_TYPE.DIVIDE_TEXT_NODE,new_node,node,offset,new_node.length);return new_node}function UndoDivideTextNode(operation_info){console.log("undo divide text node");let node=operation_info.data;let org_node=operation_info.parent;org_node.appendData(node.data);node.remove()}function RedoDivideTextNode(operation_info){console.log("redo divide text node");let new_node=operation_info.data;let node=operation_info.parent;node.deleteData(operation_info.offset,operation_info.length);node.after(new_node)}function CombineTextNode(node){console.log("combine text node");let next=node.nextSibling;const offset=node.length;node.appendData(next.data);next.remove();undo_man.Register(UR_TYPE.COMBINE_TEXT_NODE,next,node,offset,next.length)}function UndoCombineTextNode(operation_info){console.log("undo combine text node");let node=operation_info.parent;let next=operation_info.data;node.deleteData(operation_info.offset,operation_info.length);node.after(next)}function RedoCombineTextNode(operation_info){console.log("redo combine text node");let node=operation_info.parent;let next=operation_info.data;node.appendData(next.data);next.remove()}function RemoveNodeList(parent,start_node,end_node=null){console.log("remove node list");let offset=GetIndex(parent,start_node);let fragment=new DocumentFragment;let pos=start_node;while(pos!==end_node){let next=pos.nextSibling;pos.remove();fragment.appendChild(pos);pos=next}undo_man.Register(UR_TYPE.REMOVE_NODE_LIST,fragment,parent,offset,fragment.childNodes.length);return fragment}function UndoRemoveNodeList(operation_info){console.log("undo remove node list");let fragment=operation_info.data;let parent=operation_info.parent;let offset=operation_info.offset;parent.insertBefore(fragment,parent.childNodes.item(offset))}function RedoRemoveNodeList(operation_info){console.log("redo remove node list");let fragment=operation_info.data;let parent=operation_info.parent;let offset=operation_info.offset;let offset_end=offset+operation_info.length;const end_node=parent.childNodes.item(offset_end);let pos=parent.childNodes.item(offset);while(pos!==end_node){let next=pos.nextSibling;pos.remove();fragment.appendChild(pos);pos=next}}function AddNodeList(parent,ref_node,fragment){console.log("add node list");const offset=GetIndex(parent,ref_node);const length=fragment.childNodes.length;const first=fragment.firstChild;parent.insertBefore(fragment,ref_node);undo_man.Register(UR_TYPE.ADD_NODE_LIST,fragment,parent,offset,length);return first}function UndoAddNodeList(operation_info){console.log("undo add node list");let fragment=operation_info.data;let parent=operation_info.parent;let offset=operation_info.offset;let offset_end=offset+operation_info.length;const end_node=parent.childNodes.item(offset_end);let pos=parent.childNodes.item(offset);while(pos!==end_node){let next=pos.nextSibling;pos.remove();fragment.appendChild(pos);pos=next}}function RedoAddNodeList(operation_info){console.log("redo add node list");let fragment=operation_info.data;let parent=operation_info.parent;let offset=operation_info.offset;parent.insertBefore(fragment,parent.childNodes.item(offset))}function RepairLastBr(node){if(node===null)return;if(node.nodeName==="OL"||node.nodeName==="UL"){let last=node.lastChild;if(last===null){let ref=AddNode("LI",node,null);AddNode("BR",ref,null)}return}else{let last=node.lastChild;if(last===null){AddNode("BR",node,null);return}if(last.nodeName==="BR")return;if(last.nodeName!=="OL"&&last.nodeName!=="UL"){AddNode("BR",node,null);return}if(node.firstChild.nodeName==="OL"||node.firstChild.nodeName==="UL"){AddNode("BR",node,node.firstChild)}return}}function SafePushNodeList(parent1,parent2){const latter_first=parent2.firstChild;if(latter_first===null){return null}const fragment=parent2.nodeName=="#document-fragment"?parent2:RemoveNodeList(parent2,latter_first,null);AddNodeList(parent1,null,fragment);const focus=SafeJunctionPoint(parent1,latter_first);SafeTailPoint(parent1);return focus}function SafeCombineNode(parent1){if(parent1.nextSibling===null)return null;if(parent1.nextSibling.firstChild===null)return null;const fragment=RemoveNodeList(parent1.nextSibling,parent1.nextSibling.firstChild,null);RemoveNode(parent1.nextSibling);return SafePushNodeList(parent1,fragment)}function SafeJunctionPoint(parent,ref){const is_BR_ZWBR=node=>{if(node){if(node.nodeName=="BR"){return true}else if(node.nodeType===Node.TEXT_NODE){if(node.data==nt_ZWBR){return true}}}return false};let former=ref?ref.previousSibling:parent.lastChild;if(is_BR_ZWBR(former)){const org=former;former=former.previousSibling;RemoveNode(org)}let latter=ref;if(is_BR_ZWBR(latter)){const org=latter;latter=latter.nextSibling;RemoveNode(org)}if(former===null){return SafeHeadPoint(parent)}if(former.nodeName=="SPAN"){if(latter){if(latter.nodeType===Node.TEXT_NODE){return{node:latter,offset:0}}}const fnode=AddTextNode(nt_ZWBR,parent,latter);return{node:fnode,offset:0}}if(former.nodeName=="UL"||former.nodeName=="OL"){if(latter){if(latter.nodeName==former.nodeName){const focus={node:latter.firstChild,offset:0};const fragment=RemoveNodeList(latter,latter.firstChild,null);AddNodeList(former,null,fragment);RemoveNode(latter);return focus}}return{node:former.lastChild,offset:0}}if(former.nodeName=="FIGCAPTION"){if(latter){if(latter.nodeName==former.nodeName){const fragment=RemoveNodeList(latter,latter.firstChild,null);const focus=SafePushNodeList(former,fragment);RemoveNode(latter);return focus}}return{node:former.lastChild,offset:0}}if(former.nodeType!==Node.TEXT_NODE){console.log("ERROR: unexpect adjacent node(2)",former.nodeName)}const foffset=former.length;if(latter){if(latter.nodeType===Node.TEXT_NODE){CombineTextNode(former);return{node:former,offset:foffset}}}return{node:former,offset:foffset}}function SafeHeadPoint(parent){const head=parent.firstChild;if(head===null){if(parent.nodeName=="DIV"){const p=AddNode("P",parent,null);AddNode("BR",p,null);return{node:p,offset:0}}else{AddNode("BR",parent,null);return{node:parent,offset:0}}}if(head.nodeName=="BR"){if(head.nextSibling){if(head.nextSibling.nodeName!="OL"&&head.nextSibling.nodeName!="UL"&&head.nextSibling.nodeName!="FIGCAPTION"){RemoveNode(head)}}return{node:parent,offset:0}}if(head.nodeName==="SPAN"){const fnode=AddTextNode(nt_ZWBR,parent,head);return{node:fnode,offset:0}}if(head.nodeName==="OL"||head.nodeName==="UL"||head.nodeName==="FIGCAPTION"){AddNode("BR",parent,head);return{node:parent,offset:0}}if(head.nodeType==Node.TEXT_NODE){return{node:head,offset:0}}console.log("HINT: unexpect head node",head.nodeName);return SafeHeadPoint(head)}function SafeTailPoint(parent){const tail=parent.lastChild;if(tail===null){if(parent.nodeName=="DIV"){const p=AddNode("P",parent,null);AddNode("BR",p,null);return{node:p,offset:0}}else{AddNode("BR",parent,null);return{node:parent,offset:0}}}if(tail.nodeName=="BR"){if(tail.previousSibling){RemoveNode(tail);return SafeTailPoint(parent)}return{node:parent,offset:0}}if(tail.nodeName=="SPAN"){const fnode=AddTextNode(nt_ZWBR,parent,null);return{node:fnode,offset:0}}if(tail.nodeName=="OL"||tail.nodeName=="UL"){return SafeTailPoint(tail.lastChild)}if(tail.nodeName==="FIGCAPTION"){return SafeTailPoint(tail)}if(tail.nodeType==Node.TEXT_NODE){return{node:tail,offset:tail.length}}console.log("HINT: unexpect tail node",tail.nodeName);return SafeTailPoint(tail)}function SafeRemoveNodeList(parent,start_node,end_node=null){const fragment=RemoveNodeList(parent,start_node,end_node);SafeJunctionPoint(parent,end_node);return fragment}function ValidateMathInParent(parent){let prev=null;let next=null;for(let node=parent.firstChild;node;node=next){next=node.nextSibling;if(node.nodeName=="SPAN"){if(prev===null)return false;if(prev.nodeType!==Node.TEXT_NODE)return false;if(next===null)return false;if(next.nodeType!==Node.TEXT_NODE)return false}prev=node}return true}function AssertValidateMathInParent(parent){if(!ValidateMathInParent(parent)){alert("ERROR: invalid for the adjacent nodes of math",parent);ValidateMathInParent(parent);return false}return true}function IsTextNode(node){if(node){if(node.nodeType===Node.TEXT_NODE){return true}}return false}"use strict";function NextOrderNode(node,upper_limit_node){if(node.firstChild){return node.firstChild}else if(node.nextSibling){return node.nextSibling}else{while(node.nextSibling===null){node=node.parentNode;if(node===upper_limit_node){return null}}return node.nextSibling}}function FindWord(word,start_node,start_offset,upper_limit_node){if(start_node.nodeType==Node.TEXT_NODE){if(start_offset<start_node.length){const p=start_node.data.indexOf(word,start_offset);if(p>=0){return{node:start_node,offset:p}}}}let node=NextOrderNode(start_node,upper_limit_node);while(node){if(node.nodeType==Node.TEXT_NODE){const p=node.data.indexOf(word);if(p>=0){return{node:node,offset:p}}node=NextOrderNode(node,upper_limit_node)}else if(node.className=="math"){node=node.lastChild}else{node=NextOrderNode(node,upper_limit_node)}}return null}let nt_finding_word="";function NT_FindAndSelect(word){if(word.length==0){nt_finding_word="";return false}nt_finding_word=word;const selection=document.getSelection();const focus=nt_render_div.contains(selection.focusNode)?FindWord(word,selection.focusNode,selection.focusOffset,nt_render_div):FindWord(word,nt_render_div.firstChild,0,nt_render_div);if(focus){if(g_editable_math){DisableEdit(g_editable_math)}if(IsTextNodeInMath(focus.node)){EnableMathEdit(focus.node.parentNode.parentNode)}selection.setBaseAndExtent(focus.node,focus.offset,focus.node,focus.offset+word.length);return true}return false}function PreviousOrderNode(node,upper_limit_node){if(node.lastChild){return node.lastChild}else if(node.previousSibling){return node.previousSibling}else{while(node.previousSibling===null){node=node.parentNode;if(node===upper_limit_node){return null}}return node.previousSibling}}function FindBackward(word,start_node,start_offset,upper_limit_node){if(start_node.nodeType==Node.TEXT_NODE){if(start_offset>0){const p=start_node.data.lastIndexOf(word,start_offset-1);if(p>=0){return{node:start_node,offset:p}}}}let node=PreviousOrderNode(start_node,upper_limit_node);while(node){if(node.nodeType==Node.TEXT_NODE){const p=node.data.lastIndexOf(word);if(p>=0){return{node:node,offset:p}}}if(node.parentNode.className=="math"&&node===node.parentNode.firstChild){node=node.parentNode;while(node.previousSibling===null){node=node.parentNode;if(node===upper_limit_node){return null}}node=node.previousSibling}else{node=PreviousOrderNode(node,upper_limit_node)}}return null}function NT_FindBackwardAndSelect(word){if(word.length==0){nt_finding_word="";return false}nt_finding_word=word;const selection=document.getSelection();const focus=nt_render_div.contains(selection.anchorNode)?FindBackward(word,selection.anchorNode,selection.anchorOffset,nt_render_div):FindBackward(word,nt_render_div.lastChild,0,nt_render_div);if(focus){if(g_editable_math){DisableEdit(g_editable_math)}if(IsTextNodeInMath(focus.node)){EnableMathEdit(focus.node.parentNode.parentNode)}selection.setBaseAndExtent(focus.node,focus.offset,focus.node,focus.offset+word.length);return true}return false}"use strict";let nt_highlight=null;function IsHighlightMode(){return!(nt_highlight===null)}class Highlighter{constructor(master_node,word){this.master_node=master_node;this.word=word;this.change_list=[];this.SearchAndMark(master_node)}SearchAll(){this.SearchAndMark(this.master_node)}SearchIn(parent_set){parent_set.forEach((parent=>{this.SearchAndMark(parent)}))}SearchAndMark(parent){let next;for(let node=parent.firstChild;node;node=next){next=node.nextSibling;if(node.nodeType==Node.TEXT_NODE){const fragment=this.Marking(node);if(fragment){let highlight_node_list=[];fragment.childNodes.forEach((n=>{highlight_node_list.push(n)}));this.change_list.push({original:node,highlight_node_list:highlight_node_list,length:fragment.childNodes.length,parent:parent,offset:GetIndex(parent,node)});const ref=node.nextSibling;parent.removeChild(node);parent.insertBefore(fragment,ref)}}else{if(node.nodeName!="SPAN"){this.SearchAndMark(node)}}}return true}Marking(text_node,word=this.word){const text=text_node.data;const length=text.length;const width=word.length;let offset=0;let p=text.indexOf(word,offset);if(p<0)return null;const fragment=new DocumentFragment;while(p>=0){const tnode=document.createTextNode(text.slice(offset,p));fragment.appendChild(tnode);const mark=document.createElement("MARK");mark.appendChild(document.createTextNode(word));fragment.appendChild(mark);offset=p+width;p=text.indexOf(word,offset)}if(offset<length){const tnode=document.createTextNode(text.slice(offset));fragment.appendChild(tnode)}return fragment}RepairAll(){while(this.change_list.length>0){const info=this.change_list.pop();const parent=info.parent;parent.insertBefore(info.original,info.highlight_node_list[0]);info.highlight_node_list.forEach((n=>{parent.removeChild(n)}))}}RegisterUndo(parent_set,undo_man){this.change_list.forEach((info=>{if(parent_set.has(info.parent)){undo_man.Register(UR_TYPE.REMOVE_NODE,info.original,info.parent,info.offset,1);let i=0;info.highlight_node_list.forEach((n=>{undo_man.Register(UR_TYPE.ADD_NODE,n,info.parent,info.offset+i,1);++i}));info.parent=null}}));this.change_list=this.change_list.filter((info=>info.parent!==null))}ForceRepairWithRegister(parent_set,fnode,foffset){let new_focus=null;parent_set.forEach((parent=>{const focus=this.SearchAndRepairWithRegister(parent,fnode,foffset);if(focus){new_focus=focus}}));return new_focus}SearchAndRepairWithRegister(parent,fnode,foffset){let new_focus=null;let begin_text="";let is_found=false;let next;for(let node=parent.firstChild;node;node=next){next=node.nextSibling;if(node.nodeName=="MARK"){if(is_found==false){is_found=true;if(node.previousSibling){if(node.previousSibling.nodeType==Node.TEXT_NODE){begin_text+=node.previousSibling.data;RemoveNode(node.previousSibling)}}}if(node.firstChild===fnode){new_focus={node:null,offset:begin_text.length+foffset}}begin_text+=node.textContent;RemoveNode(node)}else if(node.nodeType==Node.TEXT_NODE){if(node===fnode){new_focus={node:node,offset:begin_text.length+foffset}}if(is_found){begin_text+=node.data;RemoveNode(node)}}else{if(is_found){is_found=false;const add_node=AddTextNode(begin_text,parent,node);begin_text="";if(new_focus){new_focus.node=add_node}}const ret_focus=this.SearchAndRepairWithRegister(node,fnode,foffset);if(ret_focus){new_focus=ret_focus}}}if(is_found){const add_node=AddTextNode(begin_text,parent,null);if(new_focus){new_focus.node=add_node}}return new_focus}OriginalFocus(node,offset){if(node.nodeType!=Node.TEXT_NODE)return{node:node,offset:offset};const parent=node.parentNode.nodeName=="MARK"?node.parentNode.parentNode:node.parentNode;for(let k=0;k<this.change_list.length;++k){const info=this.change_list[k];if(info.parent===parent){if(info.highlight_node_list.includes(node.parentNode.nodeName=="MARK"?node.parentNode:node)){let org_offset=0;for(let i=0;i<info.highlight_node_list.length;++i){if(info.highlight_node_list[i]===node){org_offset+=offset;break}else if(info.highlight_node_list[i]===node.parentNode){org_offset+=offset;break}org_offset+=info.highlight_node_list[i].nodeName=="MARK"?info.highlight_node_list[i].firstChild.length:info.highlight_node_list[i].length}return{node:info.original,offset:org_offset}}}}return{node:node,offset:offset}}HighlightFocus(node,offset){if(node.nodeType!=Node.TEXT_NODE)return{node:node,offset:offset};for(let k=0;k<this.change_list.length;++k){const info=this.change_list[k];if(info.original===node){let sum_offset=0;for(let i=0;i<info.highlight_node_list.length;++i){const textnode=info.highlight_node_list[i].nodeName=="MARK"?info.highlight_node_list[i].firstChild:info.highlight_node_list[i];sum_offset+=textnode.length;if(sum_offset>=offset){return{node:textnode,offset:textnode.length-(sum_offset-offset)}}}return{node:info.original,offset:info.highlight_node_list[info.highlight_node_list.length-1].length}}}return{node:node,offset:offset}}get Word(){return this.word}}function NT_HighlightWord(word,keep_selection=true){if(IsTableSelectionMode()){ReleaseTableSelectAll()}if(nt_highlight){if(nt_highlight.Word==word)return true;if(!NT_HighlightClear(keep_selection))return false}const selection=document.getSelection();let focus=CorrectFocusToText2(selection.focusNode,selection.focusOffset);const is_collapsed=selection.isCollapsed;let anchor=is_collapsed?focus:CorrectFocusToText2(selection.anchorNode,selection.anchorOffset);nt_highlight=new Highlighter(nt_render_div,word);if(keep_selection){focus=nt_highlight.HighlightFocus(focus.node,focus.offset);if(is_collapsed){selection.collapse(focus.node,focus.offset)}else{anchor=nt_highlight.HighlightFocus(anchor.node,anchor.offset);selection.setBaseAndExtent(anchor.node,anchor.offset,focus.node,focus.offset)}}}function NT_HighlightClear(keep_selection=true){if(nt_highlight){const selection=document.getSelection();let focus=CorrectFocusToText2(selection.focusNode,selection.focusOffset);focus=nt_highlight.OriginalFocus(focus.node,focus.offset);if(selection.isCollapsed){nt_highlight.RepairAll();nt_highlight=null;if(keep_selection){selection.collapse(focus.node,focus.offset)}}else{let anchor=CorrectFocusToText2(selection.anchorNode,selection.anchorOffset);anchor=nt_highlight.OriginalFocus(anchor.node,anchor.offset);nt_highlight.RepairAll();nt_highlight=null;if(keep_selection){selection.setBaseAndExtent(anchor.node,anchor.offset,focus.node,focus.offset)}}return true}return false}"use strict";const IME_TYPE={GENERAL:0,WIN_FIREFOX:0,WIN_EDGE_LEGACY:1,WIN_CHROME:2,WIN_EDG_CHR:4,WIN_ELECTRON:5,MAC_FIREFOX:100,MAC_CHROME:102,MAC_SAFARI:103,MAC_ELECTRON:105,LNX_FIREFOX:200,LNX_CHROME:202,LNX_ELECTRON:205};let nt_render_div=null;let nt_is_MacOS=false;function NT_Initialize(target_div_id,ime_type){console.log("IME_type = ",ime_type);const render_div=document.getElementById(target_div_id);nt_render_div=render_div;render_div.contentEditable="true";render_div.addEventListener("keydown",OnKeydownForShortcut,false);switch(ime_type){case IME_TYPE.WIN_EDGE_LEGACY:MO_InitComposition(render_div);render_div.addEventListener("compositionstart",MO_OnCompositionstart,false);render_div.addEventListener("compositionupdate",MO_OnCompositionupdate,false);render_div.addEventListener("compositionend",MO_OnCompositionend,false);render_div.addEventListener("keydown",MO_OnKeydownForIME,false);render_div.addEventListener("contextmenu",MO_OnContextmenuForIME,false);render_div.addEventListener("keydown",OnKeydownForNavigation,false);render_div.addEventListener("keydown",OnKeydownForAsciiChar,false);render_div.addEventListener("keyup",OnKeyup,false);break;case IME_TYPE.WIN_CHROME:case IME_TYPE.LNX_CHROME:case IME_TYPE.WIN_EDG_CHR:case IME_TYPE.WIN_ELECTRON:case IME_TYPE.LNX_ELECTRON:MO_InitComposition(render_div);render_div.addEventListener("compositionstart",MO_OnCompositionstart,false);render_div.addEventListener("compositionupdate",MO_OnCompositionupdate,false);render_div.addEventListener("compositionend",MO_OnCompositionendForChrome,false);render_div.addEventListener("keydown",MO_OnKeydownForIME,false);render_div.addEventListener("contextmenu",MO_OnContextmenuForIME,false);render_div.addEventListener("keydown",OnKeydownForNavigation,false);render_div.addEventListener("keydown",OnKeydownForAsciiChar,false);render_div.addEventListener("keyup",OnKeyup,false);break;case IME_TYPE.MAC_CHROME:case IME_TYPE.MAC_ELECTRON:MO_InitComposition(render_div);render_div.addEventListener("compositionstart",MO_OnCompositionstart,false);render_div.addEventListener("compositionupdate",MO_OnCompositionupdate,false);render_div.addEventListener("compositionend",MO_OnCompositionendForChrome,false);render_div.addEventListener("keydown",MO_OnKeydownForIME,false);render_div.addEventListener("contextmenu",MO_OnContextmenuForIME,false);render_div.addEventListener("keydown",OnKeydownForNavigation,false);render_div.addEventListener("beforeinput",OnBeforeinputForAsciiChar,false);render_div.addEventListener("keyup",OnKeyup,false);nt_is_MacOS=true;break;case IME_TYPE.MAC_SAFARI:MO_InitComposition(render_div);render_div.addEventListener("compositionstart",MO_OnCompositionstart,false);render_div.addEventListener("compositionupdate",MO_OnCompositionupdate,false);render_div.addEventListener("compositionend",MO_OnCompositionend,false);render_div.addEventListener("keydown",MO_OnKeydownForIME,false);render_div.addEventListener("contextmenu",MO_OnContextmenuForIME,false);render_div.addEventListener("input",SAFARI_OnInputMarkingEnter,false);render_div.addEventListener("keydown",SAFARI_OnKeydownForNavigation,false);render_div.addEventListener("beforeinput",OnBeforeinputForAsciiChar,false);render_div.addEventListener("keyup",OnKeyup,false);nt_is_MacOS=true;break;default:MO_InitComposition(render_div);render_div.addEventListener("compositionstart",MO_OnCompositionstart,false);render_div.addEventListener("compositionupdate",MO_OnCompositionupdate,false);render_div.addEventListener("compositionend",MO_OnCompositionend,false);render_div.addEventListener("keydown",MO_OnKeydownForIME,false);render_div.addEventListener("contextmenu",MO_OnContextmenuForIME,false);render_div.addEventListener("keydown",OnKeydownForNavigation,false);render_div.addEventListener("keydown",OnKeydownForAsciiChar,false);render_div.addEventListener("keyup",OnKeyup,false);if(ime_type===IME_TYPE.MAC_FIREFOX){nt_is_MacOS=true}break}render_div.addEventListener("cut",OnCut,false);render_div.addEventListener("copy",OnCopy,false);render_div.addEventListener("paste",OnPaste,false);document.addEventListener("click",OnClick,false);render_div.addEventListener("mousedown",OnMouseDownTable,false);render_div.addEventListener("mousemove",OnMouseMoveTable,false);render_div.parentNode.parentNode.addEventListener("scroll",OnScroll,{passive:true});window.addEventListener("resize",OnScroll,{passive:true});undo_man=new UndoManager;undo_man.SetChangeEventDispatcher(new ChangeEventDispatcher(render_div))}let EDGE_input_event_args={data:null,isComposing:false,inputType:"insertText",dataTransfer:null};function EDGE_KeepForInputEvent(event){console.log("EDGE_KeepForInputEvent");if(event.key){EDGE_input_event_args.data=event.key;EDGE_input_event_args.isComposing=EDGE_IME_in_action;EDGE_input_event_args.inputType="insertText";EDGE_input_event_args.dataTransfer=null}}let SAFARI_is_just_after_compositionend=false;function SAFARI_OnInputMarkingEnter(event){if(event.inputType==="insertFromComposition"||event.inputType==="deleteCompositionText"){SAFARI_is_just_after_compositionend=true;return false}}function SAFARI_OnKeydownForNavigation(event){if(SAFARI_is_just_after_compositionend){SAFARI_is_just_after_compositionend=false;if(event.key==="Enter"||event.key==="Delete"||event.key==="Backspace"){event.preventDefault();console.log("cancel the",event.key,"just after IME end");return}}OnKeydownForNavigation(event);return}function NT_ResetChangeFlag(){undo_man.GetChangeEventDispatcher().Reset()}let nt_scroll_ticking=false;function OnScroll(event){if(!nt_scroll_ticking){window.requestAnimationFrame((()=>{if(!nt_now_printing){QuickRedrawMath(nt_render_div)}nt_scroll_ticking=false}));nt_scroll_ticking=true}}let nt_now_printing=false;let nt_focus_print=null;function NT_BeginPrint(){if(g_editable_math){DisableEdit(g_editable_math)}const selection=document.getSelection();nt_focus_print={anchorNode:selection.anchorNode,anchorOffset:selection.anchorOffset,focusNode:selection.focusNode,focusOffset:selection.focusOffset};FullRedrawMath(nt_render_div);nt_render_div.contentEditable="false";nt_now_printing=true}function NT_EndPrint(){nt_now_printing=false;nt_render_div.contentEditable="true";QuickRedrawMath(nt_render_div);document.getSelection().setBaseAndExtent(nt_focus_print.anchorNode,nt_focus_print.anchorOffset,nt_focus_print.focusNode,nt_focus_print.focusOffset)}"use strict";let nt_math_number_state=1;function NT_MathNumbering(checked_type){if(nt_render_div===null)return;console.log("mathnumbering = ",checked_type);if(checked_type==0){nt_math_number_state=0}else if(checked_type==1){nt_math_number_state=1}const render_div=nt_render_div;const fragment=FragmentFromChildren(render_div);InitializeMathInFragment(fragment,nt_math_number_state);render_div.appendChild(fragment)}function InitializeMathInFragment(fragment,number){let matches=fragment.querySelectorAll("span.math");for(let i=0;i<matches.length;i++){const math=matches[i];const margin=GetEditMargin(math);let text_node=math.lastChild.firstChild;let mathtext=text_node.data.substring(margin,text_node.length-margin);switch(math.lastChild.className){case"editmath":{const delta=MathRendering(math,mathtext,number);number+=delta;ShowPreview(math.firstChild)}break;case"editmathdisp":{const delta=MathRendering(math,mathtext,number);number+=delta;ShowPreviewDisplay(math.firstChild)}break;case"editcode":{math.firstChild.textContent=mathtext;ShowPreview(math.firstChild)}break;case"editcodedisp":{if(mathtext.charAt(0)==="\n"){math.firstChild.textContent=mathtext.slice(1,mathtext.length-1)}else{math.firstChild.textContent=mathtext}ShowPreviewDisplay(math.firstChild)}break;case"editdeleted":{math.firstChild.textContent=mathtext;ShowPreview(math.firstChild)}break;case"editimg":{let pos_split_a_img=mathtext.indexOf("](");if(pos_split_a_img<0){math.firstChild.alt=mathtext;math.firstChild.src=null}math.firstChild.src=nt_file_dir+mathtext.slice(pos_split_a_img+2,mathtext.length+1);math.firstChild.alt=mathtext.slice(0,pos_split_a_img);ShowPreview(math.firstChild)}break}SetHide(math.lastChild)}}"use strict";let g_label_eqnumber=new Map;function katexAutoNumber(mathtext,parent,number){const word_begin="\\begin{align}";const pos=mathtext.indexOf(word_begin);if(pos<0){return katexAutoNumber_woAligned(mathtext,parent,number)}else{mathtext=ReplaceAll(mathtext,"{align}","{aligned}");return katexAutoNumber_withAligned(mathtext,pos,parent,number)}}function katexAutoNumber_woAligned(mathtext,parent,number){let line_br_points=ListupBr(mathtext,0);let line_has_nonumber=ListUpNonumber(mathtext,line_br_points);let line_has_label=ListUpLabel(mathtext,line_br_points);RegisterLabelEqnumber(line_has_nonumber,line_has_label,number);mathtext=ReplaceAll(mathtext,"\\nonumber"," ");mathtext=ReplaceByRangeAll(mathtext,"\\label{","}"," ");mathtext=ReferLabelEqnumber(mathtext);const fragment=new DocumentFragment;katex.render(mathtext,fragment,{output:"html",displayMode:true,throwOnError:false});parent.insertBefore(fragment,parent.firstElementChild);let katex_html=FindFirstChild("katex-html",parent.firstElementChild);if(katex_html===null)return 0;let base=katex_html.firstElementChild;if(base===null)return 0;if(base.className!=="base")return 0;let b_parent=base.parentElement;let tag=null;let i_line=0;let my_number=number;while(base){if(line_has_nonumber[i_line]){tag=null}else{tag=document.createElement("SPAN");tag.className="tag";tag.appendChild(base.firstElementChild.cloneNode(true));if(tag.firstElementChild.className!=="strut"){alert("ERROR: auto numbering is miss")}tag.appendChild(document.createTextNode("("+my_number+")"));my_number++}base=base.nextElementSibling;while(base){if(base.className==="mspace newline"){let next=base.nextElementSibling;if(tag){base.before(tag);tag=null}base=next;break}base=base.nextElementSibling}++i_line}if(tag){b_parent.appendChild(tag);tag=null}return my_number-number}function katexAutoNumber_withAligned(mathtext,pos_begin,parent,number){{let line_br_points=ListupBr(mathtext,pos_begin+"\\begin{aligned}".length);let line_has_nonumber=ListUpNonumber(mathtext,line_br_points);let line_has_label=ListUpLabel(mathtext,line_br_points);RegisterLabelEqnumber(line_has_nonumber,line_has_label,number);mathtext=ReplaceAll(mathtext,"\\nonumber"," ");mathtext=ReplaceByRangeAll(mathtext,"\\label{","}"," ");mathtext=ReferLabelEqnumber(mathtext);mathtext="\\tag{"+number+"}"+mathtext;const fragment=new DocumentFragment;katex.render(mathtext,fragment,{output:"html",displayMode:true,throwOnError:false});parent.insertBefore(fragment,parent.firstElementChild);let katex_html=FindFirstChild("katex-html",parent.firstElementChild);if(katex_html===null)return 0;let base=katex_html.firstElementChild;if(base.className!=="base")return 0;let tag=base.nextElementSibling;if(tag.className!=="tag")return 0;let mtable=FindFirstChild("mtable",base.firstElementChild.nextElementSibling);if(mtable===null)return 0;let mtable_clone=mtable.cloneNode(true);{let first=mtable_clone.firstChild;while(first.nextSibling){first.nextSibling.remove()}}let vlist_r=FindFirstChild("vlist-r",mtable_clone.firstElementChild);if(vlist_r===null)return 0;let vlist=FindFirstChild("vlist",vlist_r.firstElementChild);if(vlist===null)return 0;console.log("vlist.childNodes.length = "+vlist.childNodes.length);let ve=vlist.firstElementChild;let my_number=number;let i=0;while(ve){let pstrut=FindFirstChild("pstrut",ve.firstElementChild);if(pstrut){let mord=pstrut.nextElementSibling;if(mord.className==="mord"){while(mord.firstChild){mord.removeChild(mord.firstChild)}if(!line_has_nonumber[i]){mord.appendChild(document.createTextNode("("+my_number+")"));my_number++}else{mord.appendChild(document.createTextNode(" "))}}}ve=ve.nextElementSibling;++i}let tag_mord_text=tag.firstElementChild.nextElementSibling;if(tag_mord_text===null)return 0;while(tag_mord_text.firstChild){tag_mord_text.removeChild(tag_mord_text.firstChild)}tag_mord_text.appendChild(mtable_clone);return my_number-number}}function FindFirstChild(class_name,start){let node=start;while(node){if(node.className===class_name){return node}node=node.firstElementChild}return node}function FindEndPos(text,offset){let p_begin=text.indexOf("\\begin",offset);let p_end=text.indexOf("\\end",offset);while(p_begin>=0){if(p_end<p_begin){return p_end}else{offset=FindEndPos(text,p_begin+1);offset++}p_begin=text.indexOf("\\begin",offset);p_end=text.indexOf("\\end",offset)}return p_end}function ListupBr(mathtext,offset_begin){let line_br_points=[];{let offset=offset_begin;let p_begin=mathtext.indexOf("\\begin",offset);let p_br=mathtext.indexOf("\\\\",offset);while(p_br>=0){if(p_begin>=0){if(p_br<p_begin){line_br_points.push(p_br);offset=p_br+1;p_br=mathtext.indexOf("\\\\",offset)}else{offset=FindEndPos(mathtext,p_begin+1);offset++;p_begin=mathtext.indexOf("\\begin",offset);p_br=mathtext.indexOf("\\\\",offset)}}else{line_br_points.push(p_br);offset=p_br+1;p_br=mathtext.indexOf("\\\\",offset)}}line_br_points.push(mathtext.length)}return line_br_points}function ListUpNonumber(mathtext,line_br_points){let line_has_nonumber=[];{let p_nonumber=mathtext.indexOf("\\nonumber",0);let i=0;while(p_nonumber>=0){if(line_br_points[i]<p_nonumber){line_has_nonumber.push(false)}else{line_has_nonumber.push(true);p_nonumber=mathtext.indexOf("\\nonumber",line_br_points[i])}++i;if(i>=line_br_points.length)break}while(i<line_br_points.length){line_has_nonumber.push(false);++i}if(line_br_points.length!==line_has_nonumber.length){alert("ERROR: analize nonumber in multi-line equations")}}return line_has_nonumber}function ListUpLabel(mathtext,line_br_points){let line_has_label=[];{let p_label=mathtext.indexOf("\\label",0);let i=0;while(p_label>=0){if(line_br_points[i]<p_label){line_has_label.push("")}else{const ib=mathtext.indexOf("{",p_label+6);if(ib<0){line_has_label.push("");alert("ERROR: \\label does not has next { character")}else{const ie=mathtext.indexOf("}",ib+1);if(ie<0){line_has_label.push("");alert("ERROR: \\label does not has next } character")}else{let word=mathtext.slice(ib+1,ie);line_has_label.push(word.trim())}}p_label=mathtext.indexOf("\\label",line_br_points[i])}++i;if(i>=line_br_points.length)break}while(i<line_br_points.length){line_has_label.push("");++i}if(line_br_points.length!==line_has_label.length){alert("ERROR: analize label in multi-line equations")}}return line_has_label}function RegisterLabelEqnumber(line_has_nonumber,line_has_label,number){const i_end=line_has_label.length;for(let i=0;i<i_end;++i){if(!line_has_nonumber[i]){if(line_has_label[i].length>0){g_label_eqnumber.set(line_has_label[i],number)}number++}}}function ReferLabelEqnumber(text_org){const target="\\ref";let offset=0;let i=text_org.indexOf(target,offset);if(i<0)return text_org;let result="";while(i>=0){let ib=text_org.indexOf("{",i+target.length);if(ib<0)break;let ie=text_org.indexOf("}",ib+1);if(ie<0)break;const label=text_org.slice(ib+1,ie).trim();if(g_label_eqnumber.has(label)){const eqnumber=g_label_eqnumber.get(label);result+=text_org.slice(offset,i)+eqnumber.toString()}else{result+=text_org.slice(offset,i)+"??"}offset=ie+1;i=text_org.indexOf(target,offset)}result+=text_org.slice(offset);return result}"use strict";let nt_prevent_shortcut=["Ctrl+B","Ctrl+I","Ctrl+U","Ctrl+Y","Ctrl+Delete","Ctrl+Backspace"];function OnKeydownForShortcut(event){if(event.isComposing){console.log("cancel for composing");return}if(event.getModifierState("Control")||event.getModifierState("Meta")){let shortcut_key="";if(nt_is_MacOS){shortcut_key+=event.getModifierState("Meta")?"Ctrl+":""}else{shortcut_key+=event.getModifierState("Control")?"Ctrl+":""}shortcut_key+=event.getModifierState("Shift")?"Shift+":"";shortcut_key+=event.key.length===1?event.key.toUpperCase():event.key;console.log(shortcut_key);switch(shortcut_key){case"Ctrl+Z":{event.preventDefault();NT_Dispatch("undo")}break;case"Ctrl+Shift+Z":{event.preventDefault();NT_Dispatch("redo")}break;case"Ctrl+A":{console.log("ctrl + a");event.preventDefault();NT_Dispatch("selectall")}break;default:{if(nt_prevent_shortcut.includes(shortcut_key)){console.log("prevent: default short cut");event.preventDefault()}else{console.log("through: default short cut")}}}}else{switch(event.key){case"F3":{event.preventDefault();if(event.getModifierState("Shift")){NT_Dispatch("findbackward")}else{NT_Dispatch("findforward")}break}case"F2":{PrintFocus();console.log("Undo history: "+undo_man.numHistory);event.preventDefault();return}}}}"use strict";const NT_LINK_DEFAULT_URL="https://sample.url";const NT_LINK_DEFAULT_TEXT="PreviewWord";function OnKeyup(event){switch(event.key){case"ArrowUp":case"ArrowDown":case"Home":case"End":case"PageUp":case"PageDown":{if(!CorrectSelectionEdgeTable()){event.preventDefault();return false}const selection=document.getSelection();console.log("keyup   fook: "+event.key+"focus: node="+selection.focusNode.tagName+", offset="+selection.focusOffset);const focus_math=CheckEditPreview(event.currentTarget);console.log("focus_math",focus_math,g_editable_math);if(focus_math){if(event.shiftKey){document.getSelection().extend(focus_math.node,focus_math.offset)}else{document.getSelection().collapse(focus_math.node,focus_math.offset)}}}break}}function OnKeydownForNavigation(event){if(event.isComposing){console.log("nothing to do for composing");return}if(IsTableSelectionMode()){OnKeydownForNavigationTable(event);return}console.log("keydown(Navi):",event.key);const selection=document.getSelection();let[node,offset]=selection.isCollapsed?CorrectFocusToText(selection.focusNode,selection.focusOffset):[selection.focusNode,selection.focusOffset];switch(event.key){case"ArrowUp":{const td=CheckNodeInTD(selection.focusNode,event.currentTarget);if(td){console.log("keydown Up, td: ",td);if(event.getModifierState("Shift")){if(IsHighlightMode()){NT_HighlightClear()}SetSelectTable(td,td);event.preventDefault()}else{const res=SwitchInputArrowUp(td);if(res){event.preventDefault()}}}}break;case"ArrowDown":{const td=CheckNodeInTD(selection.focusNode,event.currentTarget);if(td){console.log("keydown Down, td: ",td);if(event.getModifierState("Shift")){if(IsHighlightMode()){NT_HighlightClear()}SetSelectTable(td,td);event.preventDefault()}else{const res=SwitchInputArrowDown(td);if(res){event.preventDefault()}}}}break;case"ArrowLeft":{const res=SwitchInputArrowLeft(node,offset,event.getModifierState("Shift"));if(res){event.preventDefault()}}break;case"ArrowRight":{const res=SwitchInputArrowRight(node,offset,event.getModifierState("Shift"));if(res){event.preventDefault()}}break;case"Enter":{console.log("keydown fook: "+event.key+"focus:"+offset);event.preventDefault();if(selection.focusNode){if(selection.focusNode.scrollIntoView){selection.focusNode.scrollIntoView({behavior:"auto",block:"nearest"})}}if(selection.isCollapsed){let highlight_word=null;if(IsHighlightMode()){highlight_word=nt_highlight.Word;NT_HighlightClear()}[node,offset]=CorrectFocusToText(selection.focusNode,selection.focusOffset);SwitchInputEnter(node,offset,event.getModifierState("Shift"));if(highlight_word){NT_HighlightWord(highlight_word)}}}break;case"Delete":{console.log("keydown fook: "+event.key+"focus:"+offset);event.preventDefault();if(selection.focusNode){if(selection.focusNode.scrollIntoView){selection.focusNode.scrollIntoView({behavior:"auto",block:"nearest"})}}let highlight_word=null;if(IsHighlightMode()){highlight_word=nt_highlight.Word;NT_HighlightClear()}if(selection.isCollapsed){[node,offset]=CorrectFocusToText(selection.focusNode,selection.focusOffset);SwitchInputDelete(node,offset,event.getModifierState("Shift"))}else{CorrectSelectionEdgeTable();CutSelection(event.currentTarget,selection)}if(highlight_word){NT_HighlightWord(highlight_word)}}break;case"Backspace":{console.log("keydown fook: "+event.key+"focus:"+offset);event.preventDefault();if(selection.focusNode){if(selection.focusNode.scrollIntoView){selection.focusNode.scrollIntoView({behavior:"auto",block:"nearest"})}}let highlight_word=null;if(IsHighlightMode()){highlight_word=nt_highlight.Word;NT_HighlightClear()}if(selection.isCollapsed){[node,offset]=CorrectFocusToText(selection.focusNode,selection.focusOffset);SwitchInputBackspace(node,offset,event.getModifierState("Shift"))}else{CorrectSelectionEdgeTable();CutSelection(event.currentTarget,selection)}if(highlight_word){NT_HighlightWord(highlight_word)}}break;case"Tab":{event.preventDefault();let highlight_word=null;if(IsHighlightMode()){highlight_word=nt_highlight.Word;NT_HighlightClear()}if(event.getModifierState("Shift")){console.log("keydown fook: Shift + Tab, focus:"+offset);SwitchInputShiftTab(node,offset)}else{console.log("keydown fook: Tab, focus:"+offset);SwitchInputTab(node,offset)}if(highlight_word){NT_HighlightWord(highlight_word)}}break}return}function OnKeydownForAsciiChar(event){if(event.getModifierState("Control")||event.getModifierState("Alt")||event.getModifierState("Meta")){return}console.log("keydown(Ascii):",event.key);if(TryInputAsciiChar(event.key)){event.preventDefault()}}function TryInputAsciiChar(char){if(IsTableSelectionMode())return false;const selection=document.getSelection();switch(char){case"$":case"`":case"*":case"_":{let highlight_word=null;if(IsHighlightMode()){highlight_word=nt_highlight.Word;NT_HighlightClear()}let[node,offset]=CorrectFocusToText(selection.focusNode,selection.focusOffset);if(selection.isCollapsed){SwitchInputMath(char,node,offset)}else{const[anchor_node,anchor_offset]=CorrectFocusToText(selection.anchorNode,selection.anchorOffset);SwitchInputMathSelection(char,node,offset,anchor_node,anchor_offset)}if(highlight_word){NT_HighlightWord(highlight_word)}console.log("keydown: "+char+", make math");return true}break;case" ":{if(selection.isCollapsed){let highlight_word=null;if(IsHighlightMode()){highlight_word=nt_highlight.Word;NT_HighlightClear()}let[node,offset]=CorrectFocusToText(selection.focusNode,selection.focusOffset);const res=SwitchInputSpace(node,offset);if(!res){SwitchInputChar(char,node,offset)}if(highlight_word){NT_HighlightWord(highlight_word)}}return true}break;case"|":{if(selection.isCollapsed){let highlight_word=null;if(IsHighlightMode()){highlight_word=nt_highlight.Word;NT_HighlightClear()}let[node,offset]=CorrectFocusToText(selection.focusNode,selection.focusOffset);const res=SwitchInputBar(node,offset);if(!res){SwitchInputChar(char,node,offset)}if(highlight_word){NT_HighlightWord(highlight_word)}}return true}break;case"^":{if(selection.isCollapsed){let highlight_word=null;if(IsHighlightMode()){highlight_word=nt_highlight.Word;NT_HighlightClear()}let[node,offset]=CorrectFocusToText(selection.focusNode,selection.focusOffset);const res=SwitchInputHat(node,offset);if(!res){SwitchInputChar(char,node,offset)}if(highlight_word){NT_HighlightWord(highlight_word)}}return true}break;case"~":{let highlight_word=null;if(IsHighlightMode()){highlight_word=nt_highlight.Word;NT_HighlightClear()}let[node,offset]=CorrectFocusToText(selection.focusNode,selection.focusOffset);if(selection.isCollapsed){const res=SwitchInputTilde(node,offset);if(!res){SwitchInputChar(char,node,offset)}}else{const[anchor_node,anchor_offset]=CorrectFocusToText(selection.anchorNode,selection.anchorOffset);SwitchInputMathSelection(`~~`,node,offset,anchor_node,anchor_offset)}if(highlight_word){NT_HighlightWord(highlight_word)}return true}break;case"(":{if(selection.isCollapsed){let highlight_word=null;if(IsHighlightMode()){highlight_word=nt_highlight.Word;NT_HighlightClear()}let[node,offset]=CorrectFocusToText(selection.focusNode,selection.focusOffset);const res=SwitchInputRoundBra(node,offset);if(!res){SwitchInputChar(char,node,offset)}if(highlight_word){NT_HighlightWord(highlight_word)}}return true}break;default:{console.log("keydown: "+char);if(char){if(char.length===1){let highlight_word=null;if(IsHighlightMode()){highlight_word=nt_highlight.Word;NT_HighlightClear()}if(!selection.isCollapsed){CorrectSelectionEdgeTable();CutSelection(event.currentTarget,selection)}let[node,offset]=CorrectFocusToText(selection.focusNode,selection.focusOffset);SwitchInputChar(char,node,offset);if(highlight_word){NT_HighlightWord(highlight_word)}return true}}}break}return false}function OnBeforeinputForAsciiChar(event){if(event.inputType==="insertText"){if(TryInputAsciiChar(event.data)){event.preventDefault()}}}function SwitchInputChar(text,node,offset){if(node===null)return false;if(node.nodeType===Node.TEXT_NODE){if(IsTextNodeInMath(node)){const math=node.parentNode.parentNode;const margin=GetEditMargin(math);if(offset<margin)return true;if(offset>node.length-margin)return true}else if(node.data==nt_ZWBR){undo_man.Begin(node,offset);InsertTextIntoText(text,node,1);DeleteText(node,0,1);undo_man.End(node,text.length);document.getSelection().collapse(node,text.length);return true}undo_man.Begin(node,offset);InsertTextIntoText(text,node,offset);undo_man.End(node,offset+text.length);document.getSelection().collapse(node,offset+text.length);return true}switch(node.tagName){case"P":case"LI":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"FIGCAPTION":case"TH":case"TD":{const num_children=node.childNodes.length;if(offset===0){if(node.firstChild.nodeName==="BR"){const br_node=node.firstChild;const is_br_end=br_node=>{if(br_node.nextSibling===null)return true;if(br_node.nextSibling.nodeName==="OL"||br_node.nextSibling.nodeName==="UL")return true;return true};if(is_br_end(br_node)){undo_man.Begin(node,offset);const new_node=AddTextNode(text,node,br_node);RemoveNode(br_node);undo_man.End(new_node,new_node.length);document.getSelection().collapse(new_node,new_node.length);return true}}}if(offset>0){let target=node.childNodes.item(offset-1);if(target.nodeType===Node.TEXT_NODE){undo_man.Begin(target,target.length);InsertTextIntoText(text,target,target.length);undo_man.End(target,target.length);document.getSelection().collapse(target,target.length);return true}}if(offset<num_children){let target=node.childNodes.item(offset);if(target.nodeType===Node.TEXT_NODE){undo_man.Begin(target,0);InsertTextIntoText(text,target,0);undo_man.End(target,text.length);document.getSelection().collapse(target,text.length);return true}}undo_man.Begin(node,offset);let ref_node=node.childNodes.item(offset);let text_node=AddTextNode(text,node,ref_node);if(IsSpanMathRef(ref_node)){ConvertMathRefToCite(ref_node)}undo_man.End(text_node,text_node.length);document.getSelection().collapse(text_node,text_node.length);return true}break;default:alert("ERROR: InputChar at "+node.tagName);break}return false}function FillTdBr(tr,tag_name,num_column){while(tr.childNodes.length<num_column){const td=AddNode(tag_name,tr,null);AddNode("BR",td,null)}}function SwitchInputEnter(node,offset,is_shift){if(node===null)return true;const origin={node:node,offset:offset};let should_devide=false;if(node.nodeType===Node.TEXT_NODE){switch(node.parentNode.tagName){case"P":case"LI":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"FIGCAPTION":case"TH":case"TD":{if(offset===node.length){console.log("go to divide node: "+node.parentNode.tagName);offset=GetIndex(node.parentNode,node)+1;node=node.parentNode}else{console.log("go to divide node: "+node.parentNode.tagName);should_devide=offset>0;offset=GetIndex(node.parentNode,node);node=node.parentNode}}break;case"SPAN":if(IsTextNodeInMath(node)){const math=node.parentNode.parentNode;if(node.parentNode.className=="editmathdisp"||node.parentNode.className=="editcodedisp"){const margin=GetEditMargin(math);if(margin<=offset&&offset<=node.length-margin){undo_man.Begin(node,offset);InsertTextIntoText("\n",node,offset);undo_man.End(node,offset+1);document.getSelection().collapse(node,offset+1);return true}}}return true;default:return true}}switch(node.tagName){case"P":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":{undo_man.Begin(origin.node,origin.offset);if(should_devide){DivideTextNode(origin.node,origin.offset);++offset}if(offset===0){const p_node=AddNode("P",node.parentNode,node);AddNode("BR",p_node,null);undo_man.End(node,0);document.getSelection().collapse(node,0);return true}if(node.childNodes.length===offset){const p_node=AddNode("P",node.parentNode,node.nextSibling);AddNode("BR",p_node,null);undo_man.End(p_node,0);document.getSelection().collapse(p_node,0);return true}const new_node=AddNode("P",node.parentNode,node.nextSibling);const fragment=SafeRemoveNodeList(node,node.childNodes.item(offset));let focus=SafePushNodeList(new_node,fragment);if(new_node.firstChild.nodeType===Node.TEXT_NODE){if(new_node.firstChild.data==nt_ZWBR){if(IsSpanMathImg(new_node.firstChild.nextSibling)){const figure=ConvertPtoFigure(new_node)}else{if(IsSpanMathCite(new_node.firstChild.nextSibling)){ConvertMathCiteToRef(new_node.firstChild.nextSibling)}}}}document.getSelection().collapse(focus.node,focus.offset);undo_man.End(focus.node,focus.offset)}break;case"LI":{undo_man.Begin(origin.node,origin.offset);if(should_devide){DivideTextNode(origin.node,origin.offset);++offset}if(offset===0){if(node.previousSibling===null){if(node.parentNode.parentNode.nodeName==="DIV"){const p_node=AddNode("P",node.parentNode.parentNode,node.parentNode);AddNode("BR",p_node,null);undo_man.End(node,0);document.getSelection().collapse(node,0);return true}}else if(node.nextSibling===null){if(node.firstChild.nodeName==="BR"&&node.firstChild.nextSibling===null){if(node.parentNode.parentNode.nodeName==="DIV"){const p_node=AddNode("P",node.parentNode.parentNode,node.parentNode.nextSibling);AddNode("BR",p_node,null);undo_man.End(p_node,0);document.getSelection().collapse(p_node,0);return true}}}const li_node=AddNode("LI",node.parentNode,node);AddNode("BR",li_node,null);undo_man.End(node,0);document.getSelection().collapse(node,0);return true}if(node.childNodes.length===offset){const p_node=AddNode("LI",node.parentNode,node.nextSibling);AddNode("BR",p_node,null);undo_man.End(p_node,0);document.getSelection().collapse(p_node,0);return true}else{const ref=node.childNodes.item(offset);if(ref.nodeName==="OL"||ref.nodeName==="UL"){AddNode("BR",node,ref)}}const new_node=AddNode("LI",node.parentNode,node.nextSibling);const fragment=SafeRemoveNodeList(node,node.childNodes.item(offset));const focus=SafePushNodeList(new_node,fragment);undo_man.End(focus.node,focus.offset);document.getSelection().collapse(focus.node,focus.offset)}break;case"FIGCAPTION":{undo_man.Begin(origin.node,origin.offset);const figure=node.parentNode;if(offset===0){const p_node=AddNode("P",figure.parentNode,figure.nextSibling);const fragment=RemoveNodeList(node,node.firstChild,null);SafePushNodeList(p_node,fragment);AddNode("BR",node,null);undo_man.End(p_node,0);document.getSelection().collapse(p_node,0);return true}if(node.childNodes.length===offset){AddNode("BR",node,null)}const new_node=AddNode("P",figure.parentNode,figure.nextSibling);const fragment=SafeRemoveNodeList(node,node.childNodes.item(offset),null);const focus=SafePushNodeList(new_node,fragment);document.getSelection().collapse(focus.node,focus.offset);undo_man.End(focus.node,focus.offset);return true}break;case"FIGURE":{if(offset===0&&origin.offset==0){undo_man.Begin(origin.node,origin.offset);const new_node=AddNode("P",node.parentNode,node);AddNode("BR",new_node,null);undo_man.End(new_node,0);document.getSelection().collapse(new_node,0);return true}document.getSelection().collapse(origin.node,origin.offset);return true}break;case"TH":{if(!is_shift){const table=node.parentNode.parentNode;if(table.previousSibling===null){undo_man.Begin(origin.node,origin.offset);const p=AddNode("P",table.parentNode,table);AddNode("BR",p,null);undo_man.End(p,0);document.getSelection().collapse(p,0)}}return true}break;case"TD":{if(!is_shift){const table=node.parentNode.parentNode;if(table.nextSibling===null){undo_man.Begin(origin.node,origin.offset);const p=AddNode("P",table.parentNode,null);AddNode("BR",p,null);undo_man.End(p,0);document.getSelection().collapse(p,0)}return true}const org_tr=node.parentNode;const table=org_tr.parentNode;if(org_tr===table.firstChild.nextSibling){return true}undo_man.Begin(origin.node,origin.offset);if(should_devide){DivideTextNode(origin.node,origin.offset);++offset}const new_tr=AddNode("TR",table,org_tr.nextSibling);let fnode=null;if(offset<node.childNodes.length){const fragment=SafeRemoveNodeList(node,node.childNodes.item(offset),null);const new_td=AddNode(node.tagName,new_tr,null);SafePushNodeList(new_td,fragment);if(!node.hasChildNodes()){AddNode("BR",node,null)}}if(node!==org_tr.lastChild){const fragment=RemoveNodeList(org_tr,node.nextSibling,null);AddNodeList(new_tr,null,fragment)}const num_column=table.firstChild.childNodes.length;FillTdBr(org_tr,"TD",num_column);FillTdBr(new_tr,"TD",num_column);const focus=FocusOffsetZero(new_tr);undo_man.End(focus.node,focus.offset);document.getSelection().collapse(focus.node,focus.offset);return true}break;default:alert("ERROR: InputEnter at "+node.nodeName);break}return true}function SwitchInputDelete(node,offset,is_shift){if(node===null)return;const origin={node:node,offset:offset};if(node.nodeType===Node.TEXT_NODE){switch(node.parentNode.tagName){case"P":case"LI":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"FIGCAPTION":case"FIGURE":case"TH":case"TD":{if(node.data==nt_ZWBR){offset=1}if(offset===node.length){if(node.nextSibling===null){console.log("go to parent: "+node.parentNode.tagName);node=node.parentNode;offset=node.childNodes.length}else if(node.nextSibling.nodeType===Node.TEXT_NODE){undo_man.Begin(node,offset);CombineTextNode(node);DeleteText(node,offset);undo_man.End(node,offset);document.getSelection().collapse(node,offset);return}else if(node.nextSibling.className==="math"){const math=node.nextSibling;const focus=EnableMathEdit(math,1);document.getSelection().collapse(focus.node,focus.offset);return}else{console.log("go to  parent: "+node.parentNode.tagName);offset=GetIndex(node.parentNode,node)+1;node=node.parentNode}}else{undo_man.Begin(node,offset);const focus=SafeDeleteInTextNode(node,offset);if(focus){undo_man.End(focus.node,focus.offset);document.getSelection().collapse(focus.node,focus.offset)}else{undo_man.Cancel()}return}}break;case"SPAN":if(IsTextNodeInMath(node)){const math=node.parentNode.parentNode;const margin=GetEditMargin(math);if(offset===node.length){node=math.parentNode;offset=GetIndex(node,math)+1;break}else if(offset===node.length-1){SwitchInputArrowRight(node,offset,false);return}else if(offset<margin||node.length-margin<=offset){if(node.parentNode.className==="editem2"||node.parentNode.className==="editem3"){const mark=node.data.slice(0,1);undo_man.Begin(node,offset);let math_old=node.parentNode.parentNode;let math_new=AddMathNode(mark.repeat(margin-1),math_old.parentNode,math_old);console.log("inline em and strong is rank down: ",math_new);if(math_new){InsertTextIntoText(node.data.slice(margin,node.length-margin),math_new.lastChild.lastChild,margin-1);RemoveNode(math_old)}const focus=EnableMathEdit(math_new,offset<margin?offset:offset-1);document.getSelection().collapse(focus.node,focus.offset);undo_man.End(focus.node,focus.offset);return}else{document.getSelection().collapse(node,offset+1);return}}else{undo_man.Begin(node,offset);const focus=SafeDeleteInTextNode(node,offset);if(focus){undo_man.End(focus.node,focus.offset);document.getSelection().collapse(focus.node,focus.offset)}else{undo_man.Cancel()}return}}break;default:return}}if(node.hasChildNodes()){const z=node.childNodes.item(offset);if(z){if(z.nodeType===Node.TEXT_NODE){if(z.data==nt_ZWBR){offset++}}}}switch(node.tagName){case"P":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":{undo_man.Begin(origin.node,origin.offset);if(node.firstChild.nodeName==="BR"&&node.firstChild.nextSibling===null){if(node.nextSibling===null){undo_man.Cancel();return}if(node.nextSibling.nodeName=="FIGURE"){undo_man.Cancel();return}const next=node.nextSibling;RemoveNode(node);if(next.firstChild.nodeType===Node.TEXT_NODE){undo_man.End(next.firstChild,0);document.getSelection().collapse(next.firstChild,0)}else if(next.tagName==="OL"||next.tagName==="UL"){undo_man.End(next.firstChild,0);document.getSelection().collapse(next.firstChild,0)}else{undo_man.End(next,0);document.getSelection().collapse(next,0)}return}if(offset<node.childNodes.length){let ch=node.childNodes.item(offset);if(ch.nodeType===Node.TEXT_NODE){const focus=SafeDeleteInTextNode(ch,0);if(focus){undo_man.End(focus.node,focus.offset);document.getSelection().collapse(focus.node,focus.offset)}else{undo_man.Cancel()}}else if(ch.nodeName==="BR"){RemoveNode(ch);undo_man.End(node,offset);document.getSelection().collapse(node,offset)}else if(ch.className==="math"){const focus=EnableMathEdit(ch,1);document.getSelection().collapse(focus.node,focus.offset)}else if(ch.tagName==="OL"||ch.tagName==="UL"){alert("ERROR: p node cannot have a child of ol/ul.")}else{alert("ERROR: delete key before undefined element")}}else{if(node.nextSibling===null){console.log("delete but EOF")}else if(node.nextSibling.tagName==="P"||node.nextSibling.tagName==="H1"||node.nextSibling.tagName==="H2"||node.nextSibling.tagName==="H3"||node.nextSibling.tagName==="H4"||node.nextSibling.tagName==="H5"||node.nextSibling.tagName==="H6"){const latter_head=node.nextSibling.firstChild;if(IsSpanMathRef(latter_head)){ConvertMathRefToCite(latter_head)}const focus=SafeCombineNode(node);if(focus){document.getSelection().collapse(focus.node,focus.offset);undo_man.End(focus.node,focus.offset)}else{undo_man.Cancel()}}else if(node.nextSibling.tagName==="OL"||node.nextSibling.tagName==="UL"){let ol=node.nextSibling;let ol_li=ol.firstChild;let end_point=ol_li.firstChild;if(end_point.nodeName==="BR"){if(end_point.nextSibling===null){RemoveNode(ol_li)}else{const ol2=end_point.nextSibling;if(ol2.nodeName!=="OL"&&ol2.nodeName!=="UL"){alert("ERROR: li has some node after br");undo_man.Cancel();return}const frag=RemoveNodeList(ol2,ol2.firstChild,null);AddNodeList(ol,ol_li,frag);RemoveNode(ol_li)}if(!ol.hasChildNodes()){RemoveNode(ol)}undo_man.End(node,offset);document.getSelection().collapse(node,offset)}else{while(end_point){if(end_point.nodeName==="OL")break;if(end_point.nodeName==="UL")break;end_point=end_point.nextSibling}const fragment=RemoveNodeList(ol_li,ol_li.firstChild,end_point);const focus=SafePushNodeList(node,fragment);if(end_point){const fragment2=RemoveNodeList(end_point,end_point.firstChild);AddNodeList(ol,ol_li,fragment2)}RemoveNode(ol_li);if(!ol.hasChildNodes()){RemoveNode(ol)}undo_man.End(focus.node,focus.offset);document.getSelection().collapse(focus.node,focus.offset);return true}}else if(node.nextSibling.tagName==="FIGURE"){const figure=node.nextSibling;const math_img=figure.firstChild;let end_point=figure.firstChild;while(end_point){if(end_point.nodeName==="FIGCAPTION")break;end_point=end_point.nextSibling}let focus=null;if(figure.firstChild!==end_point){const fragment=RemoveNodeList(figure,figure.firstChild,end_point);focus=SafePushNodeList(node,fragment)}if(end_point){const fragment=RemoveNodeList(end_point,end_point.firstChild,null);const f2=SafePushNodeList(node,fragment);if(focus===null){focus=f2}}RemoveNode(figure);document.getSelection().collapse(focus.node,focus.offset);undo_man.End(focus.node,focus.offset)}else{alert("WARNING: delete key before undefined element")}}}break;case"LI":{undo_man.Begin(origin.node,origin.offset);if(node.firstChild.nodeName==="BR"){if(node.firstChild.nextSibling){const ol2=node.firstChild.nextSibling;if(ol2.nodeName!=="OL"&&ol2.nodeName!=="UL"){alert("ERROR: li has some node after br");undo_man.Cancel();return}let frag=RemoveNodeList(ol2,ol2.firstChild,null);const new_node=AddNodeList(node.parentNode,node,frag);RemoveNode(node);undo_man.End(new_node,0);document.getSelection().collapse(new_node,0);return}offset++}if(offset<node.childNodes.length){let ch=node.childNodes.item(offset);if(ch.nodeType===Node.TEXT_NODE){const focus=SafeDeleteInTextNode(ch,0);if(focus){undo_man.End(focus.node,focus.offset);document.getSelection().collapse(focus.node,focus.offset)}else{undo_man.Cancel()}}else if(ch.className==="math"){const focus=EnableMathEdit(ch,1);document.getSelection().collapse(focus.node,focus.offset);undo_man.Cancel()}else if(ch.tagName==="OL"||ch.tagName==="UL"){const focus=RaiseFirstLi(ch);if(focus){undo_man.End(focus.node,focus.offset);document.getSelection().collapse(focus.node,focus.offset)}else{undo_man.End(node,offset);document.getSelection().collapse(node,offset)}}else{alert("ERROR: delete key before undefined element");undo_man.Cancel()}}else{if(node.nextSibling){if(node.nextSibling.nodeName!=="LI"){alert("WARNING: delete key before undefined element");undo_man.Cancel();return}const focus=SafeCombineNode(node);if(focus){document.getSelection().collapse(focus.node,focus.offset);undo_man.End(focus.node,focus.offset)}else{undo_man.Cancel()}}else{console.log("delete end of ol/ul");let parent_ol=node.parentNode;if(parent_ol.nextSibling){if(parent_ol.nextSibling.nodeName==="P"){const p=parent_ol.nextSibling;const fragment=RemoveNodeList(parent_ol.nextSibling,parent_ol.nextSibling.firstChild);RemoveNode(p);const focus=SafePushNodeList(node,fragment);if(focus){document.getSelection().collapse(focus.node,focus.offset);undo_man.End(focus.node,focus.offset)}else{undo_man.Cancel()}}else if(parent_ol.nextSibling.nodeName==="OL"||parent_ol.nextSibling.tagName==="UL"){let fragment=RemoveNodeList(parent_ol.nextSibling,parent_ol.nextSibling.firstChild);AddNodeList(parent_ol,node.nextSibling,fragment);RemoveNode(parent_ol.nextSibling);undo_man.End(node,offset);document.getSelection().collapse(node,offset)}else if(parent_ol.nextSibling.nodeName==="FIGURE"){const figure=parent_ol.nextSibling;const math_img=figure.firstChild;let end_point=figure.firstChild;while(end_point){if(end_point.nodeName==="FIGCAPTION")break;end_point=end_point.nextSibling}let focus=null;if(figure.firstChild!==end_point){const fragment=RemoveNodeList(figure,figure.firstChild,end_point);focus=SafePushNodeList(node,fragment)}if(end_point){if(end_point.nodeName==="FIGCAPTION"){const fragment=RemoveNodeList(end_point,end_point.firstChild,null);const f2=SafePushNodeList(node,fragment);if(focus===null){focus=f2}}}RemoveNode(figure);undo_man.End(focus.node,focus.offset);document.getSelection().collapse(focus.node,focus.offset)}else{console.log("nothing to do: "+parent_ol.nextSibling.tagName)}}else{let parent_parent=node.parentNode.parentNode;if(parent_parent.tagName==="LI"){if(parent_parent.nextSibling){let fragment=RemoveNodeList(parent_parent.parentNode,parent_parent.nextSibling,parent_parent.nextSibling.nextSibling);AddNodeList(parent_ol,node.nextSibling,fragment);undo_man.End(node,offset);document.getSelection().collapse(node,offset)}}}}}}break;case"FIGCAPTION":{undo_man.Begin(origin.node,origin.offset);if(node.firstChild.nodeName==="BR"&&node.firstChild.nextSibling===null){offset=1}if(offset<node.childNodes.length){let ch=node.childNodes.item(offset);if(ch.nodeType===Node.TEXT_NODE){const focus=SafeDeleteInTextNode(ch,0);if(focus){undo_man.End(focus.node,focus.offset);document.getSelection().collapse(focus.node,focus.offset)}else{undo_man.Cancel()}}else if(ch.nodeName==="BR"){RemoveNode(ch);undo_man.End(node,offset);document.getSelection().collapse(node,offset)}else if(ch.className==="math"){const focus=EnableMathEdit(ch,1);document.getSelection().collapse(focus.node,focus.offset)}else if(ch.tagName==="OL"||ch.tagName==="UL"){alert("ERROR: figcaption node cannot have a child of ol/ul.")}else{alert("ERROR: delete key before undefined element")}}else{const next=node.parentNode.nextSibling;if(next===null){console.log("delete but EOF")}else if(next.tagName==="P"||next.tagName==="H1"||next.tagName==="H2"||next.tagName==="H3"||next.tagName==="H4"||next.tagName==="H5"||next.tagName==="H6"){const fragment=RemoveNodeList(next,next.firstChild,null);const focus=SafePushNodeList(node,fragment);RemoveNode(next);document.getSelection().collapse(focus.node,focus.offset);undo_man.End(focus.node,focus.offset)}else if(next.tagName==="OL"||next.tagName==="UL"){let ol=next;let ol_li=ol.firstChild;let end_point=ol_li.firstChild;let fnode=node.firstChild;let foffset=0;while(end_point){if(end_point.nodeName==="OL")break;if(end_point.nodeName==="UL")break;end_point=end_point.nextSibling}const fragment=RemoveNodeList(ol_li,ol_li.firstChild,end_point);let focus=SafePushNodeList(node,fragment);if(end_point){const fragment2=RemoveNodeList(end_point,end_point.firstChild);AddNodeList(ol,ol_li,fragment2)}RemoveNode(ol_li);if(!ol.hasChildNodes()){RemoveNode(ol)}document.getSelection().collapse(focus.node,focus.offset);undo_man.End(focus.node,focus.offset)}else if(next.tagName==="FIGURE"){const figure=next;const math_img=figure.firstChild;let end_point=figure.firstChild;while(end_point){if(end_point.nodeName==="FIGCAPTION")break;end_point=end_point.nextSibling}let focus=null;if(figure.firstChild!==end_point){const fragment=RemoveNodeList(figure,figure.firstChild,end_point);focus=SafePushNodeList(node,fragment)}if(end_point){if(end_point.nodeName==="FIGCAPTION"){const fragment=RemoveNodeList(end_point,end_point.firstChild,null);const f2=SafePushNodeList(node,fragment);if(focus===null){focus=f2}}}RemoveNode(figure);undo_man.End(focus.node,focus.offset);document.getSelection().collapse(focus.node,focus.offset)}else{alert("WARNING: delete key before undefined element")}}}break;case"TH":case"TD":{undo_man.Begin(origin.node,origin.offset);if(node.firstChild.nodeName==="BR"&&node.firstChild.nextSibling===null){offset=1}if(offset<node.childNodes.length){let ch=node.childNodes.item(offset);if(ch.nodeType===Node.TEXT_NODE){const focus=SafeDeleteInTextNode(ch,0);if(focus){undo_man.End(focus.node,focus.offset);document.getSelection().collapse(focus.node,focus.offset)}else{undo_man.Cancel()}}else if(ch.nodeName==="BR"){RemoveNode(ch);undo_man.End(node,offset);document.getSelection().collapse(node,offset)}else if(ch.className==="math"){const focus=EnableMathEdit(ch,1);document.getSelection().collapse(focus.node,focus.offset)}else if(ch.tagName==="OL"||ch.tagName==="UL"){alert("ERROR: td node cannot have a child of ol/ul.")}else{alert("ERROR: delete key before undefined element")}}else{if(!is_shift){break}if(node.nextSibling){const next=node.nextSibling;const fragment=RemoveNodeList(next,next.firstChild,null);const focus=SafePushNodeList(node,fragment);RemoveNode(next);const new_td=AddNode(node.tagName,node.parentNode,null);AddNode("BR",new_td,null);document.getSelection().collapse(focus.node,focus.offset);undo_man.End(focus.node,focus.offset);return}else{const next_tr=node.parentNode.nextSibling;if(next_tr){RemoveNode(next_tr);undo_man.End(node,offset);document.getSelection().collapse(node,offset);return}}}}break;default:alert("ERROR: Delete at "+node.tagName);break}undo_man.Cancel()}function SafeDeleteInTextNode(node,offset){if(node.data==nt_ZWBR){console.error("tring to delete ZWBR");return null}if(node.length===1){const parent=node.parentNode;const next=node.nextSibling;RemoveNode(node);const focus=SafeJunctionPoint(parent,next);return focus}else{DeleteText(node,offset);return{node:node,offset:offset}}}function GetIdealFocus(node,offset){if(node.nodeType===Node.TEXT_NODE){return[node,offset]}else{if(node.previousSibling&&offset===0){if(node.previousSibling.nodeType===Node.TEXT_NODE){return[node.previousSibling,node.previousSibling.length]}}if(!node.hasChildNodes()){return[node.parentNode,GetIndex(node.parentNode,node)]}else{const ch=node.childNodes.item(offset);if(ch){if(ch.nodeType===Node.TEXT_NODE){return[ch,0]}else{const prev=ch.previousSibling;if(prev){if(prev.nodeType===Node.TEXT_NODE){return[prev,prev.length]}}return GetIdealFocus(ch.firstChild,0)}}else{const prev=node.childNodes.item(offset-1);if(prev.nodeType===Node.TEXT_NODE){return[prev,prev.length]}else{if(prev.hasChildNodes()){return GetIdealFocus(prev,prev.childNodes.length)}else{return[node,offset-1]}}}}}}function RaiseFirstLi(ol_node){const ol_li=ol_node.firstChild;if(ol_li.firstChild.nodeName=="BR"&&ol_li.childNodes.length==1){if(ol_li.nextSibling){RemoveNode(ol_li);return null}else{RemoveNode(ol_node);return null}}else{const fragment=RemoveNodeList(ol_li,ol_li.firstChild);RemoveNode(ol_li);const head=AddNodeList(ol_node.parentNode,ol_node,fragment);const focus=SafeJunctionPoint(ol_node.parentNode,head);if(ol_node.hasChildNodes()){SafeJunctionPoint(ol_node.parentNode,ol_node)}else{RemoveNode(ol_node)}return focus}}function LastFocusInList(prev){let last_li=prev.lastChild;while(last_li.lastChild.nodeName==="OL"||last_li.lastChild.nodeName==="UL"){last_li=last_li.lastChild.lastChild}if(last_li.lastChild.nodeType===Node.TEXT_NODE){return[last_li.lastChild,last_li.lastChild.length]}else{return[last_li,last_li.childNodes.length]}}function SwitchInputBackspace(node,offset,is_shift){if(node===null)return;const origin={node:node,offset:offset};if(node.nodeType===Node.TEXT_NODE){switch(node.parentNode.tagName){case"P":case"LI":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"FIGCAPTION":case"FIGURE":case"TH":case"TD":{if(node.data==nt_ZWBR){offset=0}if(offset>0){undo_man.Begin(node,offset);const focus=SafeDeleteInTextNode(node,offset-1);if(focus){undo_man.End(focus.node,focus.offset);document.getSelection().collapse(focus.node,focus.offset)}else{undo_man.Cancel()}return}else{if(node.previousSibling===null){console.log("go to parent: "+node.parentNode.tagName);node=node.parentNode;offset=0}else if(node.previousSibling.nodeType===Node.TEXT_NODE){undo_man.Begin(node,offset);const focus_node=node.previousSibling;const focus_offset=node.previousSibling.length-1;CombineTextNode(focus_node);DeleteText(focus_node,focus_offset);undo_man.End(focus_node,focus_offset);document.getSelection().collapse(focus_node,focus_offset);return}else if(node.previousSibling.className==="math"){const math=node.previousSibling;const focus=EnableMathEdit(math,-1);document.getSelection().collapse(focus.node,focus.offset);return}else{console.log("go to  parent: "+node.parentNode.tagName);offset=GetIndex(node.parentNode,node)-1;node=node.parentNode}}break}case"SPAN":if(IsTextNodeInMath(node)){const math=node.parentNode.parentNode;const margin=GetEditMargin(math);if(offset===0){node=math.parentNode;offset=GetIndex(node,math);break}else if(offset===1){SwitchInputArrowLeft(node,offset,false);return}else if(offset<=margin||node.length-margin<offset){if(node.parentNode.className==="editem2"||node.parentNode.className==="editem3"){const mark=node.data.slice(0,1);undo_man.Begin(node,offset);let math_old=node.parentNode.parentNode;let math_new=AddMathNode(mark.repeat(margin-1),math_old.parentNode,math_old);console.log("inline em and strong is rank down: ",math_new);if(math_new){InsertTextIntoText(node.data.slice(margin,node.length-margin),math_new.lastChild.lastChild,margin-1);RemoveNode(math_old)}const focus=EnableMathEdit(math_new,offset<=margin?offset-1:offset-2);document.getSelection().collapse(focus.node,focus.offset);undo_man.End(focus.node,focus.offset);return}else{document.getSelection().collapse(node,offset-1);return}}else{undo_man.Begin(node,offset);const focus=SafeDeleteInTextNode(node,offset-1);if(focus){undo_man.End(focus.node,focus.offset);document.getSelection().collapse(focus.node,focus.offset)}else{undo_man.Cancel()}return}}break;default:return}}if(node.hasChildNodes()){const z=node.childNodes.item(offset-1);if(z){if(z.nodeType===Node.TEXT_NODE){if(z.data==nt_ZWBR){offset--}}}}switch(node.tagName){case"P":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":{undo_man.Begin(origin.node,origin.offset);if(node.firstChild.nodeName==="BR"&&node.firstChild.nextSibling===null){if(node.previousSibling===null){undo_man.Cancel();return}const prev=node.previousSibling;RemoveNode(node);let fnode=null;let foffset=0;if(prev.lastChild.nodeType===Node.TEXT_NODE){fnode=prev.lastChild;foffset=prev.lastChild.length}else if(prev.nodeName==="OL"||prev.nodeName==="UL"){[fnode,foffset]=LastFocusInList(prev)}else{fnode=prev;foffset=prev.childNodes.length;if(prev.lastChild.nodeName==="BR"){foffset--}}undo_man.End(fnode,foffset);document.getSelection().collapse(fnode,foffset);return}if(offset>0){let ch=node.childNodes.item(offset-1);if(ch.nodeType===Node.TEXT_NODE){const focus=SafeDeleteInTextNode(ch,ch.length-1);if(focus){undo_man.End(focus.node,focus.offset);document.getSelection().collapse(focus.node,focus.offset)}else{undo_man.Cancel()}}else if(ch.tagName==="BR"){RemoveNode(ch);undo_man.End(node,offset-1);document.getSelection().collapse(node,offset-1)}else if(ch.className==="math"){const focus=EnableMathEdit(ch,-1);document.getSelection().collapse(focus.node,focus.offset);undo_man.Cancel()}else if(ch.tagName==="OL"||ch.tagName==="UL"){alert("ERROR: p node cannot have a child of ol/ul.");undo_man.Cancel()}else{alert("ERROR: delete key before undefined element");undo_man.Cancel()}}else{let prev=node.previousSibling;if(prev===null){console.log("backspace but BOF");undo_man.Cancel();return}else if(prev.tagName==="P"||prev.tagName==="H1"||prev.tagName==="H2"||prev.tagName==="H3"||prev.tagName==="H4"||prev.tagName==="H5"||prev.tagName==="H6"){if(IsSpanMathRef(node.firstChild)){if(prev.tagName==="P"&&prev.lastChild.nodeName!="BR"){ConvertMathRefToCite(node.firstChild)}}const focus=SafeCombineNode(prev);document.getSelection().collapse(focus.node,focus.offset);undo_man.End(focus.node,focus.offset)}else if(node.previousSibling.tagName==="OL"||node.previousSibling.tagName==="UL"){const ol=node.previousSibling;let target_li=ol.lastChild;while(target_li.lastChild.nodeName==="OL"||target_li.lastChild.nodeName==="UL"){target_li=target_li.lastChild.lastChild}const fragment=RemoveNodeList(node,node.firstChild);if(IsSpanMathRef(fragment.firstChild)){ConvertMathRefToCite(fragment.firstChild)}const focus=SafePushNodeList(target_li,fragment);RemoveNode(node);document.getSelection().collapse(focus.node,focus.offset);undo_man.End(focus.node,focus.offset)}else if(node.previousSibling.nodeName==="FIGURE"){const figure=node.previousSibling;const figcaption=figure.lastChild;const fragment=RemoveNodeList(node,node.firstChild,null);if(IsSpanMathRef(fragment.firstChild)){ConvertMathRefToCite(fragment.firstChild)}const focus=SafePushNodeList(figcaption,fragment);RemoveNode(node);undo_man.End(focus.node,focus.offset);document.getSelection().collapse(focus.node,focus.offset)}else{alert("WARNING: delete key before undefined element");undo_man.Cancel()}}}break;case"LI":{undo_man.Begin(origin.node,origin.offset);if(offset>0){if(node.childNodes.item(offset-1).nodeName==="BR"){offset--}}if(offset>0){let ch=node.childNodes.item(offset-1);if(ch.nodeType===Node.TEXT_NODE){const focus=SafeDeleteInTextNode(ch,ch.length-1);if(focus){undo_man.End(focus.node,focus.offset);document.getSelection().collapse(focus.node,focus.offset)}else{undo_man.Cancel()}}else if(ch.className==="math"){const focus=EnableMathEdit(ch,-1);document.getSelection().collapse(focus.node,focus.offset)}else if(ch.tagName==="OL"||ch.tagName==="UL"){const ol_li=ch.lastChild;const fragment=SafeRemoveNodeList(node,node.childNodes.item(offset));const focus=SafePushNodeList(ol_li,fragment);document.getSelection().collapse(focus.node,focus.offset);undo_man.End(focus.node,focus.offset)}else{alert("ERROR: backspace key after undefined element");undo_man.Cancel();return}}else{undo_man.Cancel();SwitchInputShiftTab(node,offset);return}}break;case"FIGCAPTION":{undo_man.Begin(origin.node,origin.offset);if(node.firstChild.nodeName==="BR"&&node.firstChild.nextSibling===null){offset=0}if(offset>0){let ch=node.childNodes.item(offset-1);if(ch.nodeType===Node.TEXT_NODE){const focus=SafeDeleteInTextNode(ch,ch.length-1);if(focus){undo_man.End(focus.node,focus.offset);document.getSelection().collapse(focus.node,focus.offset)}else{undo_man.Cancel()}}else if(ch.tagName==="BR"){RemoveNode(ch);undo_man.End(node,offset-1);document.getSelection().collapse(node,offset-1)}else if(ch.className==="math"){const focus=EnableMathEdit(ch,-1);document.getSelection().collapse(focus.node,focus.offset);undo_man.Cancel()}else if(ch.tagName==="OL"||ch.tagName==="UL"){alert("ERROR: figcaption node cannot have a child of ol/ul.");undo_man.Cancel()}else{alert("ERROR: delete key before undefined element");undo_man.Cancel()}}else{let prev=node.previousSibling;if(prev===null){undo_man.Cancel();alert("figure has no img tag");return}else{const math=prev;if(math.className!=="math"){alert("figure has no img tag");undo_man.Cancel();return}if(math.lastChild.className!=="editimg"){alert("figure has no img tag");undo_man.Cancel();return}const focus=EnableMathEdit(math,-1);document.getSelection().collapse(focus.node,focus.offset);undo_man.Cancel();return}}}break;case"TH":case"TD":{undo_man.Begin(origin.node,origin.offset);if(node.firstChild.nodeName==="BR"&&node.firstChild.nextSibling===null){offset=0}if(offset>0){let ch=node.childNodes.item(offset-1);if(ch.nodeType===Node.TEXT_NODE){const focus=SafeDeleteInTextNode(ch,ch.length-1);if(focus){undo_man.End(focus.node,focus.offset);document.getSelection().collapse(focus.node,focus.offset)}else{undo_man.Cancel()}}else if(ch.tagName==="BR"){RemoveNode(ch);undo_man.End(node,offset-1);document.getSelection().collapse(node,offset-1)}else if(ch.className==="math"){const focus=EnableMathEdit(ch,-1);document.getSelection().collapse(focus.node,focus.offset);undo_man.Cancel()}else if(ch.tagName==="OL"||ch.tagName==="UL"){alert("ERROR: td node cannot have a child of ol/ul.");undo_man.Cancel()}else{alert("ERROR: delete key before undefined element");undo_man.Cancel()}}else{if(!is_shift){break}let prev=node.previousSibling;if(prev){const focus=SafeCombineNode(prev);const new_td=AddNode(prev.tagName,prev.parentNode,null);AddNode("BR",new_td,null);document.getSelection().collapse(focus.node,focus.offset);undo_man.End(focus.node,focus.offset);return}else{const prev_tr=node.parentNode.previousSibling;if(prev_tr){RemoveNode(node.parentNode);const focus=FocusOffsetLast(prev_tr);undo_man.End(focus.node,focus.offset);document.getSelection().collapse(focus.node,focus.offset);return}}}}break;default:alert("ERROR: Delete at "+node.tagName);undo_man.Cancel();break}undo_man.Cancel()}function SwitchInputArrowRight(node,offset,is_shift){if(node===null)return true;if(is_shift)return SwitchInputArrowRightShift(node,offset);if(node.nodeType===Node.TEXT_NODE){if(IsTextNodeInMath(node)){const math=node.parentNode.parentNode;if(offset>=node.length-1){const res=DisableEdit(math);if(res.removed){document.getSelection().collapse(res.focus.node,res.focus.offset)}else{if(math.nextSibling===null){console.error("math.nextSibling is null")}else if(math.nextSibling.nodeType===Node.TEXT_NODE){if(math.nextSibling.data==nt_ZWBR){document.getSelection().collapse(math.nextSibling,1)}else{document.getSelection().collapse(math.nextSibling,0)}}else{const focus=FocusOffsetZero(math.nextSibling);if(focus){if(focus.node.nodeType===Node.TEXT_NODE){if(focus.node.data==nt_ZWBR){focus.offset=1}}document.getSelection().collapse(focus.node,focus.offset)}else{console.error("math.nextSibling cannot has focus")}}}return true}return false}else{if(node.data==nt_ZWBR){offset=1}if(offset===node.length){console.log("end of text node");offset=GetIndex(node.parentNode,node)+1;node=node.parentNode;if(node.nodeName=="MARK"){offset=GetIndex(node.parentNode,node)+1;node=node.parentNode}}else{return false}}}switch(node.nodeName){case"P":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"LI":case"FIGCAPTION":case"FIGURE":case"TH":case"TD":case"DIV":{let ch=node.childNodes.item(offset);if(ch){if(ch.nodeType===Node.TEXT_NODE){document.getSelection().collapse(ch,1);return true}else if(ch.className==="math"){const focus=EnableMathEdit(ch,1);document.getSelection().collapse(focus.node,focus.offset);return true}else if(ch.nodeName=="BR"){node=ch}else if(ch.nodeName=="MARK"){document.getSelection().collapse(ch.firstChild,1);return true}else{const focus=FocusOffsetZero(ch);if(focus){document.getSelection().collapse(focus.node,focus.offset)}else{console.error("cannot find focus position")}return true}}let p=node;while(p.nextSibling===null){p=p.parentNode;if(p.tagName==="DIV"){return true}}const focus=FocusOffsetZero(p.nextSibling);if(focus){document.getSelection().collapse(focus.node,focus.offset)}else{console.error("cannot find focus position")}return true}break}return false}function SwitchInputArrowRightShift(node,offset){if(node===null)return true;if(node.nodeType===Node.TEXT_NODE){if(IsTextNodeInMath(node)){const math=node.parentNode.parentNode;const margin=GetEditMargin(math);if(offset>=node.length-margin){console.log("end of math text node");if(document.getSelection().anchorNode===math.lastChild.firstChild){const res=DisableEdit(math);if(res.removed){document.getSelection().collapse(res.focus.node,res.focus.offset)}else{const foffset=GetIndex(math.parentNode,math);document.getSelection().setBaseAndExtent(math.parentNode,foffset,math.parentNode,foffset+1)}}else{const res=DisableEdit(math);if(res.removed){document.getSelection().extend(res.focus.node,res.focus.offset)}else{const foffset=GetIndex(math.parentNode,math);document.getSelection().extend(math.parentNode,foffset+1)}}return true}else if(offset===0){const res=DisableEdit(math);if(res.removed){document.getSelection().extend(res.focus.node,res.focus.offset);return true}offset=GetIndex(math.parentNode,math);node=math.parentNode}else{document.getSelection().extend(node,offset+1);return true}}else{if(node.data==nt_ZWBR){offset=1}if(offset===node.length){console.log("end of text node");offset=GetIndex(node.parentNode,node)+1;node=node.parentNode;if(node.nodeName=="MARK"){offset=GetIndex(node.parentNode,node)+1;node=node.parentNode}}else{document.getSelection().extend(node,offset+1);return true}}}if(node.tagName=="TH"||node.tagName=="TD"){if(offset==node.childNodes.length){if(IsHighlightMode()){NT_HighlightClear()}SetSelectTable(node,node);return true}}switch(node.nodeName){case"P":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"LI":case"FIGCAPTION":case"FIGURE":case"TH":case"TD":{const ch=node.childNodes.item(offset);if(ch){if(ch.nodeType===Node.TEXT_NODE){document.getSelection().extend(ch,1);return true}else if(ch.nodeName=="SPAN"){document.getSelection().extend(node,offset+1);return true}else if(ch.nodeName=="BR"){node=ch}else if(ch.nodeName=="MARK"){document.getSelection().extend(ch.firstChild,1);return true}else{const focus=FocusOffsetZero(ch,false);if(focus){document.getSelection().extend(focus.node,focus.offset)}else{console.error("cannot find focus position",ch)}return true}}let p=node;while(p.nextSibling===null){p=p.parentNode;if(p.tagName==="DIV"){return true}}if(p.nextSibling.nodeName=="TABLE"){const table=p.nextSibling;const master=table.parentNode;document.getSelection().extend(master,GetIndex(master,table)+1);return true}const focus=FocusOffsetZero(p.nextSibling,false);if(focus){document.getSelection().extend(focus.node,focus.offset)}else{console.error("cannot find focus position",p.nextSibling)}return true}break;case"DIV":{const expect_table=node.childNodes.item(offset);if(expect_table===null){return false}if(expect_table.nodeName=="TABLE"){document.getSelection().extend(node,offset+1);return true}else{const focus=FocusOffsetZero(expect_table,false);if(focus){document.getSelection().extend(focus.node,focus.offset)}else{console.error("cannot find focus position",expect_table)}return true}}break}return false}function FocusOffsetZero(node,is_enable_math=true){while(node){if(node.nodeType===Node.TEXT_NODE){return{node:node,offset:0}}if(node.firstChild===null){return{node:node.parentNode,offset:GetIndex(node.parentNode,node)}}if(node.firstChild.nodeName==="BR"){return{node:node,offset:0}}if(node.className==="math"){if(is_enable_math){return EnableMathEdit(node,0)}else{return{node:node.parentNode,offset:GetIndex(node.parentNode,node)}}}node=node.firstChild}return null}function SwitchInputArrowLeft(node,offset,is_shift){if(node===null)return true;if(is_shift)return SwitchInputArrowLeftShift(node,offset);if(node.nodeType===Node.TEXT_NODE){if(IsTextNodeInMath(node)){const math=node.parentNode.parentNode;if(offset<=1){if(math.parentNode.nodeName=="FIGURE"&&math.previousSibling===null){const figure=math.parentNode;const res=DisableEdit(math);if(res.removed){const p_node=ConvertFiguretoP(figure);const focus=FocusOffsetZero(p_node);document.getSelection().collapse(focus.node,focus.offset)}else{if(figure.previousSibling){const focus=FocusOffsetLast(figure.previousSibling);if(focus){if(focus.node.nodeType===Node.TEXT_NODE){if(focus.node.data==nt_ZWBR){focus.offset=0}}document.getSelection().collapse(focus.node,focus.offset)}else{console.error("math.previousSibling cannot has focus",math.previousSibling)}}else{undo_man.Begin(node,offset);const p_node=AddNode("P",figure.parentNode,figure);AddNode("BR",p_node,null);undo_man.End(p_node,0);document.getSelection().collapse(p_node,0)}}}else{const res=DisableEdit(math);if(res.removed){document.getSelection().collapse(res.focus.node,res.focus.offset)}else{const focus=FocusOffsetLast(math.previousSibling);if(focus){if(focus.node.nodeType===Node.TEXT_NODE){if(focus.node.data==nt_ZWBR){focus.offset=0}}document.getSelection().collapse(focus.node,focus.offset)}else{console.error("math.previousSibling cannot has focus",math.previousSibling)}}}return true}return false}else{if(node.data==nt_ZWBR){offset=0}if(offset===0){console.log("begin of text node");offset=GetIndex(node.parentNode,node);node=node.parentNode;if(node.nodeName=="MARK"){offset=GetIndex(node.parentNode,node);node=node.parentNode}}else{return false}}}switch(node.tagName){case"P":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"LI":case"FIGCAPTION":case"FIGURE":case"TH":case"TD":case"DIV":{const ch=node.childNodes.item(offset-1);if(ch){if(ch.nodeType===Node.TEXT_NODE){document.getSelection().collapse(ch,ch.length-1);return true}else if(ch.className==="math"){const focus=EnableMathEdit(ch,-1);document.getSelection().collapse(focus.node,focus.offset);return true}else if(ch.nodeName=="BR"){node=ch}else if(ch.nodeName=="MARK"){document.getSelection().collapse(ch.firstChild,ch.firstChild.length-1);return true}else{const focus=FocusOffsetLast(ch);if(focus){document.getSelection().collapse(focus.node,focus.offset)}else{console.error("cannot find focus position",ch)}return true}}let p=node;while(p.previousSibling===null){p=p.parentNode;if(p.tagName==="DIV"){return true}}const focus=FocusOffsetLast(p.previousSibling);if(focus){document.getSelection().collapse(focus.node,focus.offset)}else{console.error("cannot find focus position",p.previousSibling)}return true}}}function SwitchInputArrowLeftShift(node,offset){if(node===null)return true;if(node.nodeType===Node.TEXT_NODE){if(IsTextNodeInMath(node)){const math=node.parentNode.parentNode;const margin=GetEditMargin(math);if(offset<=margin){console.log("begin of math text node");if(document.getSelection().anchorNode===math.lastChild.firstChild){const res=DisableEdit(math);if(res.removed){document.getSelection().collapse(res.focus.node,res.focus.offset)}else{const foffset=GetIndex(math.parentNode,math);document.getSelection().setBaseAndExtent(math.parentNode,foffset+1,math.parentNode,foffset)}}else{const res=DisableEdit(math);if(res.removed){document.getSelection().extend(res.focus.node,res.focus.offset)}else{const foffset=GetIndex(math.parentNode,math);document.getSelection().extend(math.parentNode,foffset)}}return true}else if(offset===node.length){const res=DisableEdit(math);if(res.removed){document.getSelection().extend(res.focus.node,res.focus.offset);return true}offset=GetIndex(math.parentNode,math);node=math.parentNode}else{document.getSelection().extend(node,offset-1);return true}}else{if(node.data==nt_ZWBR){offset=0}if(offset===0){console.log("begin of text node");offset=GetIndex(node.parentNode,node);node=node.parentNode;if(node.nodeName=="MARK"){offset=GetIndex(node.parentNode,node);node=node.parentNode}}else{document.getSelection().extend(node,offset-1);return true}}}if(node.tagName=="TH"||node.tagName=="TD"){if(offset==0){if(IsHighlightMode()){NT_HighlightClear()}SetSelectTable(node,node);return true}}switch(node.tagName){case"P":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"LI":case"FIGCAPTION":case"FIGURE":case"TH":case"TD":{const ch=node.childNodes.item(offset-1);if(ch){if(ch.nodeType===Node.TEXT_NODE){document.getSelection().extend(ch,ch.length-1);return true}else if(ch.nodeName=="SPAN"){document.getSelection().extend(node,offset-1);return true}else if(ch.nodeName=="BR"){node=ch}else if(ch.nodeName=="MARK"){document.getSelection().extend(ch.firstChild,ch.firstChild.length-1);return true}else{const focus=FocusOffsetLast(ch,false);if(focus){document.getSelection().extend(focus.node,focus.offset)}else{console.error("cannot find focus position",ch)}return true}}let p=node;while(p.previousSibling===null){p=p.parentNode;if(p.tagName==="DIV"){return true}}if(p.previousSibling.nodeName=="TABLE"){const table=p.previousSibling;const master=table.parentNode;document.getSelection().extend(master,GetIndex(master,table));return true}const focus=FocusOffsetLast(p.previousSibling,false);if(focus){document.getSelection().extend(focus.node,focus.offset)}else{console.error("cannot find focus position",p.previousSibling)}return true}break;case"DIV":{const expect_table=node.childNodes.item(offset-1);if(expect_table===null){return false}if(expect_table.nodeName=="TABLE"){document.getSelection().extend(node,offset-1);return true}else{const focus=FocusOffsetLast(expect_table,false);if(focus){document.getSelection().extend(focus.node,focus.offset)}else{console.error("cannot find focus position",expect_table)}return true}}break}return false}function FocusOffsetLast(node,is_enable_math=true){while(node){if(node.nodeType===Node.TEXT_NODE){return{node:node,offset:node.length}}if(node.firstChild===null){return{node:node.parentNode,offset:GetIndex(node.parentNode,node)}}if(node.firstChild.nodeName==="BR"){return{node:node,offset:0}}if(node.className==="math"){if(is_enable_math){return EnableMathEdit(node,-1)}else{return{node:node.parentNode,offset:GetIndex(node.parentNode,node)}}}node=node.lastChild}return null}function SwitchInputMath(mark,node,offset){if(node===null)return;let class_name;switch(mark){case"$":class_name="editmath";break;case"`":class_name="editcode";break;case"*":case"_":class_name="editem";break;case"~":class_name="editdeleted";break;default:return}if(node.nodeType===Node.TEXT_NODE){if(node.parentNode.nodeName==="SPAN"){if(node.parentNode.className.slice(0,node.parentNode.className.length-1)===class_name){const margin=GetEditMarginByClassName(node.parentNode.className);if(!(offset===margin||offset===node.length-margin))return;undo_man.Begin(node,offset);let math_old=node.parentNode.parentNode;let math_new=AddMathNode(mark.repeat(margin+1),math_old.parentNode,math_old);console.log("inline em and strong is rank up: ",math_new);if(math_new){InsertTextIntoText(node.data.slice(margin,node.length-margin),math_new.lastChild.lastChild,margin+1);RemoveNode(math_old)}const focus=EnableMathEdit(math_new,offset+1);document.getSelection().collapse(focus.node,focus.offset);undo_man.End(focus.node,focus.offset);return}else if(node.parentNode.className===class_name){const margin=GetEditMarginByClassName(class_name+"disp");if(!(0<offset&&offset<margin))return;if(node.length>=margin){if(node.data.slice(0,margin-1)===mark.repeat(margin-1)){undo_man.Begin(node,offset);let math_inline=node.parentNode.parentNode;let math_display=AddMathNode(mark.repeat(margin),math_inline.parentNode,math_inline);console.log("inline math to display math: ",math_display);if(math_display){InsertTextIntoText(node.data.slice(margin-1,node.length-(margin-1)),math_display.lastChild.lastChild,margin+1);RemoveNode(math_inline)}if(class_name==="editmath"){SetEqNumber(math_display,1)}const focus=EnableMathEdit(math_display,margin+1);document.getSelection().collapse(focus.node,focus.offset);undo_man.End(focus.node,focus.offset);return}}}undo_man.Begin(node,offset);InsertTextIntoText(mark,node,offset);undo_man.End(node,offset+1);document.getSelection().collapse(node,offset+1);return}else{console.log("add inline ",class_name);undo_man.Begin(node,offset);const parent=node.parentNode;let ref_node;if(offset===0){ref_node=node}else if(offset===node.length){ref_node=node.nextSibling}else{ref_node=DivideTextNode(node,offset)}const math=AddMathNode(mark,parent,ref_node);if(!IsTextNode(math.previousSibling)){AddTextNode(nt_ZWBR,parent,math)}if(!IsTextNode(math.nextSibling)){AddTextNode(nt_ZWBR,parent,math.nextSibling)}const focus=EnableMathEdit(math,1);document.getSelection().collapse(focus.node,focus.offset);undo_man.End(focus.node,focus.offset);return}}switch(node.tagName){case"P":case"LI":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"FIGCAPTION":case"FIGURE":case"TH":case"TD":{let br_node=null;if(offset===0){if(node.firstChild.nodeName==="BR"){if(node.firstChild.nextSibling===null){br_node=node.firstChild}else if(node.firstChild.nextSibling.nodeName==="UL"||node.firstChild.nextSibling.nodeName==="OL"){br_node=node.firstChild}else{console.error("invalid position of BR tag")}}}undo_man.Begin(node,offset);let ref_node=node.childNodes.item(offset);let math=AddMathNode(mark,node,ref_node);if(br_node){RemoveNode(br_node)}if(!IsTextNode(math.previousSibling)){AddTextNode(nt_ZWBR,node,math)}if(!IsTextNode(math.nextSibling)){AddTextNode(nt_ZWBR,node,math.nextSibling)}const focus=EnableMathEdit(math,1);document.getSelection().collapse(focus.node,focus.offset);undo_man.End(focus.node,focus.offset);return}break;default:alert("ERROR: InputChar in Math at"+node.tagName);break}}function SwitchInputMathSelection(mark,node,offset,anchor_node,anchor_offset){if(node===null)return;if(node!==anchor_node)return;if(node.nodeType!==Node.TEXT_NODE)return;let class_name;switch(mark){case"$":class_name="editmath";break;case"`":class_name="editcode";break;case"*":case"_":class_name="editem";break;case"**":case"_":class_name="editem";break;case"~~":class_name="editem";break;default:return}if(!IsTextNodeInMath(node)){console.log("change to math span: ",class_name);undo_man.Begin(node,offset,anchor_node,anchor_offset);const parent=node.parentNode;const[begin_off,end_off]=anchor_offset<offset?[anchor_offset,offset]:[offset,anchor_offset];if(end_off<node.length){DivideTextNode(node,end_off)}const ref_node=begin_off==0?node:DivideTextNode(node,begin_off);const math=AddMathNode(mark,parent,ref_node);const math_text=math.lastChild.firstChild;const margin=GetEditMargin(math);InsertTextIntoText(ref_node.data,math_text,margin);RemoveNode(ref_node);if(!IsTextNode(math.previousSibling)){AddTextNode(nt_ZWBR,parent,math)}if(!IsTextNode(math.nextSibling)){AddTextNode(nt_ZWBR,parent,math.nextSibling)}const focus=EnableMathEdit(math,1);document.getSelection().collapse(focus.node,focus.offset);undo_man.End(focus.node,focus.offset);return}}function SwitchInputSpace(node,offset){if(node===null)return false;const is_H1to6=tagName=>"H1"<=tagName&&tagName<="H6";if(node.nodeType!==Node.TEXT_NODE){if(node.tagName==="P"||is_H1to6(node.tagName)){node=node.childNodes.item(offset-1);if(node===null)return false;offset=node.length}else{return false}}if(node.nodeType===Node.TEXT_NODE){let parent=node.parentNode;if(parent.tagName==="P"){if(node!==parent.firstChild)return false;const head_word=node.data.substring(0,offset);let tagname="none";switch(head_word){case"-":tagname="UL";break;case"*":tagname="UL";break;case"+":tagname="UL";break;case"#":tagname="H1";break;case"##":tagname="H2";break;case"###":tagname="H3";break;case"####":tagname="H4";break;case"#####":tagname="H5";break;case"######":tagname="H6";break}if(head_word[head_word.length-1]==="."){tagname="OL";for(let i=0;i<head_word.length-1;++i){if(head_word[i]<"0"||"9"<head_word[i]){tagname="none"}}}if(tagname==="none")return false;undo_man.Begin(node,offset);let new_node;if(tagname==="UL"){const ul=AddNode(tagname,parent.parentNode,parent);new_node=AddNode("LI",ul,null)}else if(tagname==="OL"){const ul=AddNode(tagname,parent.parentNode,parent);new_node=AddNode("LI",ul,null)}else{new_node=AddNode(tagname,parent.parentNode,parent)}if(node.length!==offset){DivideTextNode(node,offset)}let focus;if(node.nextSibling){const fragment=RemoveNodeList(parent,node.nextSibling,null);focus=SafePushNodeList(new_node,fragment)}else{AddNode("BR",new_node,null);focus={node:new_node,offset:0}}RemoveNode(parent);undo_man.End(focus.node,focus.offset);document.getSelection().collapse(focus.node,focus.offset);return true}else if(is_H1to6(parent.tagName)){if(node!==parent.firstChild)return false;const head_word=node.data.substring(0,offset);let tagrank=0;switch(head_word){case"#":tagrank=1;break;case"##":tagrank=2;break;case"###":tagrank=3;break;case"####":tagrank=4;break;case"#####":tagrank=5;break;case"######":tagrank=6;break}if(tagrank==="none")return false;const myrank=parseInt(parent.tagName.charAt(1),10);tagrank+=myrank;if(tagrank>6)tagrank=6;if(myrank===tagrank)return false;const tagname="H"+tagrank.toString();undo_man.Begin(node,offset);const new_node=AddNode(tagname,parent.parentNode,parent);if(node.length!==offset){DivideTextNode(node,offset)}let focus;if(node.nextSibling){const fragment=RemoveNodeList(parent,node.nextSibling,null);focus=SafePushNodeList(new_node,fragment)}else{AddNode("BR",new_node,null);focus={node:new_node,offset:0}}RemoveNode(parent);undo_man.End(focus.node,focus.offset);document.getSelection().collapse(focus.node,focus.offset);return true}}return false}function SwitchInputTab(node,offset){if(node===null)return false;if(offset>0)return false;if(node.nodeType===Node.TEXT_NODE){if(node.previousSibling)return false;node=node.parentNode}if(node.nodeName==="SPAN"){let parent=node.parentNode;while(parent.nodeName==="SPAN"){node=parent;parent=node.parentNode}offset=GetIndex(parent,node);if(offset>0)return false;node=parent}if(node.nodeName==="LI"){const prev=node.previousSibling;if(prev===null)return false;undo_man.Begin(node,offset);let joint_target_list=null;if(prev.lastChild.nodeName==="OL"||prev.lastChild.nodeName==="UL"){joint_target_list=prev.lastChild}else{joint_target_list=AddNode(node.parentNode.tagName,prev,null)}const frag=RemoveNodeList(node.parentNode,node,node.nextSibling);AddNodeList(joint_target_list,null,frag);undo_man.End(node,0);document.getSelection().collapse(node,0);return true}else if(node.nodeName>="H1"&&node.nodeName<"H6"){undo_man.Begin(node,offset);const next_tag="H"+(1+parseInt(node.nodeName.charAt(1),10)).toString();const next_H=AddNode(next_tag,node.parentNode,node);const frag=RemoveNodeList(node,node.firstChild);const focus=SafePushNodeList(next_H,frag);RemoveNode(node);undo_man.End(focus.node,focus.offset);document.getSelection().collapse(focus.node,focus.offset);return true}return false}function SwitchInputShiftTab(node,offset){if(node===null)return false;if(offset>0)return false;if(node.nodeType===Node.TEXT_NODE){if(node.previousSibling)return false;node=node.parentNode}if(node.nodeName==="SPAN"){let parent=node.parentNode;while(parent.nodeName==="SPAN"){node=parent;parent=node.parentNode}offset=GetIndex(parent,node);if(offset>0)return false;node=parent}if(node.nodeName==="LI"){undo_man.Begin(node,offset);const pp=node.parentNode.parentNode;if(pp.nodeName==="LI"){const ref=pp.nextSibling;const joint_ol=pp.parentNode;const org_ol=node.parentNode;if(node.nextSibling){const frag2=RemoveNodeList(org_ol,node.nextSibling);if(node.lastChild.nodeName!=="OL"&&node.lastChild.nodeName!=="UL"){AddNode(org_ol.tagName,node,null)}AddNodeList(node.lastChild,null,frag2)}const frag=RemoveNodeList(org_ol,node,node.nextSibling);AddNodeList(joint_ol,ref,frag);if(!org_ol.hasChildNodes()){RemoveNode(org_ol)}undo_man.End(node,0);document.getSelection().collapse(node,0)}else{const org_ol=node.parentNode;const p_node=AddNode("P",pp,org_ol.nextSibling);const frag2=node.nextSibling?RemoveNodeList(org_ol,node.nextSibling):null;let end_line=node.firstChild;while(end_line){if(end_line.nodeName==="OL")break;if(end_line.nodeName==="UL")break;end_line=end_line.nextSibling}const frag=RemoveNodeList(node,node.firstChild,end_line);const focus=SafePushNodeList(p_node,frag);if(end_line){const later_target_ol=node.lastChild;const frag3=RemoveNodeList(node,end_line);AddNodeList(pp,p_node.nextSibling,frag3);if(frag2){AddNodeList(later_target_ol,null,frag2)}}else{if(frag2){const later_target_ol=AddNode(org_ol.tagName,pp,p_node.nextSibling);AddNodeList(later_target_ol,null,frag2)}}RemoveNode(node);if(!org_ol.hasChildNodes()){RemoveNode(org_ol)}if(p_node.firstChild.nodeType==Node.TEXT_NODE){if(p_node.firstChild.data==nt_ZWBR){if(IsSpanMathImg(p_node.firstChild.nextSibling)){ConvertPtoFigure(p_node)}else if(IsSpanMathCite(p_node.firstChild.nextSibling)){ConvertMathCiteToRef(p_node.firstChild.nextSibling)}}}document.getSelection().collapse(focus.node,focus.offset);undo_man.End(focus.node,focus.offset)}return true}else if(node.nodeName>"H1"&&node.nodeName<="H6"){undo_man.Begin(node,offset);const next_tag="H"+(parseInt(node.nodeName.charAt(1),10)-1).toString();const next_H=AddNode(next_tag,node.parentNode,node);const frag=RemoveNodeList(node,node.firstChild);const focus=SafePushNodeList(next_H,frag);RemoveNode(node);undo_man.End(focus.node,focus.offset);document.getSelection().collapse(focus.node,focus.offset);return true}return false}function SelectAll(maindiv){const selection=document.getSelection();selection.setBaseAndExtent(maindiv.firstChild,0,maindiv.lastChild,maindiv.lastChild.childNodes.length)}function CorrectFocusToText2(node,offset){let[fnode,foffset]=CorrectFocusToText(node,offset);return{node:fnode,offset:foffset}}function CorrectFocusToText(node,offset){if(node.nodeType===Node.TEXT_NODE){return[node,offset]}if(!node.hasChildNodes()){return[node.parentNode,GetIndex(node.parentNode,node)]}if(node.childNodes.length<=offset){while(node.lastChild){node=node.lastChild;if(node.nodeType===Node.TEXT_NODE){return[node,node.length]}}return[node.parentNode,node.parentNode.childNodes.length]}if(node.nodeName==="SPAN"&&node.className==="math"){const text_node=node.lastChild.firstChild;return[text_node,0]}node=node.childNodes.item(offset);while(node.nodeType!=Node.TEXT_NODE){if(node.previousSibling){if(node.previousSibling.nodeType==Node.TEXT_NODE){return[node.previousSibling,node.previousSibling.length]}}if(!node.hasChildNodes()){return[node.parentNode,offset]}if(node.nodeName==="SPAN"&&node.className==="math"){const text_node=node.lastChild.firstChild;return[text_node,0]}offset=0;node=node.firstChild}return[node,0]}function IsSpanMathImg(node){if(!node)return false;if(node.nodeName!=="SPAN")return false;if(node.className!=="math")return false;if(node.lastChild.className!=="editimg")return false;return true}function ConvertPtoFigure(p_node){const figure=AddNode("FIGURE",p_node.parentNode,p_node);let i_end=p_node.firstChild;while(i_end){if(!IsSpanMathImg(i_end)){if(i_end.nodeType===Node.TEXT_NODE){if(i_end.data!=nt_ZWBR)break}else{break}}i_end=i_end.nextSibling}const fragment=RemoveNodeList(p_node,p_node.firstChild,i_end);AddNodeList(figure,null,fragment);if(figure.firstChild.nodeType==Node.TEXT_NODE){RemoveNode(figure.firstChild)}if(figure.lastChild.nodeType==Node.TEXT_NODE){RemoveNode(figure.lastChild)}const figcaption=AddNode("FIGCAPTION",figure,null);if(p_node.firstChild){const fragment2=RemoveNodeList(p_node,p_node.firstChild,null);SafePushNodeList(figcaption,fragment2)}else{AddNode("BR",figcaption,null)}RemoveNode(p_node);return figure}function ConvertFiguretoP(figure){const p_node=AddNode("P",figure.parentNode,figure);let i_end=figure.firstChild;while(i_end){if(i_end.nodeName==="FIGCAPTION")break;i_end=i_end.nextSibling}if(figure.firstChild!==i_end){const fragment=RemoveNodeList(figure,figure.firstChild,i_end);SafePushNodeList(p_node,fragment)}if(i_end){if(i_end.hasChildNodes()){const fragment2=RemoveNodeList(i_end,i_end.firstChild,null);SafePushNodeList(p_node,fragment2)}}if(!p_node.hasChildNodes()){AddNode("BR",p_node,null)}RemoveNode(figure);if(IsSpanMathCite(p_node.firstChild.nextSibling)){ConvertMathCiteToRef(p_node.firstChild.nextSibling)}return p_node}function IsSpanMathCite(node){if(!node)return false;if(node.nodeName!=="SPAN")return false;if(node.className!=="math")return false;if(node.lastChild.className!=="editcite")return false;return true}function ConvertMathCiteToRef(math_cite){const frag=new DocumentFragment;const preview=document.createElement("SPAN");preview.className="previewref";const text=math_cite.lastChild.firstChild.data;preview.appendChild(document.createTextNode(text.slice(2,text.length-2)));frag.appendChild(preview);const edit=document.createElement("SPAN");edit.className="editref";edit.appendChild(document.createTextNode(text.slice(0,text.length-1)+":"));frag.appendChild(edit);SetHide(frag.lastChild);RemoveNode(math_cite.firstChild);RemoveNode(math_cite.firstChild);AddNodeList(math_cite,null,frag)}function IsSpanMathRef(node){if(!node)return false;if(node.nodeName!=="SPAN")return false;if(node.className!=="math")return false;if(node.lastChild.className!=="editref")return false;return true}function ConvertMathRefToCite(math_ref){const frag=new DocumentFragment;const preview=document.createElement("A");preview.className="previewcite";const text=math_ref.lastChild.firstChild.data;preview.appendChild(document.createTextNode(text.slice(2,text.length-2)));preview.href="#"+text.slice(2,text.length-2);frag.appendChild(preview);const edit=document.createElement("SPAN");edit.className="editcite";edit.appendChild(document.createTextNode(text.slice(0,text.length-1)+" "));frag.appendChild(edit);SetHide(math.lastChild);const math_next=math_ref.nextSibling;RemoveNode(math_ref.firstChild);RemoveNode(math_ref.firstChild);AddNodeList(math_ref,null,frag)}function SwitchInputBar(node,offset){if(node===null)return false;const origin={node:node,offset:offset};let should_devide=false;if(node.nodeType===Node.TEXT_NODE){switch(node.parentNode.tagName){case"P":{if(offset===0)return false;const[col_size,row_size]=GetTableSize(node.data.slice(0,offset));if(col_size<=0||row_size<=0)return false;undo_man.Begin(node,offset);const table=ConvertPtoTable(node.parentNode,col_size,row_size);const fnode=table.firstChild.firstChild;undo_man.End(fnode,0);document.getSelection().collapse(fnode,0);return true}break;case"TH":case"TD":{if(offset===node.length){console.log("go to divide node: "+node.parentNode.tagName);offset=GetIndex(node.parentNode,node)+1;node=node.parentNode}else{console.log("go to divide node: "+node.parentNode.tagName);should_devide=offset>0;offset=GetIndex(node.parentNode,node);node=node.parentNode}}break;default:return false}}switch(node.tagName){case"TH":{undo_man.Begin(origin.node,origin.offset);if(should_devide){DivideTextNode(origin.node,origin.offset);++offset}const org_tr=node.parentNode;const table=org_tr.parentNode;let new_td=null;let focus;if(offset<node.childNodes.length){const fragment=SafeRemoveNodeList(node,node.childNodes.item(offset),null);new_td=AddNode(node.tagName,node.parentNode,node.nextSibling);focus=SafePushNodeList(new_td,fragment);if(!node.hasChildNodes()){AddNode("BR",node,null)}}else{new_td=AddNode(node.tagName,node.parentNode,node.nextSibling);AddNode("BR",new_td,null);focus={node:new_td,offset:0}}const begin_shilf=GetIndex(org_tr,node)+(offset===0?0:1);const second_tr=org_tr.nextSibling;{const begin_td=second_tr.childNodes.item(begin_shilf);const td=AddNode("TD",second_tr,begin_td);AddTextNode(begin_td.firstChild.data,td,null)}for(let tr=second_tr.nextSibling;tr;tr=tr.nextSibling){const begin_td=tr.childNodes.item(begin_shilf);const td=AddNode("TD",tr,begin_td);AddNode("BR",td,null)}undo_man.End(focus.node,focus.offset);document.getSelection().collapse(focus.node,focus.offset);return true}case"TD":{const org_tr=node.parentNode;const table=org_tr.parentNode;if(org_tr===table.firstChild.nextSibling){return true}undo_man.Begin(origin.node,origin.offset);if(should_devide){DivideTextNode(origin.node,origin.offset);++offset}let new_td=null;let focus;if(offset<node.childNodes.length){const fragment=SafeRemoveNodeList(node,node.childNodes.item(offset),null);new_td=AddNode(node.tagName,node.parentNode,node.nextSibling);focus=SafePushNodeList(new_td,fragment);if(!node.hasChildNodes()){AddNode("BR",node,null)}}else{new_td=AddNode(node.tagName,node.parentNode,node.nextSibling);AddNode("BR",new_td,null);focus={node:new_td,offset:0}}const num_column=table.firstChild.childNodes.length;while(org_tr.childNodes.length>num_column){RemoveNode(org_tr.lastChild)}undo_man.End(focus.node,focus.offset);document.getSelection().collapse(focus.node,focus.offset);return true}break}return false}function PreviousText(node,offset,num){if(node===null)return null;if(node.nodeType!=Node.TEXT_NODE)return null;if(offset<num)return null;return node.data.slice(offset-num,offset)}function SwitchInputHat(node,offset){if(node===null)return true;if(node.nodeType!=Node.TEXT_NODE)return true;if(IsTextNodeInMath(node)){if(["edita","editimg","editcite","editref"].includes(node.parentNode.className)){return true}}if(node.data.charAt(offset-1)!="[")return false;const pos_sq_bra=offset-1;let cut_end=node.data.indexOf("]",offset);let sq_text;if(cut_end<0){cut_end=offset;sq_text=node.data.slice(pos_sq_bra,offset)+"^] "}else{cut_end++;sq_text=node.data.slice(pos_sq_bra,offset)+"^"+node.data.slice(offset,cut_end)+" "}undo_man.Begin(node,offset);let rm_node=node;if(cut_end<node.length){DivideTextNode(node,cut_end)}if(pos_sq_bra>0){rm_node=DivideTextNode(node,pos_sq_bra)}const math=AddMathNode("[^",node.parentNode,rm_node);RemoveNode(rm_node);SafeJunctionPoint(math.parentNode,math);SafeJunctionPoint(math.parentNode,math.nextSibling);const math_text=math.lastChild.firstChild;InsertTextIntoText(sq_text,math_text,0);DeleteText(math_text,sq_text.length,math_text.length);if(math.parentNode.nodeName=="P"){if(math.previousSibling.data==nt_ZWBR){if(math.previousSibling.previousSibling===null){ConvertMathCiteToRef(math)}}}const focus=EnableMathEdit(math,offset-pos_sq_bra+1);document.getSelection().collapse(focus.node,focus.offset);undo_man.End(focus.node,focus.offset);return true}function SwitchInputTilde(node,offset){if(node===null)return true;if(node.nodeType!=Node.TEXT_NODE)return true;if(IsTextNodeInMath(node)){if(node.parentNode.className=="editdeleted"){return true}return false}let pos_begin=-1;if(offset<node.data.length){if(node.data.charAt(offset+1)=="~"){pos_begin=offset}}if(pos_begin<0&&offset>0){if(node.data.charAt(offset-1)=="~"){pos_begin=offset-1}}if(pos_begin<0)return false;undo_man.Begin(node,offset);let rm_node=node;if(pos_begin+1<node.length){DivideTextNode(node,pos_begin+1)}if(pos_begin>0){rm_node=DivideTextNode(node,pos_begin)}const math=AddMathNode("~~",node.parentNode,rm_node);RemoveNode(rm_node);SafeJunctionPoint(math.parentNode,math);SafeJunctionPoint(math.parentNode,math.nextSibling);const focus=EnableMathEdit(math,2);document.getSelection().collapse(focus.node,focus.offset);undo_man.End(focus.node,focus.offset);return true}function SwitchInputRoundBra(node,offset){if(node===null)return true;if(node.nodeType!=Node.TEXT_NODE)return false;if(IsTextNodeInMath(node))return false;if(node.data.charAt(offset-1)!="]")return false;let pos_sq_bra=node.data.lastIndexOf("[",offset-1);if(pos_sq_bra<0)return false;let is_img=false;if(node.data.charAt(pos_sq_bra-1)=="!"){pos_sq_bra--;is_img=true}let cut_end=node.data.indexOf(")",offset);let sq_text;if(cut_end<0){cut_end=offset;sq_text=node.data.slice(pos_sq_bra,offset)+"()"}else{cut_end++;sq_text=node.data.slice(pos_sq_bra,offset)+"("+node.data.slice(offset,cut_end)}if(is_img){sq_text+=" "}undo_man.Begin(node,offset);let rm_node=node;if(cut_end<node.length){DivideTextNode(node,cut_end)}if(pos_sq_bra>0){rm_node=DivideTextNode(node,pos_sq_bra)}const math=AddMathNode(is_img?"![":"[",node.parentNode,rm_node);RemoveNode(rm_node);SafeJunctionPoint(math.parentNode,math);SafeJunctionPoint(math.parentNode,math.nextSibling);const math_text=math.lastChild.firstChild;InsertTextIntoText(sq_text,math_text,0);DeleteText(math_text,sq_text.length,math_text.length);if(is_img){if(math.parentNode.nodeName=="P"){if(math.previousSibling.data==nt_ZWBR){if(math.previousSibling.previousSibling===null){ConvertPtoFigure(math.parentNode)}}}}const focus=EnableMathEdit(math,offset-pos_sq_bra+1);document.getSelection().collapse(focus.node,focus.offset);undo_man.End(focus.node,focus.offset);return true}function ConvertPtoTable(p_node,col_size,row_size){const table=AddNode("TABLE",p_node.parentNode,p_node);{const tr=AddNode("TR",table,null);for(let i=0;i<col_size;++i){const th=AddNode("TH",tr,null);AddNode("BR",th,null)}}{const tr=AddNode("TR",table,null);for(let i=0;i<col_size;++i){const td=AddNode("TD",tr,null);AddTextNode("---",td,null)}}for(let k=1;k<row_size;++k){const tr=AddNode("TR",table,null);for(let i=0;i<col_size;++i){const td=AddNode("TD",tr,null);AddNode("BR",td,null)}}RemoveNode(p_node);return table}function GetTableSize(text){if(text[0]!=="|")return[0,0];const length=text.length;let i=1;while(text[i]===" "){++i;if(i===length)return[0,0]}const num1_begin=i;while("0"<=text[i]&&text[i]<="9"){++i;if(i===length)return[0,0]}const num1_end=i;while(text[i]===" "){++i;if(i===length)return[0,0]}if(text[i]!=="x"&&text[i]!==",")return[0,0];++i;while(text[i]===" "){++i;if(i===length)return[0,0]}const num2_begin=i;while("0"<=text[i]&&text[i]<="9"){++i;if(i===length)break}if(i===num2_begin)return[0,0];const num2_end=i;while(i<length){if(text[i]!==" ")return[0,0];++i}const num1=parseInt(text.slice(num1_begin,num1_end),10);const num2=parseInt(text.slice(num2_begin,num2_end),10);return[num1,num2]}function SwitchInputArrowUp(td){const tr=td.parentNode;if(tr.previousSibling===null){const table=tr.parentNode;if(table.previousSibling===null){undo_man.Begin(document.getSelection().focusNode,document.getSelection().focusOffset);const p=AddNode("P",table.parentNode,table);AddNode("BR",p,null);document.getSelection().collapse(p,0);undo_man.End(p,0);return true}return false}const index=GetIndex(tr,td);const adj_td=tr.previousSibling.childNodes.item(index);const focus=FocusOffsetLast(adj_td);document.getSelection().collapse(focus.node,focus.offset);return true}function SwitchInputArrowDown(td){const tr=td.parentNode;if(tr.nextSibling===null){const table=tr.parentNode;if(table.nextSibling===null){undo_man.Begin(document.getSelection().focusNode,document.getSelection().focusOffset);const p=AddNode("P",table.parentNode,null);AddNode("BR",p,null);document.getSelection().collapse(p,0);undo_man.End(p,0);return true}return false}const index=GetIndex(tr,td);const adj_td=tr.nextSibling.childNodes.item(index);const focus=FocusOffsetLast(adj_td);document.getSelection().collapse(focus.node,focus.offset);return true}"use strict";function NT_SetMarkdown(md_text){console.log("md_text:\n",md_text);console.log("clear all elements");const maindiv=nt_render_div;while(maindiv.firstChild){maindiv.removeChild(maindiv.firstChild)}console.log("create dom");const fragment=MD2DOM(ResolveNewlineCode(md_text));InitializeMathInFragment(fragment,g_auto_numbering?1:0);console.log("set DOM");maindiv.appendChild(fragment);undo_man=new UndoManager;undo_man.SetChangeEventDispatcher(new ChangeEventDispatcher(render_div));console.log("fin: load")}function NT_GetMarkdown(){return DOM2MD(nt_render_div)}function NT_GetTeX(){return DOM2TEX(nt_render_div)}let nt_file_dir="";function NT_SetFilePath(path){if(path.charAt(path.length-1)==="/"){nt_file_dir=path}else if(path.charAt(path.length-1)==="\\"){nt_file_dir=path}else if(path.slice(path.length-3)===".md"){let pos=path.lastIndexOf("/");if(pos<0){pos=path.lastIndexOf("\\");if(pos<0){nt_file_dir=""}}nt_file_dir=path.slice(0,pos+1)}else{let pos=path.lastIndexOf("/");if(pos>=0){nt_file_dir=path+"/"}nt_file_dir=path+"\\"}console.log("SetFilePath:",nt_file_dir)}"use strict";let g_editable_math=null;let g_auto_numbering=true;function OnClick(event){if(IsTableSelectionMode())return false;if(!CorrectSelectionEdgeTable()){event.preventDefault();return false}if(event.shiftKey&&event.ctrlKey){const node=document.elementFromPoint(event.clientX,event.clientY);const td=CheckNodeInTD(node,nt_render_div);if(td){const table=td.parentNode.parentNode;const parent=table.parentNode;event.preventDefault();const index=GetIndex(parent,table);document.getSelection().setBaseAndExtent(parent,index,parent,index+1);return false}}OnClickMath(event)}function OnClickMath(event){const selection=document.getSelection();let clicked_node=document.elementFromPoint(event.clientX,event.clientY);let focus_math=CheckNodeInClass(clicked_node,"math",nt_render_div);if(focus_math===null){clicked_node=selection.focusNode;focus_math=CheckNodeInClass(clicked_node,"math",nt_render_div)}if(focus_math===null){if(!selection.isCollapsed){if(CheckNodeInClass(selection.anchorNode,"math",nt_render_div)){selection.collapse(selection.focusNode,selection.focusOffset)}}DisableEdit(g_editable_math,false);return}if(g_editable_math!==focus_math){const math_class=focus_math.lastChild.className;if(["editmath","editmathdisp","editimg"].includes(math_class)){DisableEdit(g_editable_math,false);if(event.shiftKey){const parent=focus_math.parentNode;const offset=GetIndex(parent,focus_math);document.getSelection().setBaseAndExtent(parent,offset,parent,offset+1)}else{const math_text=EnableMathEdit(focus_math,1);document.getSelection().collapse(math_text.node,math_text.offset)}}else{let focus_offset=document.getSelection().focusOffset;let anchor_offset=document.getSelection().anchorNode===document.getSelection().focusNode?document.getSelection().anchorOffset:focus_offset;DisableEdit(g_editable_math,false);const math_text=EnableMathEdit(focus_math,1);const margin=GetEditMarginByClassName(math_class);focus_offset+=margin;anchor_offset+=margin;if(math_class==="editcodedisp"){if(math_text.node.data.charAt(3)==="\n"){focus_offset++;anchor_offset++}}if(anchor_offset!=focus_offset){document.getSelection().setBaseAndExtent(math_text.node,anchor_offset,math_text.node,focus_offset)}else{document.getSelection().collapse(math_text.node,focus_offset)}}}}function CheckEditPreview(master_node,in_undo_redo=false){let focus_math=CheckFocusInClass("math",master_node);if(g_editable_math!==focus_math){DisableEdit(g_editable_math,in_undo_redo);if(focus_math){console.log("focus in : "+focus_math);console.log("num_child: "+focus_math.childNodes.length);return EnableMathEdit(focus_math,1)}}return null}function CheckFocusInClass(target_class_name,master_node){let selection=document.getSelection();return CheckNodeInClass(selection.focusNode,target_class_name,master_node)}function CheckNodeInClass(ref_node,target_class_name,master_node){let node=ref_node;while(node){if(node===master_node){break}if(node.nodeType===Node.ELEMENT_NODE){if(node.className===target_class_name){return node}}node=node.parentNode}return null}function CheckNodeInNode(ref_node,target_node){let node=ref_node;while(node){if(node===target_node){return node}node=node.parentNode}return null}function SetFocusByCoordinate(target_text_node,margin,x,y){let textNode=null;let offset;if(document.caretPositionFromPoint){let range=document.caretPositionFromPoint(x,y);textNode=range.offsetNode;offset=range.offset}else if(document.caretRangeFromPoint){let range=document.caretRangeFromPoint(x,y);textNode=range.startContainer;offset=range.startOffset}if(textNode===target_text_node){if(textNode.nodeType===Node.TEXT_NODE){if(offset<margin)offset=margin;if(offset>textNode.length-margin)offset=textNode.length-margin;document.getSelection().collapse(textNode,offset);return true}}return false}function EnableMathEdit(math,offset=1){if(math===null)return null;if(math.className!=="math")return null;HidePreview(math.firstChild);UnsetHide(math.lastChild);g_editable_math=math;const text=math.lastChild.firstChild;return{node:text,offset:offset<0?text.length+offset:offset}}function DisableEdit(math,in_undo_redo=false){if(math===null)return{removed:false,focus:null};if(math.className!=="math")return{removed:false,focus:null};let next_focus_node=null;let next_focus_offset=0;let edit_node=math.lastChild;const margin=GetEditMargin(math);let text_node=edit_node.firstChild;let mathtext=text_node.data.slice(margin,text_node.length-margin);let is_removed=mathtext.length===0;let pos_split_a_img=0;if(edit_node.className==="edita"||edit_node.className==="editimg"){pos_split_a_img=mathtext.indexOf("](");if(pos_split_a_img<0){is_removed=true}}if(is_removed){if(in_undo_redo){g_editable_math=null;return{removed:false,focus:null}}else{let highlight_word=null;if(IsHighlightMode()){highlight_word=nt_highlight.Word;NT_HighlightClear()}undo_man.Begin(text_node,margin);const parent=math.parentNode;const math_next=math.nextSibling;RemoveNode(math);let focus=SafeJunctionPoint(parent,math_next);undo_man.End(focus.node,focus.offset);document.getSelection().collapse(focus.node,focus.offset);if(highlight_word){NT_HighlightWord(highlight_word);focus=nt_highlight.HighlightFocus(focus.node,focus.offset)}g_editable_math=null;return{removed:true,focus:focus}}}switch(edit_node.className){case"editmath":{MathRendering(math,mathtext,-1);ShowPreview(math.firstChild)}break;case"editmathdisp":{MathRendering(math,mathtext,-1);ShowPreviewDisplay(math.firstChild);math.firstChild.style.width=String(math.firstChild.clientWidth)+"px";math.firstChild.style.height=String(math.firstChild.clientHeight)+"px"}break;case"editcode":{math.firstChild.firstChild.data=mathtext;ShowPreview(math.firstChild)}break;case"editcodedisp":{if(mathtext.charAt(0)==="\n"){math.firstChild.firstChild.data=mathtext.slice(1,mathtext.length-1)}else{math.firstChild.firstChild.data=mathtext}ShowPreviewDisplay(math.firstChild)}break;case"editem1":case"editem2":case"editem3":{let target=math.firstChild.firstChild;if(target.nodeType===Node.TEXT_NODE){target.data=mathtext}else{target.firstChild.data=mathtext}ShowPreview(math.firstChild)}break;case"editdeleted":{math.firstChild.firstChild.data=mathtext;ShowPreview(math.firstChild)}break;case"edita":{let target=math.firstChild;target.href=mathtext.slice(pos_split_a_img+2,mathtext.length+1);target.firstChild.data=mathtext.slice(0,pos_split_a_img);ShowPreview(target)}break;case"editimg":{const target=math.firstChild;target.src=nt_file_dir+mathtext.slice(pos_split_a_img+2,mathtext.length+1);target.alt=mathtext.slice(0,pos_split_a_img);ShowPreview(target)}break;case"editcite":{const target=math.firstChild;target.href="#"+mathtext;target.firstChild.data=mathtext;ShowPreview(target)}break;case"editref":{const target=math.firstChild;target.firstChild.data=mathtext;ShowPreview(target)}break;default:{alert("ERROR: invalid edit class in math like node")}break}SetHide(math.lastChild);g_editable_math=null;return{removed:false,focus:null}}function MathRendering(math,mathtext,number){let annotation=math.firstChild.getElementsByTagName("annotation");if(annotation){if(annotation.textContent===mathtext){return 0}}let edit_node=math.lastChild;let delta=0;if(edit_node.className==="editmath"){let ref_mathtext=ReferLabelEqnumber(mathtext);math.firstChild.remove();const fragment=new DocumentFragment;katex.render(ref_mathtext,fragment,{output:"html",displayMode:false,throwOnError:false});math.insertBefore(fragment,math.firstChild);math.firstChild.contentEditable=false}else if(edit_node.className==="editmathdisp"){if(number===0){math.firstChild.remove();const re_mathtext=ReplaceAll(mathtext,"{align}","{aligned}");const fragment=new DocumentFragment;katex.render(re_mathtext,fragment,{output:"html",displayMode:true,throwOnError:false});math.insertBefore(fragment,math.firstChild)}else{if(number<0){number=parseInt(math.dataset.eqnumberBegin,10)}math.firstChild.remove();delta=katexAutoNumber(mathtext,math,number);math.dataset.eqnumberBegin=number;math.dataset.eqnumberEnd=number+delta}math.firstChild.contentEditable=false}else{alert("invalid math editting")}return delta}function HidePreview(node){node.style.display="none"}function ShowPreview(node){node.style.display="inline"}function ShowPreviewDisplay(node){node.style.display="block"}function SetHide(node){node.style.cssText="border: 0; clip: rect(0 0 0 0); height: 1px; margin: -1px; overflow: hidden; padding: 0; position: absolute; white-space: nowrap; width: 1px;"}function UnsetHide(node){node.style.cssText="clip: auto; height: auto; margin: 0; overflow: visible; position: static; width: auto;"}function GetEditMargin(math){const class_name=math.className;return GetEditMarginByClassName(class_name==="math"?math.lastChild.className:class_name)}function GetEditMarginByClassName(class_name){switch(class_name){case"editmath":return 1;case"editmathdisp":return 2;case"editcode":return 1;case"editcodedisp":return 3;case"editem1":return 1;case"editem2":return 2;case"editem3":return 3;case"editdeleted":return 2;case"edita":return 1;case"editimg":return 2;case"editcite":return 2;case"editref":return 2;default:return 0}}function SetEqNumber(math,number){let delta=parseInt(math.dataset.eqnumberEnd,10)-parseInt(math.dataset.eqnumberBegin,10);math.dataset.eqnumberBegin=number;math.dataset.eqnumberEnd=number+delta}function IsTextNodeInMath(node){if(node.parentNode===null)return false;if(node.parentNode.parentNode===null)return false;return node.parentNode.parentNode.className==="math"}function QuickRedrawMath(render_div){let matches=render_div.querySelectorAll("span.editmathdisp");const whole_height=document.documentElement.clientHeight;console.log("scroll/resize",matches.length);for(let i=0;i<matches.length;i++){const editmath=matches[i];const math=editmath.parentNode;const katexdisp=math.firstChild;const katex=katexdisp.firstChild;if(katex&&"display"in katex.style){const rect=katexdisp.getBoundingClientRect();if(katex.style.display=="none"){if(rect.bottom>0&&rect.top<whole_height){if(math!==g_editable_math){katex.style.display=null}}}else{if(rect.bottom<0||rect.top>whole_height){if(rect.height>0){katexdisp.style.width=String(katexdisp.clientWidth)+"px";katexdisp.style.height=String(katexdisp.clientHeight)+"px"}katex.style.display="none"}}}}}function FullRedrawMath(render_div){let matches=render_div.querySelectorAll("span.editmathdisp");const whole_height=document.documentElement.clientHeight;console.log("all displayed math are visible",matches.length);for(let i=0;i<matches.length;i++){const editmath=matches[i];const math=editmath.parentNode;const katexdisp=math.firstChild;const katex=katexdisp.firstChild;katex.style.display=null}}"use strict";function MD2DOM(text_buffer){text_buffer=ReplaceAll(text_buffer,"\t","    ");let parent=new DocumentFragment;const buffer_length=text_buffer.length;let i=0;while(i<buffer_length){const ch=text_buffer.charAt(i);switch(ch){case"\n":{++i}break;case"#":{let k=i+1;let s=text_buffer.charAt(k);while(s==="#"){k++;s=text_buffer.charAt(k)}if(s===" "){let h1_node=document.createElement("H"+(k-i).toString());let p_end=ParseH1(text_buffer,k+1,h1_node);parent.appendChild(h1_node);i=p_end}else{let p_node=document.createElement("P");let p_end=ParseP(text_buffer,k,p_node);parent.appendChild(p_node);i=p_end}}break;case"-":case"+":case"*":{let s=text_buffer.charAt(i+1);if(s===" "){let ul_node=document.createElement("UL");let p_end=ParseOLUL(text_buffer,i,0,false,ul_node);parent.appendChild(ul_node);i=p_end}else{let p_node=document.createElement("P");let p_end=ParseP(text_buffer,i,p_node);parent.appendChild(p_node);i=p_end}}break;case" ":{let k=i+1;let s=text_buffer.charAt(k);while(s===" "){++k;s=text_buffer.charAt(k)}if(s==="-"||s==="+"||s==="*"){if(k-i>2){alert("ERROR: child list is written but parent list is not found.");i=k;break}}let p_node=document.createElement("P");let p_end=ParseP(text_buffer,i,p_node);parent.appendChild(p_node);i=p_end}break;case"[":{let is_reference=false;let k=i+1;if(text_buffer.charAt(k)==="^"){const k_end=text_buffer.indexOf("]:",k+1);if(k_end>0){const npos=text_buffer.indexOf("\n",k+1);if(npos>0&&k_end<npos||npos<0){is_reference=true;const math=document.createElement("SPAN");math.className="math";const preview=document.createElement("SPAN");preview.className="previewref";preview.appendChild(document.createTextNode(text_buffer.slice(k+1,k_end)));math.appendChild(preview);const edit=document.createElement("SPAN");edit.className="editref";edit.appendChild(document.createTextNode(text_buffer.slice(i,k_end+2)));math.appendChild(edit);let begin_pos=k_end+2;let s=text_buffer.charAt(begin_pos);while(s===" "){++begin_pos;s=text_buffer.charAt(begin_pos)}const p_node=document.createElement("P");p_node.appendChild(math);const p_end=ParseLI(text_buffer,begin_pos,p_node);CheckEmptyAndPutBR(p_node);parent.appendChild(p_node);i=p_end}}}if(!is_reference){const p_node=document.createElement("P");const p_end=ParseP(text_buffer,i,p_node);parent.appendChild(p_node);i=p_end}}break;default:{if("0"<=ch&&ch<="9"){let k=i+1;let s=text_buffer.charAt(k);while("0"<=s&&s<="9"){++k;s=text_buffer.charAt(k)}if(s==="."){++k;s=text_buffer.charAt(k);if(s===" "){let ol_node=document.createElement("OL");let p_end=ParseOLUL(text_buffer,i,0,true,ol_node);parent.appendChild(ol_node);i=p_end;break}}}let p_node=document.createElement("P");let p_end=ParseP(text_buffer,i,p_node);parent.appendChild(p_node);i=p_end;break}}}if(!parent.hasChildNodes()){const p=document.createElement("P");p.appendChild(document.createElement("BR"));parent.appendChild(p)}ConnectAdjacentText(parent);PrepareBR(parent);PrepareTable(parent);LinebreakToSpaceInP(parent);PrepareFigure(parent);PrepareZWBR2(parent);AssertAllforMath(parent);return parent}function MD2DOM_OneLine(text_buffer){text_buffer=ReplaceAll(text_buffer,"\t","    ");let parent=new DocumentFragment;const buffer_length=text_buffer.length;let i=0;while(i<buffer_length){let p_end=ParseH1(text_buffer,i,parent);i=p_end}ConnectAdjacentText(parent);AssertAllforMath(parent);return parent}function ParseP(text_buffer,i_begin,parent){const buffer_length=text_buffer.length;let offset=i_begin;let i=i_begin;while(i<buffer_length){const ch=text_buffer.charAt(i);switch(ch){case"\n":{const s=text_buffer.charAt(i+1);if(s==="\n"||s===""){if(i-offset>0){parent.appendChild(document.createTextNode(text_buffer.substring(offset,i)))}CheckEmptyAndPutBR(parent);return i+1}i++}break;case"$":{if(i-offset>0){parent.appendChild(document.createTextNode(text_buffer.substring(offset,i)))}let p_end=ParseMath(text_buffer,i,parent);offset=p_end;i=p_end}break;case"`":{if(i-offset>0){parent.appendChild(document.createTextNode(text_buffer.substring(offset,i)))}let p_end=ParseCode(text_buffer,i,parent);offset=p_end;i=p_end}break;case"*":{if(i-offset>0){parent.appendChild(document.createTextNode(text_buffer.substring(offset,i)))}const p_end=ParseEm(text_buffer,i,parent);offset=p_end;i=p_end}break;case"~":{let k=i+1;let s=text_buffer.charAt(k);if(s==="~"){if(i-offset>0){parent.appendChild(document.createTextNode(text_buffer.substring(offset,i)))}const p_end=ParseDel(text_buffer,i,parent);offset=p_end;i=p_end}}break;case"_":{if(!UnderscoreWithSpace(text_buffer,i)){++i;break}if(i-offset>0){parent.appendChild(document.createTextNode(text_buffer.substring(offset,i)))}const p_end=ParseEm(text_buffer,i,parent);offset=p_end;i=p_end}break;case"!":{if(i-offset>0){parent.appendChild(document.createTextNode(text_buffer.substring(offset,i)))}let p_end=ParseImg(text_buffer,i,parent);offset=p_end;i=p_end}break;case"[":{if(i-offset>0){parent.appendChild(document.createTextNode(text_buffer.substring(offset,i)))}let p_end;if(text_buffer.charAt(i+1)==="^"){p_end=ParseCite(text_buffer,i,parent)}else{p_end=ParseA(text_buffer,i,parent)}offset=p_end;i=p_end}break;case" ":{let k=i+1;let s=text_buffer.charAt(k);while(s===" "){++k;s=text_buffer.charAt(k)}if(s==="\n"){if(k-i>=2){if(offset<i){parent.appendChild(document.createTextNode(text_buffer.substring(offset,i)))}i=k;offset=i;break}}i=k}break;default:++i}}if(i-offset>0){parent.appendChild(document.createTextNode(text_buffer.substring(offset,i)))}CheckEmptyAndPutBR(parent);return buffer_length}function ParseH1(text_buffer,i_begin,parent){const buffer_length=text_buffer.length;let offset=i_begin;let i=i_begin;while(i<buffer_length){const ch=text_buffer.charAt(i);switch(ch){case"\n":{if(i-offset>0){parent.appendChild(document.createTextNode(text_buffer.substring(offset,i)))}CheckEmptyAndPutBR(parent);return i+1}break;case"$":{if(i-offset>0){parent.appendChild(document.createTextNode(text_buffer.substring(offset,i)))}let p_end=ParseMath(text_buffer,i,parent,false);offset=p_end;i=p_end}break;case"`":{if(i-offset>0){parent.appendChild(document.createTextNode(text_buffer.substring(offset,i)))}let p_end=ParseCode(text_buffer,i,parent,false);offset=p_end;i=p_end}break;case"*":{if(i-offset>0){parent.appendChild(document.createTextNode(text_buffer.substring(offset,i)))}const p_end=ParseEm(text_buffer,i,parent);offset=p_end;i=p_end}break;case"_":{if(!UnderscoreWithSpace(text_buffer,i)){++i;break}if(i-offset>0){parent.appendChild(document.createTextNode(text_buffer.substring(offset,i)))}const p_end=ParseEm(text_buffer,i,parent);offset=p_end;i=p_end}break;case"!":{if(i-offset>0){parent.appendChild(document.createTextNode(text_buffer.substring(offset,i)))}let p_end=ParseImg(text_buffer,i,parent);offset=p_end;i=p_end}break;case"[":{if(i-offset>0){parent.appendChild(document.createTextNode(text_buffer.substring(offset,i)))}let p_end;if(text_buffer.charAt(i+1)==="^"){p_end=ParseCite(text_buffer,i,parent)}else{p_end=ParseA(text_buffer,i,parent)}offset=p_end;i=p_end}break;default:++i}}if(i-offset>0){parent.appendChild(document.createTextNode(text_buffer.substring(offset,i)))}CheckEmptyAndPutBR(parent);return buffer_length}function ParseOLUL(text_buffer,i_begin,num_head_spaces,is_numbered,parent){let li_node=null;let i=i_begin;const buffer_length=text_buffer.length;let offset=i;while(i<buffer_length){const ch=text_buffer.charAt(i);const space=i-offset;switch(ch){case"\n":{if(i>offset){return offset}else{++i;offset=i;continue}}case" ":{++i;continue}case"-":case"+":case"*":{if(space<num_head_spaces){return offset}let s=text_buffer.charAt(i+1);if(s==" "){if(space>=num_head_spaces+2){let ul_node=document.createElement("UL");let p_end=ParseOLUL(text_buffer,offset,space,false,ul_node);li_node.appendChild(ul_node);i=p_end;offset=i;continue}else if(is_numbered){return offset}else{li_node=document.createElement("LI");let p_end=ParseLI(text_buffer,i+2,li_node);parent.appendChild(li_node);i=p_end;offset=i;continue}}}break;default:{if("0"<=ch&&ch<="9"){if(space<num_head_spaces){return offset}let k=i+1;let s=text_buffer.charAt(k);while("0"<=s&&s<="9"){++k;s=text_buffer.charAt(k)}if(s=="."){++k;s=text_buffer.charAt(k);if(s==" "){if(space>=num_head_spaces+2){let ol_node=document.createElement("OL");let p_end=ParseOLUL(text_buffer,offset,space,true,ol_node);li_node.appendChild(ol_node);i=p_end;offset=i;continue}else if(!is_numbered){return offset}else{li_node=document.createElement("LI");let p_end=ParseLI(text_buffer,k+1,li_node);parent.appendChild(li_node);i=p_end;offset=i;continue}}}}}break}if(space>=2){const p_end=ParseLI(text_buffer,i,li_node);i=p_end;offset=i}else{return offset}}return buffer_length}function ParseLI(text_buffer,i_begin,parent){const buffer_length=text_buffer.length;let offset=i_begin;let i=i_begin;while(i<buffer_length){const ch=text_buffer.charAt(i);switch(ch){case"\n":{if(i-offset>0){let text=text_buffer.substring(offset,i);parent.appendChild(document.createTextNode(text))}return i+1}case"$":{if(i-offset>0){parent.appendChild(document.createTextNode(text_buffer.substring(offset,i)))}const p_end=ParseMath(text_buffer,i,parent,true);offset=p_end;i=p_end}break;case"`":{if(i-offset>0){parent.appendChild(document.createTextNode(text_buffer.substring(offset,i)))}const p_end=ParseCode(text_buffer,i,parent,true);offset=p_end;i=p_end}break;case"*":{if(i-offset>0){parent.appendChild(document.createTextNode(text_buffer.substring(offset,i)))}const p_end=ParseEm(text_buffer,i,parent);offset=p_end;i=p_end}break;case"_":{if(!UnderscoreWithSpace(text_buffer,i)){++i;break}if(i-offset>0){parent.appendChild(document.createTextNode(text_buffer.substring(offset,i)))}const p_end=ParseEm(text_buffer,i,parent);offset=p_end;i=p_end}break;case"!":{if(i-offset>0){parent.appendChild(document.createTextNode(text_buffer.substring(offset,i)))}let p_end=ParseImg(text_buffer,i,parent);offset=p_end;i=p_end}break;case"[":{if(i-offset>0){parent.appendChild(document.createTextNode(text_buffer.substring(offset,i)))}let p_end;if(text_buffer.charAt(i+1)==="^"){p_end=ParseCite(text_buffer,i,parent)}else{p_end=ParseA(text_buffer,i,parent)}offset=p_end;i=p_end}break;default:++i}}if(i-offset>0){parent.appendChild(document.createTextNode(text_buffer.substring(offset,i)))}CheckEmptyAndPutBR(parent);return buffer_length}function ParseMath(text_buffer,i_begin,parent,allow_display=true){let i=i_begin;let s=text_buffer.charAt(i+1);if(s=="$"){if(allow_display){let p=text_buffer.indexOf("$$",i+2);let math_text;let restart_pos;if(p>=0){math_text=text_buffer.substring(i,p+2);restart_pos=p+2;const prev_n=text_buffer.lastIndexOf("\n",i);const rep_str="\n"+" ".repeat(prev_n<0?i:i-prev_n-1);math_text=ReplaceAll(math_text,rep_str,"\n");let span=document.createElement("SPAN");span.className="editmathdisp";span.appendChild(document.createTextNode(math_text));let math=document.createElement("SPAN");math.className="math";math.appendChild(document.createElement("SPAN"));math.appendChild(span);parent.appendChild(math);return restart_pos}}i++}{let p=text_buffer.indexOf("$",i+1);let math_text;let restart_pos;if(p>=0){math_text=text_buffer.substring(i,p+1);restart_pos=p+1}else{let pn=text_buffer.indexOf("\n",i+1);if(pn>=0){math_text=text_buffer.substring(i,pn)+"$";restart_pos=pn}else{math_text=text_buffer.substring(i)+"$";restart_pos=text_buffer.length}}let span=document.createElement("SPAN");span.className="editmath";span.appendChild(document.createTextNode(math_text));let math=document.createElement("SPAN");math.className="math";math.appendChild(document.createElement("SPAN"));math.appendChild(span);parent.appendChild(math);return restart_pos}}function ParseCode(text_buffer,i_begin,parent,allow_display=true){let i=i_begin;const s=text_buffer.charAt(i+1);const s2=text_buffer.charAt(i+2);if(s==="`"&&s2==="`"){if(allow_display){let p=text_buffer.indexOf("```",i+3);let math_text;let restart_pos;if(p>=0){math_text=text_buffer.substring(i,p+3);restart_pos=p+3;const prev_n=text_buffer.lastIndexOf("\n",i);const rep_str="\n"+" ".repeat(prev_n<0?i:i-prev_n-1);math_text=ReplaceAll(math_text,rep_str,"\n");const pre=document.createElement("SPAN");pre.className="previewcodedisp";pre.textContent="previewcodedisp";const span=document.createElement("SPAN");span.className="editcodedisp";span.appendChild(document.createTextNode(math_text));const math=document.createElement("SPAN");math.className="math";math.appendChild(pre);math.appendChild(span);parent.appendChild(math);return restart_pos}}i+=2}{const p=text_buffer.indexOf("`",i+1);let math_text;let restart_pos;if(p>=0){math_text=text_buffer.substring(i,p+1);restart_pos=p+1}else{let pn=text_buffer.indexOf("\n",i+1);if(pn>=0){math_text=text_buffer.substring(i,pn)+"`";restart_pos=pn}else{math_text=text_buffer.substring(i)+"`";restart_pos=text_buffer.length}}const pre=document.createElement("SPAN");pre.className="previewcode";pre.textContent="previewcode";const span=document.createElement("SPAN");span.className="editcode";span.appendChild(document.createTextNode(math_text));const math=document.createElement("SPAN");math.className="math";math.appendChild(pre);math.appendChild(span);parent.appendChild(math);return restart_pos}}function ParseDel(text_buffer,i_begin,parent){const i=i_begin;const ch=text_buffer.charAt(i);let k=i+1;if(text_buffer.charAt(k)!=ch){return ErrorTag(text_buffer,i,parent)}const mark="~~";const p=text_buffer.indexOf(mark,k+1);let math_text;let restart_pos;if(p>=0){math_text=text_buffer.substring(i,p+2);restart_pos=p+2}else{let pn=text_buffer.indexOf("\n",k+1);if(pn>=0){math_text=text_buffer.substring(i,pn)+mark;restart_pos=pn;p=pn}else{math_text=text_buffer.substring(i)+mark;restart_pos=text_buffer.length;p=text_buffer.length}}const pre=document.createElement("SPAN");pre.className="previewdeleted";pre.textContent="previewdeleted";const span=document.createElement("SPAN");span.className="editdeleted";span.appendChild(document.createTextNode(math_text));const math=document.createElement("SPAN");math.className="math";math.appendChild(pre);math.appendChild(span);parent.appendChild(math);return restart_pos}function UnderscoreWithSpace(text_buffer,i_begin){const i=i_begin;const ch=text_buffer.charAt(i);if(i>0){if(text_buffer.charAt(i-1)!=" "){return false}}let k=i+1;while(text_buffer.charAt(k)===ch){k++}const mark=ch.repeat(k-i);const p=text_buffer.indexOf(mark,k);if(p>0){if(p+(k-i)<text_buffer.length){if(text_buffer.charAt(p+(k-i))!=" "){return false}}}const s=text_buffer.indexOf(" ",k);if(s>0&&s<p){return false}return true}function ParseEm(text_buffer,i_begin,parent){const i=i_begin;const ch=text_buffer.charAt(i);let k=i+1;while(text_buffer.charAt(k)==ch){k++}if(k-i<=3){const mark=ch.repeat(k-i);const p=text_buffer.indexOf(mark,k+1);let math_text;let restart_pos;if(p>=0){math_text=text_buffer.substring(i,p+(k-i));restart_pos=p+(k-i)}else{let pn=text_buffer.indexOf("\n",k+2);if(pn>=0){math_text=text_buffer.substring(i,pn)+mark;restart_pos=pn;p=pn}else{math_text=text_buffer.substring(i)+mark;restart_pos=text_buffer.length;p=text_buffer.length}}const math=document.createElement("SPAN");math.className="math";if(k-i===1){const span=document.createElement("EM");span.appendChild(document.createTextNode(text_buffer.substring(k,p)));math.appendChild(span)}else if(k-i===2){const span=document.createElement("STRONG");span.appendChild(document.createTextNode(text_buffer.substring(k,p)));math.appendChild(span)}else{const span=document.createElement("STRONG");span.appendChild(document.createTextNode(text_buffer.substring(k,p)));const span1=document.createElement("EM");span1.appendChild(span);math.appendChild(span1)}const edit=document.createElement("SPAN");edit.className="editem"+(k-i).toString();edit.appendChild(document.createTextNode(math_text));math.appendChild(edit);parent.appendChild(math);return restart_pos}else{const mark=ch.repeat(k-i);alert("ERROR: emphasis mark "+mark+" is repeating greater than 3 characters.");return ErrorTag(text_buffer,i,parent)}}function ParseImg(text_buffer,i_begin,parent){let k=i_begin+1;if(text_buffer.charAt(k)!=="["){parent.appendChild(document.createTextNode(text_buffer.substring(i,k)));return k}let k_end=text_buffer.indexOf("]",k+1);if(k_end<0){alert("ERROR: img '![]()' has no '' symbol.");return ErrorTag(text_buffer,k,parent)}let s=k_end+1;while(text_buffer.charAt(s)===" "){s++}if(text_buffer.charAt(s)!=="("){alert("ERROR: link '[]()' has no '(' symbol.");return ErrorTag(text_buffer,k,parent)}let s_end=text_buffer.indexOf(")",s+1);if(s_end<0){alert("ERROR: link '[]()' has no ')' symbol.");return ErrorTag(text_buffer,k,parent)}const math=document.createElement("SPAN");math.className="math";const img=document.createElement("IMG");img.alt=text_buffer.substring(k+1,k_end);img.src=text_buffer.substring(s+1,s_end);math.appendChild(img);const edit=document.createElement("SPAN");edit.className="editimg";edit.appendChild(document.createTextNode(text_buffer.substring(i_begin,s_end+1)+" "));math.appendChild(edit);parent.appendChild(math);return s_end+1}function ParseA(text_buffer,i_begin,parent){let k=i_begin;let k_end=text_buffer.indexOf("]",k+1);if(k_end<0){alert("ERROR: link '[]()' has no ']' symbol.");return ErrorTag(text_buffer,k,parent)}let s=k_end+1;while(text_buffer.charAt(s)===" "){s++}if(text_buffer.charAt(s)!=="("){parent.appendChild(document.createTextNode(text_buffer.substring(i_begin,s)));return s}let s_end=text_buffer.indexOf(")",s+1);if(s_end<0){alert("ERROR: link '[]()' has no ')' symbol.");return ErrorTag(text_buffer,k,parent)}const math=document.createElement("SPAN");math.className="math";const a=document.createElement("A");a.href=text_buffer.substring(s+1,s_end);a.target="_blank";a.ref="noopener noreferrer";a.appendChild(document.createTextNode(text_buffer.substring(k+1,k_end)));math.appendChild(a);const edit=document.createElement("SPAN");edit.className="edita";edit.appendChild(document.createTextNode(text_buffer.substring(i_begin,s_end+1)));math.appendChild(edit);parent.appendChild(math);return s_end+1}function ParseCite(text_buffer,i_begin,parent){let k=i_begin;let p=text_buffer.indexOf("]",k+1);let math_text;let restart_pos;if(p>=0){math_text=text_buffer.substring(i_begin,p+1);restart_pos=p+1}else{let pn=text_buffer.indexOf("\n",i_begin+2);if(pn>=0){math_text=text_buffer.substring(i_begin,pn)+"]";restart_pos=pn;p=pn}else{math_text=text_buffer.substring(i_begin)+"]";restart_pos=text_buffer.length;p=text_buffer.length}}const math=document.createElement("SPAN");math.className="math";const a=document.createElement("A");const text=text_buffer.substring(i_begin+2,p);a.href="#"+text;a.className="previewcite";a.appendChild(document.createTextNode(text));math.appendChild(a);const edit=document.createElement("SPAN");edit.className="editcite";edit.appendChild(document.createTextNode(math_text+" "));math.appendChild(edit);parent.appendChild(math);return restart_pos}function GetEndSemantics(text_buffer,i_begin){const p_end=text_buffer.indexOf("\n",i_begin);return p_end<0?text_buffer.length:p_end}function ErrorTag(text_buffer,i_begin,parent){const i_end=GetEndSemantics(text_buffer,i_begin+1);let span=document.createElement("EM");span.className="readerror";span.appendChild(document.createTextNode(text_buffer.substring(i_begin,i_end)));parent.appendChild(span);return i_end}function CheckEmptyAndPutBR(parent){if(parent.childNodes.length===0){parent.appendChild(document.createElement("BR"))}else if(parent.childNodes.length===1){if(parent.firstChild.nodeType===Node.TEXT_NODE){if(parent.firstChild.data.trim().length===0){parent.removeChild(parent.firstChild);parent.appendChild(document.createElement("BR"))}}}}function ConnectAdjacentText(parent){let next=null;for(let node=parent.firstChild;node;node=next){next=node.nextSibling;if(node.nodeType===Node.TEXT_NODE){if(next){if(next.nodeType===Node.TEXT_NODE){node.appendData(next.data);parent.removeChild(next);next=node}}}else if(node.hasChildNodes()){ConnectAdjacentText(node)}}}function PrepareBR(parent){let next=null;for(let node=parent.firstChild;node;node=next){next=node.nextSibling;if(node.hasChildNodes()){PrepareBR(node)}else{if(["P","LI","H1","H2","H3","H4","H5","H6","FIGCAPTION","TD","TH"].includes(node.nodeName)){node.appendChild(document.createElement("BR"))}}if(["LI","FIGURE"].includes(node.nodeName)){if(["OL","UL","FIGCAPTION"].includes(node.firstChild.nodeName)){node.insertBefore(document.createElement("BR"),node.firstChild)}}}}function PrepareFigure(parent){let next=null;for(let node=parent.firstChild;node;node=next){next=node.nextSibling;if(node.nodeName==="P"){if(node.firstChild.nodeName==="SPAN"){if(node.firstChild.className==="math"){if(node.firstChild.lastChild.className==="editimg"){let first_text=null;for(first_text=node.firstChild.nextSibling;first_text;first_text=first_text.nextSibling){if(first_text.nodeName!=="SPAN"){break}if(first_text.className!=="math"){break}if(first_text.lastChild.className!=="editimg"){break}}const figure=document.createElement("FIGURE");while(node.firstChild!==first_text){figure.appendChild(node.removeChild(node.firstChild))}const caption=document.createElement("FIGCAPTION");while(node.firstChild){caption.appendChild(node.removeChild(node.firstChild))}if(caption.firstChild===null){caption.appendChild(document.createElement("BR"))}figure.appendChild(caption);parent.insertBefore(figure,node);parent.removeChild(node)}}}}}}function LinebreakToSpaceInP(parent){let next=null;for(let node=parent.firstChild;node;node=next){next=node.nextSibling;if(node.nodeName==="P"){for(let t_node=node.firstChild;t_node;t_node=t_node.nextSibling){if(t_node.nodeType===Node.TEXT_NODE){const text=t_node.data;if(text.indexOf("\n")>=0){t_node.data=ReplaceLinebreakToSpaceForJP(text)}}}}}}function PrepareTable(parent){let next=null;for(let node=parent.firstChild;node;node=next){next=node.nextSibling;if(node.nodeName==="P"){let flb_node=null;let flb_offset=0;for(let t_node=node.firstChild;t_node;t_node=t_node.nextSibling){if(t_node.nodeType===Node.TEXT_NODE){const t_offset=t_node.data.indexOf("\n");if(t_offset>=0){flb_node=t_node;flb_offset=t_offset;break}}}if(flb_node===null)continue;let has_split=false;for(let t_node=node.firstChild;t_node!==flb_node;t_node=t_node.nextSibling){if(t_node.nodeType===Node.TEXT_NODE){if(t_node.data.indexOf("|")>=0){has_split=true;break}}}if(!has_split){const pos_split=flb_node.data.indexOf("|");if(pos_split<0)continue;if(pos_split>flb_offset)continue}const slb_offset=flb_node.data.indexOf("\n",flb_offset+1);const second_line=flb_node.data.slice(flb_offset+1,slb_offset<0?flb_node.length:slb_offset);if(!IsSecondLineOfTableMD(second_line))continue;for(let i=0;i<second_line.length;++i){if("-:| ".indexOf(second_line[i])<0)continue}const table=document.createElement("TABLE");{const frag_tr=SplitLineToTD(node,"\n","TR");const tr1st=frag_tr.firstChild;{const frag_td=SplitLineToTD(tr1st,"|","TH");tr1st.appendChild(frag_td)}const num_column=tr1st.childNodes.length;for(let tr=tr1st.nextSibling;tr;tr=tr.nextSibling){const frag_td=SplitLineToTD(tr,"|","TD");while(frag_td.childNodes.length>num_column){frag_td.removeChild(frag_td.lastChild)}while(frag_td.childNodes.length<num_column){const td=document.createElement("TD");td.appendChild(document.createElement("BR"));frag_td.appendChild(td)}tr.appendChild(frag_td)}table.appendChild(frag_tr)}parent.insertBefore(table,node);parent.removeChild(node)}}}function IsSecondLineOfTableMD(second_line){for(let i=0;i<second_line.length;++i){if("-:| ".indexOf(second_line[i])<0)return false}if(second_line.indexOf("|")<0)return false;if(second_line.indexOf("-")<0)return false;return true}function SplitLineToNodes(parent,symbol,tag_name){const fragment=new DocumentFragment;let td=document.createElement(tag_name);fragment.appendChild(td);let next=null;for(let node=parent.firstChild;node;node=next){next=node.nextSibling;if(node.nodeType===Node.TEXT_NODE){let target=parent.removeChild(node);let pos_split=target.data.indexOf(symbol);while(pos_split>=0){if(pos_split>0){const after_text=target.splitText(pos_split);td.appendChild(target);target=after_text}if(td.hasChildNodes()){td=document.createElement(tag_name)}else{if(fragment.firstChild!==td){td.appendChild(document.createElement("BR"));td=document.createElement(tag_name)}}fragment.appendChild(td);if(target.length===1){target.data="";break}target=target.splitText(1);pos_split=target.data.indexOf(symbol)}if(target.length>0){td.appendChild(target)}}else{td.appendChild(parent.removeChild(node))}}if(!td.hasChildNodes()){td.remove()}return fragment}function SplitLineToTD(parent,symbol,tag_name){for(let node=parent.firstChild;node;node=node.nextSibling){if(node.nodeType===Node.TEXT_NODE){const pos_split=node.data.indexOf(symbol);if(pos_split>=0){if(pos_split>0){const after=node.splitText(pos_split);node=after}if(node.length>1){node.splitText(1)}}}}const fragment=new DocumentFragment;let td=document.createElement(tag_name);if(parent.firstChild.nodeType===Node.TEXT_NODE){if(parent.firstChild.data==symbol){parent.removeChild(parent.firstChild)}}while(parent.firstChild){if(parent.firstChild.nodeType===Node.TEXT_NODE){if(parent.firstChild.data==symbol){parent.removeChild(parent.firstChild);if(td.firstChild===null){td.appendChild(document.createElement("BR"))}fragment.appendChild(td);td=document.createElement(tag_name);continue}}td.appendChild(parent.removeChild(parent.firstChild))}if(td.firstChild!==null){fragment.appendChild(td)}return fragment}function PrepareZWBR2(parent){for(let node=parent.firstChild;node;node=node.nextSibling){switch(node.nodeName){case"P":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"LI":case"FIGCAPTION":case"TD":case"TH":{PrepereZWBR_funcP2(node)}break}if(node.hasChildNodes()){PrepareZWBR2(node)}}}function PrepereZWBR_funcP2(p_node){if(p_node.firstChild===null){p_node.appendChild(document.createElement("BR"));return}let is_prev_math=true;for(let node=p_node.firstChild;node;node=node.nextSibling){switch(node.nodeName){case"SPAN":if(is_prev_math){p_node.insertBefore(document.createTextNode(nt_ZWBR),node)}is_prev_math=true;break;case"OL":case"UL":if(is_prev_math){if(node.previousSibling){p_node.insertBefore(document.createTextNode(nt_ZWBR),node)}else{p_node.insertBefore(document.createElement("BR"),node)}}is_prev_math=false;break;case"BR":is_prev_math=false;break;default:is_prev_math=false}}if(is_prev_math){p_node.appendChild(document.createTextNode(nt_ZWBR))}}const AssertAllforMath=parent=>{for(let node=parent.firstChild;node;node=node.nextSibling){if(["P","H1","H2","H3","H4","H5","H6","LI","FIGCAPTION","TD","TH"].includes(node.nodeName)){AssertValidateMathInParent(node)}if(node.hasChildNodes()){AssertAllforMath(node)}}};"use strict";let nt_selected_cell=null;let nt_anchor_cell=null;const NT_SELECT_CELL_MODE=-256;function IsTableSelectionMode(){return!(nt_selected_cell===null)}function SwitchInputArrowLeftTable(node,offset){if(!nt_selected_cell.previousSibling)return true;if(nt_selected_cell.previousSibling.classList.contains("selectcell")){ReleaseTableSelectVertical(nt_selected_cell)}else{const index=GetIndex(nt_selected_cell.parentNode,nt_selected_cell);const table=nt_selected_cell.parentNode.parentNode;table.childNodes.forEach((tr=>{const td=tr.childNodes.item(index);if(td.classList.contains("selectcell")){td.previousSibling.classList.add("selectcell")}}))}nt_selected_cell.classList.remove("maincell");nt_selected_cell=nt_selected_cell.previousSibling;nt_selected_cell.classList.add("maincell")}function SwitchInputArrowRightTable(node,offset){if(!nt_selected_cell.nextSibling)return true;if(nt_selected_cell.nextSibling.classList.contains("selectcell")){ReleaseTableSelectVertical(nt_selected_cell)}else{const index=GetIndex(nt_selected_cell.parentNode,nt_selected_cell);const table=nt_selected_cell.parentNode.parentNode;table.childNodes.forEach((tr=>{const td=tr.childNodes.item(index);if(td.classList.contains("selectcell")){td.nextSibling.classList.add("selectcell")}}))}nt_selected_cell.classList.remove("maincell");nt_selected_cell=nt_selected_cell.nextSibling;nt_selected_cell.classList.add("maincell")}function SwitchInputArrowUpTable(node,offset){const tr=nt_selected_cell.parentNode;if(!tr)return true;if(!tr.previousSibling)return true;const index=GetIndex(tr,nt_selected_cell);const next_cell=tr.previousSibling.childNodes.item(index);if(next_cell.classList.contains("selectcell")){ReleaseTableSelectHorizontal(nt_selected_cell)}else{let tdp=tr.previousSibling.firstChild;for(let td=tr.firstChild;td;td=td.nextSibling){if(td.classList.contains("selectcell")){tdp.classList.add("selectcell")}tdp=tdp.nextSibling}}nt_selected_cell.classList.remove("maincell");nt_selected_cell=next_cell;nt_selected_cell.classList.add("maincell")}function SwitchInputArrowDownTable(node,offset){const tr=nt_selected_cell.parentNode;if(!tr)return true;if(!tr.nextSibling)return true;const index=GetIndex(tr,nt_selected_cell);const next_cell=tr.nextSibling.childNodes.item(index);if(next_cell.classList.contains("selectcell")){ReleaseTableSelectHorizontal(nt_selected_cell)}else{let tdp=tr.nextSibling.firstChild;for(let td=tr.firstChild;td;td=td.nextSibling){if(td.classList.contains("selectcell")){tdp.classList.add("selectcell")}tdp=tdp.nextSibling}}nt_selected_cell.classList.remove("maincell");nt_selected_cell=next_cell;nt_selected_cell.classList.add("maincell")}function ReleaseTableSelectAll(){if(!nt_selected_cell)return;const parent=nt_selected_cell.parentNode;nt_selected_cell.classList.remove("maincell");nt_selected_cell=null;if(!parent)return;const table=parent.parentNode;if(!table)return;table.childNodes.forEach((tr=>{tr.childNodes.forEach((td=>{td.classList.remove("selectcell")}))}))}function ReleaseTableSelectVertical(cell){if(!cell)return;if(!cell.parentNode)return;const table=cell.parentNode.parentNode;if(!table)return;const index=GetIndex(cell.parentNode,cell);table.childNodes.forEach((tr=>{const td=tr.childNodes.item(index);td.classList.remove("selectcell")}))}function ReleaseTableSelectHorizontal(cell){if(!cell)return;if(!cell.parentNode)return;const table=cell.parentNode.parentNode;if(!table)return;const tr=cell.parentNode;tr.childNodes.forEach((td=>{td.classList.remove("selectcell")}))}function CheckNodeInTD(ref_node,master_node){let node=ref_node;while(node){if(node===master_node){return null}if(node.nodeName==="TD"||node.nodeName==="TH"){return node}node=node.parentNode}return null}function OnMouseDownTable(event){if(!event.shiftKey){if(nt_selected_cell){ReleaseTableSelectAll()}return true}return CommonMouseDownAndMoveTable(event)}function OnMouseMoveTable(event){if((event.buttons&1)==0)return true;return CommonMouseDownAndMoveTable(event)}function CommonMouseDownAndMoveTable(event){const node=document.elementFromPoint(event.clientX,event.clientY);if(!node){console.log("invalid node");return true}const selection=document.getSelection();if(nt_selected_cell){const td=CheckNodeInTD(node,nt_render_div);if(td){if(IsSameTable(td,nt_selected_cell)){const anchor_td=nt_anchor_cell;ReleaseTableSelectAll();if(SetSelectTable(anchor_td,td)){event.preventDefault();return false}}}if(selection.rangeCount>0){const focus=FocusOffsetZero(nt_selected_cell);selection.collapse(focus.node,focus.offset)}event.preventDefault();return false}else{const td=CheckNodeInTD(node,nt_render_div);const anchor=CheckNodeInTD(selection.anchorNode,nt_render_div);if(anchor){if(td){if(anchor===td){return true}if(IsSameTable(anchor,td)){if(SetSelectTable(anchor,td)){event.preventDefault();return false}}const table_focus=td.parentNode.parentNode;const table_anchor=anchor.parentNode.parentNode;const master=table_focus.parentNode;const index_focus=GetIndex(master,table_focus);const index_anchor=GetIndex(master,table_anchor);if(index_anchor<index_focus){selection.setBaseAndExtent(master,index_anchor,master,index_focus+1)}else{selection.setBaseAndExtent(master,index_focus,master,index_anchor+1)}event.preventDefault();return false}else{const table=anchor.parentNode.parentNode;const master=table.parentNode;const top_focus=FindTopNode(node,master);if(!top_focus){event.preventDefault();return false}const index_table=GetIndex(master,table);const index_focus=GetIndex(master,top_focus);if(index_table<index_focus){selection.setBaseAndExtent(master,index_table,node,0)}else{selection.setBaseAndExtent(master,index_table+1,node,0)}return true}}}return true}function SetSelectTable(anchor_td,focus_td){if(nt_selected_cell){nt_selected_cell.classList.remove("maincell")}if(anchor_td){if(focus_td){nt_selected_cell=focus_td;nt_anchor_cell=anchor_td;const range=RangeSelectedIndexes();SelectCells(range);nt_selected_cell.classList.add("maincell");if(document.getSelection().rangeCount>0){document.getSelection().collapseToStart()}return true}}return false}function IsSameTable(anchor_td,focus_td){const anchor_tr=anchor_td.parentNode;const select_tr=focus_td.parentNode;const table=select_tr.parentNode;if(table!==anchor_tr.parentNode){return false}return true}function SelectCells(range){const selection=document.getSelection();const table=nt_selected_cell.parentNode.parentNode;let tr=table.childNodes.item(range.tr.begin);for(let k=range.tr.begin;k<range.tr.end;++k){let td=tr.childNodes.item(range.td.begin);for(let i=range.td.begin;i<range.td.end;++i){td.classList.add("selectcell");td=td.nextSibling}tr=tr.nextSibling}return true}function FindTopNode(node,master){while(node){if(node.parentNode===master)return node;node=node.parentNode}return node}function CorrectSelectionEdgeTable(){const selection=document.getSelection();if(selection.isCollapsed)return true;const range=selection.getRangeAt(0);const start_node=range.startContainer;const end_node=range.endContainer;let anchor_node=selection.anchorNode;let anchor_offset=selection.anchorOffset;let focus_node=selection.focusNode;let focus_offset=selection.focusOffset;const anchor_td=CheckNodeInTD(anchor_node,nt_render_div);const focus_td=CheckNodeInTD(focus_node,nt_render_div);if(!!focus_td&&focus_td===anchor_td)return true;const anchor_table=anchor_td?anchor_td.parentNode.parentNode:anchor_node.nodeName=="TABLE"?anchor_node:anchor_node.nodeName=="TR"?anchor_node.parentNode:null;if(anchor_table){const index=GetIndex(anchor_table.parentNode,anchor_table);if(anchor_node===start_node){anchor_offset=index}else{anchor_offset=index+1}anchor_node=anchor_table.parentNode}const focus_table=focus_td?focus_td.parentNode.parentNode:focus_node.nodeName=="TABLE"?focus_node:focus_node.nodeName=="TR"?focus_node.parentNode:null;if(focus_table){const index=GetIndex(focus_table.parentNode,focus_table);if(focus_node===start_node){focus_offset=index}else{focus_offset=index+1}focus_node=focus_table.parentNode}if(anchor_table||focus_table){selection.setBaseAndExtent(anchor_node,anchor_offset,focus_node,focus_offset);return false}return true}function OnKeydownForNavigationTable(event){console.log("keydown(Navi:Table):",event.key);const selection=document.getSelection();const[node,offset]=[nt_selected_cell,0];switch(event.key){case"ArrowUp":{event.preventDefault();if(event.getModifierState("Shift")){SwitchInputArrowUpTable(node,offset)}else{const focus_node=nt_selected_cell.firstChild;ReleaseTableSelectAll();if(focus_node.nodeType==Node.TEXT_NODE){selection.collapse(focus_node,0)}else{selection.collapse(focus_node.parentNode,0)}}}break;case"ArrowDown":{event.preventDefault();if(event.getModifierState("Shift")){SwitchInputArrowDownTable(node,offset)}else{const focus_node=nt_selected_cell.lastChild;ReleaseTableSelectAll();if(focus_node.nodeType==Node.TEXT_NODE){selection.collapse(focus_node,focus_node.length)}else{selection.collapse(focus_node.parentNode,focus_node.parentNode.childNodes.length)}}}break;case"ArrowLeft":{event.preventDefault();if(event.getModifierState("Shift")){SwitchInputArrowLeftTable(node,offset)}else{const focus_node=nt_selected_cell.firstChild;ReleaseTableSelectAll();if(focus_node.nodeType==Node.TEXT_NODE){selection.collapse(focus_node,0)}else{selection.collapse(focus_node.parentNode,0)}}}break;case"ArrowRight":{event.preventDefault();if(event.getModifierState("Shift")){SwitchInputArrowRightTable(node,offset)}else{const focus_node=nt_selected_cell.lastChild;ReleaseTableSelectAll();if(focus_node.nodeType==Node.TEXT_NODE){selection.collapse(focus_node,focus_node.length)}else{selection.collapse(focus_node.parentNode,focus_node.parentNode.childNodes.length)}}}break;case"Enter":{}break;case"Delete":case"Backspace":{event.preventDefault();if(IsHighlightMode()){NT_HighlightClear()}const range=RangeSelectedIndexes();undo_man.Begin(nt_selected_cell,NT_SELECT_CELL_MODE,nt_anchor_cell,NT_SELECT_CELL_MODE);DeleteSelectedCells(range);undo_man.End(nt_selected_cell,0);selection.collapse(nt_selected_cell,0);ReleaseTableSelectAll()}break;case"Tab":{event.preventDefault()}break}return}function RangeSelectedIndexes(){if(!nt_selected_cell)return null;const focus_tr=nt_selected_cell.parentNode;const anchor_tr=nt_anchor_cell.parentNode;const table=focus_tr.parentNode;if(!table)return null;let end_td_index=GetIndex(focus_tr,nt_selected_cell);let begin_td_index=GetIndex(anchor_tr,nt_anchor_cell);let end_tr_index=GetIndex(table,focus_tr);let begin_tr_index=GetIndex(table,anchor_tr);if(begin_td_index>end_td_index){const temp=end_td_index;end_td_index=begin_td_index;begin_td_index=temp}if(begin_tr_index>end_tr_index){const temp=end_tr_index;end_tr_index=begin_tr_index;begin_tr_index=temp}end_tr_index++;end_td_index++;return{tr:{begin:begin_tr_index,end:end_tr_index},td:{begin:begin_td_index,end:end_td_index}}}function CopySelectedCells(range){const table=nt_selected_cell.parentNode.parentNode;let text="";let tr=table.childNodes.item(range.tr.begin);for(let k=range.tr.begin;k<range.tr.end;++k){if(k!=1){let td=tr.childNodes.item(range.td.begin);for(let i=range.td.begin;i<range.td.end;++i){if(i!=range.td.begin){text+="\t"}text+=MdFromChildNodes(td,0);td=td.nextSibling}text+="\n"}tr=tr.nextSibling}return text}function DeleteSelectedCells(range){const table=nt_selected_cell.parentNode.parentNode;let tr=table.childNodes.item(range.tr.begin);for(let k=range.tr.begin;k<range.tr.end;++k){if(k!=1){let td=tr.childNodes.item(range.td.begin);for(let i=range.td.begin;i<range.td.end;++i){RemoveNodeList(td,td.firstChild,null);AddNode("BR",td);td=td.nextSibling}}tr=tr.nextSibling}}function OnCutTable(event){console.log("fook cut on table");event.preventDefault();if(!nt_selected_cell)return;if(!event.clipboardData){console.error("event.clipboardData is not defined");return}const range=RangeSelectedIndexes();const cell_text=CopySelectedCells(range);event.clipboardData.setData("text/plain",cell_text);undo_man.Begin(nt_selected_cell,NT_SELECT_CELL_MODE,nt_anchor_cell,NT_SELECT_CELL_MODE);DeleteSelectedCells(range);document.getSelection().collapse(nt_selected_cell,0);undo_man.End(nt_selected_cell,0);ReleaseTableSelectAll()}function OnCopyTable(event){console.log("fook copy on table");event.preventDefault();if(!nt_selected_cell)return;if(!event.clipboardData){console.error("event.clipboardData is not defined");return}const range=RangeSelectedIndexes();const cell_text=CopySelectedCells(range);event.clipboardData.setData("text/plain",cell_text)}function OnPasteTable(event){console.log("fook paste on table");event.preventDefault();if(!nt_selected_cell)return;if(!event.clipboardData){console.error("event.clipboardData is not defined");return}const text=ResolveNewlineCode(event.clipboardData.getData("text/plain"));if(!text)return;const md_text=TableMDFromCSV(text);const fragment=MD2DOM(md_text);if(!fragment)return;if(fragment.firstChild.nodeName=="TABLE"){InitializeMathInFragment(fragment,0);const range=RangeSelectedIndexes();undo_man.Begin(nt_selected_cell,NT_SELECT_CELL_MODE,nt_anchor_cell,NT_SELECT_CELL_MODE);PasteTableToTable(fragment.firstChild,range);undo_man.End(nt_selected_cell,NT_SELECT_CELL_MODE,nt_anchor_cell,NT_SELECT_CELL_MODE)}console.log("clipboard data is not table")}function CorrectForTableCell(td){let node=td.firstChild;while(node){let next=node.nextSibling;if(node.className=="math"){if(["editmathdisp","editcodedisp"].includes(node.lastChild.className)){RemoveNode(node);const focus=SafeJunctionPoint(next);if(focus){next=focus.node}}}node=next}}function TableMDFromCSV(text){const split_char="\t";let offset=0;let pos_n=text.indexOf("\n",offset);let md_text="";let num_row=0;while(pos_n>=0){const row_text=TableRowFromCSV(text,offset,pos_n);++num_row;if(num_row==2){if(!IsSecondLineOfTableMD(row_text)){md_text+="|---|\n";++num_row}}md_text+=row_text+"\n";offset=pos_n+1;pos_n=text.indexOf("\n",offset)}if(offset<text.length){md_text+=TableRowFromCSV(text,offset,text.length)+"\n";++num_row}if(num_row==1){md_text+="|---|\n";++num_row}return md_text}function TableRowFromCSV(text,begin_index,end_index){const split_char="\t";let offset=begin_index;let pos_t=text.indexOf("\t",offset);let md_text=text.charAt(offset)!="|"?"|":"";while(pos_t>=0&&pos_t<end_index){md_text+=text.slice(offset,pos_t)+"|";offset=pos_t+1;pos_t=text.indexOf("\t",offset)}if(offset<end_index){md_text+=text.slice(offset,end_index)}if(text.charAt(end_index-1)!="|"){md_text+="|"}return md_text}function PasteTableToTable(src_table,range){const table=nt_selected_cell.parentNode.parentNode;let tr=table.childNodes.item(range.tr.begin);let src_tr=src_table.firstChild;const range_width=range.td.end-range.td.begin;const num_col=range_width<src_tr.childNodes.length?range_width:src_tr.childNodes.length;for(let k=range.tr.begin;k<range.tr.end;++k){if(k!=1){if(src_tr){let src_td=src_tr.firstChild;let dest_td=tr.childNodes.item(range.td.begin);for(let i=0;i<num_col;++i){const frag_new_tds=new DocumentFragment;while(src_td.firstChild){frag_new_tds.appendChild(src_td.removeChild(src_td.firstChild))}RemoveNodeList(dest_td,dest_td.firstChild,null);AddNodeList(dest_td,dest_td.firstChild,frag_new_tds);dest_td=dest_td.nextSibling;src_td=src_td.nextSibling}for(let i=num_col;i<range_width;++i){RemoveNodeList(dest_td,dest_td.firstChild,null);AddNode("BR",dest_td);dest_td=dest_td.nextSibling}if(src_tr===src_table.firstChild)src_tr=src_tr.nextSibling;src_tr=src_tr.nextSibling}else{let dest_td=tr.childNodes.item(range.td.begin);for(let i=0;i<range_width;++i){RemoveNodeList(dest_td,dest_td.firstChild,null);AddNode("BR",dest_td);dest_td=dest_td.nextSibling}}}tr=tr.nextSibling}}"use strict";class StoredNode{constructor(node){this.real_instance=node;this.nodeName=node.nodeName;this.text_class=node.nodeType===Node.TEXT_NODE?node.data:node.className;this.children=[];for(let ch=node.firstChild;ch;ch=ch.nextSibling){this.children.push(new StoredNode(ch))}}IsSame(node){return true}}"use strict";function StrEnclosureComp(str1,str2){const length1=str1.length;const length2=str2.length;const i_end=length1<length2?length1:length2;console.log("StrEnclosureComp1:",str1,"(",length1);console.log("StrEnclosureComp2:",str2,"(",length2);let i;for(i=0;i<i_end;++i){if(str1.charAt(i)!=str2.charAt(i)){break}}const k_end=i_end-i;let k;for(k=0;k<k_end;++k){if(str1.charAt(length1-k-1)!=str2.charAt(length2-k-1)){break}}return{begin:i,width1:length1-k-i,width2:length2-k-i}}"use strict";function ReplaceAll(text_org,before_word,after_word){let i=text_org.indexOf(before_word,0);if(i<0)return text_org;const before_len=before_word.length;let result=text_org.slice(0,i)+after_word;let offset=i+before_len;i=text_org.indexOf(before_word,offset);while(i>=0){result+=text_org.slice(offset,i)+after_word;offset=i+before_len;i=text_org.indexOf(before_word,offset)}result+=text_org.slice(offset);return result}function ReplaceAllExcept(text_org,before_word,after_word,ignore_next){let i=text_org.indexOf(before_word,0);if(i<0)return text_org;const before_len=before_word.length;if(i+before_len>=text_org.length)return text_org;while(text_org.startsWith(ignore_next,i+before_len)){i=text_org.indexOf(before_word,i+1);if(i<0)return text_org;if(i+before_len>=text_org.length)return text_org}let result=text_org.slice(0,i)+after_word;let offset=i+before_len;i=text_org.indexOf(before_word,offset);while(i>=0&&i+before_len<text_org.length){if(text_org.startsWith(ignore_next,i+before_len)){i=text_org.indexOf(before_word,i+1)}else{result+=text_org.slice(offset,i)+after_word;offset=i+before_len;i=text_org.indexOf(before_word,offset)}}result+=text_org.slice(offset);return result}function ReplaceByRangeAll(text_org,begin_word,end_word,after_word){let i=text_org.indexOf(begin_word,0);if(i<0)return text_org;const begin_len=begin_word.length;let k=text_org.indexOf(end_word,i+begin_len);if(k<0)return text_org;const end_len=end_word.length;let result=text_org.slice(0,i)+after_word;let offset=k+end_len;i=text_org.indexOf(begin_word,offset);while(i>=0){k=text_org.indexOf(end_word,i+begin_len);if(k<0)break;result+=text_org.slice(offset,i)+after_word;offset=k+end_len;i=text_org.indexOf(begin_word,offset)}result+=text_org.slice(offset);return result}function IsAlphabet(str){return str.charCodeAt(0)<128}function ReplaceLinebreakToSpaceForJP(text_org){const before_word="\n";const after_word=" ";const before_len=before_word.length;let offset=0;let i=text_org.indexOf(before_word,offset);if(i<0)return text_org;if(i===0){offset=1;i=text_org.indexOf(before_word,offset);if(i<0)return text_org.slice(offset)}let result="";while(i>=0){if(i===text_org.length-1){result+=text_org.slice(offset,i)}else if(IsAlphabet(text_org[i-1])||IsAlphabet(text_org[i+1])){result+=text_org.slice(offset,i)+after_word}else{result+=text_org.slice(offset,i)}offset=i+1;i=text_org.indexOf(before_word,offset)}result+=text_org.slice(offset);return result}function ResolveNewlineCode(text_org){const before_word="\r";const after_word="\n";let offset=0;let i=text_org.indexOf(before_word,offset);if(i<0)return text_org;let result="";while(i>=0){result+=text_org.slice(offset,i)+"\n";if(text_org.charAt(i+1)=="\n"){offset=i+2}else{offset=i+1}i=text_org.indexOf(before_word,offset)}result+=text_org.slice(offset);return result}